<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>ES 底层结构原理和架构设计详解 | 余一叶知秋尽</title><meta name="author" content="余一叶知秋尽"><meta name="copyright" content="余一叶知秋尽"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="节点类型   主节点 (Master Node)：管理集群状态、节点管理、分片分配 数据节点 (Data Node)：存储数据、执行CRUD、搜索、聚合操作 协调节点 (Coordinating Node)：接收客户端请求，路由到对应节点 摄取节点 (Ingest Node)：数据预处理管道（可以对数据做加密、截取、路由等处理）   集群架构图: graph TB     subgraph &quot;El">
<meta property="og:type" content="article">
<meta property="og:title" content="ES 底层结构原理和架构设计详解">
<meta property="og:url" content="https://pengline.github.io/2025/01/ae10ad7f092a49678174f2f4f0010291/index.html">
<meta property="og:site_name" content="余一叶知秋尽">
<meta property="og:description" content="节点类型   主节点 (Master Node)：管理集群状态、节点管理、分片分配 数据节点 (Data Node)：存储数据、执行CRUD、搜索、聚合操作 协调节点 (Coordinating Node)：接收客户端请求，路由到对应节点 摄取节点 (Ingest Node)：数据预处理管道（可以对数据做加密、截取、路由等处理）   集群架构图: graph TB     subgraph &quot;El">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pengline.github.io/img/essay/small103754rLdNH1758681474.webp">
<meta property="article:published_time" content="2025-01-06T16:00:00.000Z">
<meta property="article:modified_time" content="2026-01-09T07:12:46.641Z">
<meta property="article:author" content="余一叶知秋尽">
<meta property="article:tag" content="ES 分片原理">
<meta property="article:tag" content="ES Routing">
<meta property="article:tag" content="ES Pipeline Routing">
<meta property="article:tag" content="ES 路由分片">
<meta property="article:tag" content="ES 自动路由">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pengline.github.io/img/essay/small103754rLdNH1758681474.webp"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ES 底层结构原理和架构设计详解",
  "url": "https://pengline.github.io/2025/01/ae10ad7f092a49678174f2f4f0010291/",
  "image": "https://pengline.github.io/img/essay/small103754rLdNH1758681474.webp",
  "datePublished": "2025-01-06T16:00:00.000Z",
  "dateModified": "2026-01-09T07:12:46.641Z",
  "author": [
    {
      "@type": "Person",
      "name": "余一叶知秋尽",
      "url": "https://pengline.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://pengline.github.io/2025/01/ae10ad7f092a49678174f2f4f0010291/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":30,"languages":{"author":"作者: 余一叶知秋尽","link":"链接: ","source":"来源: 余一叶知秋尽","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ES 底层结构原理和架构设计详解',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/font.css"><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="余一叶知秋尽" type="application/atom+xml">
</head><body><div id="web_bg" style="background: LightGray;"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="/img/butterfly-icon.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">52</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">236</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">41</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list-ul"></i><span> 归档</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类别</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签集</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-outdent"></i><span> AI</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/ai/aigc/"><i class="fa-fw fas fa-cubes"></i><span> AIGC 创意平台</span></a></li><li><a class="site-page child" href="/ai/agent/medical/"><i class="fa-fw fas fa-medkit"></i><span> 医疗问答Agent</span></a></li><li><a class="site-page child" href="https://github.com/HengLine/ai-stocks-agent"><i class="fa-fw fas fa-line-chart"></i><span> 股票分析Agent</span></a></li><li><a class="site-page child" href="/ai/agent/video/"><i class="fa-fw fas fa-cut"></i><span> 视频混剪Agent</span></a></li><li><a class="site-page child" href="https://github.com/HengLine/video-shot-agent"><i class="fa-fw fas fa-file-video"></i><span> 剧本分镜Agent</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list-ol"></i><span> 项目</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/turnkey/smart-city"><i class="fa-fw fas fa-building"></i><span> 智慧城市</span></a></li><li><a class="site-page child" href="/turnkey/smart-security"><i class="fa-fw fas fa-check-circle"></i><span> 智慧安检</span></a></li><li><a class="site-page child" href="/turnkey/tms"><i class="fa-fw fas fa-truck"></i><span> 物流运输</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-cogs"></i><span> 工具</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/tools/json/"><i class="fa-fw fas fa-cog"></i><span> JSON 转换工具集</span></a></li><li><a class="site-page child" href="/tools/diagrams/mermaid"><i class="fa-fw fas fa-pie-chart"></i><span> 在线绘制 UML 图</span></a></li><li><a class="site-page child" href="/tools/image/compressor/"><i class="fa-fw fas fa-image"></i><span> 图像批量压缩大小</span></a></li><li><a class="site-page child" href="/tools/image/watermark/"><i class="fa-fw fas fa-image"></i><span> 图像批量添加水印</span></a></li><li><a class="site-page child" href="/tools/image/convert/"><i class="fa-fw fas fa-file-image"></i><span> 图像格式编码转换</span></a></li><li><a class="site-page child" href="/tools/video/cropping/"><i class="fa-fw fas fa-cut"></i><span> 视频时长范围裁剪</span></a></li><li><a class="site-page child" href="/tools/video/watermark/"><i class="fa-fw fas fa-video"></i><span> 视频加水印马赛克</span></a></li><li><a class="site-page child" href="/tools/download/"><i class="fa-fw fas fa-cloud-download"></i><span> 批量下载视频图片</span></a></li><li><a class="site-page child" href="/tools/docu/watermark/"><i class="fa-fw fas fa-file-pdf"></i><span> PDF 文档添加水印</span></a></li><li><a class="site-page child" href="/tools/docu/signature"><i class="fa-fw fas fa-file"></i><span> 文档在线手写签名</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-pencil-square"></i><span> 文学</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/literature/poems"><i class="fa-fw fas fa-align-center"></i><span> 三行诗集</span></a></li><li><a class="site-page child" href="/literature/classical"><i class="fa-fw fas fa-align-justify"></i><span> 诗词歌赋</span></a></li><li><a class="site-page child" href="/literature/modern"><i class="fa-fw fas fa-align-left"></i><span> 现代诗歌</span></a></li><li><a class="site-page child" href="/literature/journal"><i class="fa-fw fas fa-align-right"></i><span> 随心随笔</span></a></li><li><a class="site-page child" href="/literature/incomplete"><i class="fa-fw fas fa-columns"></i><span> 忘梦残句</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-commenting"></i><span> 交流</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/messageboard/"><i class="fa-fw fas fa-paper-plane"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/essay/small103754rLdNH1758681474.webp);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src= "/img/20241215205335173426721579192.webp" data-lazy-src="/img/logo.png" alt="Logo"><span class="site-name">余一叶知秋尽</span></a><a class="nav-page-title" href="/"><span class="site-name">ES 底层结构原理和架构设计详解</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list-ul"></i><span> 归档</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类别</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签集</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-outdent"></i><span> AI</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/ai/aigc/"><i class="fa-fw fas fa-cubes"></i><span> AIGC 创意平台</span></a></li><li><a class="site-page child" href="/ai/agent/medical/"><i class="fa-fw fas fa-medkit"></i><span> 医疗问答Agent</span></a></li><li><a class="site-page child" href="https://github.com/HengLine/ai-stocks-agent"><i class="fa-fw fas fa-line-chart"></i><span> 股票分析Agent</span></a></li><li><a class="site-page child" href="/ai/agent/video/"><i class="fa-fw fas fa-cut"></i><span> 视频混剪Agent</span></a></li><li><a class="site-page child" href="https://github.com/HengLine/video-shot-agent"><i class="fa-fw fas fa-file-video"></i><span> 剧本分镜Agent</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list-ol"></i><span> 项目</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/turnkey/smart-city"><i class="fa-fw fas fa-building"></i><span> 智慧城市</span></a></li><li><a class="site-page child" href="/turnkey/smart-security"><i class="fa-fw fas fa-check-circle"></i><span> 智慧安检</span></a></li><li><a class="site-page child" href="/turnkey/tms"><i class="fa-fw fas fa-truck"></i><span> 物流运输</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-cogs"></i><span> 工具</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/tools/json/"><i class="fa-fw fas fa-cog"></i><span> JSON 转换工具集</span></a></li><li><a class="site-page child" href="/tools/diagrams/mermaid"><i class="fa-fw fas fa-pie-chart"></i><span> 在线绘制 UML 图</span></a></li><li><a class="site-page child" href="/tools/image/compressor/"><i class="fa-fw fas fa-image"></i><span> 图像批量压缩大小</span></a></li><li><a class="site-page child" href="/tools/image/watermark/"><i class="fa-fw fas fa-image"></i><span> 图像批量添加水印</span></a></li><li><a class="site-page child" href="/tools/image/convert/"><i class="fa-fw fas fa-file-image"></i><span> 图像格式编码转换</span></a></li><li><a class="site-page child" href="/tools/video/cropping/"><i class="fa-fw fas fa-cut"></i><span> 视频时长范围裁剪</span></a></li><li><a class="site-page child" href="/tools/video/watermark/"><i class="fa-fw fas fa-video"></i><span> 视频加水印马赛克</span></a></li><li><a class="site-page child" href="/tools/download/"><i class="fa-fw fas fa-cloud-download"></i><span> 批量下载视频图片</span></a></li><li><a class="site-page child" href="/tools/docu/watermark/"><i class="fa-fw fas fa-file-pdf"></i><span> PDF 文档添加水印</span></a></li><li><a class="site-page child" href="/tools/docu/signature"><i class="fa-fw fas fa-file"></i><span> 文档在线手写签名</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-pencil-square"></i><span> 文学</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/literature/poems"><i class="fa-fw fas fa-align-center"></i><span> 三行诗集</span></a></li><li><a class="site-page child" href="/literature/classical"><i class="fa-fw fas fa-align-justify"></i><span> 诗词歌赋</span></a></li><li><a class="site-page child" href="/literature/modern"><i class="fa-fw fas fa-align-left"></i><span> 现代诗歌</span></a></li><li><a class="site-page child" href="/literature/journal"><i class="fa-fw fas fa-align-right"></i><span> 随心随笔</span></a></li><li><a class="site-page child" href="/literature/incomplete"><i class="fa-fw fas fa-columns"></i><span> 忘梦残句</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-commenting"></i><span> 交流</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/messageboard/"><i class="fa-fw fas fa-paper-plane"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">ES 底层结构原理和架构设计详解</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-01-06T16:00:00.000Z" title="发表于 2025-01-07 00:00:00">2025-01-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-01-09T07:12:46.641Z" title="更新于 2026-01-09 15:12:46">2026-01-09</time></span></div><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/DB/">DB</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/DB/ES/">ES</a></span><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p><strong>节点类型</strong></p>
<blockquote>
<ul class="lvl-1">
<li class="lvl-2"><strong>主节点 (Master Node)</strong>：管理集群状态、节点管理、分片分配</li>
<li class="lvl-2"><strong>数据节点 (Data Node)</strong>：存储数据、执行CRUD、搜索、聚合操作</li>
<li class="lvl-2"><strong>协调节点 (Coordinating Node)</strong>：接收客户端请求，路由到对应节点</li>
<li class="lvl-2"><strong>摄取节点 (Ingest Node)</strong>：数据预处理管道（可以对数据做加密、截取、路由等处理）</li>
</ul>
</blockquote>
<p><strong>集群架构图</strong>:</p>
<pre class="mermaid">graph TB
    subgraph "Elasticsearch 集群"
        C[协调节点<br/>Coordinating Node]
        
        subgraph "节点组 A"
            M[主节点<br/>Master Node]
            D1[数据节点]
        end
        
        subgraph "节点组 B"
            D2[数据节点]
            D3[数据节点]
        end
        
        subgraph "索引结构"
            subgraph "索引: logs-2024"
                S1[主分片 P0]
                S2[副本分片 R0]
                S3[主分片 P1]
                S4[副本分片 R1]
            end
        end
        
        C -->|路由请求| D1
        C -->|路由请求| D2
        C -->|路由请求| D3
        
        M -->|集群管理| D1
        M -->|集群管理| D2
        M -->|集群管理| D3
        
        S1 -.->|副本同步| S2
        S3 -.->|副本同步| S4
    end
    
    Client[客户端] --> C</pre>
<h2 id="数据存储">数据存储</h2>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span>                    <span class="comment">// 主分片数量，根据数据量和查询负载调整</span></span><br><span class="line">      <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span>                  <span class="comment">// 副本数量，保证高可用和读取性能</span></span><br><span class="line">      <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5s&quot;</span><span class="punctuation">,</span>                 <span class="comment">// 刷新间隔，平衡实时性和性能</span></span><br><span class="line">      <span class="attr">&quot;max_result_window&quot;</span><span class="punctuation">:</span> <span class="number">10000</span><span class="punctuation">,</span>               <span class="comment">// 最大返回结果数，防止深分页内存溢出</span></span><br><span class="line">      </span><br><span class="line">      <span class="attr">&quot;codec&quot;</span><span class="punctuation">:</span> <span class="string">&quot;best_compression&quot;</span><span class="punctuation">,</span>              <span class="comment">// 压缩算法，减少存储空间</span></span><br><span class="line">      <span class="attr">&quot;routing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;allocation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;require&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;zone&quot;</span><span class="punctuation">:</span> <span class="string">&quot;east&quot;</span>                      <span class="comment">// 强制分配到东部机房节点</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;exclude&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;rack&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rack-999&quot;</span>                  <span class="comment">// 排除特定机架</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      </span><br><span class="line">      <span class="attr">&quot;translog&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;sync_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5s&quot;</span><span class="punctuation">,</span>                  <span class="comment">// translog同步间隔</span></span><br><span class="line">        <span class="attr">&quot;durability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;async&quot;</span><span class="punctuation">,</span>                  <span class="comment">// 持久化模式：async性能更好，request更安全</span></span><br><span class="line">        <span class="attr">&quot;flush_threshold_size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1gb&quot;</span>           <span class="comment">// translog大小阈值触发flush</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      </span><br><span class="line">      <span class="attr">&quot;merge&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;policy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;segments_per_tier&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span>              <span class="comment">// 每层最大段数</span></span><br><span class="line">          <span class="attr">&quot;max_merged_segment&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5gb&quot;</span><span class="punctuation">,</span>          <span class="comment">// 最大合并段大小</span></span><br><span class="line">          <span class="attr">&quot;deletes_pct_allowed&quot;</span><span class="punctuation">:</span> <span class="number">33</span>             <span class="comment">// 允许删除文档百分比</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      </span><br><span class="line">      <span class="attr">&quot;unassigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;node_left&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;delayed_timeout&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10m&quot;</span>              <span class="comment">// 节点离开后延迟分配时间</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;analysis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;smart_analyzer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>                     <span class="comment">// 自定义智能分析器</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;custom&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;tokenizer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;lowercase&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;asciifolding&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;smart_stopwords&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;synonym_filter&quot;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pinyin_analyzer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>                    <span class="comment">// 拼音分析器</span></span><br><span class="line">          <span class="attr">&quot;tokenizer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pinyin_tokenizer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ngram_analyzer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>                     <span class="comment">// 模糊搜索分析器</span></span><br><span class="line">          <span class="attr">&quot;tokenizer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ngram_tokenizer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tokenizer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;pinyin_tokenizer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pinyin&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;keep_first_letter&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;keep_separate_first_letter&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ngram_tokenizer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ngram&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;min_gram&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;max_gram&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;token_chars&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;letter&quot;</span><span class="punctuation">,</span> <span class="string">&quot;digit&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;smart_stopwords&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>                    <span class="comment">// 智能停用词过滤</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stop&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;stopwords&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;的&quot;</span><span class="punctuation">,</span> <span class="string">&quot;了&quot;</span><span class="punctuation">,</span> <span class="string">&quot;和&quot;</span><span class="punctuation">,</span> <span class="string">&quot;是&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;synonym_filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>                     <span class="comment">// 同义词过滤</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;synonym&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;synonyms_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;analysis/synonyms.txt&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>                          <span class="comment">// 存储原始文档，支持update和reindex</span></span><br><span class="line">      <span class="attr">&quot;excludes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;credit_card_number&quot;</span><span class="punctuation">]</span>        <span class="comment">// 排除敏感字段不存储</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_routing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span>                          <span class="comment">// 强制路由，提高查询性能</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dynamic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;strict&quot;</span><span class="punctuation">,</span>                        <span class="comment">// 严格模式，禁止动态添加字段</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="comment">// =========== 订单基本信息 ===========</span></span><br><span class="line">      <span class="attr">&quot;order_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span>                      <span class="comment">// 精确匹配，用于term查询</span></span><br><span class="line">        <span class="attr">&quot;ignore_above&quot;</span><span class="punctuation">:</span> <span class="number">256</span><span class="punctuation">,</span>                    <span class="comment">// 超过长度不索引</span></span><br><span class="line">        <span class="attr">&quot;norms&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span>                         <span class="comment">// 禁用评分因子，节省空间</span></span><br><span class="line">        <span class="attr">&quot;doc_values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span>                      <span class="comment">// 启用列式存储，用于排序聚合</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;order_sn&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span>                         <span class="comment">// 全文搜索</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;keyword&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span>                  <span class="comment">// 多字段类型，同时支持全文和精确</span></span><br><span class="line">            <span class="attr">&quot;ignore_above&quot;</span><span class="punctuation">:</span> <span class="number">128</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;pinyin&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>                           <span class="comment">// 拼音搜索</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pinyin_analyzer&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;search_analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pinyin_analyzer&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ngram&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>                            <span class="comment">// 模糊搜索</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ngram_analyzer&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// =========== 用户信息 ===========</span></span><br><span class="line">      <span class="attr">&quot;user_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span>                       <span class="comment">// 对象类型</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;coerce&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span>                      <span class="comment">// 允许类型转换</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;smart_analyzer&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;fielddata&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span>                  <span class="comment">// 禁用fielddata，防止内存溢出</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;byte&quot;</span><span class="punctuation">,</span>                     <span class="comment">// 小整数类型，节省空间</span></span><br><span class="line">            <span class="attr">&quot;null_value&quot;</span><span class="punctuation">:</span> <span class="number">0</span>                     <span class="comment">// 空值默认值</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;eager_global_ordinals&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span>       <span class="comment">// 预加载全局序号，加速聚合</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;profile&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flattened&quot;</span><span class="punctuation">,</span>                <span class="comment">// 扁平化类型，用于不确定字段名的对象</span></span><br><span class="line">            <span class="attr">&quot;depth_limit&quot;</span><span class="punctuation">:</span> <span class="number">5</span>                    <span class="comment">// 嵌套深度限制</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// =========== 商品信息 ===========</span></span><br><span class="line">      <span class="attr">&quot;products&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nested&quot;</span><span class="punctuation">,</span>                       <span class="comment">// 嵌套类型，保持数组对象独立性</span></span><br><span class="line">        <span class="attr">&quot;include_in_parent&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span>             <span class="comment">// 不包含在父文档中</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;product_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span>                       <span class="comment">// 默认true，可显式声明</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;sku_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;smart_analyzer&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;boost&quot;</span><span class="punctuation">:</span> <span class="number">2.0</span>                        <span class="comment">// 权重提升</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;scaled_float&quot;</span><span class="punctuation">,</span>             <span class="comment">// 缩放浮点，避免浮点精度问题</span></span><br><span class="line">            <span class="attr">&quot;scaling_factor&quot;</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;quantity&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span>                    <span class="comment">// 禁用索引，仅存储</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;categories&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;index_options&quot;</span><span class="punctuation">:</span> <span class="string">&quot;freqs&quot;</span>            <span class="comment">// 只索引词频，节省空间</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// =========== 金额信息 ===========</span></span><br><span class="line">      <span class="attr">&quot;amount&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;double&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;coerce&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span>                     <span class="comment">// 严格模式，不允许类型转换</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;discount&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;half_float&quot;</span><span class="punctuation">,</span>               <span class="comment">// 半精度浮点，节省空间</span></span><br><span class="line">            <span class="attr">&quot;ignore_malformed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span>            <span class="comment">// 忽略格式错误</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;currency&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;constant_keyword&quot;</span><span class="punctuation">,</span>         <span class="comment">// 常量关键字，所有文档值相同</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CNY&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;payment_method&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// =========== 时间信息 ===========</span></span><br><span class="line">      <span class="attr">&quot;timestamps&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;created_at&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;strict_date_optional_time||epoch_millis&quot;</span><span class="punctuation">,</span>  <span class="comment">// 严格日期格式</span></span><br><span class="line">            <span class="attr">&quot;ignore_malformed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;paid_at&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;delivered_at&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date_hour_minute_second&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;estimated_delivery&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date_range&quot;</span><span class="punctuation">,</span>               <span class="comment">// 日期范围类型</span></span><br><span class="line">            <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;yyyy-MM-dd&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// =========== 地理位置 ===========</span></span><br><span class="line">      <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;geo_point&quot;</span><span class="punctuation">,</span>                    <span class="comment">// 地理坐标点</span></span><br><span class="line">        <span class="attr">&quot;ignore_z_value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span>                  <span class="comment">// 忽略Z坐标（3D）</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;delivery_route&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;geo_shape&quot;</span><span class="punctuation">,</span>                    <span class="comment">// 地理形状</span></span><br><span class="line">        <span class="attr">&quot;strategy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;recursive&quot;</span>                 <span class="comment">// 递归策略</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// =========== 状态与标签 ===========</span></span><br><span class="line">      <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;keyword&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;status_history&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;histogram&quot;</span><span class="punctuation">,</span>                    <span class="comment">// 直方图类型，用于预聚合数据</span></span><br><span class="line">        <span class="attr">&quot;ignore_malformed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;normalizer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lowercase_normalizer&quot;</span>    <span class="comment">// 规范化处理</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;flags&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;boolean&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;null_value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// =========== 搜索优化字段 ===========</span></span><br><span class="line">      <span class="attr">&quot;search_vector&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dense_vector&quot;</span><span class="punctuation">,</span>                 <span class="comment">// 稠密向量，用于向量搜索</span></span><br><span class="line">        <span class="attr">&quot;dims&quot;</span><span class="punctuation">:</span> <span class="number">768</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;similarity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cosine&quot;</span>                  <span class="comment">// 相似度算法</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;suggest&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;completion&quot;</span><span class="punctuation">,</span>                   <span class="comment">// 自动补全类型</span></span><br><span class="line">        <span class="attr">&quot;preserve_separators&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;preserve_position_increments&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// =========== 复杂数据类型 ===========</span></span><br><span class="line">      <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flattened&quot;</span><span class="punctuation">,</span>                    <span class="comment">// 扁平化处理动态元数据</span></span><br><span class="line">        <span class="attr">&quot;split_queries_on_whitespace&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span>     <span class="comment">// 空格分割查询</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;attachments&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;binary&quot;</span><span class="punctuation">,</span>                       <span class="comment">// 二进制类型</span></span><br><span class="line">        <span class="attr">&quot;doc_values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span>                     <span class="comment">// 二进制不参与聚合</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// =========== 关联关系 ===========</span></span><br><span class="line">      <span class="attr">&quot;related_orders&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;join&quot;</span><span class="punctuation">,</span>                         <span class="comment">// 关联类型</span></span><br><span class="line">        <span class="attr">&quot;relations&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;refund&quot;</span>                     <span class="comment">// 订单-退款关系</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// =========== 性能优化字段 ===========</span></span><br><span class="line">      <span class="attr">&quot;hot_score&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rank_feature&quot;</span><span class="punctuation">,</span>                 <span class="comment">// 排名特征，用于boosting</span></span><br><span class="line">        <span class="attr">&quot;positive_score_impact&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span>           <span class="comment">// 正向影响评分</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;popularity&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rank_features&quot;</span>                 <span class="comment">// 多排名特征</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// =========== 聚合优化字段 ===========</span></span><br><span class="line">      <span class="attr">&quot;category_tree&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ip&quot;</span><span class="punctuation">,</span>                           <span class="comment">// IP地址类型（特殊场景复用）</span></span><br><span class="line">        <span class="attr">&quot;doc_values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span>                          <span class="comment">// 不索引，只用于聚合</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// =========== 版本控制 ===========</span></span><br><span class="line">      <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;version&quot;</span>                       <span class="comment">// 版本类型，用于乐观锁</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dynamic_templates&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;strings_as_keywords&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;match_mapping_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;mapping&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;norms&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;doc_values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;numbers_as_floats&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;match_mapping_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;mapping&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;float&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;coerce&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aliases&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;orders_current&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span>                       <span class="comment">// 当前订单别名</span></span><br><span class="line">    <span class="attr">&quot;orders_search&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>                          <span class="comment">// 搜索专用别名</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;timestamps.created_at&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;now-30d/d&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="数据结构">数据结构</h3>
<blockquote>
<ul class="lvl-1">
<li class="lvl-2">
<p>.tip: 词典索引</p>
</li>
<li class="lvl-2">
<p>.tim: 词典数据</p>
</li>
<li class="lvl-2">
<p>.doc: 文档列表</p>
</li>
<li class="lvl-2">
<p>.pos: 位置信息</p>
</li>
<li class="lvl-2">
<p>.nvd/.nvm: 数值型数据</p>
</li>
</ul>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Lucene 倒排索引文件结构</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">InvertedIndex</span> &#123;</span></span><br><span class="line">    <span class="comment">// 1. 词典文件 (.tim)</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">TermDictionary</span> &#123;</span></span><br><span class="line">        TermBlock[] blocks;          <span class="comment">// 术语块，按字典序排序</span></span><br><span class="line">        FST fst;                     <span class="comment">// 有限状态转换器，快速定位</span></span><br><span class="line">        <span class="type">long</span>[] blockOffsets;         <span class="comment">// 块偏移量</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 倒排列表文件 (.doc, .pos, .pay)</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">PostingList</span> &#123;</span></span><br><span class="line">        <span class="comment">// .doc 文件：文档ID和词频</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">DocData</span> &#123;</span></span><br><span class="line">            <span class="type">uint32_t</span> docId;           <span class="comment">// 文档ID（增量编码）</span></span><br><span class="line">            <span class="type">uint32_t</span> freq;            <span class="comment">// 词频</span></span><br><span class="line">            <span class="type">uint32_t</span>[] positionDelta; <span class="comment">// 位置信息（增量编码）</span></span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// .pos 文件：位置信息</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">PositionData</span> &#123;</span></span><br><span class="line">            <span class="type">uint32_t</span> position;        <span class="comment">// 词在文档中的位置</span></span><br><span class="line">            <span class="type">uint32_t</span> startOffset;     <span class="comment">// 开始偏移量</span></span><br><span class="line">            <span class="type">uint32_t</span> endOffset;       <span class="comment">// 结束偏移量</span></span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// .pay 文件：payload信息</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">PayloadData</span> &#123;</span></span><br><span class="line">            byte[] payload;           <span class="comment">// 自定义负载数据</span></span><br><span class="line">            <span class="type">float</span> weight;             <span class="comment">// 权重信息</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 跳跃列表 (Skip List) - 加速联合查询</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">SkipList</span> &#123;</span></span><br><span class="line">        <span class="type">uint32_t</span> skipInterval;        <span class="comment">// 跳跃间隔</span></span><br><span class="line">        <span class="type">uint32_t</span> maxSkipLevels;       <span class="comment">// 最大跳跃层级</span></span><br><span class="line">        SkipNode[] nodes;             <span class="comment">// 跳跃节点</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>文档存储</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文档在Segment中的存储</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Document</span> &#123;</span></span><br><span class="line">    StoredFields;    <span class="comment">// 存储字段（原始值）</span></span><br><span class="line">    TermVectors;     <span class="comment">// 词向量</span></span><br><span class="line">    InvertedIndex;   <span class="comment">// 倒排索引</span></span><br><span class="line">    DocValues;       <span class="comment">// 列式存储（排序/聚合）</span></span><br><span class="line">    PointValues;     <span class="comment">// 数值型索引（范围查询）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>FST特性</strong>：</p>
<ol>
<li class="lvl-3">
<p>前缀共享，节省内存</p>
</li>
<li class="lvl-3">
<p>支持前缀匹配</p>
</li>
<li class="lvl-3">
<p>O(length) 时间复杂度查找</p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">c--a--t--$ (输出: cat)</span><br><span class="line">      |</span><br><span class="line">      +--s--$ (输出: cats)</span><br><span class="line"> </span><br><span class="line">d--o--g--$ (输出: dog)</span><br><span class="line">      |</span><br><span class="line">      +--s--$ (输出: dogs)</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ol>
<h3 id="倒排索引">倒排索引</h3>
<pre class="mermaid">graph TB
    subgraph "原始文档"
        D1[文档1: Elasticsearch is fast and scalable]
        D2[文档2: Search is fast]
        D3[文档3: Elasticsearch distributed]
    end
    
    subgraph "分词与处理"
        D1 --> T1[分词: elasticsearch, is, fast, and, scalable]
        D2 --> T2[分词: search, is, fast]
        D3 --> T3[分词: elasticsearch, distributed]
    end
    
    subgraph "倒排索引结构"
        subgraph "词典 Term Dictionary"
            T_es[elasticsearch]
            T_is[is]
            T_fast[fast]
            T_scalable[scalable]
            T_search[search]
            T_dist[distributed]
        end
        
        subgraph "倒排列表 Posting List"
            PL_es[文档1: pos0, 文档3: pos0]
            PL_is[文档1: pos1, 文档2: pos1]
            PL_fast[文档1: pos2, 文档2: pos2]
            PL_scalable[文档1: pos4]
            PL_search[文档2: pos0]
            PL_dist[文档3: pos1]
        end
    end
    
    T1 --> T_es
    T1 --> T_is
    T1 --> T_fast
    T1 --> T_scalable
    T2 --> T_search
    T2 --> T_is
    T2 --> T_fast
    T3 --> T_es
    T3 --> T_dist
    
    T_es --> PL_es
    T_is --> PL_is
    T_fast --> PL_fast
    T_scalable --> PL_scalable
    T_search --> PL_search
    T_dist --> PL_dist</pre>
<h3 id="分段存储">分段存储</h3>
<p><strong>不可变性</strong>：写入后不可修改，删除是标记删除</p>
<p><strong>合并过程</strong>：定期合并小分段，清理删除文档</p>
<p><strong>优点</strong>：缓存友好，支持并发读</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;索引设置优化&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;refresh_interval&quot;</span>: <span class="string">&quot;控制刷新频率&quot;</span>,</span><br><span class="line">    <span class="string">&quot;translog_sync_interval&quot;</span>: <span class="string">&quot;事务日志同步间隔&quot;</span>,</span><br><span class="line">    <span class="string">&quot;merge_policy&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;tiered&quot;</span>: <span class="string">&quot;分层合并策略&quot;</span>,</span><br><span class="line">      <span class="string">&quot;max_merged_segment&quot;</span>: <span class="string">&quot;最大合并段大小&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>索引与段合并流程图：</p>
<pre class="mermaid">flowchart TD
    Start[文档写入] --> Buffer[内存缓冲区]
    
    subgraph A [刷新流程 Refresh]
        direction TB
        A1[缓冲区满或定时触发]
        A2[创建新Lucene Segment]
        A3[Segment可被搜索<br/>NRT实现]
    end
    
    Buffer --> A1 --> A2 --> A3
    
    subgraph B [段合并流程 Merge]
        direction LR
        B1[多个小Segment]
        B2{合并策略检查}
        B3[选择合并的Segment]
        B4[创建新大Segment]
        B5[删除旧Segment]
    end
    
    A3 --> B1 --> B2 --> B3 --> B4 --> B5
    
    subgraph C [持久化流程 Flush]
        C1[定期触发或Translog满]
        C2[提交所有内存数据]
        C3[写入磁盘]
        C4[清空Translog]
        C5[创建新提交点]
    end
    
    A3 --> C1
    B5 --> C1
    C1 --> C2 --> C3 --> C4 --> C5
    
    C5 --> End[持久化完成]</pre>
<h3 id="事务日志（Translog）">事务日志（Translog）</h3>
<p><strong>Translog 结构与流程</strong></p>
<pre class="mermaid">sequenceDiagram
    participant C as 客户端
    participant M as 内存缓冲区
    participant T as Translog
    participant S as Segment
    participant D as 磁盘
    
    Note over C,D: 正常写入流程
    
    C->>M: 1. 写入文档
    M->>T: 2. 追加Translog记录
    T-->>C: 3. 返回ACK (异步模式)
    
    Note over M,S: 刷新周期 (默认1秒)
    
    alt 刷新触发
        M->>S: 4. 创建新Segment
        S->>D: 5. 异步写入磁盘
        S-->>M: 6. Segment可搜索
    end
    
    Note over T,D: 刷盘周期 (默认5秒)
    
    alt Translog刷盘
        T->>T: 7. 检查刷盘条件
        T->>D: 8. 同步到磁盘
        T->>T: 9. 创建新Translog文件
    end
    
    Note over C,D: 故障恢复流程
    
    rect rgb(200, 150, 150)
        Note over T: 节点崩溃后重启
        T->>T: 10. 读取最后提交点
        T->>T: 11. 扫描Translog文件
        T->>M: 12. 重放未提交操作
        M->>S: 13. 重新创建Segment
        S-->>C: 14. 数据恢复完成
    end</pre>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Translog</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Translog 文件结构</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">TranslogFile</span> &#123;</span><br><span class="line">        <span class="comment">// 文件头</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Header</span> &#123;</span><br><span class="line">            <span class="type">long</span> generation;     <span class="comment">// 代次</span></span><br><span class="line">            <span class="type">byte</span> uuid[<span class="number">16</span>];       <span class="comment">// 唯一标识</span></span><br><span class="line">            <span class="type">long</span> primaryTerm;    <span class="comment">// 主任期</span></span><br><span class="line">            <span class="type">long</span> minSeqNo;       <span class="comment">// 最小序列号</span></span><br><span class="line">            <span class="type">long</span> maxSeqNo;       <span class="comment">// 最大序列号</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 操作记录</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Operation</span> &#123;</span><br><span class="line">            <span class="keyword">enum</span> <span class="title class_">OpType</span> &#123; INDEX, DELETE &#125;</span><br><span class="line">            </span><br><span class="line">            OpType type;</span><br><span class="line">            <span class="type">long</span> seqNo;          <span class="comment">// 序列号</span></span><br><span class="line">            <span class="type">long</span> primaryTerm;</span><br><span class="line">            String id;           <span class="comment">// 文档ID</span></span><br><span class="line">            <span class="type">long</span> version;</span><br><span class="line">            Source source;       <span class="comment">// 文档内容</span></span><br><span class="line">            <span class="type">long</span> timestamp;</span><br><span class="line">            <span class="type">long</span> checksum;       <span class="comment">// 校验和</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 文件尾</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Footer</span> &#123;</span><br><span class="line">            <span class="type">long</span> opCount;        <span class="comment">// 操作计数</span></span><br><span class="line">            <span class="type">long</span> checksum;       <span class="comment">// 文件校验和</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 写入流程</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(Operation op)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 序列化操作</span></span><br><span class="line">        <span class="type">byte</span>[] data = serialize(op);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 计算校验和</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">checksum</span> <span class="operator">=</span> calculateChecksum(data);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 写入文件</span></span><br><span class="line">        <span class="keyword">synchronized</span> (writeLock) &#123;</span><br><span class="line">            <span class="comment">// 追加到当前文件</span></span><br><span class="line">            currentFile.append(data, checksum);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 检查文件大小</span></span><br><span class="line">            <span class="keyword">if</span> (currentFile.size() &gt; flushThreshold) &#123;</span><br><span class="line">                rollTranslog();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. 根据持久化模式处理</span></span><br><span class="line">        <span class="keyword">if</span> (durability == Durability.REQUEST) &#123;</span><br><span class="line">            sync();  <span class="comment">// 立即刷盘</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 刷盘策略</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sync</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// fsync策略</span></span><br><span class="line">        <span class="keyword">switch</span> (syncInterval) &#123;</span><br><span class="line">            <span class="keyword">case</span> IMMEDIATE:</span><br><span class="line">                fileChannel.force(<span class="literal">true</span>);  <span class="comment">// 元数据和数据都刷盘</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ASYNC:</span><br><span class="line">                <span class="comment">// 使用O_DIRECT或异步IO</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SCHEDULED:</span><br><span class="line">                <span class="comment">// 定时任务刷盘</span></span><br><span class="line">                scheduler.schedule(<span class="built_in">this</span>::doSync, syncInterval);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Translog 配置示例</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">index.translog:</span></span><br><span class="line">  <span class="attr">sync_interval:</span> <span class="string">&quot;5s&quot;</span>           <span class="comment"># 刷盘间隔</span></span><br><span class="line">  <span class="attr">durability:</span> <span class="string">&quot;async&quot;</span>           <span class="comment"># 持久化模式: request/async</span></span><br><span class="line">  <span class="attr">flush_threshold_size:</span> <span class="string">&quot;512mb&quot;</span> <span class="comment"># 触发flush的大小阈值</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">retention:</span></span><br><span class="line">    <span class="attr">size:</span> <span class="string">&quot;2gb&quot;</span>                 <span class="comment"># 保留大小</span></span><br><span class="line">    <span class="attr">age:</span> <span class="string">&quot;12h&quot;</span>                  <span class="comment"># 保留时间</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">generation_threshold_size:</span> <span class="string">&quot;64mb&quot;</span>  <span class="comment"># 创建新文件的大小</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 不同场景的配置建议</span></span><br><span class="line"><span class="attr">development:</span>                    <span class="comment"># 开发环境</span></span><br><span class="line">  <span class="attr">sync_interval:</span> <span class="string">&quot;1s&quot;</span></span><br><span class="line">  <span class="attr">durability:</span> <span class="string">&quot;request&quot;</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">production_performance:</span>         <span class="comment"># 生产高性能</span></span><br><span class="line">  <span class="attr">sync_interval:</span> <span class="string">&quot;5s&quot;</span></span><br><span class="line">  <span class="attr">durability:</span> <span class="string">&quot;async&quot;</span></span><br><span class="line">  <span class="attr">flush_threshold_size:</span> <span class="string">&quot;1gb&quot;</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">production_safety:</span>              <span class="comment"># 生产高可靠</span></span><br><span class="line">  <span class="attr">sync_interval:</span> <span class="string">&quot;100ms&quot;</span></span><br><span class="line">  <span class="attr">durability:</span> <span class="string">&quot;request&quot;</span></span><br><span class="line">  <span class="attr">flush_threshold_size:</span> <span class="string">&quot;256mb&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="近实时搜索-NRT">近实时搜索 (NRT)</h2>
<p>NRT机制是Elasticsearch实时性的核心保障，理解其工作原理对于构建高性能的搜索和分析系统至关重要。通过合理的配置和监控，可以在数据新鲜度、写入性能和搜索延迟之间找到最佳平衡点。</p>
<blockquote>
<ol>
<li class="lvl-3">
<p>文档写入 <strong>内存缓冲区</strong></p>
</li>
<li class="lvl-3">
<p><strong>定期刷新</strong> 新的Lucene Segment（可搜索）</p>
</li>
<li class="lvl-3">
<p>事务日志 (Translog) 保证持久性</p>
</li>
<li class="lvl-3">
<p>定期Flush  磁盘持久化</p>
</li>
</ol>
</blockquote>
<h3 id="文档写入与刷新">文档写入与刷新</h3>
<p><strong>文档写入与刷新流程</strong></p>
<pre class="mermaid">sequenceDiagram
    participant Client as 客户端
    participant Node as ES节点
    participant Buffer as 内存缓冲区
    participant Translog as 事务日志
    participant Lucene as Lucene索引
    participant Searcher as IndexSearcher
    
    Note over Client,Searcher: 阶段1: 文档写入
    Client->>Node: 1. 发送文档写入请求
    Node->>Buffer: 2. 写入内存缓冲区
    Node->>Translog: 3. 追加Translog记录
    Node-->>Client: 4. 返回写入成功
    
    Note over Client,Searcher: 阶段2: 定时刷新 (默认1秒)
    
    loop 每秒检查
        Node->>Buffer: 5. 检查缓冲区状态
        alt 满足刷新条件
            Buffer->>Lucene: 6. 创建新Segment
            Lucene->>Searcher: 7. 通知新Segment
            Searcher->>Searcher: 8. 重新打开IndexReader
            Lucene->>Translog: 9. 标记已刷新
        end
    end
    
    Note over Client,Searcher: 阶段3: 搜索可见性
    
    Client->>Node: 10. 发送搜索请求
    Node->>Searcher: 11. 查询IndexReader
    Searcher->>Lucene: 12. 搜索所有Segment
    Lucene-->>Searcher: 13. 返回搜索结果
    Searcher-->>Node: 14. 返回结果
    Node-->>Client: 15. 返回最终结果
    
    Note over Client,Searcher: 阶段4: 持久化 (异步)
    
    par Translog刷盘
        loop 每5秒或缓冲区满
            Translog->>Translog: 16. 同步到磁盘
        end
    and Segment刷盘
        loop 每30分钟或Translog满
            Lucene->>Lucene: 17. 提交Segment到磁盘
            Lucene->>Translog: 18. 清除已提交日志
        end
    end</pre>
<p><strong>刷新机制</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RefreshService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 刷新触发条件</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">enum</span> <span class="title class_">RefreshTrigger</span> &#123;</span><br><span class="line">        SCHEDULED,      <span class="comment">// 定时触发 (index.refresh_interval)</span></span><br><span class="line">        BUFFER_FULL,    <span class="comment">// 内存缓冲区满</span></span><br><span class="line">        MANUAL,         <span class="comment">// 手动调用_refresh API</span></span><br><span class="line">        SEARCH_REQUEST, <span class="comment">// 搜索请求触发</span></span><br><span class="line">        TRANSLOG_SIZE   <span class="comment">// Translog大小达到阈值</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 内存缓冲区结构</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">DocumentsBuffer</span> &#123;</span><br><span class="line">        List&lt;Document&gt; documents = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        Map&lt;String, Object&gt; pendingDeletes = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">long</span> <span class="variable">ramBytesUsed</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 刷新条件检查</span></span><br><span class="line">        <span class="type">boolean</span> <span class="title function_">shouldRefresh</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> </span><br><span class="line">                <span class="comment">// 1. 定时刷新</span></span><br><span class="line">                (System.currentTimeMillis() - lastRefresh &gt; refreshInterval) ||</span><br><span class="line">                <span class="comment">// 2. 缓冲区大小超过限制</span></span><br><span class="line">                (ramBytesUsed &gt; bufferSize) ||</span><br><span class="line">                <span class="comment">// 3. 文档数量达到阈值</span></span><br><span class="line">                (documents.size() &gt; maxBufferedDocs) ||</span><br><span class="line">                <span class="comment">// 4. Translog操作数过多</span></span><br><span class="line">                (translogOps &gt; maxTranslogOps);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 刷新过程</span></span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                <span class="comment">// 1. 创建新的IndexWriter</span></span><br><span class="line">                <span class="type">IndexWriter</span> <span class="variable">writer</span> <span class="operator">=</span> createIndexWriter();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 2. 添加文档到Lucene</span></span><br><span class="line">                <span class="keyword">for</span> (Document doc : documents) &#123;</span><br><span class="line">                    writer.addDocument(doc);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 3. 处理删除</span></span><br><span class="line">                <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; delete : pendingDeletes.entrySet()) &#123;</span><br><span class="line">                    writer.deleteDocuments(<span class="keyword">new</span> <span class="title class_">Term</span>(<span class="string">&quot;_id&quot;</span>, delete.getKey()));</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 4. 提交并创建新Segment</span></span><br><span class="line">                writer.commit();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 5. 更新IndexSearcher</span></span><br><span class="line">                <span class="type">IndexReader</span> <span class="variable">newReader</span> <span class="operator">=</span> DirectoryReader.open(writer, <span class="literal">true</span>);</span><br><span class="line">                indexSearcher.getIndexReader().close();</span><br><span class="line">                indexSearcher = <span class="keyword">new</span> <span class="title class_">IndexSearcher</span>(newReader);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 6. 清空缓冲区</span></span><br><span class="line">                documents.clear();</span><br><span class="line">                pendingDeletes.clear();</span><br><span class="line">                ramBytesUsed = <span class="number">0</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 7. 更新统计信息</span></span><br><span class="line">                lastRefresh = System.currentTimeMillis();</span><br><span class="line">                refreshCount++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 异步刷新调度器</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">RefreshScheduler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> ScheduledExecutorService scheduler;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">long</span> scheduledInterval;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (shouldRefresh()) &#123;</span><br><span class="line">                    <span class="comment">// 执行刷新</span></span><br><span class="line">                    refresh();</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 记录性能指标</span></span><br><span class="line">                    recordRefreshMetrics();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;Refresh failed&quot;</span>, e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 重新调度</span></span><br><span class="line">                <span class="keyword">if</span> (!shutdown) &#123;</span><br><span class="line">                    scheduler.schedule(<span class="built_in">this</span>, scheduledInterval, TimeUnit.MILLISECONDS);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="IndexSearcher-Reader">IndexSearcher + Reader</h3>
<pre class="mermaid">graph TB
    subgraph "IndexReader 层级"
        MIR[MultiReader<br/>多索引读取器]
        
        subgraph "索引级别"
            DIR[DirectoryReader<br/>目录读取器]
            
            subgraph "分片级别"
                SIR1[SegmentReader A]
                SIR2[SegmentReader B]
                SIR3[SegmentReader C]
                SIR4[SegmentReader N]
            end
            
            DIR --> SIR1
            DIR --> SIR2
            DIR --> SIR3
            DIR --> SIR4
        end
        
        MIR --> DIR
    end
    
    subgraph "IndexSearcher"
        IS[IndexSearcher<br/>搜索执行器]
        QP[QueryParser<br/>查询解析]
        WS[Weight 和 Scorer<br/>评分计算]
    end
    
    IS --> MIR
    
    subgraph "Segment 结构"
        SEG1[Segment_0<br/>已提交]
        SEG2[Segment_1<br/>已刷新]
        SEG3[Segment_2<br/>内存中]
        
        SEG1 --> SIR1
        SEG2 --> SIR2
        SEG3 --> SIR3
    end
    
    subgraph "Reader 池管理"
        RP[ReaderPool<br/>读取器池]
        RC[ReaderCache<br/>缓存策略]
        RL[ReferenceCounting<br/>引用计数]
    end
    
    SIR1 --> RP
    SIR2 --> RP
    SIR3 --> RP
    RP --> RC
    RP --> RL</pre>
<h3 id="配置与调优">配置与调优</h3>
<p>elasticsearch.yml 中的NRT相关配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">indices:</span></span><br><span class="line">  <span class="attr">memory:</span></span><br><span class="line">    <span class="attr">index_buffer_size:</span> <span class="string">&quot;10%&quot;</span>           <span class="comment"># 索引缓冲区大小（堆内存百分比）</span></span><br><span class="line">    <span class="attr">min_index_buffer_size:</span> <span class="string">&quot;48mb&quot;</span>      <span class="comment"># 最小索引缓冲区</span></span><br><span class="line">    <span class="attr">max_index_buffer_size:</span> <span class="string">&quot;512mb&quot;</span>     <span class="comment"># 最大索引缓冲区</span></span><br><span class="line">    </span><br><span class="line">  <span class="comment"># 刷新配置</span></span><br><span class="line">  <span class="attr">refresh_interval:</span> <span class="string">&quot;1s&quot;</span>               <span class="comment"># 默认刷新间隔</span></span><br><span class="line">  <span class="attr">max_refresh_listeners:</span> <span class="number">1000</span>          <span class="comment"># 最大刷新监听器数</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Translog配置</span></span><br><span class="line">  <span class="attr">translog:</span></span><br><span class="line">    <span class="attr">flush_threshold_size:</span> <span class="string">&quot;512mb&quot;</span>      <span class="comment"># 触发flush的大小</span></span><br><span class="line">    <span class="attr">sync_interval:</span> <span class="string">&quot;5s&quot;</span>                <span class="comment"># Translog刷盘间隔</span></span><br><span class="line">    <span class="attr">durability:</span> <span class="string">&quot;async&quot;</span>                <span class="comment"># 持久化模式</span></span><br><span class="line">    </span><br><span class="line">  <span class="comment"># 合并配置</span></span><br><span class="line">  <span class="attr">merge:</span></span><br><span class="line">    <span class="attr">scheduler:</span></span><br><span class="line">      <span class="attr">max_thread_count:</span> <span class="number">1</span>              <span class="comment"># 合并最大线程数</span></span><br><span class="line">      <span class="attr">max_merge_count:</span> <span class="number">6</span>               <span class="comment"># 最大合并数</span></span><br><span class="line">      </span><br><span class="line">  <span class="comment"># 搜索配置</span></span><br><span class="line">  <span class="attr">queries:</span></span><br><span class="line">    <span class="attr">cache:</span></span><br><span class="line">      <span class="attr">size:</span> <span class="string">&quot;10%&quot;</span>                      <span class="comment"># 查询缓存大小</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">fielddata:</span></span><br><span class="line">    <span class="attr">cache:</span></span><br><span class="line">      <span class="attr">size:</span> <span class="string">&quot;20%&quot;</span>                      <span class="comment"># 字段数据缓存大小</span></span><br></pre></td></tr></table></figure>
<p><strong>不同场景的优化配置</strong></p>
<p>场景1：写入密集型应用（日志收集）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">PUT</span> <span class="string">/logs/_settings</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;index&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;refresh_interval&quot;:</span> <span class="string">&quot;30s&quot;</span>,           <span class="string">//</span> <span class="string">延长刷新间隔，提高吞吐量</span></span><br><span class="line">    <span class="attr">&quot;translog&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;sync_interval&quot;:</span> <span class="string">&quot;30s&quot;</span>,           <span class="string">//</span> <span class="string">减少刷盘频率</span></span><br><span class="line">      <span class="attr">&quot;durability&quot;:</span> <span class="string">&quot;async&quot;</span>             <span class="string">//</span> <span class="string">异步持久化</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;:</span> <span class="number">0</span>,            <span class="string">//</span> <span class="string">写入时禁用副本</span></span><br><span class="line">    <span class="attr">&quot;merge&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;scheduler&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;max_thread_count&quot;:</span> <span class="number">2</span>           <span class="string">//</span> <span class="string">增加合并线程</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>场景2：搜索密集型应用（电商搜索）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">PUT</span> <span class="string">/products/_settings</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;index&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;refresh_interval&quot;:</span> <span class="string">&quot;5s&quot;</span>,           <span class="string">//</span> <span class="string">较短的刷新间隔，保证数据新鲜度</span></span><br><span class="line">    <span class="attr">&quot;translog&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;sync_interval&quot;:</span> <span class="string">&quot;1s&quot;</span>,           <span class="string">//</span> <span class="string">频繁刷盘保证数据安全</span></span><br><span class="line">      <span class="attr">&quot;durability&quot;:</span> <span class="string">&quot;request&quot;</span>          <span class="string">//</span> <span class="string">请求级别持久化</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;routing&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;allocation&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;enable&quot;:</span> <span class="string">&quot;primaries&quot;</span>          <span class="string">//</span> <span class="string">优化搜索路由</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;queries&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;cache&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;enabled&quot;:</span> <span class="literal">true</span>,               <span class="string">//</span> <span class="string">启用查询缓存</span></span><br><span class="line">        <span class="attr">&quot;size&quot;:</span> <span class="string">&quot;20%&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>场景3：混合型应用（订单系统）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">PUT</span> <span class="string">/orders/_settings</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;index&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;refresh_interval&quot;:</span> <span class="string">&quot;10s&quot;</span>,          <span class="string">//</span> <span class="string">平衡写入和搜索</span></span><br><span class="line">    <span class="attr">&quot;translog&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;sync_interval&quot;:</span> <span class="string">&quot;5s&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;durability&quot;:</span> <span class="string">&quot;async&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;flush_threshold_size&quot;:</span> <span class="string">&quot;1gb&quot;</span>    <span class="string">//</span> <span class="string">增大flush阈值</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;indexing&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;slowlog&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;threshold&quot;:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;index&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;warn&quot;:</span> <span class="string">&quot;5s&quot;</span>,              <span class="string">//</span> <span class="string">慢索引日志</span></span><br><span class="line">            <span class="attr">&quot;info&quot;:</span> <span class="string">&quot;2s&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;debug&quot;:</span> <span class="string">&quot;500ms&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;trace&quot;:</span> <span class="string">&quot;100ms&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;merge&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;policy&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;segments_per_tier&quot;:</span> <span class="number">10</span>,       <span class="string">//</span> <span class="string">优化合并策略</span></span><br><span class="line">        <span class="attr">&quot;max_merged_segment&quot;:</span> <span class="string">&quot;5gb&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="监控与调优">监控与调优</h3>
<p><strong>关键监控指标</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NRT相关监控API</span></span><br><span class="line">GET /_nodes/stats/indices?filter_path=**.refresh,**.indexing,**.translog</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;nodes&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;node-1&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;indices&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;refresh&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;total&quot;</span>: <span class="number">15000</span>,              <span class="comment">// 总刷新次数</span></span><br><span class="line">          <span class="string">&quot;total_time_in_millis&quot;</span>: <span class="number">120000</span>, <span class="comment">// 总刷新时间</span></span><br><span class="line">          <span class="string">&quot;listeners&quot;</span>: <span class="number">5</span>               <span class="comment">// 当前监听器数</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;indexing&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;index_total&quot;</span>: <span class="number">1000000</span>,      <span class="comment">// 总索引文档数</span></span><br><span class="line">          <span class="string">&quot;index_time_in_millis&quot;</span>: <span class="number">300000</span>,</span><br><span class="line">          <span class="string">&quot;index_current&quot;</span>: <span class="number">100</span>,        <span class="comment">// 当前正在索引的文档数</span></span><br><span class="line">          <span class="string">&quot;index_failed&quot;</span>: <span class="number">10</span>,</span><br><span class="line">          <span class="string">&quot;throttle_time_in_millis&quot;</span>: <span class="number">5000</span>  <span class="comment">// 索引限流时间</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;translog&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;operations&quot;</span>: <span class="number">25000</span>,         <span class="comment">// Translog中的操作数</span></span><br><span class="line">          <span class="string">&quot;size_in_bytes&quot;</span>: <span class="string">&quot;256mb&quot;</span>,    <span class="comment">// Translog大小</span></span><br><span class="line">          <span class="string">&quot;uncommitted_operations&quot;</span>: <span class="number">1500</span>,</span><br><span class="line">          <span class="string">&quot;uncommitted_size_in_bytes&quot;</span>: <span class="string">&quot;15mb&quot;</span>,</span><br><span class="line">          <span class="string">&quot;earliest_last_modified_age&quot;</span>: <span class="number">3000</span>  <span class="comment">// 最早未提交操作年龄</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>性能调优策略</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NRTOptimizer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. 刷新间隔动态调整</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">DynamicRefreshAdjuster</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">adjustRefreshInterval</span><span class="params">(IndexStats stats)</span> &#123;</span><br><span class="line">            <span class="type">double</span> <span class="variable">indexingRate</span> <span class="operator">=</span> stats.getIndexingRate();</span><br><span class="line">            <span class="type">double</span> <span class="variable">searchLatency</span> <span class="operator">=</span> stats.getSearchLatency();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 基于写入速率和搜索延迟动态调整</span></span><br><span class="line">            <span class="keyword">if</span> (indexingRate &gt; <span class="number">1000</span> &amp;&amp; searchLatency &lt; <span class="number">100</span>) &#123;</span><br><span class="line">                <span class="comment">// 高写入、低延迟搜索：延长刷新间隔</span></span><br><span class="line">                increaseRefreshInterval();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (searchLatency &gt; <span class="number">200</span>) &#123;</span><br><span class="line">                <span class="comment">// 搜索延迟高：缩短刷新间隔</span></span><br><span class="line">                decreaseRefreshInterval();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 缓冲区大小优化</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">BufferOptimizer</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">optimizeBufferSize</span><span class="params">(JVMStats jvmStats, IndexingStats idxStats)</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">heapSize</span> <span class="operator">=</span> jvmStats.getHeapMax();</span><br><span class="line">            <span class="type">long</span> <span class="variable">indexingRate</span> <span class="operator">=</span> idxStats.getIndexingRate();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 基于堆大小和索引速率调整缓冲区</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">recommendedBuffer</span> <span class="operator">=</span> Math.min(</span><br><span class="line">                heapSize / <span class="number">10</span>,           <span class="comment">// 堆的10%</span></span><br><span class="line">                indexingRate * <span class="number">1000</span>      <span class="comment">// 每秒索引量的1000倍</span></span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            setIndexBufferSize(recommendedBuffer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. Translog 优化</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">TranslogOptimizer</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">optimizeTranslog</span><span class="params">(TranslogStats tlogStats)</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">uncommittedSize</span> <span class="operator">=</span> tlogStats.getUncommittedSize();</span><br><span class="line">            <span class="type">long</span> <span class="variable">uncommittedOps</span> <span class="operator">=</span> tlogStats.getUncommittedOperations();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 基于未提交数据调整flush策略</span></span><br><span class="line">            <span class="keyword">if</span> (uncommittedSize &gt; <span class="number">512</span> * <span class="number">1024</span> * <span class="number">1024</span>) &#123;  <span class="comment">// 512MB</span></span><br><span class="line">                <span class="comment">// 触发主动flush</span></span><br><span class="line">                triggerFlush();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (uncommittedOps &gt; <span class="number">50000</span>) &#123;</span><br><span class="line">                <span class="comment">// 减少Translog sync间隔</span></span><br><span class="line">                decreaseSyncInterval();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 合并策略优化</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">MergeOptimizer</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">optimizeMergePolicy</span><span class="params">(IndexStats stats)</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">segmentCount</span> <span class="operator">=</span> stats.getSegmentCount();</span><br><span class="line">            <span class="type">double</span> <span class="variable">deleteRatio</span> <span class="operator">=</span> stats.getDeleteRatio();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (segmentCount &gt; <span class="number">50</span>) &#123;</span><br><span class="line">                <span class="comment">// 分段过多，触发合并</span></span><br><span class="line">                triggerMerge();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (deleteRatio &gt; <span class="number">0.3</span>) &#123;</span><br><span class="line">                <span class="comment">// 删除文档多，调整合并策略</span></span><br><span class="line">                adjustMergeForDeletes();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="高级特性">高级特性</h3>
<h4 id="等待刷新-Refresh-Wait">等待刷新 (Refresh Wait)</h4>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 写入时等待刷新</span></span><br><span class="line">POST /orders/_doc?refresh=wait_for</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;order_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;12345&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pending&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 批量操作等待刷新</span></span><br><span class="line">POST /_bulk?refresh=wait_for</span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;orders&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span> <span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;order_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;paid&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;orders&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span> <span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;order_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shipped&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 更新设置启用等待刷新</span></span><br><span class="line">PUT /orders/_settings</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_refresh_listeners&quot;</span><span class="punctuation">:</span> <span class="number">1000</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="序列号与版本控制"><strong>序列号与版本控制</strong></h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SequenceNumberManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 全局序列号管理</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">AtomicLong</span> <span class="variable">globalSeqNo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Long&gt; localCheckpoints = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Long&gt; globalCheckpoints = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 分配序列号</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">assignSeqNo</span><span class="params">(String index, String id)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">seqNo</span> <span class="operator">=</span> globalSeqNo.incrementAndGet();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新本地检查点</span></span><br><span class="line">        localCheckpoints.compute(index, (k, v) -&gt; </span><br><span class="line">            v == <span class="literal">null</span> ? seqNo : Math.max(v, seqNo)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> seqNo;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 等待操作可见</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">waitForSeqNo</span><span class="params">(String index, <span class="type">long</span> targetSeqNo)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">timeout</span> <span class="operator">=</span> <span class="number">30000</span>;  <span class="comment">// 30秒超时</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (System.currentTimeMillis() - startTime &lt; timeout) &#123;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">globalCheckpoint</span> <span class="operator">=</span> globalCheckpoints.get(index);</span><br><span class="line">            <span class="keyword">if</span> (globalCheckpoint != <span class="literal">null</span> &amp;&amp; globalCheckpoint &gt;= targetSeqNo) &#123;</span><br><span class="line">                <span class="keyword">return</span>;  <span class="comment">// 操作已全局可见</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="type">Long</span> <span class="variable">localCheckpoint</span> <span class="operator">=</span> localCheckpoints.get(index);</span><br><span class="line">            <span class="keyword">if</span> (localCheckpoint != <span class="literal">null</span> &amp;&amp; localCheckpoint &gt;= targetSeqNo) &#123;</span><br><span class="line">                <span class="comment">// 本地可见，等待刷新</span></span><br><span class="line">                waitForRefresh();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 等待一段时间再检查</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TimeoutException</span>(<span class="string">&quot;Wait for seqno timeout&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="分片机制">分片机制</h2>
<pre class="mermaid">flowchart TD
    Start[分片分配决策] --> A{分配场景}
    
    A -->|新索引创建| B[初始分配]
    A -->|节点故障| C[故障恢复]
    A -->|节点加入| D[集群扩容]
    A -->|分片不均| E[重新平衡]
    
    subgraph B [初始分配]
        B1[计算分片数量]
        B2[选择主分片节点]
        B3[选择副本节点<br/>确保不同机架]
        B4[创建分片]
    end
    
    subgraph C [故障恢复]
        C1[检测节点离线]
        C2[副本提升为主]
        C3[在新节点创建副本]
        C4[数据同步]
    end
    
    subgraph D [集群扩容]
        D1[新节点加入]
        D2[重新评估负载]
        D3[迁移部分分片]
        D4[保持负载均衡]
    end
    
    subgraph E [重新平衡]
        E1[监控分片分布]
        E2[计算不平衡度]
        E3{超过阈值?}
        E3 -->|是| E4[计划迁移]
        E3 -->|否| E5[保持现状]
        E4 --> E6[执行迁移]
    end
    
    B4 --> F[分配完成]
    C4 --> F
    D4 --> F
    E6 --> F
    E5 --> F
    
    F --> Monitor[持续监控]
    Monitor --> Start</pre>
<h3 id="分片分配策略">分片分配策略</h3>
<p>分片分配考虑因素</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>磁盘容量</p>
</li>
<li class="lvl-2">
<p>内存使用</p>
</li>
<li class="lvl-2">
<p>CPU负载</p>
</li>
<li class="lvl-2">
<p>网络拓扑</p>
</li>
<li class="lvl-2">
<p>副本放置规则（避免单点故障）</p>
</li>
</ul>
<h3 id="分片重新平衡">分片重新平衡</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>触发条件</strong>：节点加入/离开、分片不均</p>
</li>
<li class="lvl-2">
<p><strong>平衡策略</strong>：基于分片数量、磁盘使用率</p>
</li>
<li class="lvl-2">
<p><strong>恢复过程</strong>：从主分片或副本复制数据</p>
</li>
</ul>
<h2 id="数据流程">数据流程</h2>
<h3 id="写入流程">写入流程</h3>
<blockquote>
<ol>
<li class="lvl-3">
<p>客户端请求 <strong>协调节点</strong></p>
</li>
<li class="lvl-3">
<p>协调节点，<strong>路由计算</strong>: shard = hash(document_id) % num_primary_shards</p>
</li>
<li class="lvl-3">
<p>转发到对应<strong>主分片节点</strong></p>
</li>
<li class="lvl-3">
<p>写入操作：</p>
<ul class="lvl-3">
<li class="lvl-5">写入内存<strong>缓冲区</strong></li>
<li class="lvl-5">追加到<strong>Translog</strong>（用于崩溃恢复）</li>
<li class="lvl-5"><strong>定期刷新</strong>（默认1秒）创建新Segment</li>
</ul>
</li>
<li class="lvl-3">
<p>并行复制到<strong>副本分片</strong></p>
</li>
<li class="lvl-3">
<p>返回客户端确认</p>
</li>
</ol>
</blockquote>
<p>写入流程序列图：</p>
<pre class="mermaid">sequenceDiagram
    participant C as 客户端
    participant CO as 协调节点
    participant PN as 主分片节点
    participant RN as 副本节点
    participant L as Lucene
    
    Note over C,L: 写入文档流程
    
    C->>CO: 1. 发送写入请求
    CO->>CO: 2. 计算路由<br/>shard = hash(id) % shard_count
    CO->>PN: 3. 转发到主分片节点
    
    Note over PN: 主分片处理
    PN->>PN: 4. 验证文档结构
    PN->>L: 5. 写入内存缓冲区
    PN->>PN: 6. 写入Translog
    PN->>RN: 7. 并行复制到副本
    
    Note over RN: 副本处理
    RN->>RN: 8. 验证文档
    RN->>RN: 9. 写入本地Translog
    
    RN-->>PN: 10. 副本确认
    PN-->>CO: 11. 主分片确认
    CO-->>C: 12. 返回客户端成功
    
    Note over PN,L: 后台异步刷新
    par 刷新到磁盘
        PN->>L: 定时刷新(默认1s)<br/>创建新Segment
    and Translog持久化
        PN->>PN: 定期Flush<br/>清空Translog
    end</pre>
<h3 id="搜索流程">搜索流程</h3>
<pre class="mermaid">flowchart TD
    Start[客户端搜索请求] --> A[协调节点接收]
    
    subgraph B [查询阶段 Query Phase]
        B1[解析查询DSL]
        B2[创建查询计划]
        B3[广播查询到所有相关分片]
    end
    
    A --> B1
    
    subgraph C [分片本地执行]
        direction LR
        C1[分片1<br/>执行查询]
        C2[分片2<br/>执行查询]
        C3[分片N<br/>执行查询]
        
        C1 --> C1a[本地排序<br/>返回Top-K ID+Score]
        C2 --> C2a[本地排序<br/>返回Top-K ID+Score]
        C3 --> C3a[本地排序<br/>返回Top-K ID+Score]
    end
    
    B3 --> C
    
    subgraph D [合并结果]
        D1[收集所有分片结果]
        D2[全局排序合并]
        D3[生成最终Top-M列表]
    end
    
    C1a --> D1
    C2a --> D1
    C3a --> D1
    D1 --> D2 --> D3
    
    subgraph E [取回阶段 Fetch Phase]
        E1[根据ID向对应分片<br/>请求完整文档]
        E2[分片返回文档内容]
        E3[组装最终结果]
    end
    
    D3 --> E1 --> E2 --> E3
    
    E3 --> F[返回客户端结果]</pre>
<p><strong>分布式查询执行</strong></p>
<pre class="mermaid">graph TB
    subgraph "分布式查询执行计划"
        CO[协调节点]
        
        subgraph "查询树优化"
            QT[查询树优化器]
            PP[分区计划器]
            MP[合并计划器]
            
            QT --> PP --> MP
        end
        
        subgraph "分片查询调度"
            SQ1[分片查询器1]
            SQ2[分片查询器2]
            SQ3[分片查询器3]
            
            subgraph "查询下推优化"
                QP1[谓词下推]
                AP1[聚合下推]
                SP1[排序下推]
            end
        end
        
        CO --> QT
        MP --> SQ1
        MP --> SQ2
        MP --> SQ3
        
        SQ1 --> QP1 --> AP1 --> SP1
    end
    
    subgraph "结果流式处理"
        RS1[结果流1]
        RS2[结果流2]
        RS3[结果流3]
        
        MC[流式合并器]
        SO[流式排序器]
        FO[最终输出]
        
        RS1 --> MC
        RS2 --> MC
        RS3 --> MC
        MC --> SO --> FO --> CO
    end
    
    SQ1 --> RS1
    SQ2 --> RS2
    SQ3 --> RS3</pre>
<h4 id="查询阶段">查询阶段</h4>
<p><strong>查询阶段整体架构</strong></p>
<pre class="mermaid">graph TB
    subgraph "查询请求流程"
        C[客户端]
        CO[协调节点]
        
        subgraph "查询解析与优化"
            QP[查询解析器]
            QR[查询重写器]
            QO[查询优化器]
            EP[执行计划生成器]
            
            QP --> QR --> QO --> EP
        end
        
        subgraph "分片查询执行"
            SH1[分片1]
            SH2[分片2]
            SH3[分片N]
            
            subgraph "分片1内部"
                SQ1[分片查询器]
                SM1[评分模型]
                RC1[结果收集器]
            end
            
            subgraph "分片2内部"
                SQ2[分片查询器]
                SM2[评分模型]
                RC2[结果收集器]
            end
        end
        
        C --> CO
        CO --> QP
        EP --> SH1
        EP --> SH2
        EP --> SH3
        
        SH1 --> SQ1 --> SM1 --> RC1
        SH2 --> SQ2 --> SM2 --> RC2
    end
    
    subgraph "查询类型处理"
        QT1[布尔查询]
        QT2[范围查询]
        QT3[全文查询]
        QT4[短语查询]
        QT5[过滤器]
        
        QT1 --> DP1[倒排列表交集]
        QT2 --> DP2[BKD树搜索]
        QT3 --> DP3[文本分析+评分]
        QT4 --> DP4[位置信息匹配]
        QT5 --> DP5[位图过滤]
    end
    
    SQ1 --> QT1
    SQ1 --> QT2
    SQ1 --> QT3
    SQ1 --> QT4
    SQ1 --> QT5</pre>
<p><strong>查询阶段详细执行流程</strong></p>
<blockquote>
<ol>
<li class="lvl-3">
<p>客户端 → 协调节点</p>
</li>
<li class="lvl-3">
<p>协调节点广播查询到所有相关分片</p>
</li>
<li class="lvl-3">
<p>每个分片本地执行查询，返回Top-K结果（文档ID+评分）</p>
</li>
<li class="lvl-3">
<p>协调节点合并结果，生成全局排序列表</p>
</li>
</ol>
</blockquote>
<pre class="mermaid">sequenceDiagram
    participant C as 客户端
    participant CO as 协调节点
    participant SH1 as 分片1 (主)
    participant SH2 as 分片2 (副)
    participant SH3 as 分片3 (副)
    participant IQ as IndexSearcher
    participant W as Weight计算
    participant SC as Scorer评分
    participant TC as TopDocs收集器
    
    Note over C,TC: 阶段1: 查询准备
    
    C->>CO: 1. 发送搜索请求
    CO->>CO: 2. 解析查询DSL
    CO->>CO: 3. 构建查询执行计划
    
    Note over C,TC: 阶段2: 分片查询并行执行
    
    par 分片1查询
        CO->>SH1: 4. 转发查询请求
        SH1->>IQ: 5. 获取IndexSearcher
        IQ->>W: 6. 创建Weight对象
        W->>SC: 7. 创建Scorer对象
        SC->>TC: 8. 遍历文档并评分
        TC->>SH1: 9. 返回Top-K结果
        SH1->>CO: 10. 返回分片结果
    and 分片2查询
        CO->>SH2: 并行查询
        SH2->>CO: 返回分片结果
    and 分片3查询
        CO->>SH3: 并行查询
        SH3->>CO: 返回分片结果
    end
    
    Note over C,TC: 阶段3: 结果合并
    
    CO->>CO: 11. 收集所有分片结果
    CO->>CO: 12. 全局排序合并
    CO->>CO: 13. 生成最终Top-M列表
    
    CO-->>C: 14. 返回查询阶段结果<br/>（文档ID + 评分）
    
    Note over C,TC: 查询阶段完成，准备取回阶段</pre>
<h4 id="取回阶段">取回阶段</h4>
<p><strong>取回阶段整体架构</strong></p>
<pre class="mermaid">graph TB
    subgraph "取回阶段流程"
        CO[协调节点]
        
        subgraph "取回计划生成"
            FP[取回规划器]
            DS[数据源选择器]
            SB[分数重新计算器]
            AG[聚合数据收集器]
            
            FP --> DS --> SB --> AG
        end
        
        subgraph "并行数据取回"
            SH1[分片1]
            SH2[分片2]
            SH3[分片3]
            
            subgraph "分片1取回"
                FD1[字段读取器]
                HV1[高亮器]
                SF1[源过滤器]
                EX1[脚本执行器]
            end
            
            subgraph "分片2取回"
                FD2[字段读取器]
                HV2[高亮器]
                SF2[源过滤器]
                EX2[脚本执行器]
            end
        end
        
        CO --> FP
        DS --> SH1
        DS --> SH2
        DS --> SH3
        
        SH1 --> FD1 --> HV1 --> SF1 --> EX1
        SH2 --> FD2 --> HV2 --> SF2 --> EX2
    end
    
    subgraph "字段数据源"
        STF[存储字段 Storage Fields]
        DV[文档值 DocValues]
        SRC[_source字段]
        TV[词向量 Term Vectors]
        SCT[脚本字段 Script Fields]
        
        STF --> FD1
        DV --> FD1
        SRC --> FD1
        TV --> FD1
        SCT --> EX1
    end
    
    subgraph "结果后处理"
        MR[结果合并器]
        SR[分数重新排序]
        FG[最终格式化]
        PC[分页裁剪]
        
        SH1 --> MR
        SH2 --> MR
        SH3 --> MR
        MR --> SR --> FG --> PC --> CO
    end</pre>
<p><strong>取回阶段详细执行流程</strong></p>
<blockquote>
<ol>
<li class="lvl-3">
<p>协调节点向相关分片请求完整文档</p>
</li>
<li class="lvl-3">
<p>分片返回文档内容</p>
</li>
<li class="lvl-3">
<p>协调节点组装最终结果返回客户端</p>
</li>
</ol>
</blockquote>
<pre class="mermaid">sequenceDiagram
    participant C as 客户端
    participant CO as 协调节点
    participant SH1 as 分片1
    participant SH2 as 分片2
    participant SH3 as 分片3
    participant FS as 字段读取器
    participant HL as 高亮器
    participant AG as 聚合器
    participant SC as 脚本引擎
    
    Note over C,SC: 阶段1: 取回请求准备
    
    C->>CO: 1. 发送取回请求
    CO->>CO: 2. 分析文档分布
    CO->>CO: 3. 构建取回计划
    
    Note over C,SC: 阶段2: 并行文档取回
    
    par 分片1取回
        CO->>SH1: 4. 请求文档数据
        SH1->>FS: 5. 读取存储字段
        FS->>FS: 6. 应用_source过滤
        
        alt 需要高亮
            FS->>HL: 7. 执行高亮处理
            HL->>SH1: 8. 返回高亮结果
        end
        
        alt 需要脚本字段
            FS->>SC: 9. 执行脚本计算
            SC->>SH1: 10. 返回脚本字段
        end
        
        SH1->>CO: 11. 返回完整文档
    and 分片2取回
        CO->>SH2: 并行取回
        SH2->>CO: 返回文档数据
    and 分片3取回
        CO->>SH3: 并行取回
        SH3->>CO: 返回文档数据
    end
    
    Note over C,SC: 阶段3: 聚合数据处理（如需要）
    
    CO->>AG: 12. 执行全局聚合
    AG->>CO: 13. 返回聚合结果
    
    Note over C,SC: 阶段4: 最终结果构建
    
    CO->>CO: 14. 合并所有文档数据
    CO->>CO: 15. 重新计算分数（如需要）
    CO->>CO: 16. 应用排序和分页
    
    CO-->>C: 17. 返回最终搜索结果</pre>
<h3 id="缓存机制">缓存机制</h3>
<ul class="lvl-0">
<li class="lvl-4">
<p>Query Cache: 过滤查询结果缓存</p>
</li>
<li class="lvl-4">
<p>Request Cache: 查询请求缓存</p>
</li>
<li class="lvl-4">
<p>Field Data Cache: 字段数据缓存（排序/聚合）</p>
</li>
<li class="lvl-4">
<p>Page Cache: 操作系统文件缓存</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># elasticsearch.yml 缓存配置</span></span><br><span class="line"><span class="attr">indices:</span></span><br><span class="line">  <span class="attr">requests:</span></span><br><span class="line">    <span class="attr">cache:</span></span><br><span class="line">      <span class="attr">size:</span> <span class="string">&quot;2%&quot;</span>                <span class="comment"># 堆内存的2%</span></span><br><span class="line">      <span class="attr">expire:</span> <span class="literal">null</span>              <span class="comment"># 不过期</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">fielddata:</span></span><br><span class="line">    <span class="attr">cache:</span></span><br><span class="line">      <span class="attr">size:</span> <span class="string">&quot;10%&quot;</span>               <span class="comment"># 堆内存的10%</span></span><br><span class="line">      <span class="attr">expire:</span> <span class="string">&quot;6h&quot;</span>              <span class="comment"># 6小时过期</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">queries:</span></span><br><span class="line">    <span class="attr">cache:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">size:</span> <span class="string">&quot;5%&quot;</span>                <span class="comment"># 堆内存的5%</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">memory:</span></span><br><span class="line">    <span class="attr">index_buffer_size:</span> <span class="string">&quot;10%&quot;</span>    <span class="comment"># 索引写入缓冲区</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 索引级别缓存设置</span></span><br><span class="line"><span class="string">PUT</span> <span class="string">/my_index/_settings</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;index.queries.cache.enabled&quot;:</span> <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;index.fielddata.cache.expire&quot;:</span> <span class="string">&quot;1h&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;index.requests.cache.enable&quot;:</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre class="mermaid">graph TB
    subgraph "查询请求处理"
        Q[查询请求] --> P[查询解析]
        P --> QP[查询规划]
    end
    
    subgraph "缓存层级"
        RC[请求缓存<br/>Request Cache]
        QC[查询缓存<br/>Query Cache]
        FDC[字段数据缓存<br/>FieldData Cache]
        PC[页缓存<br/>Page Cache/OS Cache]
        DC[文档值缓存<br/>DocValues Cache]
        
        QC --> FDC
        FDC --> DC
    end
    
    QP --> RC
    
    subgraph "缓存命中流程"
        RC_H{RC命中?}
        RC_H -->|是| RC_R[返回缓存结果]
        RC_H -->|否| QC_H{QC命中?}
        
        QC_H -->|是| QC_R[使用缓存过滤结果]
        QC_H -->|否| FDC_H{FDC命中?}
        
        FDC_H -->|是| FDC_R[使用缓存字段数据]
        FDC_H -->|否| PC_H{PC命中?}
        
        PC_H -->|是| PC_R[内存读取Segment]
        PC_H -->|否| DISK[磁盘读取]
    end
    
    RC_R --> Result[返回结果]
    QC_R --> Result
    FDC_R --> Result
    PC_R --> Result
    DISK --> Result
    
    Result --> Update[更新缓存]
    Update --> RC
    Update --> QC
    Update --> FDC</pre>
<p><strong>多级缓存架构</strong></p>
<pre class="mermaid">graph TB
    subgraph "查询请求"
        Q[查询请求] --> P[查询解析器]
    end
    
    subgraph "L1缓存: 节点级"
        RC[请求缓存 RequestCache]
        QC[查询缓存 QueryCache]
        FDC[字段数据缓存 FieldData Cache]
    end
    
    subgraph "L2缓存: 分段级"
        PC[页缓存 Page Cache]
        BC[缓冲区缓存 Buffer Cache]
    end
    
    subgraph "L3缓存: 磁盘级"
        DC[磁盘缓存 Disk Cache]
        SC[系统缓存 System Cache]
    end
    
    subgraph "内存层次"
        H[热点数据 Hot Data]
        W[温数据 Warm Data]
        C[冷数据 Cold Data]
    end
    
    P --> RC
    RC --> QC
    QC --> FDC
    FDC --> PC
    PC --> BC
    BC --> DC
    DC --> SC
    
    H --> RC
    W --> QC
    C --> FDC
    
    subgraph "缓存失效策略"
        LRU[LRU 最近最少使用]
        LFU[LFU 最不经常使用]
        FIFO[FIFO 先进先出]
        TTL[基于时间失效]
    end
    
    RC --> LRU
    QC --> LFU
    FDC --> TTL
    PC --> FIFO
    
    subgraph "缓存统计"
        STAT1[命中率统计]
        STAT2[缓存大小监控]
        STAT3[回收频率]
        STAT4[淘汰策略效果]
    end
    
    LRU --> STAT1
    LFU --> STAT2
    FIFO --> STAT3
    TTL --> STAT4</pre>
<h2 id="容错与高可用">容错与高可用</h2>
<h3 id="故障检测与恢复">故障检测与恢复</h3>
<h4 id="集群故障恢复">集群故障恢复</h4>
<pre class="mermaid">sequenceDiagram
    participant M as 主节点
    participant N1 as 节点1
    participant N2 as 节点2
    participant N3 as 节点3
    
    Note over M,N3: 正常状态
    M->>N1: 心跳检测
    M->>N2: 心跳检测
    M->>N3: 心跳检测
    
    Note over N2: 节点2故障
    N2--x M: 心跳超时
    
    Note over M: 检测到故障
    rect rgb(255, 200, 200)
        M->>M: 1. 更新集群状态
        M->>M: 2. 重新路由分片
        
        par 副本提升
            M->>N1: 3. 提升副本为主分片
            N1-->>M: 确认提升
        and 重新分配
            M->>N3: 4. 创建新副本
            N3-->>M: 副本创建中
        end
    end
    
    Note over N3: 数据恢复
    N3->>N1: 5. 从主分片复制数据
    N1-->>N3: 传输分片数据
    N3->>N3: 6. 构建本地索引
    
    N3-->>M: 7. 恢复完成
    M->>M: 8. 更新集群状态为Green
    
    Note over N2: 节点恢复
    N2->>M: 9. 重新加入集群
    M->>M: 10. 重新平衡分片
    M->>N1: 11. 迁移部分分片到N2
    M->>N3: 12. 迁移部分分片到N2
    
    Note over M,N3: 集群恢复平衡状态</pre>
<h4 id="NRT-故障恢复">NRT 故障恢复</h4>
<pre class="mermaid">sequenceDiagram
    participant App as 应用程序
    participant ES as Elasticsearch节点
    participant Translog as Translog
    participant Segment as Segment文件
    participant Replica as 副本节点
    
    Note over App,Replica: 正常写入流程
    
    App->>ES: 1. 写入文档
    ES->>Translog: 2. 记录操作
    ES->>Segment: 3. 内存写入
    ES->>Replica: 4. 同步副本
    
    Note over ES,Replica: 节点故障场景
    
    rect rgb(200, 150, 150)
        Note over ES: 节点崩溃
        ES--x App: 连接中断
        
        App->>Replica: 5. 重试写入其他节点
        Replica->>Replica: 6. 提升为主分片
        
        Note over ES: 节点恢复
        ES->>ES: 7. 重启恢复
        
        ES->>Translog: 8. 读取最后提交点
        ES->>Translog: 9. 扫描未提交操作
        
        par 数据恢复
            ES->>Segment: 10. 重放Translog操作
        and 状态同步
            ES->>Replica: 11. 同步最新状态
        end
        
        ES->>App: 12. 恢复完成，可继续写入
    end
    
    Note over App,Replica: NRT保证
    
    App->>ES: 13. 新写入请求
    ES->>Translog: 14. 确保持久化
    ES->>Segment: 15. 快速刷新
    ES-->>App: 16. 近实时可见</pre>
<h3 id="数据一致性">数据一致性</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>写入一致性</strong>：quorum机制（多数副本确认）</p>
</li>
<li class="lvl-2">
<p><strong>读取一致性</strong>：primary/replica选择策略</p>
</li>
<li class="lvl-2">
<p><strong>版本控制</strong>：乐观锁并发控制</p>
</li>
</ul>
<!-- flag of hidden posts --></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://pengline.github.io">余一叶知秋尽</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://pengline.github.io/2025/01/ae10ad7f092a49678174f2f4f0010291/">https://pengline.github.io/2025/01/ae10ad7f092a49678174f2f4f0010291/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://pengline.github.io" target="_blank">余一叶知秋尽</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ES-%E5%88%86%E7%89%87%E5%8E%9F%E7%90%86/">ES 分片原理</a><a class="post-meta__tags" href="/tags/ES-Routing/">ES Routing</a><a class="post-meta__tags" href="/tags/ES-Pipeline-Routing/">ES Pipeline Routing</a><a class="post-meta__tags" href="/tags/ES-%E8%B7%AF%E7%94%B1%E5%88%86%E7%89%87/">ES 路由分片</a><a class="post-meta__tags" href="/tags/ES-%E8%87%AA%E5%8A%A8%E8%B7%AF%E7%94%B1/">ES 自动路由</a></div><div class="post-share"><div class="social-share" data-image="/img/essay/small103754rLdNH1758681474.webp" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/12/993e8895ae2e46ca8c4d744b312d1491/" title="ES 手动路由和自动路由的实现过程"><img class="cover" src= "/img/20241215205335173426721579192.webp" data-lazy-src="/img/essay/1755144740598175514474060.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-12-20</div><div class="info-item-2">ES 手动路由和自动路由的实现过程</div></div><div class="info-2"><div class="info-item-1">Routing 决定文档存在哪个分片，Pipeline 在文档入库前可以自动处理数据，能实现自动、智能的路由策略。</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8"><span class="toc-number">1.</span> <span class="toc-text">数据存储</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.1.</span> <span class="toc-text">数据结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="toc-number">1.2.</span> <span class="toc-text">倒排索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%AE%B5%E5%AD%98%E5%82%A8"><span class="toc-number">1.3.</span> <span class="toc-text">分段存储</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%97%A5%E5%BF%97%EF%BC%88Translog%EF%BC%89"><span class="toc-number">1.4.</span> <span class="toc-text">事务日志（Translog）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%91%E5%AE%9E%E6%97%B6%E6%90%9C%E7%B4%A2-NRT"><span class="toc-number">2.</span> <span class="toc-text">近实时搜索 (NRT)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E5%86%99%E5%85%A5%E4%B8%8E%E5%88%B7%E6%96%B0"><span class="toc-number">2.1.</span> <span class="toc-text">文档写入与刷新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IndexSearcher-Reader"><span class="toc-number">2.2.</span> <span class="toc-text">IndexSearcher + Reader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%8E%E8%B0%83%E4%BC%98"><span class="toc-number">2.3.</span> <span class="toc-text">配置与调优</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E4%B8%8E%E8%B0%83%E4%BC%98"><span class="toc-number">2.4.</span> <span class="toc-text">监控与调优</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7"><span class="toc-number">2.5.</span> <span class="toc-text">高级特性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%89%E5%BE%85%E5%88%B7%E6%96%B0-Refresh-Wait"><span class="toc-number">2.5.1.</span> <span class="toc-text">等待刷新 (Refresh Wait)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8F%B7%E4%B8%8E%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6"><span class="toc-number">2.5.2.</span> <span class="toc-text">序列号与版本控制</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E7%89%87%E6%9C%BA%E5%88%B6"><span class="toc-number">3.</span> <span class="toc-text">分片机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%89%87%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5"><span class="toc-number">3.1.</span> <span class="toc-text">分片分配策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%89%87%E9%87%8D%E6%96%B0%E5%B9%B3%E8%A1%A1"><span class="toc-number">3.2.</span> <span class="toc-text">分片重新平衡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B"><span class="toc-number">4.</span> <span class="toc-text">数据流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B"><span class="toc-number">4.1.</span> <span class="toc-text">写入流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E6%B5%81%E7%A8%8B"><span class="toc-number">4.2.</span> <span class="toc-text">搜索流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E9%98%B6%E6%AE%B5"><span class="toc-number">4.2.1.</span> <span class="toc-text">查询阶段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%96%E5%9B%9E%E9%98%B6%E6%AE%B5"><span class="toc-number">4.2.2.</span> <span class="toc-text">取回阶段</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6"><span class="toc-number">4.3.</span> <span class="toc-text">缓存机制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E9%94%99%E4%B8%8E%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">5.</span> <span class="toc-text">容错与高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E6%A3%80%E6%B5%8B%E4%B8%8E%E6%81%A2%E5%A4%8D"><span class="toc-number">5.1.</span> <span class="toc-text">故障检测与恢复</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%95%85%E9%9A%9C%E6%81%A2%E5%A4%8D"><span class="toc-number">5.1.1.</span> <span class="toc-text">集群故障恢复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NRT-%E6%95%85%E9%9A%9C%E6%81%A2%E5%A4%8D"><span class="toc-number">5.1.2.</span> <span class="toc-text">NRT 故障恢复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">5.2.</span> <span class="toc-text">数据一致性</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 - 2026 By 余一叶知秋尽</span><span class="framework-info"><span>框架 </span><a href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.3</a></span></div><div class="footer_custom_text"><p><a style="margin-inline:5px"target="_blank"href="https://github.com/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Hosted-Github-brightgreen?style=flat&logo=GitHub"title="本站项目由Gtihub托管"></a><a style="margin-inline:5px"target="_blank"href="https://hexo.io/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo"title="博客框架为Hexo"></a><a style="margin-inline:5px"target="_blank"href="https://butterfly.js.org/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?logoColor=white&style=flat&logo=buefy"title="主题采用butterfly"></a><a style="margin-inline:5px"target="_blank"href="https://giscus.app/zh-CN/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Comment-Giscus-2873df?logoColor=white&style=flat&logo=git"title="评论系统为Giscus"></a><a style="margin-inline:5px"target="_blank"href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris"title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div><script src="https://unpkg.com/mermaid@11.5.0/dist/mermaid.min.js"></script><script>if (window.mermaid) {
  mermaid.initialize({
    startOnLoad: true,
    theme: '[object Object]',
    securityLevel: 'loose',
    flowchart: { useMaxWidth: true, htmlLabels: true }
  });
}</script></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="日间和夜间模式切换"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getGiscusTheme = theme => theme === 'dark' ? 'dark' : 'light'

  const createScriptElement = config => {
    const ele = document.createElement('script')
    Object.entries(config).forEach(([key, value]) => {
      ele.setAttribute(key, value)
    })
    return ele
  }

  const loadGiscus = (el = document, key) => {
    const mappingConfig = isShuoshuo
      ? { 'data-mapping': 'specific', 'data-term': key }
      : { 'data-mapping': (option && option['data-mapping']) || 'pathname' }

    const giscusConfig = {
      src: 'https://giscus.app/client.js',
      'data-repo': 'pengline/pengline.github.io',
      'data-repo-id': 'R_kgDOPqG50w',
      'data-category-id': 'DIC_kwDOPqG5084Cu_K9',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      'data-lang': 'zh-CN',
      'data-input-position': 'top',
      async: true,
      ...option,
      ...mappingConfig
    }

    const scriptElement = createScriptElement(giscusConfig)

    el.querySelector('#giscus-wrap').appendChild(scriptElement)

    if (isShuoshuo) {
      window.shuoshuoComment.destroyGiscus = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }
  }

  const changeGiscusTheme = theme => {
    const iframe = document.querySelector('#giscus-wrap iframe')
    if (iframe) {
      const message = {
        giscus: {
          setConfig: {
            theme: getGiscusTheme(theme),
            lang: 'zh-CN'
          }
        }
      }
      iframe.contentWindow.postMessage(message, 'https://giscus.app')
    }
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if (isShuoshuo) {
    'Giscus' === 'Giscus'
      ? window.shuoshuoComment = { loadComment: loadGiscus }
      : window.loadOtherComment = loadGiscus
    return
  }

  if ('Giscus' === 'Giscus' || !false) {
    if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment = loadGiscus
  }
})()</script></div><script src="/js/custom/sun_moon.js" async></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>