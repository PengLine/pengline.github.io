<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>剧本分镜智能体架构设计与实现（MVP版） | 余一叶知秋尽</title><meta name="author" content="余一叶知秋尽"><meta name="copyright" content="余一叶知秋尽"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="该工具将自然语言剧本自动拆分为多个N秒长度的短视频片段脚本，以适用于 AI 视频生成模型，可直接用于“文生视频”。">
<meta property="og:type" content="article">
<meta property="og:title" content="剧本分镜智能体架构设计与实现（MVP版）">
<meta property="og:url" content="https://pengline.github.io/2025/10/0194020a663c408fb500dd7532349519/index.html">
<meta property="og:site_name" content="余一叶知秋尽">
<meta property="og:description" content="该工具将自然语言剧本自动拆分为多个N秒长度的短视频片段脚本，以适用于 AI 视频生成模型，可直接用于“文生视频”。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pengline.github.io/img/essay/1634204470553163420447079.webp">
<meta property="article:published_time" content="2025-10-28T16:00:00.000Z">
<meta property="article:modified_time" content="2026-01-28T15:17:48.804Z">
<meta property="article:author" content="余一叶知秋尽">
<meta property="article:tag" content="LangGraph流程编排">
<meta property="article:tag" content="长剧本拆分">
<meta property="article:tag" content="长剧本分镜">
<meta property="article:tag" content="长剧本视频生成">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pengline.github.io/img/essay/1634204470553163420447079.webp"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "剧本分镜智能体架构设计与实现（MVP版）",
  "url": "https://pengline.github.io/2025/10/0194020a663c408fb500dd7532349519/",
  "image": "https://pengline.github.io/img/essay/1634204470553163420447079.webp",
  "datePublished": "2025-10-28T16:00:00.000Z",
  "dateModified": "2026-01-28T15:17:48.804Z",
  "author": [
    {
      "@type": "Person",
      "name": "余一叶知秋尽",
      "url": "https://pengline.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://pengline.github.io/2025/10/0194020a663c408fb500dd7532349519/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":30,"languages":{"author":"作者: 余一叶知秋尽","link":"链接: ","source":"来源: 余一叶知秋尽","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '剧本分镜智能体架构设计与实现（MVP版）',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/font.css"><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="余一叶知秋尽" type="application/atom+xml">
</head><body><div id="web_bg" style="background: LightGray;"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="/img/butterfly-icon.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">52</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">236</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">41</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list-ul"></i><span> 归档</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类别</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签集</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-outdent"></i><span> AI</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/ai/aigc/"><i class="fa-fw fas fa-cubes"></i><span> AIGC 创意平台</span></a></li><li><a class="site-page child" href="/ai/agent/medical/"><i class="fa-fw fas fa-medkit"></i><span> 医疗问答Agent</span></a></li><li><a class="site-page child" href="https://github.com/HengLine/ai-stocks-agent"><i class="fa-fw fas fa-line-chart"></i><span> 股票分析Agent</span></a></li><li><a class="site-page child" href="/ai/agent/video/"><i class="fa-fw fas fa-cut"></i><span> 视频混剪Agent</span></a></li><li><a class="site-page child" href="https://github.com/HengLine/video-shot-agent"><i class="fa-fw fas fa-file-video"></i><span> 剧本分镜Agent</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list-ol"></i><span> 项目</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/turnkey/smart-city"><i class="fa-fw fas fa-building"></i><span> 智慧城市（IOT）</span></a></li><li><a class="site-page child" href="/turnkey/smart-security"><i class="fa-fw fas fa-check-circle"></i><span> 智慧安检（IOT）</span></a></li><li><a class="site-page child" href="/turnkey/tms"><i class="fa-fw fas fa-truck"></i><span> 物流运输（TMS）</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-cogs"></i><span> 工具</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/tools/json/"><i class="fa-fw fas fa-cog"></i><span> JSON 转换工具集</span></a></li><li><a class="site-page child" href="/tools/diagrams/mermaid"><i class="fa-fw fas fa-pie-chart"></i><span> 在线绘制 UML 图</span></a></li><li><a class="site-page child" href="/tools/image/compressor/"><i class="fa-fw fas fa-image"></i><span> 图像批量压缩大小</span></a></li><li><a class="site-page child" href="/tools/image/watermark/"><i class="fa-fw fas fa-image"></i><span> 图像批量添加水印</span></a></li><li><a class="site-page child" href="/tools/image/convert/"><i class="fa-fw fas fa-file-image"></i><span> 图像格式编码转换</span></a></li><li><a class="site-page child" href="/tools/video/cropping/"><i class="fa-fw fas fa-cut"></i><span> 视频时长范围裁剪</span></a></li><li><a class="site-page child" href="/tools/video/watermark/"><i class="fa-fw fas fa-video"></i><span> 视频加水印马赛克</span></a></li><li><a class="site-page child" href="/tools/download/"><i class="fa-fw fas fa-cloud-download"></i><span> 批量下载视频图片</span></a></li><li><a class="site-page child" href="/tools/docu/watermark/"><i class="fa-fw fas fa-file-pdf"></i><span> PDF 文档添加水印</span></a></li><li><a class="site-page child" href="/tools/docu/signature"><i class="fa-fw fas fa-file"></i><span> 文档在线手写签名</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-pencil-square"></i><span> 文学</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/literature/poems"><i class="fa-fw fas fa-align-center"></i><span> 三行诗集</span></a></li><li><a class="site-page child" href="/literature/classical"><i class="fa-fw fas fa-align-justify"></i><span> 诗词歌赋</span></a></li><li><a class="site-page child" href="/literature/modern"><i class="fa-fw fas fa-align-left"></i><span> 现代诗歌</span></a></li><li><a class="site-page child" href="/literature/journal"><i class="fa-fw fas fa-align-right"></i><span> 随心随笔</span></a></li><li><a class="site-page child" href="/literature/incomplete"><i class="fa-fw fas fa-columns"></i><span> 忘梦残句</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-commenting"></i><span> 交流</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/messageboard/"><i class="fa-fw fas fa-paper-plane"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/essay/1634204470553163420447079.webp);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src= "/img/20241215205335173426721579192.webp" data-lazy-src="/img/logo.png" alt="Logo"><span class="site-name">余一叶知秋尽</span></a><a class="nav-page-title" href="/"><span class="site-name">剧本分镜智能体架构设计与实现（MVP版）</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list-ul"></i><span> 归档</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类别</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签集</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-outdent"></i><span> AI</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/ai/aigc/"><i class="fa-fw fas fa-cubes"></i><span> AIGC 创意平台</span></a></li><li><a class="site-page child" href="/ai/agent/medical/"><i class="fa-fw fas fa-medkit"></i><span> 医疗问答Agent</span></a></li><li><a class="site-page child" href="https://github.com/HengLine/ai-stocks-agent"><i class="fa-fw fas fa-line-chart"></i><span> 股票分析Agent</span></a></li><li><a class="site-page child" href="/ai/agent/video/"><i class="fa-fw fas fa-cut"></i><span> 视频混剪Agent</span></a></li><li><a class="site-page child" href="https://github.com/HengLine/video-shot-agent"><i class="fa-fw fas fa-file-video"></i><span> 剧本分镜Agent</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list-ol"></i><span> 项目</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/turnkey/smart-city"><i class="fa-fw fas fa-building"></i><span> 智慧城市（IOT）</span></a></li><li><a class="site-page child" href="/turnkey/smart-security"><i class="fa-fw fas fa-check-circle"></i><span> 智慧安检（IOT）</span></a></li><li><a class="site-page child" href="/turnkey/tms"><i class="fa-fw fas fa-truck"></i><span> 物流运输（TMS）</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-cogs"></i><span> 工具</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/tools/json/"><i class="fa-fw fas fa-cog"></i><span> JSON 转换工具集</span></a></li><li><a class="site-page child" href="/tools/diagrams/mermaid"><i class="fa-fw fas fa-pie-chart"></i><span> 在线绘制 UML 图</span></a></li><li><a class="site-page child" href="/tools/image/compressor/"><i class="fa-fw fas fa-image"></i><span> 图像批量压缩大小</span></a></li><li><a class="site-page child" href="/tools/image/watermark/"><i class="fa-fw fas fa-image"></i><span> 图像批量添加水印</span></a></li><li><a class="site-page child" href="/tools/image/convert/"><i class="fa-fw fas fa-file-image"></i><span> 图像格式编码转换</span></a></li><li><a class="site-page child" href="/tools/video/cropping/"><i class="fa-fw fas fa-cut"></i><span> 视频时长范围裁剪</span></a></li><li><a class="site-page child" href="/tools/video/watermark/"><i class="fa-fw fas fa-video"></i><span> 视频加水印马赛克</span></a></li><li><a class="site-page child" href="/tools/download/"><i class="fa-fw fas fa-cloud-download"></i><span> 批量下载视频图片</span></a></li><li><a class="site-page child" href="/tools/docu/watermark/"><i class="fa-fw fas fa-file-pdf"></i><span> PDF 文档添加水印</span></a></li><li><a class="site-page child" href="/tools/docu/signature"><i class="fa-fw fas fa-file"></i><span> 文档在线手写签名</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-pencil-square"></i><span> 文学</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/literature/poems"><i class="fa-fw fas fa-align-center"></i><span> 三行诗集</span></a></li><li><a class="site-page child" href="/literature/classical"><i class="fa-fw fas fa-align-justify"></i><span> 诗词歌赋</span></a></li><li><a class="site-page child" href="/literature/modern"><i class="fa-fw fas fa-align-left"></i><span> 现代诗歌</span></a></li><li><a class="site-page child" href="/literature/journal"><i class="fa-fw fas fa-align-right"></i><span> 随心随笔</span></a></li><li><a class="site-page child" href="/literature/incomplete"><i class="fa-fw fas fa-columns"></i><span> 忘梦残句</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-commenting"></i><span> 交流</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/messageboard/"><i class="fa-fw fas fa-paper-plane"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">剧本分镜智能体架构设计与实现（MVP版）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-10-28T16:00:00.000Z" title="发表于 2025-10-29 00:00:00">2025-10-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-01-28T15:17:48.804Z" title="更新于 2026-01-28 23:17:48">2026-01-28</time></span></div><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/AI/">AI</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/AI/Agent/">Agent</a></span><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p>该工具能将用户提供的原始自然语言剧本，自动拆分为多个<strong>n秒长度的短视频片段脚本</strong>，并确保<strong>画面连贯性、角色一致性、动作延续性</strong>，适用于主流 AI 视频生成模型（如 Runway、Pika、Sora、Wan、Stable Video等）</p>
<blockquote>
<ul class="lvl-1">
<li class="lvl-2">
<p><strong>需求描述</strong>：假如我有一段预估两分钟左右的剧本，想通过AI模型生成对应的短视频。</p>
</li>
<li class="lvl-2">
<p><strong>技术受限</strong>：目前的各种模型仅支持一次生成5-10秒长度的视频，想要生成两分钟长度的视频，只能通过“拼接”的方式，将多个5秒的片段合成为一个视频。</p>
</li>
<li class="lvl-2">
<p><strong>任务&amp;挑战点</strong>：要实现视频拼接，第一步就需要拆分原剧本，拆分后的剧本尽量接近5-10秒时长（取决于模型），且每个视频片段还必须要保持连贯性，不然生成的视频片段合成后会导致场景、动作、人物等衔接不上。</p>
<p>且剧情中的动作、语速等会影响时长，所以需要考虑多种情景，比如：老人动作慢、生气怒吼时语速会较快、跑比走要快等等。</p>
<p>这便是本智能体需要完成的任务，用户只需要给出剧本，而后根据各种技术拆解，最后将拆解完成的剧本片段返回，用户只需要将其交给模型（Runway、Pika、Sora、Wan、Stable Video等）生成即可，最后再利用相关技术将片段合成为完整视频。</p>
</li>
</ul>
</blockquote>
<p>详细使用方式，请参照 <a href="https://github.com/HengLine/tool-shot-agent">GitHub 项目</a> （功能开发完善中），如果有更好的思路或想法，可参与开发或提出需求。</p>
<h2 id="剧本分镜智能体（V1-0）"><a href="https://github.com/HengLine/tool-shot-agent">剧本分镜智能体</a>（V1.0）</h2>
<p>当前版本：1.0.0（MVP版），<strong>单次简短剧本处理，不跨剧本记录状态</strong></p>
<h3 id="设计原则">设计原则</h3>
<ol>
<li class="lvl-3">
<p>核心功能优先，简化复杂性</p>
</li>
<li class="lvl-3">
<p>尽可能使用LLM，减少规则实现</p>
</li>
<li class="lvl-3">
<p>保持基础连续性，但不过度设计</p>
</li>
<li class="lvl-3">
<p>输出格式统一，便于后续扩展</p>
</li>
</ol>
<p><strong>包含的核心功能</strong></p>
<blockquote>
<ol>
<li class="lvl-3">
<p>基础剧本解析（场景、角色、对话）</p>
</li>
<li class="lvl-3">
<p>简单镜头拆分（基于场景和对话）</p>
</li>
<li class="lvl-3">
<p>5秒强制切分（无复杂合并）</p>
</li>
<li class="lvl-3">
<p>基础Prompt生成（模板+LLM）</p>
</li>
<li class="lvl-3">
<p>基础质量检查（时长、基本连续性）</p>
</li>
</ol>
</blockquote>
<p><strong>暂不包含的功能</strong>（后续版本）</p>
<blockquote>
<ol>
<li class="lvl-3">
<p>复杂连续性管理</p>
</li>
<li class="lvl-3">
<p>多模型适配</p>
</li>
<li class="lvl-3">
<p>智能合并策略</p>
</li>
<li class="lvl-3">
<p>高级情感分析</p>
</li>
<li class="lvl-3">
<p>自动修正回滚</p>
</li>
</ol>
</blockquote>
<h3 id="核心目标">核心目标</h3>
<p>将任意长度的剧本，拆分为N个5秒的、视觉连贯的Sora视频片段脚本单元（Shot）</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>自动化转换</strong>：实现剧本→AI视频指令的端到端自动化流程</p>
</li>
<li class="lvl-2">
<p><strong>智能分段</strong>：智能处理5秒限制，保证叙事连贯性</p>
</li>
<li class="lvl-2">
<p><strong>连续性保障</strong>：基础的角色、场景、道具一致性维护</p>
</li>
<li class="lvl-2">
<p><strong>高质量输出</strong>：生成专业级的AI视频生成提示词</p>
</li>
</ul>
<blockquote>
<p>核心挑战：</p>
<ol>
<li class="lvl-3">处理多种输入格式（自然语言、AI分镜、结构化场景、标准剧本）</li>
<li class="lvl-3">精确估算每个视觉/对话元素的合理时长</li>
<li class="lvl-3">确保5秒片段间的视觉和叙事连贯性</li>
<li class="lvl-3">生成Sora优化的提示词</li>
</ol>
</blockquote>
<h3 id="使用场景">使用场景</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>场景1：内容创作者</p>
<p><strong>用户画像</strong>：短视频创作者、自媒体博主、内容营销人员<br>
<strong>典型需求</strong>：快速将故事脚本转化为视频内容，批量生成短视频素材，降低视频制作门槛和时间成本</p>
</li>
<li class="lvl-2">
<p>场景2：影视制作预可视化</p>
<p><strong>用户画像</strong>：独立电影人、学生剧组、低成本制作团队<br>
<strong>典型需求</strong>：剧本的分镜预览和可视化，成本可控的概念验证</p>
</li>
<li class="lvl-2">
<p>场景3：游戏剧情制作</p>
<p><strong>用户画像</strong>：独立游戏开发者、视觉小说创作者<br>
<strong>典型需求</strong>：游戏过场动画的快速原型，低成本的情节演示</p>
</li>
<li class="lvl-2">
<p>场景4：教育培训内容</p>
<p><strong>用户画像</strong>：在线教育机构、企业培训部门、知识付费创作者<br>
<strong>典型需求</strong>：将文字课程转化为视频课程，快速更新和迭代教学内容</p>
</li>
<li class="lvl-2">
<p>场景5：广告营销素材</p>
<p><strong>用户画像</strong>：广告代理公司、电商企业、品牌营销团队<br>
<strong>典型需求</strong>：快速生成多平台适配的产品演示视频</p>
</li>
</ul>
<h3 id="输入输出">输入输出</h3>
<table>
<thead>
<tr>
<th style="text-align:left">阶段</th>
<th style="text-align:left">输入</th>
<th style="text-align:left">输出</th>
<th style="text-align:left">关键处理</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>剧本解析</strong></td>
<td style="text-align:left">原始文本</td>
<td style="text-align:left">结构化剧本</td>
<td style="text-align:left">LLM提取场景、角色、对话</td>
</tr>
<tr>
<td style="text-align:left"><strong>镜头拆分</strong></td>
<td style="text-align:left">结构化剧本</td>
<td style="text-align:left">镜头序列</td>
<td style="text-align:left">按对话和动作变化分镜</td>
</tr>
<tr>
<td style="text-align:left"><strong>视频分段</strong></td>
<td style="text-align:left">镜头序列</td>
<td style="text-align:left">视频片段</td>
<td style="text-align:left">5秒切分，保持连续性</td>
</tr>
<tr>
<td style="text-align:left"><strong>指令转换</strong></td>
<td style="text-align:left">视频片段</td>
<td style="text-align:left">Prompt指令</td>
<td style="text-align:left">LLM生成视觉描述</td>
</tr>
<tr>
<td style="text-align:left"><strong>质量审查</strong></td>
<td style="text-align:left">Prompt指令</td>
<td style="text-align:left">审查报告</td>
<td style="text-align:left">基础规则检查</td>
</tr>
</tbody>
</table>
<p><strong>输入剧本</strong>（自然语言剧本）</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">深夜11点，城市公寓客厅，窗外大雨滂沱。林然裹着旧羊毛毯蜷在沙发里，电视静音播放着黑白老电影。茶几上半杯凉茶已凝出水雾，旁边摊开一本旧相册。手机突然震动，屏幕亮起“未知号码”。她盯着看了三秒，指尖悬停在接听键上方，喉头轻轻滚动。终于，她按下接听，将手机贴到耳边。电话那头沉默两秒，传来一个沙哑的男声：“是我。”  林然的手指瞬间收紧，指节泛白，呼吸停滞了一瞬。  她声音微颤：“……陈默？你还好吗？”  对方停顿片刻，低声说：“我回来了。” 林然猛地坐直，瞳孔收缩，泪水在眼眶中打转。她张了张嘴，却发不出声音，只有毛毯从肩头滑落。”</span><br></pre></td></tr></table></figure>
<p><strong>输出结果</strong>（分段后的指令提示词）：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;generated_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2026-01-27T20:20:52.118062&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mvp_1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;target_model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;runway_gen2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;total_prompts&quot;</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;converter_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;LLMPromptConverter&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;saved_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2026-01-27T20:20:52.119706&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uuid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hengline-20260127-201642388&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;project_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AI视频项目&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;total_fragments&quot;</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;total_duration&quot;</span><span class="punctuation">:</span> <span class="number">25.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;source_fragments&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;frag_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;frag_002&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;frag_003&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;frag_004&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;frag_005&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;frag_006&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;frag_007&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;frag_008&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;frag_009&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;frag_010&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;frag_011&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fragments&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;fragment_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;frag_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Cinematic wide shot of a rainy-night city apartment living room: rain-streaked window blurs vibrant neon signs outside into soft, glowing color smudges; interior lit solely by a single warm yellow floor lamp casting gentle light on a dusty vintage record player, faded movie posters on the walls, and stacked leather-bound notebooks; shallow depth of field, moody chiaroscuro lighting, film grain texture, 35mm cinematic color grading, atmospheric haze, hyper-detailed realism, slow ambient camera drift&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;negative_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bright lighting, daylight, people, text, logos, modern furniture, clean surfaces, sharp focus everywhere, cartoonish style, low resolution, motion blur artifacts, lens flare, overexposure, cluttered composition&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;runway_gen2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;style&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cinematic noir ambiance with nostalgic analog warmth&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;requires_special_attention&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;fragment_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;frag_002&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Cinematic medium shot: Lin Ran curled up on a light gray fabric sofa, bare feet resting on a textured wool rug, knees covered by a faded indigo blanket with worn edges; she wears a creamy white cotton robe, hair slightly damp at the ends, her profile softly illuminated by warm floor lamp light revealing tired, serene contours; outside the window, a faint lightning flash briefly illuminates her still, delicate eyelashes — shallow depth of field, soft cinematic lighting, film grain texture, 35mm anamorphic lens aesthetic, natural skin tones, ultra-detailed fabric and textile realism, subtle ambient occlusion, moody yet intimate atmosphere.&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;negative_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blurry, deformed hands, extra limbs, text, logos, cartoonish style, low resolution, oversaturated colors, harsh shadows, noisy grain, CGI look, anime style, smiling, motion blur, talking, open eyes blinking, daylight, cluttered background&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;runway_gen2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;style&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Cinematic, moody, intimate, photorealistic, 35mm film aesthetic&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;requires_special_attention&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;fragment_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;frag_003&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Cinematic close-up shot:林然&#x27;s left hand resting on her knee, a vintage black smartphone beside it suddenly vibrates; its screen flares with intense white light in low ambient lighting—&#x27;Unknown Number&#x27; glows sharply in bold white sans-serif text, floating eerily in darkness; shallow depth of field emphasizes the text&#x27;s reflection shimmering faintly on her iris; raindrops streak vertically down a fogged window in soft bokeh background; moody chiaroscuro lighting, film grain texture, 35mm cinematic color grading, ultra-detailed skin and fabric textures, realistic subsurface scattering on skin, subtle lens flare from screen glow.&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;negative_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blurry, low resolution, cartoonish, anime style, text errors, extra limbs, deformed hands, overexposed screen, visible UI icons or logos, bright room lighting, smiling face, motion blur on phone, audio waveforms, sound indicators, captions, subtitles, watermark, logo, frame borders&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;runway_gen2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;style&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Cinematic, moody, neo-noir thriller aesthetic, shallow depth of field, high-contrast lighting, photorealistic detail&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;requires_special_attention&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;fragment_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;frag_004&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Cinematic tight medium shot of Lin Ran, a young East Asian woman with delicate features, gazing downward at her smartphone screen in quiet intensity; soft cool moonlight illuminates her face and bare neck, highlighting a subtle, rhythmic rise and fall of her Adam&#x27;s apple; her right index finger hovers 2mm above the call-accept button, trembling faintly, nails gleaming with silvery-blue, lunar-toned sheen; a textured wool blanket drapes across her lap, its folds tautening slightly as she holds her breath; shallow depth of field, film grain, chiaroscuro lighting, muted desaturated palette with cool cyan and pearl-gray accents, ultra-detailed skin texture and fabric realism, 8K resolution, shot on ARRI Alexa Mini LF with vintage anamorphic lens.&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;negative_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blurry, low-res, deformed hands, extra fingers, distorted face, text, logos, bright highlights, overexposure, warm tones, motion blur, talking, smiling, open mouth, background characters, cluttered background, cartoonish, anime, illustration, drawing, watermark, noise, grainy beyond cinematic film grain&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;runway_gen2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;style&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cinematic, moody, intimate, high-fidelity realism, neo-noir ambiance, restrained emotional tension, shallow focus, naturalistic lighting&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;requires_special_attention&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;fragment_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;frag_005&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Cinematic close-up shot of a young East Asian man&#x27;s hand and left ear: thumb decisively pressing a smartphone&#x27;s answer button, phone receiver smoothly tilting to press against the left ear; visible delicate ear anatomy with subtle redness on the auricle and faint goosebumps on the nape skin; soft ambient lighting, shallow depth of field, realistic skin texture and micro-details, muted urban interior background (scene_001), screen backlight fading to black in frame, ultra-high resolution, film grain, 8K, shot on ARRI Alexa Mini LF with 50mm lens&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;negative_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blurry, low-res, cartoonish, anime, deformed ears or hands, excessive makeup, text, logos, bright screen glare, wet hair, smiling, open mouth, multiple people, motion blur, overexposed highlights, CGI look, doll-like skin&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">1.5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;runway_gen2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;style&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cinematic realism, intimate framing, tactile detail emphasis, naturalistic lighting, psychological tension conveyed visually&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;requires_special_attention&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;fragment_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;frag_006&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Extreme close-up cinematic shot: the metallic edge of a smartphone earpiece pressed tightly against Lin Ran&#x27;s delicate ear contour; subtle visible vibration ripples on skin surface; shallow depth of field, ultra-detailed skin texture and fine hairs; soft directional lighting creates a sharp specular highlight on a tiny silver hoop earring dangling from her right earlobe; warm ambient tone with cool accent light on metal; film grain, 35mm anamorphic lens aesthetic, shallow focus, high-resolution detail, naturalistic color grading.&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;negative_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blurry, low resolution, distorted anatomy, extra limbs, text, logos, cartoonish style, overexposed, underexposed, flat lighting, wide shot, background clutter, motion blur, audio waveform, sound visualization, microphone, hands, face full frame, unnatural skin tones&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">2.0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;runway_gen2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;style&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cinematic, photorealistic, anamorphic, shallow depth of field, natural lighting, high-fidelity skin detail&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;requires_special_attention&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;fragment_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;frag_007&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Cinematic tight medium shot of Lin Ran, a young East Asian woman with sharp features and damp hair, seated by a rain-streaked window; her left hand tightly grips a smartphone, fingers clenched—knuckles whitened, prominent blue veins and bulging tendons visible on the back of her hand; jawline taut, lips parted then sealed, chest frozen mid-breath; shallow depth of field, soft natural lighting with cool blue-gray ambient tones; rain intensifies outside, blurring distant city lights; subtle skin texture, realistic subsurface scattering, film grain, 35mm cinematic color grading, shallow focus on hand and face, ultra-detailed skin and fabric details.&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;negative_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blurry, low resolution, deformed hands, extra fingers, distorted face, cartoonish, anime, text, logo, watermark, overexposed, underexposed, flat lighting, static background, smiling, relaxed expression, motion blur, audio visualization, sound waves, microphone, speaker icons&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">1.2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;runway_gen2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;style&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cinematic, photorealistic, dramatic tension, shallow depth of field, moody natural lighting, 35mm film aesthetic&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;requires_special_attention&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;fragment_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;frag_008&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Cinematic close-up portrait of Lin Ran, early 30s, East Asian, expressive face in shallow depth of field. Her eyes are wide open, pupils sharply constricted to pinpoints; lower lip gently bitten by upper teeth, leaving a faint indentation. Slight breath visible on lips, eyelashes trembling intensely. A single tear glistens precariously at the lower lash line, unshed. Soft, directional studio lighting with subtle rim light accentuating facial contours; muted, emotionally charged color grade—cool teal and desaturated skin tones. Background softly blurred, hinting at scene_001’s ambient texture but non-distracting. Ultra-high resolution, film grain, 8K detail, shallow focus, cinematic framing.&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;negative_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blurry, deformed eyes, asymmetrical face, extra limbs, text, logo, watermark, cartoonish, anime, low resolution, flat lighting, overexposed, underexposed, smiling, calm expression, dry eyes, open mouth showing teeth, motion blur, shaky cam, wide shot, background details, audio waveform, subtitles&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">2.8</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;runway_gen2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;style&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Cinematic realism, emotional intimacy, psychological tension, shallow-focus portraiture, David Fincher / Roger Deakins inspired lighting&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;requires_special_attention&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;fragment_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;frag_009&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Cinematic close-up of a smartphone earpiece surface, ultra-detailed macro view showing subtle micro-scratches catching a fleeting glint of cool ambient light; shallow depth of field with soft bokeh background suggesting an intimate, tense interior space (scene_001); faint dust motes visible in the light beam; muted color palette dominated by brushed metal grays, matte black, and desaturated blues; subtle lens flare and micro-reflections enhance realism; film grain texture, 35mm cinematic aspect ratio, shot on ARRI Alexa Mini LF with vintage anamorphic lens rendering.&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;negative_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text, words, logos, people&#x27;s faces, hands, motion blur, overexposure, HDR, cartoon, anime, illustration, 3D render, CGI, low resolution, noise, distortion, watermark, audio waveform, sound indicators, microphone, speaker icon, brightness bloom&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">2.5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;runway_gen2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;style&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cinematic, macro, realistic, moody, atmospheric, shallow depth of field, anamorphic&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;requires_special_attention&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;fragment_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;frag_010&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Cinematic medium shot of Lin Ran jolting upright on a sofa, spine rigid like a drawn bowstring, soft blanket slipping down to her waist; her pupils sharply constricted, sclera veined with red, two glistening tears tracing clean paths down her cheeks; right hand instinctively gripping the front of her sleep robe, fabric deeply wrinkled into a dark, tense vortex. Warm ambient lighting, shallow depth of field, film grain texture, emotionally charged realism, subtle skin detail, naturalistic facial micro-expressions, 8K resolution, shot on ARRI Alexa Mini LF with vintage anamorphic lens.&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;negative_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blurry, deformed face, extra limbs, text, logo, cartoonish style, low resolution, flat lighting, overexposed, underexposed, motion blur, static pose, smiling, calm expression, clean untouched fabric, symmetrical composition, CGI look, anime style&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">1.8</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;runway_gen2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;style&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cinematic realism, emotionally intense, shallow focus, tactile fabric detail, expressive close-medium framing, naturalistic color grading&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;requires_special_attention&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;fragment_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;frag_011&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Cinematic close-up shot: a young East Asian woman (Lin Ran) in soft natural lighting, her face tense and mouth slightly open as throat muscles visibly contract—no sound emitted. Slow downward dolly movement reveals a rich indigo wool blanket slipping fully off her frame, pooling at the junction of a beige linen sofa cushion and light oak hardwood floor. Her bare, slender shoulders and pronounced clavicle are exposed; a single damp strand of black hair clings to her neck, subtly lifting with each shallow, rigid breath. Shallow depth of field, film grain texture, Kodak Portra 400 color grading, delicate skin detail, emotionally charged stillness, intimate psychological realism.&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;negative_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text, words, speech bubbles, cartoon, anime, deformed hands, extra fingers, disfigured face, blurry eyes, low resolution, oversaturated, harsh shadows, motion blur, audio waveform, microphone, speaker, background characters, clothing logos, modern tech devices&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">2.2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;runway_gen2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;style&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cinematic, photorealistic, emotionally restrained, shallow depth of field, natural lighting, filmic color grade&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;requires_special_attention&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;global_settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;style_consistency&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;use_common_negative_prompt&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;execution_suggestions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;按顺序生成片段&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;保持相同种子值以获得一致性&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;生成后检查片段衔接&quot;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="集成方式">集成方式</h3>
<p>集成到Web应用（API）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify</span><br><span class="line"><span class="keyword">from</span> hengline.generate_agent <span class="keyword">import</span> generate_storyboard</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/v1/generate&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate</span>():</span><br><span class="line">    data = request.json</span><br><span class="line">    result = generate_storyboard(</span><br><span class="line">        script_text=data[<span class="string">&#x27;script_text&#x27;</span>],</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> jsonify(result)</span><br></pre></td></tr></table></figure>
<p>集成到 LangGraph 工作流节点</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> Graph, StateGraph, END</span><br><span class="line"><span class="keyword">from</span> hengline.hengline_agent <span class="keyword">import</span> generate_storyboard</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义工作流状态</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StoryWorkflowState</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="variable language_">self</span>.script = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="variable language_">self</span>.storyboard = <span class="literal">None</span></span><br><span class="line">    <span class="variable language_">self</span>.status = <span class="string">&quot;pending&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建分镜生成节点</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_storyboard_node</span>(<span class="params">state:StoryWorkflowState</span>) -&gt; StoryWorkflowState:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        state.storyboard = generate_storyboard(</span><br><span class="line">            script_text=state.script</span><br><span class="line">        )</span><br><span class="line">        state.status = <span class="string">&quot;completed&quot;</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        state.status = <span class="string">f&quot;error: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建LangGraph工作流</span></span><br><span class="line">graph = StateGraph(StoryWorkflowState)</span><br><span class="line">graph.add_node(<span class="string">&quot;storyboard_generator&quot;</span>, generate_storyboard_node)</span><br><span class="line">graph.set_entry_point(<span class="string">&quot;storyboard_generator&quot;</span>)</span><br><span class="line">graph.add_edge(<span class="string">&quot;storyboard_generator&quot;</span>, END)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译并运行工作流</span></span><br><span class="line">app = graph.<span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行工作流</span></span><br><span class="line">result = app.invoke(&#123;</span><br><span class="line">    <span class="string">&quot;script&quot;</span>: <span class="string">&quot;深夜11点，城市公寓客厅，窗外大雨滂沱...&quot;</span>,</span><br><span class="line">    <span class="string">&quot;status&quot;</span>: <span class="string">&quot;pending&quot;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>集成到A2A系统</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="技术架构（多智能体）">技术架构（多智能体）</h2>
<p><strong>智能体框架</strong>: LangGraph（专为多智能体状态机设计）</p>
<pre class="mermaid">graph TB
    %% 输入输出
    Input[原始剧本文本] --> Parser
    FinalOutput[AI视频指令] --> End[完成]
    
    %% 核心处理流程
    subgraph "处理流程"
        Parser[剧本解析智能体]
        Splitter[镜头拆分智能体]
        Fragmenter[视频分段智能体]
        Converter[指令转换智能体]
        Auditor[质量审查智能体]
    end
    
    %% 数据流
    Parser --> Splitter
    Splitter --> Fragmenter
    Fragmenter --> Converter
    Converter --> Auditor
    Auditor --> FinalOutput
    
    %% 支持服务
    subgraph "支持服务"
        LLM[LLM服务]
        StateDB[(状态存储)]
    end
    
    %% 服务调用
    Parser -.-> LLM
    Converter -.-> LLM
    Fragmenter -.-> StateDB
    Converter -.-> StateDB</pre>
<table>
<thead>
<tr>
<th>智能体</th>
<th>职责</th>
<th>输入 → 输出</th>
<th>要点</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>1. 剧本解析智能体</strong></td>
<td>将任意格式剧本统一解析为结构化叙事单元，提取场景、角色、动作、对话、道具、情绪等</td>
<td>原始文本 → 结构化序列（场景、角色、对话等）</td>
<td>仅提取基本元素，<strong>不做复杂时长估算</strong></td>
</tr>
<tr>
<td><strong>2. 镜头拆分智能体</strong></td>
<td>基于情感强度、节奏变化等，将剧本划分为最小可独立表达的镜头单元，并分配合理时长</td>
<td>结构化对象 → 带时间戳的镜头序列JSON</td>
<td>基于<strong>简单规则</strong>（如场景变化、对话切换）拆分，不涉及复杂镜头语言</td>
</tr>
<tr>
<td><strong>3. 视频分段智能体</strong></td>
<td>将镜头按5秒粒度切分，优先在动作静止点切割，输出符合AI视频模型要求的片段序列</td>
<td>镜头序列 → 符合AI视频长度限制的片段序列</td>
<td>只对&gt;5秒镜头 <strong>简单切分</strong>，不做镜头智能合并等复杂操作</td>
</tr>
<tr>
<td><strong>4. 指令转换智能体</strong></td>
<td>为每个AI片段生成模型适配的文生视频提示词（Prompt），包含构图、光线、运动等</td>
<td>片段内容 + 连续性锚点 → 可直接用于AI视频生成指令</td>
<td><strong>使用“模板+LLM优化”</strong> 的方式生成提示词，降低复杂度</td>
</tr>
<tr>
<td><strong>5. 质量审查智能体</strong></td>
<td>对全序列进行连贯性、时长合规性、角色漂移等检查，输出修正建议</td>
<td>AI片段序列 → <strong>审查报告</strong> （通过 / 修正建议列表）</td>
<td><strong>只检查硬性规则</strong>（如时长、基本连续性），不做深度美学判断</td>
</tr>
</tbody>
</table>
<p><strong>全流程协作序列图</strong>：</p>
<pre class="mermaid">sequenceDiagram
    participant User as 用户
    participant System as 流程编排器
    participant Parser as 剧本解析
    participant Splitter as 镜头拆分
    participant Fragmenter as 视频分段
    participant Converter as 指令转换
    participant Auditor as 质量审查
    
    User->>System: 提交剧本
    System->>Parser: 开始解析
    Parser-->>System: 返回结构化剧本
    System->>Splitter: 开始镜头拆分
    Splitter-->>System: 返回镜头序列
    System->>Fragmenter: 开始5秒分段
    Fragmenter-->>System: 返回片段序列
    System->>Converter: 生成AI指令
    Converter-->>System: 返回Prompt序列
    System->>Auditor: 开始质量审查
    Auditor-->>System: 返回审查结果
    
    alt 审查通过
        System->>User: 返回完整AI指令
    else 审查不通过
        System->>User: 返回错误和建议
    end</pre>
<h3 id="1-剧本解析智能体">1.剧本解析智能体</h3>
<p><strong>核心目标</strong>：将任意格式剧本转换为<strong>统一的结构化中间表示</strong>，执行剧本的格式转换和语义提取。</p>
<blockquote>
<p>支持四种类型的剧本：</p>
<ul class="lvl-1">
<li class="lvl-2">自然语言剧本</li>
<li class="lvl-2">标准电影剧本</li>
<li class="lvl-2">AI生成的分镜剧本</li>
<li class="lvl-2">结构化场景剧本</li>
</ul>
</blockquote>
<pre class="mermaid">graph TD
    A[原始剧本文本] --> B(LLM解析)
    B --> C{解析成功?}
    C -->|是| D[结构化JSON]
    C -->|否| E[错误处理]
    D --> F[添加元数据]
    F --> G[输出结构化剧本]
    E --> H[返回错误信息]</pre>
<blockquote>
<ol>
<li class="lvl-3">
<p>自动识别输入格式，根据不同的剧本做不同处理</p>
</li>
<li class="lvl-3">
<p>使用LLM解析，通过剧本复杂度、类型、解析置信度</p>
</li>
<li class="lvl-3">
<p>提取语义元素（角色、动作、对话、场景）</p>
</li>
<li class="lvl-3">
<p>转换为统一数据结构</p>
</li>
<li class="lvl-3">
<p>保持原始语义，不添加时间信息</p>
</li>
</ol>
</blockquote>
<pre class="mermaid">sequenceDiagram
    participant User as 用户
    participant API as 流程编排器
    participant Parser as 剧本解析智能体
    participant LLM as LLM服务
    
    User->>API: POST 接口 {text: "剧本文本"}
    API->>Parser: 调用解析任务
    Parser->>LLM: 发送解析请求
    Note over Parser,LLM: 使用提示词让LLM提取<br/>场景、角色、对话、动作
    LLM-->>Parser: 返回结构化JSON
    Parser->>Parser: 添加元数据
    Parser-->>API: 返回解析结果
    API-->>User: 返回结构化剧本</pre>
<p><strong>输出示例</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;parsed_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-01-20T10:30:00Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mvp_1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;source_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;深夜对话&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;characters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;中年男性，神情紧张&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;key_traits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;穿灰色夹克&quot;</span><span class="punctuation">,</span> <span class="string">&quot;声音低沉&quot;</span><span class="punctuation">,</span> <span class="string">&quot;性格谨慎&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;李四&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;年轻女性，警觉性高&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;key_traits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;长发&quot;</span><span class="punctuation">,</span> <span class="string">&quot;穿黑色外套&quot;</span><span class="punctuation">,</span> <span class="string">&quot;敏锐观察力&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;scenes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;scene_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="string">&quot;客厅&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;昏暗的客厅，只有一盏台灯亮着&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;time_of_day&quot;</span><span class="punctuation">:</span> <span class="string">&quot;night&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;elements&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;elem_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ACTION&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;sequence&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;estimated_duration&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;confidence&quot;</span><span class="punctuation">:</span> <span class="number">0.9</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;环顾四周&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;character&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;target_character&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三紧张地环顾客厅四周&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intensity&quot;</span><span class="punctuation">:</span> <span class="number">0.7</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;emotion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fear&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;elem_002&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DIALOGUE&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;sequence&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;estimated_duration&quot;</span><span class="punctuation">:</span> <span class="number">2.0</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;confidence&quot;</span><span class="punctuation">:</span> <span class="number">0.95</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;你听到了吗？&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;character&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;target_character&quot;</span><span class="punctuation">:</span> <span class="string">&quot;李四&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三压低声音询问李四&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intensity&quot;</span><span class="punctuation">:</span> <span class="number">0.6</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;emotion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fear&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;elem_003&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ACTION&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;sequence&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;estimated_duration&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;confidence&quot;</span><span class="punctuation">:</span> <span class="number">0.85</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;走向窗边&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;character&quot;</span><span class="punctuation">:</span> <span class="string">&quot;李四&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;target_character&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;李四小心翼翼地走向窗边查看&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intensity&quot;</span><span class="punctuation">:</span> <span class="number">0.8</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;emotion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;neutral&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;elem_004&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SCENE&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;sequence&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;estimated_duration&quot;</span><span class="punctuation">:</span> <span class="number">2.5</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;confidence&quot;</span><span class="punctuation">:</span> <span class="number">0.8</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;窗外传来微弱声响&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;character&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;target_character&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;窗外传来微弱的、类似树枝摩擦的声音&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intensity&quot;</span><span class="punctuation">:</span> <span class="number">0.4</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;emotion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;neutral&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;scene_002&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="string">&quot;客厅窗边&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;窗帘微动，月光从缝隙透入&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;time_of_day&quot;</span><span class="punctuation">:</span> <span class="string">&quot;night&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;elements&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;elem_005&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DIALOGUE&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;sequence&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;estimated_duration&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;confidence&quot;</span><span class="punctuation">:</span> <span class="number">0.9</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;外面好像有人...&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;character&quot;</span><span class="punctuation">:</span> <span class="string">&quot;李四&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;target_character&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;李四压低声音，语气紧张&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intensity&quot;</span><span class="punctuation">:</span> <span class="number">0.7</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;emotion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fear&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;stats&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total_elements&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;total_duration&quot;</span><span class="punctuation">:</span> <span class="number">14.5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dialogue_count&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;action_count&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>存在的问题和挑战</strong>：</p>
<blockquote>
<p>AI的顺序识别能力</p>
<ul class="lvl-1">
<li class="lvl-2"><strong>优势</strong>：理解语义关系，推断逻辑顺序</li>
<li class="lvl-2"><strong>劣势</strong>：无法精确对应原始文本位置</li>
<li class="lvl-2"><strong>准确率</strong>：约70-85%（取决于剧本复杂度）</li>
</ul>
</blockquote>
<p>解决方案：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">mvp_order_handling</span>(<span class="params">raw_text: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="comment"># 1. 让AI解析，明确要求保持顺序</span></span><br><span class="line">    ai_result = parse_with_ai(raw_text, instruction=<span class="string">&quot;保持原始顺序&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. 添加简单的位置标记</span></span><br><span class="line">    <span class="keyword">for</span> element <span class="keyword">in</span> ai_result[<span class="string">&quot;elements&quot;</span>]:</span><br><span class="line">        element[<span class="string">&quot;order_index&quot;</span>] = estimate_position(raw_text, element)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. 按位置标记排序</span></span><br><span class="line">    sorted_elements = sort_by_order_index(ai_result[<span class="string">&quot;elements&quot;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. 标记需要人工检查的元素</span></span><br><span class="line">    <span class="keyword">for</span> element <span class="keyword">in</span> sorted_elements:</span><br><span class="line">        <span class="keyword">if</span> element.get(<span class="string">&quot;order_confidence&quot;</span>, <span class="number">1</span>) &lt; <span class="number">0.6</span>:</span><br><span class="line">            element[<span class="string">&quot;needs_human_review&quot;</span>] = <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;elements&quot;</span>: sorted_elements,</span><br><span class="line">        <span class="string">&quot;order_quality&quot;</span>: calculate_order_quality(sorted_elements),</span><br><span class="line">        <span class="string">&quot;review_needed&quot;</span>: <span class="built_in">any</span>(e.get(<span class="string">&quot;needs_human_review&quot;</span>) <span class="keyword">for</span> e <span class="keyword">in</span> sorted_elements)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>演进路径与挑战：</p>
<pre class="mermaid">graph LR
    A[MVP: 简单顺序<br/>LLM推断+数组索引] --> B[V1.1: 增强位置<br/>后端文本匹配]
    B --> C[V1.2: 精确位置<br/>分词+偏移计算]
    C --> D[V2.0: 智能验证<br/>多模型交叉验证]
    
    style A fill:#e1f5fe
    style D fill:#c8e6c9</pre>
<h3 id="2-镜头拆分智能体">2.镜头拆分智能体</h3>
<p><strong>核心目标</strong>：将结构化剧本拆分为视觉上独立的镜头单元，考虑情感节奏和时长合理性</p>
<pre class="mermaid">flowchart TD
    A[结构化剧本] --> B[提取场景]
    B --> C[遍历场景元素]
    C --> D{元素类型?}
    D -->|新场景| E[创建新镜头]
    D -->|对话切换| F[创建新镜头]
    D -->|同一动作| G[扩展当前镜头]
    E --> H[添加到镜头序列]
    F --> H
    G --> H
    H --> I[计算时间戳]
    I --> J[输出镜头序列]</pre>
<p><strong>输出示例</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;generated_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-01-20T10:35:00Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mvp_1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;parser_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shot_splitter_v1&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;script_reference&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;深夜对话&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;total_elements&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;original_duration&quot;</span><span class="punctuation">:</span> <span class="number">14.5</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;shots&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shot_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;scene_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;scene_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三紧张地环顾客厅四周&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;shot_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;medium_shot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;main_character&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;element_ids&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;elem_001&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;confidence&quot;</span><span class="punctuation">:</span> <span class="number">0.8</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shot_002&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;scene_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;scene_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三压低声音询问李四&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">2.0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;shot_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;close_up&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;main_character&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;element_ids&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;elem_002&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;confidence&quot;</span><span class="punctuation">:</span> <span class="number">0.9</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shot_003&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;scene_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;scene_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;李四小心翼翼地走向窗边查看&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="number">5.0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;shot_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;medium_shot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;main_character&quot;</span><span class="punctuation">:</span> <span class="string">&quot;李四&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;element_ids&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;elem_003&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;confidence&quot;</span><span class="punctuation">:</span> <span class="number">0.8</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;stats&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;shot_count&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;total_duration&quot;</span><span class="punctuation">:</span> <span class="number">9.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;avg_shot_duration&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;close_up_count&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;wide_shot_count&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>存在的问题和挑战</strong>：时长的精准估算（动作、对话、场景等），MVP演进路径：</p>
<pre class="mermaid">graph LR
    A[MVP: 固定参数<br/>简单分类<br/>接受30%误差] --> B[V1: 可配置参数<br/>情感检测<br/>误差20%]
    B --> C[V2: 机器学习模型<br/>个性化适配<br/>误差15%]
    C --> D[V3: 实时调整<br/>根据生成反馈优化<br/>误差10%]
    
    style A fill:#e1f5fe
    style D fill:#c8e6c9</pre>
<h3 id="3-视频分段智能体">3.视频分段智能体</h3>
<p><strong>核心目标</strong>:：将镜头序列按5秒粒度切分，确保每个片段符合AI视频模型限制</p>
<pre class="mermaid">sequenceDiagram
    participant Splitter as 视频分段智能体
    participant Logic as 切分逻辑
    participant CM as 简单连续性管理
    
    Splitter->>Logic: 镜头序列输入
    Logic->>Logic: 遍历每个镜头
    Logic->>Logic: 检查时长是否超过5秒
    alt 时长≤5秒
        Logic->>CM: 获取连续性信息
        CM-->>Logic: 返回角色/场景状态
        Logic->>Logic: 创建单个片段
    else 时长>5秒
        Logic->>Logic: 计算切分点
        Logic->>Logic: 创建多个片段
        Logic->>CM: 为每个片段获取状态
        CM-->>Logic: 返回状态信息
    end
    Logic-->>Splitter: 返回片段序列
    Splitter->>Splitter: 组装最终输出</pre>
<p><strong>输出示例</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;generated_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-01-20T10:40:00Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mvp_1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_fragment_duration&quot;</span><span class="punctuation">:</span> <span class="number">5.0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;source_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;shot_count&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;original_duration&quot;</span><span class="punctuation">:</span> <span class="number">9.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;深夜对话&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fragments&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;frag_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;shot_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shot_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;element_ids&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;elem_001&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;中景：张三紧张地环顾四周&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;continuity_notes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;main_character&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="string">&quot;场景scene_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;main_action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三紧张地环顾四周&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;requires_special_attention&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;frag_002&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;shot_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shot_002&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;element_ids&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;elem_002&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">2.0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;特写：张三低声询问&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;continuity_notes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;main_character&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="string">&quot;场景scene_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;main_action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三压低声音询问李四&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;requires_special_attention&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;frag_003&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;shot_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shot_003&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;element_ids&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;elem_003&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span> <span class="number">5.0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;中景：李四小心翼翼地走向窗边查看&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;continuity_notes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;main_character&quot;</span><span class="punctuation">:</span> <span class="string">&quot;李四&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="string">&quot;场景scene_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;main_action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;李四小心翼翼地走向窗边查看&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;requires_special_attention&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;stats&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;fragment_count&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;total_duration&quot;</span><span class="punctuation">:</span> <span class="number">9.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;avg_duration&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fragments_under_5s&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fragments_split&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;split_ratio&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>视频分段时的连续性挑战</strong>：</p>
<blockquote>
<ol>
<li class="lvl-3">
<p><strong>动作中断</strong>：在动作中间切分导致视觉跳跃</p>
</li>
<li class="lvl-3">
<p><strong>状态不一致</strong>：片段边界状态不匹配</p>
</li>
<li class="lvl-3">
<p><strong>时空不连续</strong>：位置、服装、道具突然变化</p>
</li>
<li class="lvl-3">
<p><strong>情绪断裂</strong>：情绪变化不符合时间逻辑</p>
</li>
</ol>
<pre class="mermaid">> flowchart TD
    A[镜头序列] --> B[提取连续性信息]
    B --> C[分析动作完整性]
    C --> D[识别语义边界]
    D --> E[状态一致性检查]
    E --> F{是否需要切分?}
    F -->|是| G[寻找安全切分点]
    F -->|否| H[直接创建片段]
    G --> I[动态规划优化]
    I --> J[生成片段序列]
    H --> J
    J --> K[连续性验证]
    K --> L{通过验证?}
    L -->|是| M[输出最终片段]
    L -->|否| N[调整切分策略]
    N --> G
</pre>
<pre class="mermaid">> sequenceDiagram
    participant Splitter as 分段智能体
    participant Action as 动作保护器
    participant State as 状态检查器
    participant Boundary as 边界检测器
    participant Validator as 约束验证器
    
    Splitter->>Action: 检查镜头动作完整性
    Action-->>Splitter: 返回可切分点列表
    
    Splitter->>Boundary: 寻找语义边界
    Boundary-->>Splitter: 返回安全切分点
    
    Splitter->>State: 获取当前状态
    State-->>Splitter: 返回角色/场景状态
    
    Splitter->>Splitter: 动态规划计算最优切分
    
    Splitter->>Validator: 验证片段连续性
    Validator-->>Splitter: 返回验证结果
    
    alt 验证通过
        Splitter->>Splitter: 生成最终片段
    else 验证失败
        Splitter->>Splitter: 调整切分点重试
        Splitter->>Validator: 重新验证
    end
</pre>
</blockquote>
<h3 id="4-指令转换智能体">4.指令转换智能体</h3>
<p><strong>核心目标</strong>：将片段序列转换为高质量、模型特定的AI视频生成提示词</p>
<p><strong>技术栈</strong>：使用模板+LLM优化</p>
<pre class="mermaid">graph TD
    A[片段序列] --> B{选择AI模型}
    B --> C[Runway Gen-2]
    B --> D[Pika Labs]
    B --> E[其他模型]
    C --> F[加载模型模板]
    D --> F
    E --> F
    F --> G[LLM优化描述]
    G --> H[生成技术参数]
    H --> I[组装最终Prompt]
    I --> J[输出AI指令]</pre>
<p><strong>输出示例</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;generated_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-01-20T10:45:00Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mvp_1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;target_model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;runway_gen2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;project_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;深夜对话&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;total_fragments&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;total_duration&quot;</span><span class="punctuation">:</span> <span class="number">9.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;source_fragments&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;frag_001&quot;</span><span class="punctuation">,</span> <span class="string">&quot;frag_002&quot;</span><span class="punctuation">,</span> <span class="string">&quot;frag_003&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fragments&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;fragment_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;frag_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三, 中景：张三紧张地环顾四周, cinematic style, dramatic lighting, high quality&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;negative_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blurry, distorted, low quality, cartoonish, bad anatomy&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;runway_gen2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;style&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cinematic, suspense&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;requires_special_attention&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;fragment_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;frag_002&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三, 特写：张三低声询问, close-up shot, cinematic lighting, detailed facial expression&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;negative_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blurry, distorted, low quality, cartoonish, bad anatomy&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">2.0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;runway_gen2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;style&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cinematic&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;requires_special_attention&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;fragment_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;frag_003&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;李四, 中景：李四小心翼翼地走向窗边查看, cinematic style, suspenseful atmosphere&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;negative_prompt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blurry, distorted, low quality, cartoonish, bad anatomy&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;runway_gen2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;style&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cinematic, suspense&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;requires_special_attention&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;global_settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;style_consistency&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;use_common_negative_prompt&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;execution_suggestions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;按顺序生成片段&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;保持相同种子值以获得一致性&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;生成后检查片段衔接&quot;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="5-质量审查智能体">5.质量审查智能体</h3>
<p><strong>核心目标</strong>：确保整个流程的输出质量，检查连贯性、合规性和技术可行性</p>
<blockquote>
<ul class="lvl-1">
<li class="lvl-2">
<p>基础合规性检查</p>
</li>
<li class="lvl-2">
<p>只检查硬性规则</p>
</li>
</ul>
</blockquote>
<pre class="mermaid">flowchart TD
    A[AI指令序列] --> B[提取检查数据]
    B --> C[时长检查]
    B --> D[基本连续性检查]
    B --> E[技术参数检查]
    C --> F{所有片段≤5秒?}
    D --> G{角色服装一致?}
    E --> H{参数有效?}
    F -->|是| I[记录通过]
    F -->|否| J[记录失败]
    G -->|是| K[记录通过]
    G -->|否| L[记录警告]
    H -->|是| M[记录通过]
    H -->|否| N[记录失败]
    I --> O[汇总结果]
    J --> O
    K --> O
    L --> O
    M --> O
    N --> O
    O --> P{有失败项?}
    P -->|无| Q[状态: 通过]
    P -->|有| R[状态: 失败]
    Q --> S[生成报告]
    R --> S</pre>
<p><strong>输出示例</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;audited_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-01-20T10:50:00Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mvp_1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;auditor_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;basic&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;project_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;深夜对话&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fragment_count&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;total_duration&quot;</span><span class="punctuation">:</span> <span class="number">9.0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;passed&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;checks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;片段时长限制检查&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;passed&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;details&quot;</span><span class="punctuation">:</span> <span class="string">&quot;所有片段时长符合要求&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;checked_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-01-20T10:50:01Z&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;提示词内容检查&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;passed&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;details&quot;</span><span class="punctuation">:</span> <span class="string">&quot;所有提示词非空&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;checked_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-01-20T10:50:01Z&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;提示词长度检查&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;passed&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;details&quot;</span><span class="punctuation">:</span> <span class="string">&quot;所有提示词长度合适&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;checked_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-01-20T10:50:01Z&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;片段数量检查&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;passed&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;details&quot;</span><span class="punctuation">:</span> <span class="string">&quot;共3个片段&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;checked_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-01-20T10:50:01Z&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;模型支持检查&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;passed&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;details&quot;</span><span class="punctuation">:</span> <span class="string">&quot;所有模型都受支持&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;checked_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-01-20T10:50:01Z&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;violations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;stats&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total_checks&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;passed_checks&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;warnings&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;errors&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fragments_checked&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;suggestions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;检查所有片段时长是否≤5秒&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;确保没有空提示词&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;conclusion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;审查通过，可以开始视频生成&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="智能体实现细节">智能体实现细节</h2>
<h3 id="LLM-客户端">LLM 客户端</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>OpenAI</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ChatOpenAI(</span><br><span class="line">    model=<span class="variable language_">self</span>.config.model,</span><br><span class="line">    temperature=<span class="variable language_">self</span>.config.temperature,</span><br><span class="line">    api_key=<span class="variable language_">self</span>.config.api_key,</span><br><span class="line">    base_url=<span class="variable language_">self</span>.base_url,</span><br><span class="line">    max_retries=<span class="number">3</span>,</span><br><span class="line">    max_tokens=<span class="variable language_">self</span>.config.max_tokens,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Embeddings</span></span><br><span class="line">OpenAIEmbeddings(</span><br><span class="line">    model=<span class="variable language_">self</span>.config.model,</span><br><span class="line">    api_key=<span class="variable language_">self</span>.config.api_key,</span><br><span class="line">    base_url=<span class="variable language_">self</span>.base_url</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
<li class="lvl-2">
<p><strong>Ollama</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ChatOllama(</span><br><span class="line">    base_url=<span class="variable language_">self</span>.base_url,</span><br><span class="line">    model=<span class="variable language_">self</span>.config.model,</span><br><span class="line">    temperature=<span class="variable language_">self</span>.config.temperature,</span><br><span class="line">    num_predict=<span class="variable language_">self</span>.config.max_tokens * <span class="number">4</span>,</span><br><span class="line">    keep_alive=<span class="variable language_">self</span>.config.timeout * <span class="number">5</span>,</span><br><span class="line">    num_thread=<span class="number">8</span>,</span><br><span class="line">    client_kwargs=<span class="variable language_">self</span>._get_model_kwargs(),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Embeddings</span></span><br><span class="line">OllamaEmbeddings(</span><br><span class="line">    model=<span class="variable language_">self</span>.config.model,</span><br><span class="line">    base_url=<span class="variable language_">self</span>.base_url</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
<li class="lvl-2">
<p><strong>QWen</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ChatTongyi(</span><br><span class="line">    model=<span class="variable language_">self</span>.config.model,</span><br><span class="line">    model_kwargs=<span class="variable language_">self</span>._get_model_kwargs(),</span><br><span class="line">    api_key=<span class="variable language_">self</span>.config.api_key,</span><br><span class="line">    max_retries=<span class="number">3</span>,</span><br><span class="line">    streaming=<span class="literal">False</span>,</span><br><span class="line">)</span><br><span class="line"><span class="comment"># Embeddings</span></span><br><span class="line">DashScopeEmbeddings(</span><br><span class="line">    model=<span class="variable language_">self</span>.config.model,</span><br><span class="line">    dashscope_api_key=<span class="variable language_">self</span>.config.api_key</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="提示词管理">提示词管理</h3>
<p>LLM 提示词管理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_call_llm_chat_with_retry</span>(<span class="params">self, llm, system_prompt: <span class="built_in">str</span>, user_prompt, max_retries: <span class="built_in">int</span> = <span class="number">3</span></span>) -&gt; <span class="built_in">str</span> | <span class="literal">None</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        调用LLM，直接返回json字符串（支持重试）</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    messages = [</span><br><span class="line">        &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, <span class="string">&quot;content&quot;</span>: system_prompt&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: user_prompt&#125;</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> attempt <span class="keyword">in</span> <span class="built_in">range</span>(max_retries):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">        	response = llm.invoke(_convert_messages(messages))</span><br><span class="line">    		<span class="keyword">return</span> response.content</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">if</span> attempt == max_retries - <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">raise</span> Exception(<span class="string">f&quot;LLM调用失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_convert_messages</span>(<span class="params">messages: <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]]</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Convert dict messages to LangChain message objects&quot;&quot;&quot;</span></span><br><span class="line">    lc_messages = []</span><br><span class="line">    <span class="keyword">for</span> msg <span class="keyword">in</span> messages:</span><br><span class="line">        role = msg[<span class="string">&quot;role&quot;</span>]</span><br><span class="line">        content = msg[<span class="string">&quot;content&quot;</span>]</span><br><span class="line">        <span class="keyword">if</span> role == <span class="string">&quot;system&quot;</span>:</span><br><span class="line">            lc_messages.append(SystemMessage(content=content))</span><br><span class="line">        <span class="keyword">elif</span> role == <span class="string">&quot;user&quot;</span>:</span><br><span class="line">            lc_messages.append(HumanMessage(content=content))</span><br><span class="line">        <span class="keyword">elif</span> role == <span class="string">&quot;assistant&quot;</span>:</span><br><span class="line">            <span class="comment"># lc_messages.append(AIMessage(content=content, additional_kwargs=&#123;&quot;tool_calls&quot;: []&#125;))</span></span><br><span class="line">            lc_messages.append(AIMessage(content=content))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Unsupported role: <span class="subst">&#123;role&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> lc_messages</span><br></pre></td></tr></table></figure>
<h3 id="流程编排（LangGraph）">流程编排（LangGraph）</h3>
<p>多智能体协作流程，负责协调各个智能体完成端到端的分镜生成</p>
<pre class="mermaid">graph TD
    Start[开始] --> Parse[剧本解析]
    
    Parse --> Decision1{解析结果?}
    Decision1 -->|成功/部分成功| Split[镜头拆分]
    Decision1 -->|关键失败| Error1[错误处理]
    Decision1 -->|需人工干预| Human1[人工干预]
    
    Split --> Decision2{拆分结果?}
    Decision2 -->|成功| Fragment[AI分段]
    Decision2 -->|重试| Split
    Decision2 -->|失败| Error2[错误处理]
    
    Fragment --> Decision3{分段结果?}
    Decision3 -->|成功| Prompt[Prompt生成]
    Decision3 -->|需调整| Split
    Decision3 -->|失败| Error3[错误处理]
    
    Prompt --> Audit[质量审查]
    
    Audit --> Decision4{审查结果?}
    Decision4 -->|通过/小问题| Continuity[连续性检查]
    Decision4 -->|主要问题| Prompt
    Decision4 -->|关键问题| Split
    Decision4 -->|需人工| Human2[人工干预]
    
    Continuity --> Decision5{连续性?}
    Decision5 -->|通过| Output[生成输出]
    Decision5 -->|可修复问题| Prompt
    Decision5 -->|结构问题| Fragment
    Decision5 -->|关键问题| Split
    
    Output --> End[结束]
    
    Error1 --> DecisionE1{错误类型?}
    Error2 --> DecisionE2{错误类型?}
    Error3 --> DecisionE3{错误类型?}
    
    DecisionE1 -->|可恢复| Parse
    DecisionE1 -->|不可恢复| End
    DecisionE1 -->|需人工| Human1
    
    Human1 --> DecisionH1{人工决策?}
    Human2 --> DecisionH2{人工决策?}
    
    DecisionH1 -->|继续| Output
    DecisionH1 -->|重试| Parse
    DecisionH1 -->|中止| End
    
    style Start fill:#4CAF50
    style End fill:#F44336
    style Human1 fill:#FF9800
    style Human2 fill:#FF9800
    style Error1 fill:#9E9E9E
    style Error2 fill:#9E9E9E
    style Error3 fill:#9E9E9E</pre>
<h3 id="LangChain-工具集">LangChain 工具集</h3>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://pengline.github.io">余一叶知秋尽</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://pengline.github.io/2025/10/0194020a663c408fb500dd7532349519/">https://pengline.github.io/2025/10/0194020a663c408fb500dd7532349519/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://pengline.github.io" target="_blank">余一叶知秋尽</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/LangGraph%E6%B5%81%E7%A8%8B%E7%BC%96%E6%8E%92/">LangGraph流程编排</a><a class="post-meta__tags" href="/tags/%E9%95%BF%E5%89%A7%E6%9C%AC%E6%8B%86%E5%88%86/">长剧本拆分</a><a class="post-meta__tags" href="/tags/%E9%95%BF%E5%89%A7%E6%9C%AC%E5%88%86%E9%95%9C/">长剧本分镜</a><a class="post-meta__tags" href="/tags/%E9%95%BF%E5%89%A7%E6%9C%AC%E8%A7%86%E9%A2%91%E7%94%9F%E6%88%90/">长剧本视频生成</a></div><div class="post-share"><div class="social-share" data-image="/img/essay/1634204470553163420447079.webp" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/11/0c17e5dc04ae4994b411db081a7c82d6/" title="LangChain 框架功能详解和使用案例"><img class="cover" src= "/img/20241215205335173426721579192.webp" data-lazy-src="/img/essay/small204025vlPNF1760100025.webp" onerror="onerror=null;src='/img/k3zssqvjw2d.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">LangChain 框架功能详解和使用案例</div></div><div class="info-2"><div class="info-item-1">开源框架 LangChain，旨在简化基于大语言模型构建应用程序的过程。集成了记忆机制、工具调用和智能决策等。</div></div></div></a><a class="pagination-related" href="/2025/10/1332727d5b8a4fdc9cfbfd3661f009d4/" title="AI 模型的多种轻量化压缩技术"><img class="cover" src= "/img/20241215205335173426721579192.webp" data-lazy-src="/img/essay/171084628467171084628487.webp" onerror="onerror=null;src='/img/k3zssqvjw2d.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">AI 模型的多种轻量化压缩技术</div></div><div class="info-2"><div class="info-item-1">模型轻量化不是单一技术，而是组合策略（轻量结构设计 → 知识蒸馏 → 结构化剪枝 → 量化感知训练 → 硬件部署）。</div></div></div></a></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%A7%E6%9C%AC%E5%88%86%E9%95%9C%E6%99%BA%E8%83%BD%E4%BD%93%EF%BC%88V1-0%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">剧本分镜智能体（V1.0）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"><span class="toc-number">1.1.</span> <span class="toc-text">设计原则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%9B%AE%E6%A0%87"><span class="toc-number">1.2.</span> <span class="toc-text">核心目标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.3.</span> <span class="toc-text">使用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA"><span class="toc-number">1.4.</span> <span class="toc-text">输入输出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E6%88%90%E6%96%B9%E5%BC%8F"><span class="toc-number">1.5.</span> <span class="toc-text">集成方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84%EF%BC%88%E5%A4%9A%E6%99%BA%E8%83%BD%E4%BD%93%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">技术架构（多智能体）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%89%A7%E6%9C%AC%E8%A7%A3%E6%9E%90%E6%99%BA%E8%83%BD%E4%BD%93"><span class="toc-number">2.1.</span> <span class="toc-text">1.剧本解析智能体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%95%9C%E5%A4%B4%E6%8B%86%E5%88%86%E6%99%BA%E8%83%BD%E4%BD%93"><span class="toc-number">2.2.</span> <span class="toc-text">2.镜头拆分智能体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%A7%86%E9%A2%91%E5%88%86%E6%AE%B5%E6%99%BA%E8%83%BD%E4%BD%93"><span class="toc-number">2.3.</span> <span class="toc-text">3.视频分段智能体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%8C%87%E4%BB%A4%E8%BD%AC%E6%8D%A2%E6%99%BA%E8%83%BD%E4%BD%93"><span class="toc-number">2.4.</span> <span class="toc-text">4.指令转换智能体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E8%B4%A8%E9%87%8F%E5%AE%A1%E6%9F%A5%E6%99%BA%E8%83%BD%E4%BD%93"><span class="toc-number">2.5.</span> <span class="toc-text">5.质量审查智能体</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%99%BA%E8%83%BD%E4%BD%93%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82"><span class="toc-number">3.</span> <span class="toc-text">智能体实现细节</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LLM-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">3.1.</span> <span class="toc-text">LLM 客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E7%A4%BA%E8%AF%8D%E7%AE%A1%E7%90%86"><span class="toc-number">3.2.</span> <span class="toc-text">提示词管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E7%BC%96%E6%8E%92%EF%BC%88LangGraph%EF%BC%89"><span class="toc-number">3.3.</span> <span class="toc-text">流程编排（LangGraph）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LangChain-%E5%B7%A5%E5%85%B7%E9%9B%86"><span class="toc-number">3.4.</span> <span class="toc-text">LangChain 工具集</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 - 2026 By 余一叶知秋尽</span><span class="framework-info"><span>框架 </span><a href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.3</a></span></div><div class="footer_custom_text"><p><a style="margin-inline:5px"target="_blank"href="https://github.com/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Hosted-Github-brightgreen?style=flat&logo=GitHub"title="本站项目由Gtihub托管"></a><a style="margin-inline:5px"target="_blank"href="https://hexo.io/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo"title="博客框架为Hexo"></a><a style="margin-inline:5px"target="_blank"href="https://butterfly.js.org/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?logoColor=white&style=flat&logo=buefy"title="主题采用butterfly"></a><a style="margin-inline:5px"target="_blank"href="https://giscus.app/zh-CN/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Comment-Giscus-2873df?logoColor=white&style=flat&logo=git"title="评论系统为Giscus"></a><a style="margin-inline:5px"target="_blank"href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris"title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div><script src="https://unpkg.com/mermaid@11.5.0/dist/mermaid.min.js"></script><script>if (window.mermaid) {
  mermaid.initialize({
    startOnLoad: true,
    theme: '[object Object]',
    securityLevel: 'loose',
    flowchart: { useMaxWidth: true, htmlLabels: true }
  });
}</script></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="日间和夜间模式切换"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getGiscusTheme = theme => theme === 'dark' ? 'dark' : 'light'

  const createScriptElement = config => {
    const ele = document.createElement('script')
    Object.entries(config).forEach(([key, value]) => {
      ele.setAttribute(key, value)
    })
    return ele
  }

  const loadGiscus = (el = document, key) => {
    const mappingConfig = isShuoshuo
      ? { 'data-mapping': 'specific', 'data-term': key }
      : { 'data-mapping': (option && option['data-mapping']) || 'pathname' }

    const giscusConfig = {
      src: 'https://giscus.app/client.js',
      'data-repo': 'pengline/pengline.github.io',
      'data-repo-id': 'R_kgDOPqG50w',
      'data-category-id': 'DIC_kwDOPqG5084Cu_K9',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      'data-lang': 'zh-CN',
      'data-input-position': 'top',
      async: true,
      ...option,
      ...mappingConfig
    }

    const scriptElement = createScriptElement(giscusConfig)

    el.querySelector('#giscus-wrap').appendChild(scriptElement)

    if (isShuoshuo) {
      window.shuoshuoComment.destroyGiscus = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }
  }

  const changeGiscusTheme = theme => {
    const iframe = document.querySelector('#giscus-wrap iframe')
    if (iframe) {
      const message = {
        giscus: {
          setConfig: {
            theme: getGiscusTheme(theme),
            lang: 'zh-CN'
          }
        }
      }
      iframe.contentWindow.postMessage(message, 'https://giscus.app')
    }
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if (isShuoshuo) {
    'Giscus' === 'Giscus'
      ? window.shuoshuoComment = { loadComment: loadGiscus }
      : window.loadOtherComment = loadGiscus
    return
  }

  if ('Giscus' === 'Giscus' || !false) {
    if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment = loadGiscus
  }
})()</script></div><script src="/js/custom/sun_moon.js" async></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>