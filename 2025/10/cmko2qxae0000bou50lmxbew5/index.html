<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>剧本分镜智能体架构设计与实现细节 | 余一叶知秋尽</title><meta name="author" content="余一叶知秋尽"><meta name="copyright" content="余一叶知秋尽"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="该工具将自然语言剧本自动拆分为多个N秒长度的短视频片段脚本，以适用于 AI 视频生成模型，可直接用于“文生视频”。">
<meta property="og:type" content="article">
<meta property="og:title" content="剧本分镜智能体架构设计与实现细节">
<meta property="og:url" content="https://pengline.github.io/2025/10/cmko2qxae0000bou50lmxbew5/index.html">
<meta property="og:site_name" content="余一叶知秋尽">
<meta property="og:description" content="该工具将自然语言剧本自动拆分为多个N秒长度的短视频片段脚本，以适用于 AI 视频生成模型，可直接用于“文生视频”。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pengline.github.io/img/essay/small203823RMRXW1760099903.webp">
<meta property="article:published_time" content="2025-10-28T16:00:00.000Z">
<meta property="article:modified_time" content="2026-01-21T11:38:38.771Z">
<meta property="article:author" content="余一叶知秋尽">
<meta property="article:tag" content="LlamaIndex向量检索">
<meta property="article:tag" content="LangGraph流程编排">
<meta property="article:tag" content="长剧本拆分">
<meta property="article:tag" content="长剧本分镜">
<meta property="article:tag" content="长剧本视频生成">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pengline.github.io/img/essay/small203823RMRXW1760099903.webp"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "剧本分镜智能体架构设计与实现细节",
  "url": "https://pengline.github.io/2025/10/cmko2qxae0000bou50lmxbew5/",
  "image": "https://pengline.github.io/img/essay/small203823RMRXW1760099903.webp",
  "datePublished": "2025-10-28T16:00:00.000Z",
  "dateModified": "2026-01-21T11:38:38.771Z",
  "author": [
    {
      "@type": "Person",
      "name": "余一叶知秋尽",
      "url": "https://pengline.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://pengline.github.io/2025/10/cmko2qxae0000bou50lmxbew5/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":30,"languages":{"author":"作者: 余一叶知秋尽","link":"链接: ","source":"来源: 余一叶知秋尽","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '剧本分镜智能体架构设计与实现细节',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/font.css"><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="余一叶知秋尽" type="application/atom+xml">
</head><body><div id="web_bg" style="background: LightGray;"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="/img/butterfly-icon.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">52</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">236</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">41</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list-ul"></i><span> 归档</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类别</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签集</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-outdent"></i><span> AI</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/ai/aigc/"><i class="fa-fw fas fa-cubes"></i><span> AIGC 创意平台</span></a></li><li><a class="site-page child" href="/ai/agent/medical/"><i class="fa-fw fas fa-medkit"></i><span> 医疗问答Agent</span></a></li><li><a class="site-page child" href="https://github.com/HengLine/ai-stocks-agent"><i class="fa-fw fas fa-line-chart"></i><span> 股票分析Agent</span></a></li><li><a class="site-page child" href="/ai/agent/video/"><i class="fa-fw fas fa-cut"></i><span> 视频混剪Agent</span></a></li><li><a class="site-page child" href="https://github.com/HengLine/video-shot-agent"><i class="fa-fw fas fa-file-video"></i><span> 剧本分镜Agent</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list-ol"></i><span> 项目</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/turnkey/smart-city"><i class="fa-fw fas fa-building"></i><span> 智慧城市（IOT）</span></a></li><li><a class="site-page child" href="/turnkey/smart-security"><i class="fa-fw fas fa-check-circle"></i><span> 智慧安检（IOT）</span></a></li><li><a class="site-page child" href="/turnkey/tms"><i class="fa-fw fas fa-truck"></i><span> 物流运输（TMS）</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-cogs"></i><span> 工具</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/tools/json/"><i class="fa-fw fas fa-cog"></i><span> JSON 转换工具集</span></a></li><li><a class="site-page child" href="/tools/diagrams/mermaid"><i class="fa-fw fas fa-pie-chart"></i><span> 在线绘制 UML 图</span></a></li><li><a class="site-page child" href="/tools/image/compressor/"><i class="fa-fw fas fa-image"></i><span> 图像批量压缩大小</span></a></li><li><a class="site-page child" href="/tools/image/watermark/"><i class="fa-fw fas fa-image"></i><span> 图像批量添加水印</span></a></li><li><a class="site-page child" href="/tools/image/convert/"><i class="fa-fw fas fa-file-image"></i><span> 图像格式编码转换</span></a></li><li><a class="site-page child" href="/tools/video/cropping/"><i class="fa-fw fas fa-cut"></i><span> 视频时长范围裁剪</span></a></li><li><a class="site-page child" href="/tools/video/watermark/"><i class="fa-fw fas fa-video"></i><span> 视频加水印马赛克</span></a></li><li><a class="site-page child" href="/tools/download/"><i class="fa-fw fas fa-cloud-download"></i><span> 批量下载视频图片</span></a></li><li><a class="site-page child" href="/tools/docu/watermark/"><i class="fa-fw fas fa-file-pdf"></i><span> PDF 文档添加水印</span></a></li><li><a class="site-page child" href="/tools/docu/signature"><i class="fa-fw fas fa-file"></i><span> 文档在线手写签名</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-pencil-square"></i><span> 文学</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/literature/poems"><i class="fa-fw fas fa-align-center"></i><span> 三行诗集</span></a></li><li><a class="site-page child" href="/literature/classical"><i class="fa-fw fas fa-align-justify"></i><span> 诗词歌赋</span></a></li><li><a class="site-page child" href="/literature/modern"><i class="fa-fw fas fa-align-left"></i><span> 现代诗歌</span></a></li><li><a class="site-page child" href="/literature/journal"><i class="fa-fw fas fa-align-right"></i><span> 随心随笔</span></a></li><li><a class="site-page child" href="/literature/incomplete"><i class="fa-fw fas fa-columns"></i><span> 忘梦残句</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-commenting"></i><span> 交流</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/messageboard/"><i class="fa-fw fas fa-paper-plane"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/essay/small203823RMRXW1760099903.webp);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src= "/img/20241215205335173426721579192.webp" data-lazy-src="/img/logo.png" alt="Logo"><span class="site-name">余一叶知秋尽</span></a><a class="nav-page-title" href="/"><span class="site-name">剧本分镜智能体架构设计与实现细节</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list-ul"></i><span> 归档</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类别</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签集</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-outdent"></i><span> AI</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/ai/aigc/"><i class="fa-fw fas fa-cubes"></i><span> AIGC 创意平台</span></a></li><li><a class="site-page child" href="/ai/agent/medical/"><i class="fa-fw fas fa-medkit"></i><span> 医疗问答Agent</span></a></li><li><a class="site-page child" href="https://github.com/HengLine/ai-stocks-agent"><i class="fa-fw fas fa-line-chart"></i><span> 股票分析Agent</span></a></li><li><a class="site-page child" href="/ai/agent/video/"><i class="fa-fw fas fa-cut"></i><span> 视频混剪Agent</span></a></li><li><a class="site-page child" href="https://github.com/HengLine/video-shot-agent"><i class="fa-fw fas fa-file-video"></i><span> 剧本分镜Agent</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list-ol"></i><span> 项目</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/turnkey/smart-city"><i class="fa-fw fas fa-building"></i><span> 智慧城市（IOT）</span></a></li><li><a class="site-page child" href="/turnkey/smart-security"><i class="fa-fw fas fa-check-circle"></i><span> 智慧安检（IOT）</span></a></li><li><a class="site-page child" href="/turnkey/tms"><i class="fa-fw fas fa-truck"></i><span> 物流运输（TMS）</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-cogs"></i><span> 工具</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/tools/json/"><i class="fa-fw fas fa-cog"></i><span> JSON 转换工具集</span></a></li><li><a class="site-page child" href="/tools/diagrams/mermaid"><i class="fa-fw fas fa-pie-chart"></i><span> 在线绘制 UML 图</span></a></li><li><a class="site-page child" href="/tools/image/compressor/"><i class="fa-fw fas fa-image"></i><span> 图像批量压缩大小</span></a></li><li><a class="site-page child" href="/tools/image/watermark/"><i class="fa-fw fas fa-image"></i><span> 图像批量添加水印</span></a></li><li><a class="site-page child" href="/tools/image/convert/"><i class="fa-fw fas fa-file-image"></i><span> 图像格式编码转换</span></a></li><li><a class="site-page child" href="/tools/video/cropping/"><i class="fa-fw fas fa-cut"></i><span> 视频时长范围裁剪</span></a></li><li><a class="site-page child" href="/tools/video/watermark/"><i class="fa-fw fas fa-video"></i><span> 视频加水印马赛克</span></a></li><li><a class="site-page child" href="/tools/download/"><i class="fa-fw fas fa-cloud-download"></i><span> 批量下载视频图片</span></a></li><li><a class="site-page child" href="/tools/docu/watermark/"><i class="fa-fw fas fa-file-pdf"></i><span> PDF 文档添加水印</span></a></li><li><a class="site-page child" href="/tools/docu/signature"><i class="fa-fw fas fa-file"></i><span> 文档在线手写签名</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-pencil-square"></i><span> 文学</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/literature/poems"><i class="fa-fw fas fa-align-center"></i><span> 三行诗集</span></a></li><li><a class="site-page child" href="/literature/classical"><i class="fa-fw fas fa-align-justify"></i><span> 诗词歌赋</span></a></li><li><a class="site-page child" href="/literature/modern"><i class="fa-fw fas fa-align-left"></i><span> 现代诗歌</span></a></li><li><a class="site-page child" href="/literature/journal"><i class="fa-fw fas fa-align-right"></i><span> 随心随笔</span></a></li><li><a class="site-page child" href="/literature/incomplete"><i class="fa-fw fas fa-columns"></i><span> 忘梦残句</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-commenting"></i><span> 交流</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/messageboard/"><i class="fa-fw fas fa-paper-plane"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">剧本分镜智能体架构设计与实现细节</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-10-28T16:00:00.000Z" title="发表于 2025-10-29 00:00:00">2025-10-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-01-21T11:38:38.771Z" title="更新于 2026-01-21 19:38:38">2026-01-21</time></span></div><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/AI/">AI</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/AI/Agent/">Agent</a></span><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p>该工具能将用户提供的原始自然语言剧本，自动拆分为多个<strong>n秒长度的短视频片段脚本</strong>，并确保<strong>画面连贯性、角色一致性、动作延续性</strong>，适用于主流 AI 视频生成模型（如 Runway、Pika、Sora、Wan、Stable Video等）</p>
<blockquote>
<ul class="lvl-1">
<li class="lvl-2">
<p><strong>需求描述</strong>：假如我有一段预估两分钟左右的剧本，想通过AI模型生成对应的短视频。</p>
</li>
<li class="lvl-2">
<p><strong>技术受限</strong>：目前的各种模型仅支持一次生成5-10秒长度的视频，想要生成两分钟长度的视频，只能通过“拼接”的方式，将多个5秒的片段合成为一个视频。</p>
</li>
<li class="lvl-2">
<p><strong>任务&amp;挑战点</strong>：要实现视频拼接，第一步就需要拆分原剧本，拆分后的剧本尽量接近5-10秒时长（取决于模型），且每个视频片段还必须要保持连贯性，不然生成的视频片段合成后会导致场景、动作、人物等衔接不上。</p>
<p>且剧情中的动作、语速等会影响时长，所以需要考虑多种情景，比如：老人动作慢、生气怒吼时语速会较快、跑比走要快等等。</p>
<p>这便是本智能体需要完成的任务，用户只需要给出剧本，而后根据各种技术拆解，最后将拆解完成的剧本片段返回，用户只需要将其交给模型（Runway、Pika、Sora、Wan、Stable Video等）生成即可，最后再利用相关技术将片段合成为完整视频。</p>
</li>
</ul>
</blockquote>
<p>详细使用方式，请参照 <a href="https://github.com/HengLine/tool-shot-agent">GitHub 项目</a> （功能开发完善中），如果有更好的思路或想法，可参与开发或提出需求。</p>
<h2 id="剧本分镜智能体"><a href="https://github.com/HengLine/tool-shot-agent">剧本分镜智能体</a></h2>
<h3 id="核心目标">核心目标</h3>
<p>将任意长度的剧本，拆分为N个5秒的、视觉连贯的Sora视频片段脚本单元（Shot）</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>每段包含：画面描述 + 角色动作 + 对话（如有）+ 镜头语言</p>
</li>
<li class="lvl-2">
<p>保证跨片段连续性（角色外观、位置、情绪、动作状态一致）</p>
</li>
<li class="lvl-2">
<p>输出格式兼容主流 AI 视频生成平台（文本提示词格式）</p>
</li>
</ul>
<blockquote>
<p>核心挑战：</p>
<ol>
<li class="lvl-3">处理多种输入格式（自然语言、AI分镜、结构化场景、标准剧本）</li>
<li class="lvl-3">精确估算每个视觉/对话元素的合理时长</li>
<li class="lvl-3">确保5秒片段间的视觉和叙事连贯性</li>
<li class="lvl-3">生成Sora优化的提示词</li>
</ol>
</blockquote>
<h3 id="使用场景">使用场景</h3>
<p><strong>短视频内容创作</strong></p>
<ul class="lvl-0">
<li class="lvl-2">
<p>将小说章节转换为短视频分镜脚本</p>
</li>
<li class="lvl-2">
<p>为广告创意生成详细的镜头规划</p>
</li>
<li class="lvl-2">
<p>自动将剧本拆分为社交媒体短视频格式</p>
</li>
</ul>
<p><strong>影视前期制作辅助</strong></p>
<ul class="lvl-0">
<li class="lvl-2">
<p>快速生成剧本的视觉化预览</p>
</li>
<li class="lvl-2">
<p>辅助导演进行镜头规划和调度</p>
</li>
<li class="lvl-2">
<p>为分镜头绘制提供详细参考</p>
</li>
</ul>
<p><strong>教育培训应用</strong></p>
<ul class="lvl-0">
<li class="lvl-2">
<p>为教学内容创建情景化视频脚本</p>
</li>
<li class="lvl-2">
<p>将复杂概念通过分镜形式直观呈现</p>
</li>
<li class="lvl-2">
<p>辅助培训视频的标准化制作</p>
</li>
</ul>
<h3 id="输入输出">输入输出</h3>
<p>输入剧本（自然语言、）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[场景：城市咖啡馆，下午3点]</span><br><span class="line">李明坐在靠窗的位置，低头看着手机。突然，他抬头看见前女友小雨走进来。他愣住，手机差点掉到地上。小雨也看见了他，犹豫了一下，还是走了过来。</span><br><span class="line">小雨：（轻声）好久不见。</span><br><span class="line">李明：（紧张）你……你怎么在这？</span><br></pre></td></tr></table></figure>
<p>分镜输出示例（基于上文剧本）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Shot 1（0–5秒）</span><br><span class="line">AI Prompt:</span><br><span class="line">&quot;A young man (Li Ming) sits alone at a window table in a cozy cafe, afternoon sunlight streaming in. He stares intently at his smartphone. Medium shot, calm atmosphere, realistic style.&quot;</span><br><span class="line"></span><br><span class="line">Shot 2（5–10秒）</span><br><span class="line">AI Prompt:</span><br><span class="line">&quot;Li Ming suddenly looks up toward the cafe entrance, eyes wide in shock. His phone begins to slip from his left hand, halfway to the table. Medium close-up, shallow depth of field, natural lighting. Background slightly blurred.&quot;</span><br><span class="line"></span><br><span class="line">Shot 3（10–15秒）</span><br><span class="line">AI Prompt:</span><br><span class="line">&quot;A woman (Xiao Yu) enters the cafe, sees Li Ming, and pauses. She hesitates, then walks slowly toward his table. Over-the-shoulder shot from Li Ming&#x27;s perspective, soft focus on her face showing uncertainty.&quot;</span><br><span class="line"></span><br><span class="line">Shot 4（15–20秒）</span><br><span class="line">AI Prompt:</span><br><span class="line">&quot;Xiao Yu stands beside Li Ming&#x27;s table. She says softly: &#x27;Long time no see.&#x27; Li Ming looks up nervously, hands gripping the edge of the table. Two-shot, eye-level, warm cafe lighting.&quot;</span><br></pre></td></tr></table></figure>
<p>智能体返回结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="集成方式">集成方式</h3>
<p>集成到Web应用（API）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Flask示例</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify</span><br><span class="line"><span class="keyword">from</span> hengline.generate_agent <span class="keyword">import</span> generate_storyboard</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/generate&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate</span>():</span><br><span class="line">    data = request.json</span><br><span class="line">    result = generate_storyboard(</span><br><span class="line">        script_text=data[<span class="string">&#x27;script_text&#x27;</span>],</span><br><span class="line">        style=data.get(<span class="string">&#x27;style&#x27;</span>, <span class="string">&#x27;realistic&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> jsonify(result)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>集成到 LangGraph 工作流节点</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> StateGraph, END</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义全局状态</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StoryboardState</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    raw_script: <span class="built_in">str</span></span><br><span class="line">    style: <span class="built_in">str</span></span><br><span class="line">    storyboard: <span class="built_in">list</span></span><br><span class="line">    continuity_state: <span class="built_in">dict</span></span><br><span class="line">    error: <span class="type">Optional</span>[<span class="built_in">str</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分镜生成节点</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">storyboard_agent_node</span>(<span class="params">state: StoryboardState</span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = generate_storyboard(</span><br><span class="line">            script_text=state[<span class="string">&quot;raw_script&quot;</span>],</span><br><span class="line">            style=state[<span class="string">&quot;style&quot;</span>],</span><br><span class="line">            prev_continuity_state=state.get(<span class="string">&quot;continuity_state&quot;</span>)</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;storyboard&quot;</span>: result[<span class="string">&quot;shots&quot;</span>],</span><br><span class="line">            <span class="string">&quot;continuity_state&quot;</span>: result[<span class="string">&quot;final_continuity_state&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建图</span></span><br><span class="line">workflow = StateGraph(StoryboardState)</span><br><span class="line">workflow.add_node(<span class="string">&quot;generate_storyboard&quot;</span>, storyboard_agent_node)</span><br><span class="line">workflow.set_entry_point(<span class="string">&quot;generate_storyboard&quot;</span>)</span><br><span class="line">workflow.add_edge(<span class="string">&quot;generate_storyboard&quot;</span>, END)</span><br><span class="line"></span><br><span class="line">app = workflow.<span class="built_in">compile</span>()</span><br></pre></td></tr></table></figure>
<p>集成到A2A系统</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># A2A Agent示例</span></span><br><span class="line"><span class="keyword">from</span> a2a <span class="keyword">import</span> Agent, Message</span><br><span class="line"><span class="keyword">from</span> hengline.generate_agent <span class="keyword">import</span> generate_storyboard</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StoryboardAgent</span>(<span class="title class_ inherited__">Agent</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_message</span>(<span class="params">self, message: Message</span>) -&gt; Message:</span><br><span class="line">        <span class="comment"># 处理传入的剧本消息</span></span><br><span class="line">        script = message.content</span><br><span class="line">        storyboard = generate_storyboard(script)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 返回分镜结果</span></span><br><span class="line">        <span class="keyword">return</span> Message(</span><br><span class="line">            content=storyboard,</span><br><span class="line">            <span class="built_in">type</span>=<span class="string">&quot;storyboard_result&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册和使用Agent</span></span><br><span class="line">agent = StoryboardAgent(name=<span class="string">&quot;storyboard_agent&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="技术架构（多智能体）">技术架构（多智能体）</h2>
<p><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="/imgs/ai/pengline-converted-image-20251122.webp" alt="image-20251027171255745"></p>
<p><strong>智能体框架</strong>: LangGraph（专为多智能体状态机设计）</p>
<table>
<thead>
<tr>
<th>智能体</th>
<th>职责</th>
<th>关键技术栈</th>
<th>输入 → 输出</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.<strong>剧本解析智能体</strong></td>
<td>解析原始剧本，统一格式的剧本元素（场景、角色、动作、对话、情绪）</td>
<td>LlamaIndex + 规则引擎</td>
<td>原始文本 → 结构化对象（UnifiedScript）</td>
</tr>
<tr>
<td>2.<strong>时序规划智能体</strong></td>
<td>将剧本按 5 秒粒度切分，估算每段动作/对话时长，避免超时</td>
<td>规则库 + LLM（微调动作时长模型）</td>
<td>结构化对象（UnifiedScript） → 带时间戳的分段计划（TimelinePlan）</td>
</tr>
<tr>
<td>3.<strong>连续性守护智能体</strong></td>
<td>跟踪角色状态（位置、姿势、情绪、道具），生成/验证连续性锚点</td>
<td>向量记忆 + 状态机</td>
<td>上一段状态 + 当前动作 → 带强约束的锚点约束（AnchoredTimeline）</td>
</tr>
<tr>
<td>4.<strong>分镜生成智能体</strong></td>
<td>生成符合 AI 视频模型要求的提示词（含镜头、光线、构图）</td>
<td>LangChain + LLM（GPT-4o/Claude）</td>
<td>分段内容 + 连续性锚点 → AI Prompt 提示词 + 技术参数（SoraReadyShots）</td>
</tr>
<tr>
<td>5.<strong>质量审查智能体</strong></td>
<td>检查分镜是否连贯、是否超时、角色是否漂移</td>
<td>规则检查 + LLM 自反思</td>
<td>分镜序列 → 修正建议或通过</td>
</tr>
</tbody>
</table>
<blockquote>
<ol>
<li class="lvl-3">
<p><strong>解析 vs 规划</strong>：智能体1只做理解，智能体2只做规划</p>
</li>
<li class="lvl-3">
<p><strong>规划 vs 连贯性</strong>：智能体2做时间规划，智能体3做空间/视觉连贯性</p>
</li>
<li class="lvl-3">
<p><strong>连贯性 vs 视觉化</strong>：智能体3定义约束，智能体4生成视觉描述</p>
</li>
<li class="lvl-3">
<p><strong>生成 vs 验证</strong>：智能体4生成内容，智能体5验证质量</p>
</li>
</ol>
</blockquote>
<p><strong>智能体间的数据流</strong></p>
<p><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="/imgs/ai/pengline-mermaid-flowchart-1767515343751.png" alt="pengline-mermaid-flowchart-1767515343751"></p>
<p><strong>优势：</strong></p>
<blockquote>
<ul class="lvl-1">
<li class="lvl-2">
<p><strong>可测试性</strong>：每个智能体可独立测试</p>
</li>
<li class="lvl-2">
<p><strong>可维护性</strong>：修改一个智能体不影响其他</p>
</li>
<li class="lvl-2">
<p><strong>可扩展性</strong>：容易替换或增强单个组件</p>
</li>
<li class="lvl-2">
<p><strong>错误隔离</strong>：问题可定位到具体智能体</p>
</li>
</ul>
</blockquote>
<h3 id="剧本解析智能体">剧本解析智能体</h3>
<p><strong>核心目标</strong>：将任意格式剧本转换为<strong>统一的结构化中间表示</strong>，执行剧本的格式转换和语义提取。</p>
<p><strong>关键技术</strong>：格式检测 + 语义提取 + 结构标准化</p>
<blockquote>
<p>支持四种类型的剧本：</p>
<ul class="lvl-1">
<li class="lvl-2">自然语言剧本</li>
<li class="lvl-2">标准电影剧本</li>
<li class="lvl-2">AI生成的分镜剧本</li>
<li class="lvl-2">结构化场景</li>
</ul>
</blockquote>
<h4 id="核心功能">核心功能</h4>
<ol>
<li class="lvl-3">
<p>自动识别输入格式，根据不同的剧本做不同处理</p>
</li>
<li class="lvl-3">
<p>通过剧本复杂度、类型、解析置信度，判断本地解析还是AI 解析（80%规则保证效率，20%AI处理复杂语义）</p>
</li>
<li class="lvl-3">
<p>提取语义元素（角色、动作、对话、场景）</p>
</li>
<li class="lvl-3">
<p>转换为统一数据结构</p>
</li>
<li class="lvl-3">
<p>保持原始语义，不添加时间信息</p>
</li>
</ol>
<p><strong>解析规则应包含</strong>：</p>
<ol>
<li class="lvl-3">
<p>动作切分规则：</p>
<ul class="lvl-2">
<li class="lvl-5">遇到句号/分号/连接词（“突然”“随后”） → 拆分动作</li>
<li class="lvl-5">对话独立为 <code>dialogue</code> 字段</li>
</ul>
</li>
<li class="lvl-3">
<p>角色行为去重：</p>
<ul class="lvl-2">
<li class="lvl-5">未出镜角色（如电话声音）不生成独立 action</li>
</ul>
</li>
<li class="lvl-3">
<p>情绪标准化：</p>
<ul class="lvl-2">
<li class="lvl-5">
<p>将文学描述映射到预定义情绪库：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EMOTION_MAP = &#123;</span><br><span class="line">    <span class="string">&quot;恐惧中夹杂震惊&quot;</span>: [<span class="string">&quot;震惊&quot;</span>, <span class="string">&quot;恐惧&quot;</span>],</span><br><span class="line">    <span class="string">&quot;低沉压抑&quot;</span>: [<span class="string">&quot;压抑&quot;</span>, <span class="string">&quot;愧疚&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<h4 id="关键技术">关键技术</h4>
<p>格式检测 + 语义提取 + 结构标准化</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>LlamaIndex + 规则增强的 LLM</p>
</li>
<li class="lvl-2">
<p>中文分词（jieba）+ 正则匹配</p>
</li>
<li class="lvl-2">
<p>自动识别场景、角色、动作、对话、情绪</p>
</li>
<li class="lvl-2">
<p>推断角色外观</p>
</li>
</ul>
<h4 id="输入输出-2">输入输出</h4>
<p>输入，自然语言剧本：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;script_text&quot;</span>: <span class="string">&quot;深夜11点，城市公寓客厅，窗外大雨滂沱。林然裹着旧羊毛毯蜷在沙发里，电视静音播放着黑白老电影。茶几上半杯凉茶已凝出水雾，旁边摊开一本旧相册。手机突然震动，屏幕亮起“未知号码”。她盯着看了三秒，指尖悬停在接听键上方，喉头轻轻滚动。终于，她按下接听，将手机贴到耳边。电话那头沉默两秒，传来一个沙哑的男声：“是我。”  林然的手指瞬间收紧，指节泛白，呼吸停滞了一瞬。  她声音微颤：“……陈默？你还好吗？”  对方停顿片刻，低声说：“我回来了。” 林然猛地坐直，瞳孔收缩，泪水在眼眶中打转。她张了张嘴，却发不出声音，只有毛毯从肩头滑落。”&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;format_type&quot;</span><span class="punctuation">:</span> str<span class="punctuation">,</span>          # 原始格式类型</span><br><span class="line">    <span class="attr">&quot;scenes&quot;</span><span class="punctuation">:</span> List<span class="punctuation">[</span>Scene<span class="punctuation">]</span><span class="punctuation">,</span>       # 场景列表（无时间信息）</span><br><span class="line">    <span class="attr">&quot;characters&quot;</span><span class="punctuation">:</span> List<span class="punctuation">[</span>Character<span class="punctuation">]</span><span class="punctuation">,</span> # 角色列表</span><br><span class="line">    <span class="attr">&quot;dialogues&quot;</span><span class="punctuation">:</span> List<span class="punctuation">[</span>Dialogue<span class="punctuation">]</span><span class="punctuation">,</span> # 对话列表</span><br><span class="line">    <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> List<span class="punctuation">[</span>Action<span class="punctuation">]</span><span class="punctuation">,</span>     # 动作列表</span><br><span class="line">    <span class="attr">&quot;parsing_confidence&quot;</span><span class="punctuation">:</span> Dict   # 解析置信度</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="时序规划智能体">时序规划智能体</h3>
<p><strong>核心目标</strong>：为剧本元素估算时长，并智能分割为5秒片段</p>
<p><strong>关键技术</strong>：时长估算算法 + 5秒分片 + 节奏分析</p>
<blockquote>
<p>将<strong>结构化的原子动作序列</strong> → 拆分为 <strong>N 个 5 秒分镜段（segments）</strong>，确保：</p>
<ol>
<li class="lvl-3"><strong>每段总时长 ≤ 5.5 秒</strong>（留 0.5 秒缓冲防超时）</li>
<li class="lvl-3"><strong>语义完整性</strong>：不拆分单句对话、连续动作</li>
<li class="lvl-3"><strong>输出可执行</strong>：每段包含动作列表 + 精确时长估算</li>
</ol>
</blockquote>
<h4 id="处理流程">处理流程</h4>
<p>步骤 1：初始化</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>加载 <strong>动作时长估算器</strong>（含动词库 + 对话模型）</p>
</li>
<li class="lvl-2">
<p>设置 <strong>最大分段时长 = 5.5 秒</strong></p>
</li>
</ul>
<p>步骤 2：贪心分段（核心算法）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">segments = []</span><br><span class="line">current_segment = []</span><br><span class="line">current_time = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> action <span class="keyword">in</span> actions:</span><br><span class="line">    <span class="comment"># 估算当前动作时长</span></span><br><span class="line">    duration = duration_estimator.estimate(</span><br><span class="line">        action_text=action[<span class="string">&quot;action&quot;</span>] <span class="keyword">or</span> action[<span class="string">&quot;dialogue&quot;</span>],</span><br><span class="line">        emotion=action[<span class="string">&quot;emotion&quot;</span>],</span><br><span class="line">        character_type=get_character_type(action[<span class="string">&quot;character&quot;</span>])</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查是否可加入当前段</span></span><br><span class="line">    <span class="keyword">if</span> current_time + duration &lt;= <span class="number">5.5</span>:</span><br><span class="line">        current_segment.append(action)</span><br><span class="line">        current_time += duration</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 提交当前段</span></span><br><span class="line">        segments.append(create_segment(current_segment, current_time))</span><br><span class="line">        <span class="comment"># 开启新段（当前动作放入新段）</span></span><br><span class="line">        current_segment = [action]</span><br><span class="line">        current_time = duration</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交最后一段</span></span><br><span class="line"><span class="keyword">if</span> current_segment:</span><br><span class="line">    segments.append(create_segment(current_segment, current_time))</span><br></pre></td></tr></table></figure>
<p>步骤 3：语义完整性保护（关键规则）</p>
<p>在贪心算法前预标记 <strong>不可分割单元（atomic units）</strong></p>
<table>
<thead>
<tr>
<th>场景</th>
<th>处理方式</th>
</tr>
</thead>
<tbody>
<tr>
<td>单句对话</td>
<td>强制整句放入一段（即使超 5.5 秒）</td>
</tr>
<tr>
<td>连续动作</td>
<td>如“起身→走向门口”，尽量同段</td>
</tr>
<tr>
<td>情绪突变</td>
<td>如“平静→震惊”，优先分段</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>核心算法</strong>：</p>
<ol>
<li class="lvl-3">混合时长估算（规则+AI）</li>
<li class="lvl-3">智能5秒分片</li>
<li class="lvl-3">连续性锚点生成</li>
<li class="lvl-3">节奏分析</li>
</ol>
</blockquote>
<h4 id="注意事项">注意事项</h4>
<blockquote>
<ol>
<li class="lvl-3">
<p><strong>缓冲区管理</strong></p>
<ul class="lvl-3">
<li class="lvl-5">
<p>目标时长：5.0 秒</p>
</li>
<li class="lvl-5">
<p>允许上限：5.5 秒（防动作截断）</p>
</li>
<li class="lvl-5">
<p><strong>绝不允许 &lt; 0.4 秒</strong>（防空镜头）</p>
</li>
</ul>
</li>
<li class="lvl-3">
<p><strong>长动作处理</strong></p>
<ul class="lvl-3">
<li class="lvl-5">若单动作 &gt; 5.5 秒（如“奔跑穿过街道”）：
<ul class="lvl-5">
<li class="lvl-7">自动拆分为 <strong>起始 + 中间 + 结束</strong> 三段</li>
<li class="lvl-7">注入 <strong>continuity_anchor</strong> 保持连贯</li>
</ul>
</li>
</ul>
</li>
<li class="lvl-3">
<p><strong>情绪时长补偿</strong></p>
<ul class="lvl-3">
<li class="lvl-5">
<p>高强度情绪（如“崩溃大哭”）自动 +0.5 秒</p>
</li>
<li class="lvl-5">
<p>低强度情绪（如“平静注视”）自动 -0.3 秒</p>
</li>
</ul>
</li>
</ol>
</blockquote>
<h4 id="输出示例">输出示例</h4>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;timeline_segments&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>       # <span class="number">5</span>秒时间片段</span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;segment_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s001&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time_range&quot;</span><span class="punctuation">:</span> (<span class="number">0.0</span><span class="punctuation">,</span> <span class="number">5.0</span>)<span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">5.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;visual_content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5秒内的视觉描述&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;continuity_hooks&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span>  # 衔接要求</span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;duration_estimations&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span>   # 每个元素的时长估算</span><br><span class="line">    <span class="attr">&quot;continuity_anchors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span>     # 片段间衔接锚点</span><br><span class="line">    <span class="attr">&quot;pacing_analysis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span>         # 节奏分析</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="连续性守护智能体">连续性守护智能体</h3>
<p><strong>核心目标</strong>：确保5秒片段间的视觉/逻辑连贯性</p>
<blockquote>
<ol>
<li class="lvl-3">
<p><strong>状态跟踪系统</strong>：实时跟踪角色位置、姿势、服装、道具状态</p>
</li>
<li class="lvl-3">
<p><strong>视觉一致性验证</strong>：确保片段间视觉元素的一致性</p>
</li>
<li class="lvl-3">
<p><strong>物理合理性检查</strong>：验证动作和移动的物理可行性</p>
</li>
<li class="lvl-3">
<p><strong>生成强制性锚点</strong>：创建必须遵守的视觉匹配约束</p>
</li>
</ol>
</blockquote>
<p><strong>关键技术</strong>：视觉一致性验证 + 状态跟踪 + 物理合理性检查</p>
<blockquote>
<p><strong>解决 AI 视频生成中最致命的问题</strong>：<strong>“角色漂移（Character Drift）” + “动作断裂（Action Discontinuity）”</strong></p>
<p>通过<strong>跨分镜状态跟踪</strong>，确保：</p>
<ul class="lvl-1">
<li class="lvl-2">
<p>角色外观/位置/姿态严格一致</p>
</li>
<li class="lvl-2">
<p>动作状态无缝衔接（如“手抖”→“握紧”）</p>
</li>
<li class="lvl-2">
<p>道具轨迹连续（如“毛毯滑落”→“手机脱手”）</p>
</li>
</ul>
</blockquote>
<h4 id="核心功能-2">核心功能</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p>状态机模型（跟踪角色状态变化）</p>
</li>
<li class="lvl-2">
<p>空间关系推理（角色相对位置）</p>
</li>
<li class="lvl-2">
<p>视觉元素匹配算法</p>
</li>
<li class="lvl-2">
<p>物理运动验证</p>
</li>
</ul>
<p><strong>1. 状态跟踪的精确性</strong></p>
<ul class="lvl-0">
<li class="lvl-2">
<p>实时跟踪角色位置、姿势、外观</p>
</li>
<li class="lvl-2">
<p>道具状态和位置的历史记录</p>
</li>
<li class="lvl-2">
<p>环境变化的渐进跟踪</p>
</li>
</ul>
<p><strong>2. 约束生成的智能性</strong></p>
<ul class="lvl-0">
<li class="lvl-2">
<p>自动识别需要保持一致的视觉元素</p>
</li>
<li class="lvl-2">
<p>根据内容推断必须的匹配要求</p>
</li>
<li class="lvl-2">
<p>优先级系统区分强制约束和建议约束</p>
</li>
</ul>
<p><strong>3. 物理验证的严谨性</strong></p>
<ul class="lvl-0">
<li class="lvl-2">
<p>移动速度和距离的合理性检查</p>
</li>
<li class="lvl-2">
<p>交互动作的物理可行性验证</p>
</li>
<li class="lvl-2">
<p>空间关系的逻辑一致性检查</p>
</li>
</ul>
<p><strong>4. 问题解决的主动性</strong></p>
<ul class="lvl-0">
<li class="lvl-2">
<p>自动检测连续性断裂点</p>
</li>
<li class="lvl-2">
<p>提供具体的修复建议</p>
</li>
<li class="lvl-2">
<p>尝试自动调整约束</p>
</li>
</ul>
<h4 id="检测器">检测器</h4>
<ol>
<li class="lvl-3">
<p><strong>CollisionDetector</strong> - 碰撞检测器</p>
</li>
</ol>
<ul class="lvl-0">
<li class="lvl-2">
<p>支持多种边界体类型（球体、盒体等）</p>
</li>
<li class="lvl-2">
<p>宽相位和窄相位碰撞检测</p>
</li>
<li class="lvl-2">
<p>碰撞响应计算和物理属性</p>
</li>
<li class="lvl-2">
<p>碰撞统计和可视化</p>
</li>
</ul>
<ol start="2">
<li class="lvl-3">
<p><strong>MotionAnalyzer</strong> - 运动分析器</p>
</li>
</ol>
<ul class="lvl-0">
<li class="lvl-2">
<p>运动轨迹分析和分类</p>
</li>
<li class="lvl-2">
<p>加速度、平滑度、曲率计算</p>
</li>
<li class="lvl-2">
<p>物理合理性评估</p>
</li>
<li class="lvl-2">
<p>运动模式检测和预测</p>
</li>
</ul>
<ol start="3">
<li class="lvl-3">
<p><strong>MaterialDatabase</strong> - 材料数据库</p>
</li>
</ol>
<ul class="lvl-0">
<li class="lvl-2">
<p>完整的材料属性管理</p>
</li>
<li class="lvl-2">
<p>材料搜索、推荐和组合</p>
</li>
<li class="lvl-2">
<p>材料统计和可视化卡片</p>
</li>
<li class="lvl-2">
<p>导入导出功能</p>
</li>
</ul>
<ol start="4">
<li class="lvl-3">
<p><strong>TemporalGraph</strong> - 时间图</p>
</li>
</ol>
<ul class="lvl-0">
<li class="lvl-2">
<p>时间序列事件管理</p>
</li>
<li class="lvl-2">
<p>事件关系和相关性分析</p>
</li>
<li class="lvl-2">
<p>时间模式检测和预测</p>
</li>
<li class="lvl-2">
<p>时间图可视化和摘要</p>
</li>
</ul>
<ol start="5">
<li class="lvl-3">
<p><strong>SpatialIndex</strong> - 空间索引</p>
</li>
</ol>
<ul class="lvl-0">
<li class="lvl-2">
<p>高效的空间查询和邻居查找</p>
</li>
<li class="lvl-2">
<p>射线投射和碰撞检测</p>
</li>
<li class="lvl-2">
<p>空间关系管理和分析</p>
</li>
<li class="lvl-2">
<p>空间分布可视化</p>
</li>
</ul>
<ol start="6">
<li class="lvl-3">
<p><strong>ChangeDetector</strong> - 变化检测器</p>
</li>
</ol>
<ul class="lvl-0">
<li class="lvl-2">
<p>状态变化检测和分析</p>
</li>
<li class="lvl-2">
<p>漂移检测和基线管理</p>
</li>
<li class="lvl-2">
<p>变化模式识别</p>
</li>
<li class="lvl-2">
<p>变化统计和报告</p>
</li>
</ul>
<ol start="7">
<li class="lvl-3">
<p><strong>ConsistencyChecker</strong> - 一致性检查器</p>
</li>
</ol>
<ul class="lvl-0">
<li class="lvl-2">
<p>多维度一致性规则（时间、空间、逻辑、物理）</p>
</li>
<li class="lvl-2">
<p>规则违反检测和报告</p>
</li>
<li class="lvl-2">
<p>一致性趋势分析</p>
</li>
<li class="lvl-2">
<p>修复建议生成</p>
</li>
</ul>
<ol start="8">
<li class="lvl-3">
<p><strong>AnomalyDetector</strong> - 异常检测器</p>
</li>
</ol>
<ul class="lvl-0">
<li class="lvl-2">
<p>属性异常检测</p>
</li>
<li class="lvl-2">
<p>异常统计和模式识别</p>
</li>
</ul>
<h4 id="约束生成">约束生成</h4>
<ol>
<li class="lvl-3">
<p><strong>角色外貌约束生成</strong> (<code>_generate_character_appearance_constraints</code>)</p>
</li>
</ol>
<ul class="lvl-0">
<li class="lvl-2">
<p>发型、服装、肤色、年龄特征、配饰的一致性约束</p>
</li>
<li class="lvl-2">
<p>详细的参数配置，包括变化范围和刚性控制</p>
</li>
</ul>
<ol start="2">
<li class="lvl-3">
<p><strong>道具位置约束生成</strong> (<code>_generate_prop_position_constraints</code>)</p>
</li>
</ol>
<ul class="lvl-0">
<li class="lvl-2">
<p>位置稳定性、物理属性、交互一致性约束</p>
</li>
<li class="lvl-2">
<p>环境关系和时间行为约束</p>
</li>
</ul>
<ol start="3">
<li class="lvl-3">
<p><strong>环境光照约束生成</strong> (<code>_generate_environment_lighting_constraints</code>)</p>
</li>
</ol>
<ul class="lvl-0">
<li class="lvl-2">
<p>全局光照、关键光源、填充光、环境光遮蔽约束</p>
</li>
<li class="lvl-2">
<p>反射和体积光约束</p>
</li>
</ul>
<ol start="4">
<li class="lvl-3">
<p><strong>相机运动约束生成</strong> (<code>_generate_camera_movement_constraints</code>)</p>
</li>
</ol>
<ul class="lvl-0">
<li class="lvl-2">
<p>相机参数、位置、旋转、镜头运动一致性约束</p>
</li>
<li class="lvl-2">
<p>帧率、取景、稳定性约束</p>
</li>
</ul>
<ol start="5">
<li class="lvl-3">
<p><strong>时间约束生成</strong> (<code>_generate_temporal_constraints</code>)</p>
</li>
</ol>
<ul class="lvl-0">
<li class="lvl-2">
<p>时间流、时序事件、动画时间、物理模拟时间约束</p>
</li>
<li class="lvl-2">
<p>时间效果、同步和时间连续性约束</p>
</li>
</ul>
<ol start="6">
<li class="lvl-3">
<p><strong>空间约束生成</strong> (<code>_generate_spatial_constraints</code>)</p>
</li>
</ol>
<ul class="lvl-0">
<li class="lvl-2">
<p>空间关系、比例、碰撞、物理空间约束</p>
</li>
<li class="lvl-2">
<p>遮挡、连续性、层级、网格拓扑约束</p>
</li>
</ul>
<ol start="7">
<li class="lvl-3">
<p><strong>物理约束生成</strong> (<code>_generate_physical_constraints</code>)</p>
</li>
</ol>
<ul class="lvl-0">
<li class="lvl-2">
<p>牛顿力学、材料物理、流体动力学约束</p>
</li>
<li class="lvl-2">
<p>刚体、软体、热力学、光学、声学、生物力学约束</p>
</li>
</ul>
<ol start="8">
<li class="lvl-3">
<p><strong>叙事约束生成</strong> (<code>_generate_narrative_constraints</code>)</p>
</li>
</ol>
<ul class="lvl-0">
<li class="lvl-2">
<p>角色发展、情节连续性、时间线约束</p>
</li>
<li class="lvl-2">
<p>对话、主题、环境叙事、冲突解决约束</p>
</li>
<li class="lvl-2">
<p>观众认知、类型、文化一致性约束</p>
</li>
</ul>
<h4 id="输出示例-2">输出示例</h4>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;anchored_segments&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;segment_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s001&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;hard_constraints&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;character_appearance&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;林然必须穿着灰色毛衣&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;sora_instruction&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Character Lin Ran must wear grey sweater&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;visual_match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;match_with_previous&quot;</span><span class="punctuation">:</span> <span class="string">&quot;林然坐在沙发上的姿势&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;key_elements&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;沙发角度&quot;</span><span class="punctuation">,</span> <span class="string">&quot;窗户雨景&quot;</span><span class="punctuation">,</span> <span class="string">&quot;电视光线&quot;</span><span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;start_state&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;林然&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="string">&quot;沙发&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;posture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;蜷缩&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;clothing&quot;</span><span class="punctuation">:</span> <span class="string">&quot;灰色毛衣&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_state&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;林然&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="string">&quot;沙发&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;posture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;前倾&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;clothing&quot;</span><span class="punctuation">:</span> <span class="string">&quot;灰色毛衣&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;continuity_score&quot;</span><span class="punctuation">:</span> <span class="number">0.92</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;critical_issues&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span>  # 如果为空，表示连续性良好</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="分镜生成智能体">分镜生成智能体</h3>
<p><strong>核心目标</strong>：将上一个智能体的连续性约束<strong>转换</strong>为Sora优化的视觉提示词序列</p>
<p><strong>关键技术</strong>：Sora提示词工程 + 视觉风格编码 + 技术参数优化</p>
<blockquote>
<ol>
<li class="lvl-3">
<p>将锚点转换为Sora可理解的约束</p>
</li>
<li class="lvl-3">
<p>优化视觉描述为Sora风格</p>
</li>
<li class="lvl-3">
<p>添加技术参数（镜头、灯光、运动）</p>
</li>
<li class="lvl-3">
<p>确保风格一致性</p>
</li>
</ol>
</blockquote>
<pre class="mermaid">flowchart LR
    subgraph A [输入与解析层]
        direction LR
        A1[“剧本结构化数据<br>（来自剧本智能体）”] --> A2[“自然语言处理引擎<br>（解析场景/动作/台词）”]
    end

    subgraph B [分析与决策层]
        B1[“分镜逻辑决策器”] --> B2[“时长分配算法”]
        B2 --> B3[“景别与运镜策略库”]
    end

    subgraph C [生成与输出层]
        C1[“分镜脚本组装器”] --> C2[“标准格式分镜脚本”]
        C2 --> C3[“可视化故事板（可选）”]
    end

    A --> B
    B --> C

    style A fill:#e1f5fe
    style B fill:#f3e5f5
    style C fill:#e8f5e8</pre>
<h4 id="核心功能-3">核心功能</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>时间精准控制</strong>：能按5-10秒为单位拆分剧本，确保节奏符合短视频平台。</p>
</li>
<li class="lvl-2">
<p><strong>专业分镜生成</strong>：自动规划镜头景别（特写、中景、全景）、运镜方式（推、拉、摇、移）和画面内容。</p>
</li>
<li class="lvl-2">
<p><strong>声画关系设计</strong>：为每个镜头匹配音效、音乐和关键台词。</p>
</li>
<li class="lvl-2">
<p><strong>情绪与节奏把控</strong>：通过镜头语言（如手持晃动、慢镜头、色调变化）强化故事的情感转折。</p>
</li>
<li class="lvl-2">
<p><strong>提供拍摄与生成建议</strong>：输出视觉风格、道具细节、扩展可能性等实操指南。</p>
</li>
</ul>
<p>​</p>
<pre class="mermaid">flowchart LR
    subgraph A [用户输入]
        direction LR
        A1[“完整剧本”] --> A2[“故事梗概/灵感”]
    end
    
    A --> B{“智能体处理阶段”}
    
    subgraph B
        B1[“步骤1: 剧本分析<br>提取核心叙事结构”] --> B2[“步骤2: 节奏划分<br>按时长（如每5秒）切分段落”] --> B3[“步骤3: 分镜转译<br>将文字逐一转换为视听指令”]
    end
    
    B --> C[“标准化分镜头脚本<br>（核心输出）”]</pre>
<h4 id="标准化输出">标准化输出</h4>
<p>这是智能体最终生成的、可直接使用的成果，其格式如下：</p>
<table>
<thead>
<tr>
<th style="text-align:left">时长 (秒)</th>
<th style="text-align:left">画面 (镜头描述)</th>
<th style="text-align:left">景别/运镜</th>
<th style="text-align:left">声音/音效</th>
<th style="text-align:left">表演/备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>0-5</strong></td>
<td style="text-align:left">雨夜窗景，雨水在玻璃上划出光晕。 镜头拉近，室内林然蜷在沙发上的剪影。</td>
<td style="text-align:left">全景→特写，缓慢推进</td>
<td style="text-align:left">密集雨声，远处闷雷</td>
<td style="text-align:left">林然裹紧毯子，眼神空洞。</td>
</tr>
<tr>
<td style="text-align:left"><strong>6-10</strong></td>
<td style="text-align:left">镜头扫过茶几：凉茶、旧相册。 手机震动，屏幕亮起“未知号码”。</td>
<td style="text-align:left">中景横摇→物品特写</td>
<td style="text-align:left">手机“嗡嗡”震动声</td>
<td style="text-align:left">林然目光被吸引，身体微僵。</td>
</tr>
<tr>
<td style="text-align:left"><strong>11-15</strong></td>
<td style="text-align:left">林然的脸，屏幕光照亮一半面容。</td>
<td style="text-align:left">正面特写</td>
<td style="text-align:left">雨声持续，来电铃声</td>
<td style="text-align:left">手指悬在接听键上方， 轻微颤抖，吞咽。</td>
</tr>
<tr>
<td style="text-align:left"><strong>…</strong></td>
<td style="text-align:left">…</td>
<td style="text-align:left">…</td>
<td style="text-align:left">…</td>
<td style="text-align:left">…</td>
</tr>
</tbody>
</table>
<p><strong>表格后通常会附上关键的“拍摄建议”</strong>，例如：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>视觉风格</strong>：前半段冷色调（都市疏离感），对话开始后色调转暖。</p>
</li>
<li class="lvl-2">
<p><strong>节奏控制</strong>：紧张时用手持晃动镜头，关键对话用浅景深特写，结尾用慢镜头营造余韵。</p>
</li>
<li class="lvl-2">
<p><strong>道具细节</strong>：豆浆袋上的水珠、名片的简约设计等。</p>
</li>
</ul>
<p><strong>先进的色彩处理系统</strong></p>
<ul class="lvl-0">
<li class="lvl-2">
<p>色彩转换和调整</p>
</li>
<li class="lvl-2">
<p>情绪到色彩的映射</p>
</li>
<li class="lvl-2">
<p>电影感调色板生成</p>
</li>
<li class="lvl-2">
<p>色彩和谐度计算</p>
</li>
</ul>
<p><strong>专业的相机预设库</strong></p>
<ul class="lvl-0">
<li class="lvl-2">
<p>8种不同的拍摄风格</p>
</li>
<li class="lvl-2">
<p>导演风格模拟</p>
</li>
<li class="lvl-2">
<p>内容类型优化建议</p>
</li>
<li class="lvl-2">
<p>镜头语言最佳实践</p>
</li>
</ul>
<p><strong>强大的约束配置系统</strong></p>
<ul class="lvl-0">
<li class="lvl-2">
<p>约束分类和优先级管理</p>
</li>
<li class="lvl-2">
<p>自动约束参数提取</p>
</li>
<li class="lvl-2">
<p>约束冲突解决</p>
</li>
<li class="lvl-2">
<p>验证和评分系统</p>
</li>
</ul>
<p><strong>完整的工具链</strong></p>
<ul class="lvl-0">
<li class="lvl-2">
<p>验证工具确保数据质量</p>
</li>
<li class="lvl-2">
<p>提示词处理工具</p>
</li>
<li class="lvl-2">
<p>颜色处理工具</p>
</li>
<li class="lvl-2">
<p>配置管理工具</p>
</li>
</ul>
<h4 id="输出示例-3">输出示例</h4>
<h3 id="质量审查智能体">质量审查智能体</h3>
<p><strong>核心目标</strong>：整体质量把控和问题检测，验证上一智能体生成的Sora提示词序列是否符合所有连续性约束，并确保整体质量</p>
<p><strong>关键技术</strong>：多维度质量评估 + 问题检测 + 自动修复建议</p>
<blockquote>
<ol>
<li class="lvl-3">
<p>检查时间连续性</p>
</li>
<li class="lvl-3">
<p>验证视觉连贯性</p>
</li>
<li class="lvl-3">
<p>检测角色漂移</p>
</li>
<li class="lvl-3">
<p>评估整体节奏</p>
</li>
</ol>
<p><strong>客观评审 + 自动修复建议</strong> - 不修改内容，只发现问题并提供修复建议</p>
</blockquote>
<h4 id="四大检查维度">四大检查维度</h4>
<ol>
<li class="lvl-3">
<p><strong>连续性检查</strong>：验证镜头间的视觉和逻辑连续性</p>
</li>
<li class="lvl-3">
<p><strong>约束验证</strong>：确保智能体4的输出满足智能体3的所有约束</p>
</li>
<li class="lvl-3">
<p><strong>视觉质量评估</strong>：评估构图、灯光、色彩、风格质量</p>
</li>
<li class="lvl-3">
<p><strong>技术验证</strong>：验证提示词质量、相机参数合理性、生成可行性</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">输入接收</span><br><span class="line">    ↓</span><br><span class="line">连续性检查 → 位置、外观、动作、时间连续性</span><br><span class="line">    ↓</span><br><span class="line">约束验证 → 角色、道具、环境、相机约束</span><br><span class="line">    ↓</span><br><span class="line">视觉质量评估 → 构图、灯光、色彩、风格</span><br><span class="line">    ↓</span><br><span class="line">技术验证 → 提示词、相机参数、可行性</span><br><span class="line">    ↓</span><br><span class="line">评分计算 → 各维度评分 + 总体评分</span><br><span class="line">    ↓</span><br><span class="line">问题识别 → 关键问题、警告、建议</span><br><span class="line">    ↓</span><br><span class="line">修复建议 → 自动修复 + 手动修复</span><br><span class="line">    ↓</span><br><span class="line">最终决策 → 批准/需修订/需重新生成</span><br><span class="line">    ↓</span><br><span class="line">报告生成 → 完整质量报告</span><br></pre></td></tr></table></figure>
<h4 id="智能化问题识别">智能化问题识别</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p>自动识别关键问题、警告和建议</p>
</li>
<li class="lvl-2">
<p>基于阈值的智能问题分类</p>
</li>
<li class="lvl-2">
<p>问题严重性自动评估</p>
</li>
<li class="lvl-2">
<p>根本原因分析建议</p>
</li>
</ul>
<h4 id="自动修复建议">自动修复建议</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p>智能生成修复建议</p>
</li>
<li class="lvl-2">
<p>支持自动修复和手动修复</p>
</li>
<li class="lvl-2">
<p>修复效果预估</p>
</li>
<li class="lvl-2">
<p>修复复杂度评估</p>
</li>
</ul>
<h4 id="科学评分系统">科学评分系统</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p>多维度的质量评分</p>
</li>
<li class="lvl-2">
<p>加权评分算法</p>
</li>
<li class="lvl-2">
<p>置信度评估</p>
</li>
<li class="lvl-2">
<p>阈值检查</p>
</li>
</ul>
<h4 id="智能决策系统">智能决策系统</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p>基于规则和评分的决策</p>
</li>
<li class="lvl-2">
<p>支持多种审查结果</p>
</li>
<li class="lvl-2">
<p>清晰的下一步行动建议</p>
</li>
<li class="lvl-2">
<p>风险评估</p>
</li>
</ul>
<h4 id="完整报告生成">完整报告生成</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p>详细的检查结果</p>
</li>
<li class="lvl-2">
<p>可视化质量评分</p>
</li>
<li class="lvl-2">
<p>修复建议清单</p>
</li>
<li class="lvl-2">
<p>批准状态明确</p>
</li>
</ul>
<h4 id="高度可配置">高度可配置</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p>可调整的严格度级别</p>
</li>
<li class="lvl-2">
<p>可配置的阈值系统</p>
</li>
<li class="lvl-2">
<p>模块化的检查项</p>
</li>
<li class="lvl-2">
<p>灵活的报告选项</p>
</li>
</ul>
<h2 id="智能体实现细节">智能体实现细节</h2>
<h3 id="场景及动作时长">场景及动作时长</h3>
<p>待完成</p>
<h3 id="提示工程管理">提示工程管理</h3>
<p><strong>剧本分析提示词</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;1.1&quot;</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">&quot;优化剧本解析结果，确保场景、角色和动作的正确解析&quot;</span></span><br><span class="line"><span class="attr">template:</span> <span class="string">|</span></span><br><span class="line"><span class="string">  你是一位专业的剧本分析专家，请根据以下原始解析结果，优化和完善剧本结构：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">  <span class="string">原始解析结果：&#123;raw_script&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="string">要求：</span></span><br><span class="line">  <span class="number">1</span><span class="string">.</span> <span class="string">检查场景、角色对话和动作描述的完整性和准确性</span></span><br><span class="line">  <span class="number">2</span><span class="string">.</span> <span class="string">修正任何明显的解析错误</span></span><br><span class="line">  <span class="number">3</span><span class="string">.</span> <span class="string">确保每个场景都有明确的场景名、时间和地点</span></span><br><span class="line">  <span class="number">4</span><span class="string">.</span> <span class="string">确保每个对话都有明确的角色标识</span></span><br><span class="line">  <span class="number">5</span><span class="string">.</span> <span class="string">补充缺失的动作描述和情感信息</span></span><br><span class="line"></span><br><span class="line">  <span class="string">请直接返回优化后的完整JSON结构，确保格式完全正确。</span></span><br></pre></td></tr></table></figure>
<p><strong>剧本分镜提示词</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;1.4&quot;</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">&quot;生成5秒分镜，含中文画面描述和英文AI视频提示词，优化提示词结构和输出格式&quot;</span></span><br><span class="line"><span class="attr">template:</span> <span class="string">|</span></span><br><span class="line"><span class="string">  你是一位顶尖的电影分镜师和AI视频提示词工程师，精通分镜头设计和视觉叙事。请为一段5秒的短视频生成专业分镜：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">  <span class="comment">## 场景信息</span></span><br><span class="line">  <span class="string">场景位置:</span> &#123;<span class="string">location</span>&#125;</span><br><span class="line">  <span class="string">时间:</span> &#123;<span class="string">time</span>&#125;</span><br><span class="line">  <span class="string">氛围:</span> &#123;<span class="string">atmosphere</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">## 动作序列</span></span><br><span class="line">  &#123;<span class="string">actions_text</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">## 连续性约束</span></span><br><span class="line">  &#123;<span class="string">continuity_constraints_text</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">## 视频风格</span></span><br><span class="line">  &#123;<span class="string">style</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">## 分镜ID</span></span><br><span class="line">  &#123;<span class="string">shot_id</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">## 创作要求</span></span><br><span class="line">  <span class="number">1</span><span class="string">.</span> <span class="string">精确计时:</span> <span class="string">确保所有描述的动作能够在5秒内自然流畅地完成</span></span><br><span class="line">  <span class="number">2</span><span class="string">.</span> <span class="string">生动描述:</span> <span class="string">中文画面描述要具体、生动，包含场景细节、角色状态和情感变化</span></span><br><span class="line">  <span class="number">3</span><span class="string">.</span> <span class="string">专业提示词:</span> <span class="string">英文AI提示词必须详细精确，使用电影术语和视觉描述，适合主流AI视频生成模型</span></span><br><span class="line">  <span class="number">4</span><span class="string">.</span> <span class="string">镜头设计:</span> <span class="string">选择最适合呈现当前场景的镜头类型、角度和运动方式</span></span><br><span class="line">  <span class="number">5</span><span class="string">.</span> <span class="string">连续性保证:</span> <span class="string">严格遵循连续性约束，确保角色外观、位置和状态的一致性</span></span><br><span class="line">  <span class="number">6</span><span class="string">.</span> <span class="string">细节丰富:</span> <span class="string">添加适当的环境细节、光线效果和视觉元素，增强画面表现力</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## 输出格式要求</span></span><br><span class="line">  <span class="string">请严格按照以下JSON格式输出，不要添加任何额外的解释、说明或前缀后缀：</span></span><br><span class="line">  &#123;&#123;</span><br><span class="line">    <span class="attr">&quot;chinese_description&quot;:</span> <span class="string">&quot;详细的中文画面描述，至少200字&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;ai_prompt&quot;:</span> <span class="string">&quot;详细的英文AI视频提示词，包含镜头、构图、灯光、角色和动作描述&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;camera&quot;:</span> &#123;&#123;</span><br><span class="line">      <span class="attr">&quot;shot_type&quot;:</span> <span class="string">&quot;镜头类型，如medium_shot、close_up、wide_shot等&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;angle&quot;:</span> <span class="string">&quot;拍摄角度，如eye-level、high-angle、low-angle等&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;movement&quot;:</span> <span class="string">&quot;镜头运动，如static、pan、tilt、track等&quot;</span></span><br><span class="line">    &#125;&#125;,</span><br><span class="line">    <span class="attr">&quot;initial_state&quot;:</span> [</span><br><span class="line">      &#123;&#123;</span><br><span class="line">        <span class="attr">&quot;character_name&quot;:</span> <span class="string">&quot;角色名&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;pose&quot;:</span> <span class="string">&quot;初始姿势，如standing、sitting、walking等&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;position&quot;:</span> <span class="string">&quot;初始位置，如left、center、right等&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;holding&quot;:</span> <span class="string">&quot;手持物品描述&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;emotion&quot;:</span> <span class="string">&quot;初始情绪描述&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;appearance&quot;:</span> <span class="string">&quot;角色外观详细描述&quot;</span></span><br><span class="line">      &#125;&#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;final_state&quot;:</span> [</span><br><span class="line">      &#123;&#123;</span><br><span class="line">        <span class="attr">&quot;character_name&quot;:</span> <span class="string">&quot;角色名&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;pose&quot;:</span> <span class="string">&quot;结束姿势&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;position&quot;:</span> <span class="string">&quot;结束位置&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;gaze_direction&quot;:</span> <span class="string">&quot;视线方向描述&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;emotion&quot;:</span> <span class="string">&quot;结束情绪描述&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;holding&quot;:</span> <span class="string">&quot;手持物品描述&quot;</span></span><br><span class="line">      &#125;&#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="工作流节点定义">工作流节点定义</h3>
<p>包含所有工作流执行功能</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">WorkflowNodes</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;工作流节点集合，封装所有工作流执行功能&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, script_parser, temporal_planner, continuity_guardian, shot_generator, qa_agent, llm=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        初始化工作流节点集合</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            script_parser: 剧本解析器实例</span></span><br><span class="line"><span class="string">            temporal_planner: 时序规划器实例</span></span><br><span class="line"><span class="string">            continuity_guardian: 连续性守卫实例</span></span><br><span class="line"><span class="string">            shot_generator: 分镜生成器实例</span></span><br><span class="line"><span class="string">            qa_agent: 质量审查实例</span></span><br><span class="line"><span class="string">            llm: 语言模型实例（可选）</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.script_parser = script_parser</span><br><span class="line">        <span class="variable language_">self</span>.temporal_planner = temporal_planner</span><br><span class="line">        <span class="variable language_">self</span>.continuity_guardian = continuity_guardian</span><br><span class="line">        <span class="variable language_">self</span>.shot_generator = shot_generator</span><br><span class="line">        <span class="variable language_">self</span>.qa_agent = qa_agent</span><br><span class="line">        <span class="variable language_">self</span>.llm = llm</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse_script_node</span>(<span class="params">self, state: StoryboardWorkflowState</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;解析剧本文本节点&quot;&quot;&quot;</span></span><br><span class="line">        debug(<span class="string">&quot;解析剧本文本节点执行中&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">			<span class="comment"># 使用LLM增强解析</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            error(<span class="string">f&quot;剧本解析失败: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">plan_timeline_node</span>(<span class="params">self, state: StoryboardWorkflowState</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;规划时间线节点&quot;&quot;&quot;</span></span><br><span class="line">        debug(<span class="string">&quot;规划时间线节点执行中&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 进行时序规划</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            error(<span class="string">f&quot;时序规划失败: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_shot_node</span>(<span class="params">self, state: StoryboardWorkflowState</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        生成分镜节点</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        debug(<span class="string">f&quot;生成分镜节点执行中，当前分段索引: <span class="subst">&#123;state[<span class="string">&#x27;current_segment_index&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 获取场景上下文，增加安全检查，生成连续性约束</span></span><br><span class="line">            <span class="comment"># 生成分镜</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            error(<span class="string">f&quot;生成分镜节点发生严重错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">review_shot_node</span>(<span class="params">self, state: StoryboardWorkflowState</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;审查分镜节点，优化警告处理&quot;&quot;&quot;</span></span><br><span class="line">        info(<span class="string">&quot;审查分镜节点执行中&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 审查分镜</span></span><br><span class="line">            <span class="comment"># 记录不同级别的问题</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            error(<span class="string">f&quot;分镜审查失败: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;qa_results&quot;</span>: qa_results</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">extract_continuity_node</span>(<span class="params">self, state: StoryboardWorkflowState</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;提取连续性信息节点&quot;&quot;&quot;</span></span><br><span class="line">        debug(<span class="string">&quot;提取连续性信息节点执行中&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 如果是有效分镜，提取连续性锚点</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            error(<span class="string">f&quot;提取连续性信息失败: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">review_sequence_node</span>(<span class="params">self, state: StoryboardWorkflowState</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;审查分镜序列节点，优化序列连续性审查&quot;&quot;&quot;</span></span><br><span class="line">        debug(<span class="string">&quot;审查分镜序列连续性节点执行中&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:    </span><br><span class="line">            <span class="comment"># 分类错误类型          </span></span><br><span class="line">            <span class="comment"># 记录警告</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            error(<span class="string">f&quot;分镜序列审查失败: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># 返回默认的审查结果</span></span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;sequence_qa&quot;</span>: &#123;<span class="string">&quot;has_continuity_issues&quot;</span>: <span class="literal">False</span>, <span class="string">&quot;issues&quot;</span>: [], <span class="string">&quot;warnings&quot;</span>: [<span class="string">f&quot;审查过程出错: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>]&#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<h3 id="LangGraph-流程编排">LangGraph 流程编排</h3>
<p>多智能体协作流程，负责协调各个智能体完成端到端的分镜生成</p>
<img src= "/img/20241215205335173426721579192.webp" data-lazy-src="/imgs/ai/mermaid-diagram.webp" alt="mermaid-diagram" style="zoom:50%;" />
<p>通过 <code>InMemorySaver</code> 编译工作流</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_init_agents</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;初始化各个智能体&quot;&quot;&quot;</span></span><br><span class="line">    debug(<span class="string">&quot;初始化智能体组件&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">self</span>.script_parser = ScriptParserAgent(llm=<span class="variable language_">self</span>.llm)</span><br><span class="line">    <span class="variable language_">self</span>.temporal_planner = TemporalPlannerAgent()</span><br><span class="line">    <span class="variable language_">self</span>.continuity_guardian = ContinuityGuardianAgent()</span><br><span class="line">    <span class="variable language_">self</span>.shot_generator = ShotGeneratorAgent(llm=<span class="variable language_">self</span>.llm)</span><br><span class="line">    <span class="variable language_">self</span>.qa_agent = QAAgent(llm=<span class="variable language_">self</span>.llm)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 初始化工作流节点集合</span></span><br><span class="line">    <span class="variable language_">self</span>.workflow_nodes = WorkflowNodes(</span><br><span class="line">        script_parser=<span class="variable language_">self</span>.script_parser,</span><br><span class="line">        temporal_planner=<span class="variable language_">self</span>.temporal_planner,</span><br><span class="line">        continuity_guardian=<span class="variable language_">self</span>.continuity_guardian,</span><br><span class="line">        shot_generator=<span class="variable language_">self</span>.shot_generator,</span><br><span class="line">        qa_agent=<span class="variable language_">self</span>.qa_agent,</span><br><span class="line">        llm=<span class="variable language_">self</span>.llm</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_init_workflow</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;初始化基于LangGraph的工作流&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建状态图</span></span><br><span class="line">    workflow = StateGraph(StoryboardWorkflowState)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义工作流节点</span></span><br><span class="line">    workflow.add_node(<span class="string">&quot;parse_script&quot;</span>, <span class="variable language_">self</span>.workflow_nodes.parse_script_node)</span><br><span class="line">    workflow.add_node(<span class="string">&quot;plan_timeline&quot;</span>, <span class="variable language_">self</span>.workflow_nodes.plan_timeline_node)</span><br><span class="line">    workflow.add_node(<span class="string">&quot;generate_shot&quot;</span>, <span class="variable language_">self</span>.workflow_nodes.generate_shot_node)</span><br><span class="line">    workflow.add_node(<span class="string">&quot;review_shot&quot;</span>, <span class="variable language_">self</span>.workflow_nodes.review_shot_node)</span><br><span class="line">    workflow.add_node(<span class="string">&quot;extract_continuity&quot;</span>, <span class="variable language_">self</span>.workflow_nodes.extract_continuity_node)</span><br><span class="line">    workflow.add_node(<span class="string">&quot;review_sequence&quot;</span>, <span class="variable language_">self</span>.workflow_nodes.review_sequence_node)</span><br><span class="line">    workflow.add_node(<span class="string">&quot;fix_continuity&quot;</span>, <span class="variable language_">self</span>.workflow_nodes.fix_continuity_node)</span><br><span class="line">    workflow.add_node(<span class="string">&quot;generate_result&quot;</span>, <span class="variable language_">self</span>.workflow_nodes.generate_result_node)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义条件边，根据解析结果是否有效继续流程（工作流执行流程）</span></span><br><span class="line">    workflow.add_conditional_edges(</span><br><span class="line">        <span class="string">&quot;parse_script&quot;</span>,</span><br><span class="line">        <span class="keyword">lambda</span> state: <span class="string">&quot;continue&quot;</span>,  <span class="comment"># 始终继续到下一步</span></span><br><span class="line">        &#123;<span class="string">&quot;continue&quot;</span>: <span class="string">&quot;plan_timeline&quot;</span>&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    workflow.add_conditional_edges(</span><br><span class="line">        <span class="string">&quot;plan_timeline&quot;</span>,</span><br><span class="line">        <span class="keyword">lambda</span> state: <span class="string">&quot;continue&quot;</span>,</span><br><span class="line">        &#123;<span class="string">&quot;continue&quot;</span>: <span class="string">&quot;generate_shot&quot;</span>&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    workflow.add_conditional_edges(</span><br><span class="line">        <span class="string">&quot;generate_shot&quot;</span>,</span><br><span class="line">        <span class="keyword">lambda</span> state: <span class="string">&quot;continue&quot;</span>,</span><br><span class="line">        &#123;<span class="string">&quot;continue&quot;</span>: <span class="string">&quot;review_shot&quot;</span>&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    workflow.add_conditional_edges(</span><br><span class="line">        <span class="string">&quot;review_shot&quot;</span>,</span><br><span class="line">        <span class="keyword">lambda</span> state: <span class="string">&quot;valid&quot;</span> <span class="keyword">if</span> state[<span class="string">&quot;qa_results&quot;</span>][-<span class="number">1</span>][<span class="string">&quot;is_valid&quot;</span>] <span class="keyword">else</span> <span class="string">&quot;invalid&quot;</span>,</span><br><span class="line">        &#123;<span class="string">&quot;valid&quot;</span>: <span class="string">&quot;extract_continuity&quot;</span>, <span class="string">&quot;invalid&quot;</span>: <span class="string">&quot;check_retry&quot;</span>&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加检查重试逻辑的条件边</span></span><br><span class="line">    workflow.add_conditional_edges(</span><br><span class="line">        <span class="string">&quot;extract_continuity&quot;</span>,</span><br><span class="line">        <span class="keyword">lambda</span> state: <span class="string">&quot;next_segment&quot;</span> <span class="keyword">if</span> state[<span class="string">&quot;current_segment_index&quot;</span>] &lt; <span class="built_in">len</span>(state[<span class="string">&quot;segments&quot;</span>]) - <span class="number">1</span> <span class="keyword">else</span> <span class="string">&quot;review_sequence&quot;</span>,</span><br><span class="line">        &#123;<span class="string">&quot;next_segment&quot;</span>: <span class="string">&quot;generate_shot&quot;</span>, <span class="string">&quot;review_sequence&quot;</span>: <span class="string">&quot;review_sequence&quot;</span>&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加自定义检查重试节点</span></span><br><span class="line">    workflow.add_node(<span class="string">&quot;check_retry&quot;</span>, <span class="variable language_">self</span>.workflow_nodes.check_retry_node)</span><br><span class="line">    workflow.add_conditional_edges(</span><br><span class="line">        <span class="string">&quot;check_retry&quot;</span>,</span><br><span class="line">        <span class="keyword">lambda</span> state: <span class="string">&quot;retry&quot;</span> <span class="keyword">if</span> state[<span class="string">&quot;retry_count&quot;</span>] &lt; state[<span class="string">&quot;max_retries&quot;</span>] <span class="keyword">else</span> <span class="string">&quot;use_current&quot;</span>,</span><br><span class="line">        &#123;<span class="string">&quot;retry&quot;</span>: <span class="string">&quot;generate_shot&quot;</span>, <span class="string">&quot;use_current&quot;</span>: <span class="string">&quot;extract_continuity&quot;</span>&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    workflow.add_conditional_edges(</span><br><span class="line">        <span class="string">&quot;review_sequence&quot;</span>,</span><br><span class="line">        <span class="keyword">lambda</span> state: <span class="string">&quot;fix&quot;</span> <span class="keyword">if</span> state[<span class="string">&quot;sequence_qa&quot;</span>][<span class="string">&quot;has_continuity_issues&quot;</span>] <span class="keyword">else</span> <span class="string">&quot;done&quot;</span>,</span><br><span class="line">        &#123;<span class="string">&quot;fix&quot;</span>: <span class="string">&quot;fix_continuity&quot;</span>, <span class="string">&quot;done&quot;</span>: <span class="string">&quot;generate_result&quot;</span>&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    workflow.add_conditional_edges(</span><br><span class="line">        <span class="string">&quot;fix_continuity&quot;</span>,</span><br><span class="line">        <span class="keyword">lambda</span> state: <span class="string">&quot;continue&quot;</span>,</span><br><span class="line">        &#123;<span class="string">&quot;continue&quot;</span>: <span class="string">&quot;generate_result&quot;</span>&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置入口点</span></span><br><span class="line">    workflow.set_entry_point(<span class="string">&quot;parse_script&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 编译工作流</span></span><br><span class="line">    <span class="keyword">return</span> workflow.<span class="built_in">compile</span>(checkpointer=<span class="variable language_">self</span>.memory)</span><br></pre></td></tr></table></figure>
<h3 id="LlamaIndex-向量检索">LlamaIndex 向量检索</h3>
<h3 id="LangChain-状态记忆">LangChain 状态记忆</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>保存对话历史</strong>：让 LLM 知道上下文</p>
</li>
<li class="lvl-2">
<p><strong>维护状态</strong>：跟踪用户偏好、任务进度</p>
</li>
<li class="lvl-2">
<p><strong>支持多轮交互</strong>：如填表、分步任务</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>类型</th>
<th>适用场景</th>
<th>特点</th>
</tr>
</thead>
<tbody>
<tr>
<td>ConversationBufferMemory</td>
<td>简单对话（基础记忆）</td>
<td>保存全部历史（可能超 token）</td>
</tr>
<tr>
<td>ConversationBufferWindowMemory</td>
<td>长对话（窗口记忆）</td>
<td>仅保存最近 N 轮</td>
</tr>
<tr>
<td>ConversationSummaryMemory</td>
<td>超长对话（摘要记忆）</td>
<td>用 LLM 生成摘要</td>
</tr>
<tr>
<td>EntityMemory</td>
<td>实体跟踪（实体记忆）</td>
<td>记住人物/物品属性</td>
</tr>
<tr>
<td>VectorStoreRetrieverMemory</td>
<td>知识库问答（向量记忆）</td>
<td>从向量库检索相关记忆</td>
</tr>
<tr>
<td>ConversationBufferMemory<br />RedisChatMessageHistory</td>
<td>Redis 持久化</td>
<td>持久化到数据库</td>
</tr>
</tbody>
</table>
<h3 id="LangChain-LLM客户端">LangChain LLM客户端</h3>
<h3 id="LangChain-工具集">LangChain 工具集</h3>
<!-- flag of hidden posts --></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://pengline.github.io">余一叶知秋尽</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://pengline.github.io/2025/10/cmko2qxae0000bou50lmxbew5/">https://pengline.github.io/2025/10/cmko2qxae0000bou50lmxbew5/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://pengline.github.io" target="_blank">余一叶知秋尽</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/LlamaIndex%E5%90%91%E9%87%8F%E6%A3%80%E7%B4%A2/">LlamaIndex向量检索</a><a class="post-meta__tags" href="/tags/LangGraph%E6%B5%81%E7%A8%8B%E7%BC%96%E6%8E%92/">LangGraph流程编排</a><a class="post-meta__tags" href="/tags/%E9%95%BF%E5%89%A7%E6%9C%AC%E6%8B%86%E5%88%86/">长剧本拆分</a><a class="post-meta__tags" href="/tags/%E9%95%BF%E5%89%A7%E6%9C%AC%E5%88%86%E9%95%9C/">长剧本分镜</a><a class="post-meta__tags" href="/tags/%E9%95%BF%E5%89%A7%E6%9C%AC%E8%A7%86%E9%A2%91%E7%94%9F%E6%88%90/">长剧本视频生成</a></div><div class="post-share"><div class="social-share" data-image="/img/essay/small203823RMRXW1760099903.webp" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/10/0194020a663c408fb500dd7532349519/" title="剧本分镜智能体架构设计与实现（MVP版）"><img class="cover" src= "/img/20241215205335173426721579192.webp" data-lazy-src="/img/essay/small073833O6Jvi1754869113.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-29</div><div class="info-item-2">剧本分镜智能体架构设计与实现（MVP版）</div></div><div class="info-2"><div class="info-item-1">该工具将自然语言剧本自动拆分为多个N秒长度的短视频片段脚本，以适用于 AI 视频生成模型，可直接用于“文生视频”。</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%A7%E6%9C%AC%E5%88%86%E9%95%9C%E6%99%BA%E8%83%BD%E4%BD%93"><span class="toc-number">1.</span> <span class="toc-text">剧本分镜智能体</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%9B%AE%E6%A0%87"><span class="toc-number">1.1.</span> <span class="toc-text">核心目标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.2.</span> <span class="toc-text">使用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA"><span class="toc-number">1.3.</span> <span class="toc-text">输入输出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E6%88%90%E6%96%B9%E5%BC%8F"><span class="toc-number">1.4.</span> <span class="toc-text">集成方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84%EF%BC%88%E5%A4%9A%E6%99%BA%E8%83%BD%E4%BD%93%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">技术架构（多智能体）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%A7%E6%9C%AC%E8%A7%A3%E6%9E%90%E6%99%BA%E8%83%BD%E4%BD%93"><span class="toc-number">2.1.</span> <span class="toc-text">剧本解析智能体</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD"><span class="toc-number">2.1.1.</span> <span class="toc-text">核心功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E6%8A%80%E6%9C%AF"><span class="toc-number">2.1.2.</span> <span class="toc-text">关键技术</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA-2"><span class="toc-number">2.1.3.</span> <span class="toc-text">输入输出</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%B6%E5%BA%8F%E8%A7%84%E5%88%92%E6%99%BA%E8%83%BD%E4%BD%93"><span class="toc-number">2.2.</span> <span class="toc-text">时序规划智能体</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-number">2.2.1.</span> <span class="toc-text">处理流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">2.2.2.</span> <span class="toc-text">注意事项</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.2.3.</span> <span class="toc-text">输出示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E7%BB%AD%E6%80%A7%E5%AE%88%E6%8A%A4%E6%99%BA%E8%83%BD%E4%BD%93"><span class="toc-number">2.3.</span> <span class="toc-text">连续性守护智能体</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD-2"><span class="toc-number">2.3.1.</span> <span class="toc-text">核心功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E5%99%A8"><span class="toc-number">2.3.2.</span> <span class="toc-text">检测器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%A6%E6%9D%9F%E7%94%9F%E6%88%90"><span class="toc-number">2.3.3.</span> <span class="toc-text">约束生成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E7%A4%BA%E4%BE%8B-2"><span class="toc-number">2.3.4.</span> <span class="toc-text">输出示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E9%95%9C%E7%94%9F%E6%88%90%E6%99%BA%E8%83%BD%E4%BD%93"><span class="toc-number">2.4.</span> <span class="toc-text">分镜生成智能体</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD-3"><span class="toc-number">2.4.1.</span> <span class="toc-text">核心功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%87%E5%87%86%E5%8C%96%E8%BE%93%E5%87%BA"><span class="toc-number">2.4.2.</span> <span class="toc-text">标准化输出</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E7%A4%BA%E4%BE%8B-3"><span class="toc-number">2.4.3.</span> <span class="toc-text">输出示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%A8%E9%87%8F%E5%AE%A1%E6%9F%A5%E6%99%BA%E8%83%BD%E4%BD%93"><span class="toc-number">2.5.</span> <span class="toc-text">质量审查智能体</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9B%E5%A4%A7%E6%A3%80%E6%9F%A5%E7%BB%B4%E5%BA%A6"><span class="toc-number">2.5.1.</span> <span class="toc-text">四大检查维度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%99%BA%E8%83%BD%E5%8C%96%E9%97%AE%E9%A2%98%E8%AF%86%E5%88%AB"><span class="toc-number">2.5.2.</span> <span class="toc-text">智能化问题识别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="toc-number">2.5.3.</span> <span class="toc-text">自动修复建议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A7%91%E5%AD%A6%E8%AF%84%E5%88%86%E7%B3%BB%E7%BB%9F"><span class="toc-number">2.5.4.</span> <span class="toc-text">科学评分系统</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%99%BA%E8%83%BD%E5%86%B3%E7%AD%96%E7%B3%BB%E7%BB%9F"><span class="toc-number">2.5.5.</span> <span class="toc-text">智能决策系统</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E6%8A%A5%E5%91%8A%E7%94%9F%E6%88%90"><span class="toc-number">2.5.6.</span> <span class="toc-text">完整报告生成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AB%98%E5%BA%A6%E5%8F%AF%E9%85%8D%E7%BD%AE"><span class="toc-number">2.5.7.</span> <span class="toc-text">高度可配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%99%BA%E8%83%BD%E4%BD%93%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82"><span class="toc-number">3.</span> <span class="toc-text">智能体实现细节</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E5%8F%8A%E5%8A%A8%E4%BD%9C%E6%97%B6%E9%95%BF"><span class="toc-number">3.1.</span> <span class="toc-text">场景及动作时长</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E7%AE%A1%E7%90%86"><span class="toc-number">3.2.</span> <span class="toc-text">提示工程管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E8%8A%82%E7%82%B9%E5%AE%9A%E4%B9%89"><span class="toc-number">3.3.</span> <span class="toc-text">工作流节点定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LangGraph-%E6%B5%81%E7%A8%8B%E7%BC%96%E6%8E%92"><span class="toc-number">3.4.</span> <span class="toc-text">LangGraph 流程编排</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LlamaIndex-%E5%90%91%E9%87%8F%E6%A3%80%E7%B4%A2"><span class="toc-number">3.5.</span> <span class="toc-text">LlamaIndex 向量检索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LangChain-%E7%8A%B6%E6%80%81%E8%AE%B0%E5%BF%86"><span class="toc-number">3.6.</span> <span class="toc-text">LangChain 状态记忆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LangChain-LLM%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">3.7.</span> <span class="toc-text">LangChain LLM客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LangChain-%E5%B7%A5%E5%85%B7%E9%9B%86"><span class="toc-number">3.8.</span> <span class="toc-text">LangChain 工具集</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 - 2026 By 余一叶知秋尽</span><span class="framework-info"><span>框架 </span><a href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.3</a></span></div><div class="footer_custom_text"><p><a style="margin-inline:5px"target="_blank"href="https://github.com/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Hosted-Github-brightgreen?style=flat&logo=GitHub"title="本站项目由Gtihub托管"></a><a style="margin-inline:5px"target="_blank"href="https://hexo.io/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo"title="博客框架为Hexo"></a><a style="margin-inline:5px"target="_blank"href="https://butterfly.js.org/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?logoColor=white&style=flat&logo=buefy"title="主题采用butterfly"></a><a style="margin-inline:5px"target="_blank"href="https://giscus.app/zh-CN/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Comment-Giscus-2873df?logoColor=white&style=flat&logo=git"title="评论系统为Giscus"></a><a style="margin-inline:5px"target="_blank"href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris"title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div><script src="https://unpkg.com/mermaid@11.5.0/dist/mermaid.min.js"></script><script>if (window.mermaid) {
  mermaid.initialize({
    startOnLoad: true,
    theme: '[object Object]',
    securityLevel: 'loose',
    flowchart: { useMaxWidth: true, htmlLabels: true }
  });
}</script></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="日间和夜间模式切换"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getGiscusTheme = theme => theme === 'dark' ? 'dark' : 'light'

  const createScriptElement = config => {
    const ele = document.createElement('script')
    Object.entries(config).forEach(([key, value]) => {
      ele.setAttribute(key, value)
    })
    return ele
  }

  const loadGiscus = (el = document, key) => {
    const mappingConfig = isShuoshuo
      ? { 'data-mapping': 'specific', 'data-term': key }
      : { 'data-mapping': (option && option['data-mapping']) || 'pathname' }

    const giscusConfig = {
      src: 'https://giscus.app/client.js',
      'data-repo': 'pengline/pengline.github.io',
      'data-repo-id': 'R_kgDOPqG50w',
      'data-category-id': 'DIC_kwDOPqG5084Cu_K9',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      'data-lang': 'zh-CN',
      'data-input-position': 'top',
      async: true,
      ...option,
      ...mappingConfig
    }

    const scriptElement = createScriptElement(giscusConfig)

    el.querySelector('#giscus-wrap').appendChild(scriptElement)

    if (isShuoshuo) {
      window.shuoshuoComment.destroyGiscus = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }
  }

  const changeGiscusTheme = theme => {
    const iframe = document.querySelector('#giscus-wrap iframe')
    if (iframe) {
      const message = {
        giscus: {
          setConfig: {
            theme: getGiscusTheme(theme),
            lang: 'zh-CN'
          }
        }
      }
      iframe.contentWindow.postMessage(message, 'https://giscus.app')
    }
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if (isShuoshuo) {
    'Giscus' === 'Giscus'
      ? window.shuoshuoComment = { loadComment: loadGiscus }
      : window.loadOtherComment = loadGiscus
    return
  }

  if ('Giscus' === 'Giscus' || !false) {
    if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment = loadGiscus
  }
})()</script></div><script src="/js/custom/sun_moon.js" async></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>