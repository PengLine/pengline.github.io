<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>几种分布式事务协议与实现模式 | 余一叶知秋尽</title><meta name="author" content="余一叶知秋尽"><meta name="copyright" content="余一叶知秋尽"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="在多个分布式节点上协调执行一组操作，通过特定协议或机制，确保操作原子性“全成功或全失败”，保障数据的一致性。">
<meta property="og:type" content="article">
<meta property="og:title" content="几种分布式事务协议与实现模式">
<meta property="og:url" content="https://pengline.github.io/2025/11/a8416e3d58d542d3883d2be1dab051f6/index.html">
<meta property="og:site_name" content="余一叶知秋尽">
<meta property="og:description" content="在多个分布式节点上协调执行一组操作，通过特定协议或机制，确保操作原子性“全成功或全失败”，保障数据的一致性。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pengline.github.io/img/essay/small204025vlPNF1760100025.webp">
<meta property="article:published_time" content="2025-11-24T16:00:00.000Z">
<meta property="article:modified_time" content="2026-01-16T07:57:13.544Z">
<meta property="article:author" content="余一叶知秋尽">
<meta property="article:tag" content="分布式事务">
<meta property="article:tag" content="2PC协议">
<meta property="article:tag" content="3PC协议">
<meta property="article:tag" content="XA协议">
<meta property="article:tag" content="TCC模式">
<meta property="article:tag" content="Saga模式">
<meta property="article:tag" content="AT模式">
<meta property="article:tag" content="Seata">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pengline.github.io/img/essay/small204025vlPNF1760100025.webp"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "几种分布式事务协议与实现模式",
  "url": "https://pengline.github.io/2025/11/a8416e3d58d542d3883d2be1dab051f6/",
  "image": "https://pengline.github.io/img/essay/small204025vlPNF1760100025.webp",
  "datePublished": "2025-11-24T16:00:00.000Z",
  "dateModified": "2026-01-16T07:57:13.544Z",
  "author": [
    {
      "@type": "Person",
      "name": "余一叶知秋尽",
      "url": "https://pengline.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://pengline.github.io/2025/11/a8416e3d58d542d3883d2be1dab051f6/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":30,"languages":{"author":"作者: 余一叶知秋尽","link":"链接: ","source":"来源: 余一叶知秋尽","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '几种分布式事务协议与实现模式',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/font.css"><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="余一叶知秋尽" type="application/atom+xml">
</head><body><div id="web_bg" style="background: LightGray;"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="/img/butterfly-icon.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">52</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">236</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">41</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list-ul"></i><span> 归档</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类别</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签集</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-outdent"></i><span> AI</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/ai/aigc/"><i class="fa-fw fas fa-cubes"></i><span> AIGC 创意平台</span></a></li><li><a class="site-page child" href="/ai/agent/medical/"><i class="fa-fw fas fa-medkit"></i><span> 医疗问答Agent</span></a></li><li><a class="site-page child" href="https://github.com/HengLine/ai-stocks-agent"><i class="fa-fw fas fa-line-chart"></i><span> 股票分析Agent</span></a></li><li><a class="site-page child" href="/ai/agent/video/"><i class="fa-fw fas fa-cut"></i><span> 视频混剪Agent</span></a></li><li><a class="site-page child" href="https://github.com/HengLine/video-shot-agent"><i class="fa-fw fas fa-file-video"></i><span> 剧本分镜Agent</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list-ol"></i><span> 项目</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/turnkey/smart-city"><i class="fa-fw fas fa-building"></i><span> 智慧城市（IOT）</span></a></li><li><a class="site-page child" href="/turnkey/smart-security"><i class="fa-fw fas fa-check-circle"></i><span> 智慧安检（IOT）</span></a></li><li><a class="site-page child" href="/turnkey/tms"><i class="fa-fw fas fa-truck"></i><span> 物流运输（TMS）</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-cogs"></i><span> 工具</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/tools/json/"><i class="fa-fw fas fa-cog"></i><span> JSON 转换工具集</span></a></li><li><a class="site-page child" href="/tools/diagrams/mermaid"><i class="fa-fw fas fa-pie-chart"></i><span> 在线绘制 UML 图</span></a></li><li><a class="site-page child" href="/tools/image/compressor/"><i class="fa-fw fas fa-image"></i><span> 图像批量压缩大小</span></a></li><li><a class="site-page child" href="/tools/image/watermark/"><i class="fa-fw fas fa-image"></i><span> 图像批量添加水印</span></a></li><li><a class="site-page child" href="/tools/image/convert/"><i class="fa-fw fas fa-file-image"></i><span> 图像格式编码转换</span></a></li><li><a class="site-page child" href="/tools/video/cropping/"><i class="fa-fw fas fa-cut"></i><span> 视频时长范围裁剪</span></a></li><li><a class="site-page child" href="/tools/video/watermark/"><i class="fa-fw fas fa-video"></i><span> 视频加水印马赛克</span></a></li><li><a class="site-page child" href="/tools/download/"><i class="fa-fw fas fa-cloud-download"></i><span> 批量下载视频图片</span></a></li><li><a class="site-page child" href="/tools/docu/watermark/"><i class="fa-fw fas fa-file-pdf"></i><span> PDF 文档添加水印</span></a></li><li><a class="site-page child" href="/tools/docu/signature"><i class="fa-fw fas fa-file"></i><span> 文档在线手写签名</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-pencil-square"></i><span> 文学</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/literature/poems"><i class="fa-fw fas fa-align-center"></i><span> 三行诗集</span></a></li><li><a class="site-page child" href="/literature/classical"><i class="fa-fw fas fa-align-justify"></i><span> 诗词歌赋</span></a></li><li><a class="site-page child" href="/literature/modern"><i class="fa-fw fas fa-align-left"></i><span> 现代诗歌</span></a></li><li><a class="site-page child" href="/literature/journal"><i class="fa-fw fas fa-align-right"></i><span> 随心随笔</span></a></li><li><a class="site-page child" href="/literature/incomplete"><i class="fa-fw fas fa-columns"></i><span> 忘梦残句</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-commenting"></i><span> 交流</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/messageboard/"><i class="fa-fw fas fa-paper-plane"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/essay/small204025vlPNF1760100025.webp);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src= "/img/20241215205335173426721579192.webp" data-lazy-src="/img/logo.png" alt="Logo"><span class="site-name">余一叶知秋尽</span></a><a class="nav-page-title" href="/"><span class="site-name">几种分布式事务协议与实现模式</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list-ul"></i><span> 归档</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类别</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签集</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-outdent"></i><span> AI</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/ai/aigc/"><i class="fa-fw fas fa-cubes"></i><span> AIGC 创意平台</span></a></li><li><a class="site-page child" href="/ai/agent/medical/"><i class="fa-fw fas fa-medkit"></i><span> 医疗问答Agent</span></a></li><li><a class="site-page child" href="https://github.com/HengLine/ai-stocks-agent"><i class="fa-fw fas fa-line-chart"></i><span> 股票分析Agent</span></a></li><li><a class="site-page child" href="/ai/agent/video/"><i class="fa-fw fas fa-cut"></i><span> 视频混剪Agent</span></a></li><li><a class="site-page child" href="https://github.com/HengLine/video-shot-agent"><i class="fa-fw fas fa-file-video"></i><span> 剧本分镜Agent</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list-ol"></i><span> 项目</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/turnkey/smart-city"><i class="fa-fw fas fa-building"></i><span> 智慧城市（IOT）</span></a></li><li><a class="site-page child" href="/turnkey/smart-security"><i class="fa-fw fas fa-check-circle"></i><span> 智慧安检（IOT）</span></a></li><li><a class="site-page child" href="/turnkey/tms"><i class="fa-fw fas fa-truck"></i><span> 物流运输（TMS）</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-cogs"></i><span> 工具</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/tools/json/"><i class="fa-fw fas fa-cog"></i><span> JSON 转换工具集</span></a></li><li><a class="site-page child" href="/tools/diagrams/mermaid"><i class="fa-fw fas fa-pie-chart"></i><span> 在线绘制 UML 图</span></a></li><li><a class="site-page child" href="/tools/image/compressor/"><i class="fa-fw fas fa-image"></i><span> 图像批量压缩大小</span></a></li><li><a class="site-page child" href="/tools/image/watermark/"><i class="fa-fw fas fa-image"></i><span> 图像批量添加水印</span></a></li><li><a class="site-page child" href="/tools/image/convert/"><i class="fa-fw fas fa-file-image"></i><span> 图像格式编码转换</span></a></li><li><a class="site-page child" href="/tools/video/cropping/"><i class="fa-fw fas fa-cut"></i><span> 视频时长范围裁剪</span></a></li><li><a class="site-page child" href="/tools/video/watermark/"><i class="fa-fw fas fa-video"></i><span> 视频加水印马赛克</span></a></li><li><a class="site-page child" href="/tools/download/"><i class="fa-fw fas fa-cloud-download"></i><span> 批量下载视频图片</span></a></li><li><a class="site-page child" href="/tools/docu/watermark/"><i class="fa-fw fas fa-file-pdf"></i><span> PDF 文档添加水印</span></a></li><li><a class="site-page child" href="/tools/docu/signature"><i class="fa-fw fas fa-file"></i><span> 文档在线手写签名</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-pencil-square"></i><span> 文学</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/literature/poems"><i class="fa-fw fas fa-align-center"></i><span> 三行诗集</span></a></li><li><a class="site-page child" href="/literature/classical"><i class="fa-fw fas fa-align-justify"></i><span> 诗词歌赋</span></a></li><li><a class="site-page child" href="/literature/modern"><i class="fa-fw fas fa-align-left"></i><span> 现代诗歌</span></a></li><li><a class="site-page child" href="/literature/journal"><i class="fa-fw fas fa-align-right"></i><span> 随心随笔</span></a></li><li><a class="site-page child" href="/literature/incomplete"><i class="fa-fw fas fa-columns"></i><span> 忘梦残句</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-commenting"></i><span> 交流</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/messageboard/"><i class="fa-fw fas fa-paper-plane"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">几种分布式事务协议与实现模式</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-11-24T16:00:00.000Z" title="发表于 2025-11-25 00:00:00">2025-11-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-01-16T07:57:13.544Z" title="更新于 2026-01-16 15:57:13">2026-01-16</time></span></div><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java/">Java</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a></span><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p>分布式事务是指在多个独立的数据存储节点（如数据库、服务、微服务等）之间协调完成的一组操作，这些操作要么全部成功提交，要么全部回滚，以保证数据的一致性。</p>
<blockquote>
<p>事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的分布式系统的不同节点之上。</p>
<p>在分布式系统中，由于网络延迟、节点故障等问题，实现事务的一致性比单机事务复杂得多。</p>
</blockquote>
<p><strong>分布式事务的产生的原因</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>数据库分库分表</p>
</li>
<li class="lvl-2">
<p>应用 SOA 化（业务多服务拆分）</p>
</li>
<li class="lvl-2">
<p>分布式场景，多节点</p>
</li>
</ul>
<h2 id="挑战与目标">挑战与目标</h2>
<p><strong>分布式事务的核心挑战，就是在不可靠的分布式环境中，尽可能地维持事务的原子性和一致性</strong>。</p>
<p>在单机数据库中，事务满足 <strong>ACID</strong> 特性：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>A</strong>tomicity（原子性）：操作不可分割；</p>
</li>
<li class="lvl-2">
<p><strong>C</strong>onsistency（一致性）：事务前后数据合法；</p>
</li>
<li class="lvl-2">
<p><strong>I</strong>solation（隔离性）：并发事务互不干扰；</p>
</li>
<li class="lvl-2">
<p><strong>D</strong>urability（持久性）：提交后结果永久保存。</p>
</li>
</ul>
<p>而在分布式环境下，<strong>ACID 的实现变得极其困难</strong>，因为：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>网络可能延迟、丢包、分区；</p>
</li>
<li class="lvl-2">
<p>节点可能宕机；</p>
</li>
<li class="lvl-2">
<p>各子系统可能使用不同数据库或技术栈。</p>
</li>
</ul>
<p><strong>典型场景举例</strong>：</p>
<ol>
<li class="lvl-3">
<p><strong>电商下单</strong></p>
<ul class="lvl-2">
<li class="lvl-5">扣减库存（库存服务）</li>
<li class="lvl-5">创建订单（订单服务）</li>
<li class="lvl-5">扣减用户余额（账户服务）</li>
</ul>
<p>三者必须同时成功或同时失败。</p>
</li>
<li class="lvl-3">
<p><strong>跨数据库转账</strong></p>
<ul class="lvl-2">
<li class="lvl-5">从 MySQL 的 A 账户扣款</li>
<li class="lvl-5">向 PostgreSQL 的 B 账户加款</li>
</ul>
<p>需跨异构数据库保证一致性。</p>
</li>
<li class="lvl-3">
<p><strong>微服务架构中的状态同步</strong></p>
<ul class="lvl-2">
<li class="lvl-5">用户服务创建用户</li>
<li class="lvl-5">消息服务发送欢迎邮件</li>
<li class="lvl-5">日志服务记录审计日志</li>
</ul>
<p>要么全做，要么全不做（或通过补偿机制最终一致）。</p>
</li>
</ol>
<p>分布式事务的分类（按一致性强度）：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>一致性级别</th>
<th>典型方案</th>
<th>特点</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>强一致性事务</strong></td>
<td>严格 ACID</td>
<td>2PC、XA</td>
<td>数据实时一致，但性能低、可用性差</td>
</tr>
<tr>
<td><strong>最终一致性事务</strong></td>
<td>宽松一致性</td>
<td>TCC、Saga、消息队列</td>
<td>允许短暂不一致，通过补偿或重试达成最终一致，性能高</td>
</tr>
</tbody>
</table>
<blockquote>
<p>实际系统中，<strong>最终一致性方案使用更广泛</strong>（如电商、支付），因为强一致性代价太高。</p>
</blockquote>
<p>分布式事务通常选择 <strong>CP</strong>（优先一致性和分区容错），在网络分区时可能拒绝服务（如 2PC 阻塞）。而最终一致性方案则偏向 <strong>AP</strong>，牺牲强一致换取高可用。</p>
<h2 id="事务协议">事务协议</h2>
<p>XA 是 2PC 的工业标准实现规范，而 3PC 是 2PC 的理论扩展。</p>
<p><strong>2PC 是思想，XA 是它的工业标准落地，3PC 是它的“理想化升级版”但难以实用。</strong></p>
<p><strong>特性对比</strong>：</p>
<table>
<thead>
<tr>
<th>维度</th>
<th>2PC</th>
<th>XA</th>
<th>3PC</th>
</tr>
</thead>
<tbody>
<tr>
<td>一致性保证</td>
<td>强一致性（ACID）</td>
<td>强一致性（ACID）</td>
<td>强一致性</td>
</tr>
<tr>
<td>是否阻塞</td>
<td>是（协调者或参与者故障会导致阻塞）</td>
<td>是（继承 2PC 的阻塞特性）</td>
<td>理论上非阻塞（超时自动决策）</td>
</tr>
<tr>
<td>容错能力</td>
<td>协调者单点故障 → 系统停滞<br>参与者故障 → 可恢复但复杂</td>
<td>同 2PC</td>
<td>能容忍协调者或部分参与者故障</td>
</tr>
<tr>
<td>通信轮次</td>
<td>2 轮（Prepare + Commit/Abort）</td>
<td>2 轮（通过 xa_prepare + xa_commit/rollback）</td>
<td>3 轮（CanCommit + PreCommit + DoCommit）</td>
</tr>
<tr>
<td>复杂度</td>
<td>中等</td>
<td>中等（需数据库/MQ 支持 XA 接口）</td>
<td>高（状态机复杂，需维护更多阶段状态）</td>
</tr>
<tr>
<td>工业应用</td>
<td>广泛（尤其在传统数据库）</td>
<td>广泛（Oracle、MySQL、PostgreSQL、ActiveMQ 等支持）</td>
<td>极少（因理论假设强，实际网络环境不满足）</td>
</tr>
<tr>
<td>网络分区容忍性</td>
<td>不容忍（CP 系统）</td>
<td>不容忍</td>
<td>不满足（异步网络下无法保证一致性）</td>
</tr>
</tbody>
</table>
<blockquote>
<p>XA 是 2PC 的升级标准规范，<strong>XA = 2PC + 标准化接口 + 资源管理约定</strong></p>
<ul class="lvl-1">
<li class="lvl-2">2PC/ XA 追求<strong>强一致性</strong>，接受阻塞；</li>
<li class="lvl-2">3PC 试图在<strong>协调者故障时避免阻塞</strong>。</li>
<li class="lvl-2"><strong>超时机制</strong>：3PC 在 PreCommit 阶段后引入超时，若未收到 DoCommit，参与者可自行提交（假设多数已同意）。</li>
</ul>
</blockquote>
<p><strong>典型问题对比</strong>：</p>
<table>
<thead>
<tr>
<th>问题</th>
<th>2PC / XA</th>
<th>3PC</th>
</tr>
</thead>
<tbody>
<tr>
<td>协调者宕机</td>
<td>所有参与者阻塞，直到协调者恢复</td>
<td>参与者在超时后可自行决策（提交或回滚）</td>
</tr>
<tr>
<td>参与者宕机</td>
<td>协调者需等待或超时回滚（可能不一致）</td>
<td>类似，但状态更多，恢复更复杂</td>
</tr>
<tr>
<td>脑裂（网络分区）</td>
<td>可能出现部分提交、部分回滚（数据不一致）</td>
<td>仍无法避免，甚至可能加剧不一致</td>
</tr>
</tbody>
</table>
<blockquote>
<ul class="lvl-1">
<li class="lvl-2">
<p>传统数据库跨库事务（如银行转账，订单中心等）时，可选择<strong>2PC / XA</strong> 协议</p>
</li>
<li class="lvl-2">
<p>高并发、高可用、可接受最终一致时，使用 <strong>Saga / TCC / 消息队列</strong> 模式的实现</p>
</li>
</ul>
</blockquote>
<h3 id="两阶段提交（2PC-协议）">两阶段提交（2PC 协议）</h3>
<p>事务管理器分两个阶段来协调资源管理器，第一阶段准备资源，也就是预留事务所需的资源，如果每个资源管理器都资源预留成功，则进行第二阶段资源提交，否则协调资源管理器回滚资源。</p>
<p>2PC 能保证强一致性（ACID），它包含两个角色：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>参与者（Participants）</strong>：执行事务操作的节点。</p>
</li>
<li class="lvl-2">
<p><strong>协调者（Coordinator）</strong>：负责协调各参与者的提交或回滚。</p>
</li>
</ul>
<blockquote>
<ol>
<li class="lvl-3">
<p><strong>准备阶段（Prepare Phase）</strong>：</p>
<ul class="lvl-3">
<li class="lvl-5">协调者向所有参与者发送“准备”请求，询问是否可以提交事务。</li>
<li class="lvl-5">参与者执行事务操作（但不提交），记录事务日志（如 undo/redo log），并锁定资源。</li>
<li class="lvl-5">若参与者可以提交，则返回 <strong>Yes</strong>；否则返回 <strong>No</strong>。</li>
</ul>
<p>具体流程图如下：</p>
<img src= "/img/20241215205335173426721579192.webp" data-lazy-src="/imgs/java/d0108a2f18594790ad4d439acb1d87e8.webp" alt="img" style="zoom:44%;" />
</li>
<li class="lvl-3">
<p><strong>提交阶段（Commit Phase）</strong>：</p>
<ul class="lvl-3">
<li class="lvl-5">如果所有参与者都返回 Yes，协调者发送 <strong>Commit</strong> 命令，各参与者正式提交事务并释放资源。</li>
<li class="lvl-5">若任一参与者返回 No 或超时，协调者发送 <strong>Abort</strong> 命令，所有参与者回滚事务。</li>
</ul>
<p>协调者节点收到所有参与者节点反馈的ACK消息后，完成事务：<br>
<img src= "/img/20241215205335173426721579192.webp" data-lazy-src="/imgs/java/774f089e7d4f4aae8af79314cf317d5a.webp" alt="img" style="zoom:65%;" /></p>
</li>
</ol>
<p><strong>事务回滚：</strong></p>
<p>如果任意一个参与者节点在第一阶段返回 <strong>No</strong>，或者协调者在第一阶段的询问超时之前，无法获取所有参与者节点的响应消息时，那么这个事务将会被回滚，具体流程如下：</p>
<blockquote>
<p>① 协调者向所有参与者发出 rollback 回滚操作的请求<br>
② 参与者利用阶段一写入的undo信息执行回滚，并释放在整个事务期间内占用的资源<br>
③ 参与者在完成事务回滚之后，向协调者发送回滚完成的ACK消息<br>
④ 协调者收到所有参与者反馈的ACK消息后，取消事务</p>
</blockquote>
<img src= "/img/20241215205335173426721579192.webp" data-lazy-src="/imgs/java/f1574438c5c548149fe117bf7209f40e.webp" alt="img" style="zoom:67%;" />
</blockquote>
<p><strong>存在的问题</strong>：单点故障（协调者宕机则系统阻塞）、同步阻塞、性能差、恢复复杂。</p>
<p>二阶段提交确实能够提供原子性的操作，但是还有以下缺点：</p>
<blockquote>
<p>（1）性能问题：执行过程中，所有参与节点都是事务阻塞性的，当参与者占有公共资源时，其他第三方节点访问公共资源就不得不处于阻塞状态，为了数据的一致性而牺牲了可用性，对性能影响较大，不适合高并发高性能场景</p>
<p>（2）可靠性问题：2PC非常依赖协调者，当协调者发生故障时，尤其是第二阶段，那么所有的参与者就会都处于锁定事务资源的状态中，而无法继续完成事务操作（如果是协调者挂掉，可以重新选举一个协调者，但是无法解决因为协调者宕机导致的参与者处于阻塞状态的问题）</p>
<p>（3）数据一致性问题：在阶段二中，当协调者向参与者发送commit请求之后，发生了局部网络异常或者在发送commit请求过程中协调者发生了故障，这回导致只有一部分参与者接受到了commit请求。而在这部分参与者接到commit请求之后就会执行commit操作。但是其他部分未接到commit请求的机器则无法执行事务提交。于是整个分布式系统便出现了数据部一致性的现象。</p>
<p>（4）二阶段无法解决的问题：协调者在发出 commit 消息之后宕机，而唯一接收到这条消息的参与者同时也宕机了，那么即使协调者通过选举协议产生了新的协调者，这条事务的状态也是不确定的，没人知道事务是否被已经提交。</p>
</blockquote>
<h3 id="三阶段提交（3PC-协议）">三阶段提交（3PC 协议）</h3>
<p>为解决 2PC 的阻塞问题，在其基础上增加一个“预提交”阶段。</p>
<blockquote>
<ol>
<li class="lvl-3">
<p><strong>CanCommit</strong>：协调者询问参与者是否可以执行事务（轻量试探）。</p>
</li>
<li class="lvl-3">
<p><strong>PreCommit</strong>：若所有参与者同意，则协调者发送 PreCommit，参与者准备提交并响应。</p>
</li>
<li class="lvl-3">
<p><strong>DoCommit</strong>：协调者确认后发送正式提交命令。</p>
</li>
</ol>
</blockquote>
<p>处理流程如下：</p>
<p><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="/imgs/java/a7453220330b4aa1b4fcced3f839ca15-1763999690559-4.webp" alt="img"></p>
<blockquote>
<p>与2PC相比，3PC降低了阻塞范围，并且在等待超时后，协调者或参与者会中断事务，避免了协调者单点问题，阶段三中协调者出现问题时，参与者会继续提交事务。</p>
<p>数据不一致问题依然存在，当在参与者收到 preCommit 请求后等待 doCommit 指令时，此时如果协调者请求中断事务，而协调者因为网络问题无法与参与者正常通信，会导致参与者继续提交事务，造成数据不一致。</p>
</blockquote>
<p><strong>特点</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>引入超时机制，允许参与者在协调者故障时自行决策。</p>
</li>
<li class="lvl-2">
<p>减少阻塞，但无法完全避免不一致（网络分区时仍可能分裂决策）。</p>
</li>
<li class="lvl-2">
<p>实现复杂，实际应用较少。</p>
</li>
<li class="lvl-2">
<p>3PC 要求网络 <strong>“同步通信”</strong>（消息延迟有上限），但真实网络是异步的（可能任意延迟），因此 <strong>3PC 无法在实际分布式系统中保证一致性</strong>。</p>
</li>
</ul>
<h3 id="XA-协议（2PC-的标准）">XA 协议（2PC 的标准）</h3>
<p>XA是一个分布式事务协议，由Tuxedo提出。</p>
<p>XA中大致分为两部分：事务管理器和本地资源管理器。其中本地资源管理器往往由数据库实现，比如Oracle、DB2这些商业数据库都实现了XA接口，而事务管理器作为全局的调度者，负责各个本地资源的提交和回滚。</p>
<p><strong>弱点</strong>：性能较低，无法满足高并发场景。在mysql数据库中支持不太理想，mysql的XA实现，没有记录准备阶段日志，主备切换回导致主库与备库数据不一致</p>
<p>参与者将操作成败通知协调者，再由协调者根据所有参与者的反馈情报决定各参与者是否要提交操作还是中止操作。</p>
<img src= "/img/20241215205335173426721579192.webp" data-lazy-src="/imgs/java/1517793973852088232.webp" alt="img" style="zoom: 33%;" />
<h2 id="事务模式">事务模式</h2>
<p>分布式事务实现的多种模式，一般是应用协议，具体实现分布式事务。</p>
<table>
<thead>
<tr>
<th>模式</th>
<th>一致性类型</th>
<th>类型</th>
<th>阻塞</th>
<th>性能</th>
<th>业务侵入</th>
<th>适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCC</td>
<td>最终一致性</td>
<td>补偿型</td>
<td>否</td>
<td>高</td>
<td>高</td>
<td>金融、电商核心链路<br />依赖业务代码实现 Try/Confirm/Cancel 三阶段</td>
</tr>
<tr>
<td>Saga</td>
<td>最终一致性</td>
<td>长事务编排</td>
<td>否</td>
<td>高</td>
<td>中</td>
<td>长流程、微服务编排<br />本地事务+补偿操作，流程由业务或编排器控制</td>
</tr>
<tr>
<td>消息队列</td>
<td>最终一致性</td>
<td>中间件扩展</td>
<td>否</td>
<td>高</td>
<td>中</td>
<td>异步解耦、通知类场景<br />RocketMQ/Kafka 事务消息，厂商特定实现</td>
</tr>
<tr>
<td>Seata（AT/XA）</td>
<td>强/最终一致性</td>
<td>框架提供</td>
<td>视模式</td>
<td>中高</td>
<td>低（AT）</td>
<td>微服务架构通用方案<br />AT 模式是自定义协议，XA 模式基于 XA 协议</td>
</tr>
</tbody>
</table>
<h3 id="AT-模式">AT 模式</h3>
<p><strong>AT 模式</strong> 是开源分布式事务框架 <strong>Seata</strong> 提供的一种<strong>对业务无侵入</strong>的分布式事务解决方案。其核心目标是：<strong>像使用本地事务一样使用分布式事务</strong>，开发者只需关注业务 SQL，Seata 自动完成全局事务的协调、回滚和提交。</p>
<blockquote>
<ul class="lvl-1">
<li class="lvl-2">
<p>业务代码<strong>零改造</strong>（只需加 <code>@GlobalTransactional</code> 注解）；</p>
</li>
<li class="lvl-2">
<p><strong>无长时间锁</strong>（本地事务提交即释放 DB 锁）；</p>
</li>
<li class="lvl-2">
<p><strong>高性能</strong>（一阶段直接提交，二阶段异步）。</p>
</li>
</ul>
</blockquote>
<p>Seata AT 模式包含三个核心角色：</p>
<table>
<thead>
<tr>
<th>组件</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>事务协调者</strong><br />TC（Transaction Coordinator）</td>
<td>全局事务协调器，维护全局事务状态，驱动二阶段提交/回滚</td>
</tr>
<tr>
<td><strong>事务管理器</strong><br />TM（Transaction Manager）</td>
<td>全局事务发起者（通常在业务服务中），定义事务边界（<code>@GlobalTransactional</code>）。<br />开启、提交或回滚全局事务</td>
</tr>
<tr>
<td><strong>资源管理器</strong><br />RM（Resource Manager）</td>
<td>分支事务管理者（集成在业务服务中），负责 undo log 管理、与 TC 通信。<br />与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</td>
</tr>
</tbody>
</table>
<blockquote>
<p>RM 以 <strong>Java Agent 或 SDK</strong> 形式嵌入应用，<strong>拦截 JDBC 操作</strong>。</p>
<p>其中，TC 为单独部署的 Server 服务端，TM 和 RM 为嵌入到应用中的 Client 客户端。</p>
</blockquote>
<h4 id="核心思想">核心思想</h4>
<p><strong>“一阶段提交 + 二阶段异步回滚”</strong>，基于 <strong>支持本地 ACID 事务</strong> 的 <strong>关系型数据库</strong></p>
<blockquote>
<ul class="lvl-1">
<li class="lvl-2">
<p><strong>一阶段（Phase 1）</strong>：本地事务提交时，Seata <strong>自动记录 undo log（回滚日志）</strong>，并注册分支事务到 TC，<strong>本地事务直接提交</strong>（不锁定资源）。</p>
</li>
<li class="lvl-2">
<p><strong>二阶段（Phase 2）</strong>：</p>
<ul class="lvl-3">
<li class="lvl-4"><strong>提交</strong>：TC 通知各分支“删除 undo log”（异步、快速）；</li>
<li class="lvl-4"><strong>回滚</strong>：TC 通知各分支“根据 undo log 逆向生成补偿 SQL 并执行”。</li>
</ul>
</li>
</ul>
</blockquote>
<pre class="mermaid">sequenceDiagram
    participant TM as TM(@GlobalTransactional)
    participant TC as TC(协调器)
    participant RMA as RM-A(服务A)
    participant RMB as RM-B(服务B)

    TM->>TC: 开启全局事务(XID)
    TC-->>TM: 返回 XID

    TM->>RMA: 执行 SQL (带 XID)
    RMA->>RMA: 解析SQL → 生成 before/after image
    RMA->>RMA: 插入 undo_log + 业务SQL → 本地提交
    RMA->>TC: 注册分支事务

    TM->>RMB: 执行 SQL (带 XID)
    RMB->>RMB: 同上：生成 undo_log + 本地提交
    RMB->>TC: 注册分支事务

    alt 全局提交
        TC->>RMA: 删除 undo_log
        TC->>RMB: 删除 undo_log
        Note right of TC: 异步快速完成
    else 全局回滚
        TC->>RMA: 回滚分支（执行补偿SQL）
        TC->>RMB: 回滚分支（执行补偿SQL）
        Note right of TC: 基于 undo_log 自动还原
    end</pre>
<p><strong>场景</strong>：跨库转账（account_db1 → account_db2）</p>
<ol>
<li class="lvl-3">
<p><strong>一阶段</strong>：本地提交 + 注册分支</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GlobalTransactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(String from, String to, BigDecimal amount)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 扣减 from 账户（db1）</span></span><br><span class="line">    accountMapper.decrease(from, amount); </span><br><span class="line">    <span class="comment">// 2. 增加 to 账户（db2）</span></span><br><span class="line">    accountMapper.increase(to, amount);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<ol>
<li class="lvl-3">
<p><strong>TM 向 TC 申请开启全局事务</strong>，TC 返回全局事务 ID（XID）；</p>
</li>
<li class="lvl-3">
<p><strong>XID 通过 RPC 上下文传递</strong>到所有参与的服务；</p>
</li>
<li class="lvl-3">
<p><strong>每个本地事务执行时</strong>（如 <code>decrease</code>）：</p>
<ul class="lvl-5">
<li class="lvl-5">RM <strong>解析 SQL</strong>，生成 <strong>before image（更新前数据）</strong> 和 <strong>after image（更新后数据）</strong>；</li>
<li class="lvl-5">将 <strong>undo log</strong>（包含 before/after image）<strong>与业务 SQL 放入同一本地事务</strong>，一同提交；</li>
<li class="lvl-5">向 TC <strong>注册分支事务</strong>（携带 XID、资源 ID、undo log 等）；</li>
</ul>
</li>
<li class="lvl-3">
<p><strong>本地事务提交</strong> → <strong>数据库行锁立即释放</strong>！</p>
</li>
</ol>
</blockquote>
</li>
<li class="lvl-3">
<p><strong>二阶段</strong>：提交或回滚</p>
<ul class="lvl-2">
<li class="lvl-5"><strong>全局提交</strong>（所有分支成功）
<ol>
<li class="lvl-8">TC 向所有 RM 发送 “删除 undo log” 指令；</li>
<li class="lvl-8">RM 异步删除对应 undo log；</li>
<li class="lvl-8">无数据库操作，性能极高。</li>
</ol>
</li>
<li class="lvl-5"><strong>全局回滚</strong>（任一分支失败）
<ol>
<li class="lvl-8">TC 向所有 RM 发送 “回滚分支” 指令；</li>
<li class="lvl-8">RM 根据 undo log 的 before image，自动生成反向 SQL 并执行：<br>
<code>UPDATE account SET balance = 1000 WHERE id = '1'; </code></li>
<li class="lvl-8"><strong>回滚必须幂等</strong>（Seata 通过 undo log 状态保证）。</li>
</ol>
</li>
</ul>
</li>
</ol>
<blockquote>
<p><strong>AT 模式的“脏读”问题</strong>：一阶段本地提交后，其他事务可读到“中间状态”（如 A 已扣款但 B 未到账）。</p>
<p><strong>解决方案</strong>：Seata 提供 <strong>全局锁（Global Lock）</strong> 机制（需开启），在更新前检查是否有未提交的全局事务。</p>
</blockquote>
<h4 id="Undo-Log-机制">Undo Log 机制</h4>
<ol>
<li class="lvl-3">
<p><strong>Undo Log 表结构</strong>（需业务库手动创建）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> `undo_log` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `branch_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  `xid` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  `context` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  `rollback_info` longblob <span class="keyword">NOT NULL</span>,</span><br><span class="line">  `log_status` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  `log_created` datetime <span class="keyword">NOT NULL</span>,</span><br><span class="line">  `log_modified` datetime <span class="keyword">NOT NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `ux_undo_log` (`xid`,`branch_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>
<p>具体参考：<a href="https://seata.apache.org/zh-cn/docs/user/quickstart">官网</a></p>
</li>
<li class="lvl-3">
<p><strong>Undo 生成策略</strong></p>
<ol>
<li class="lvl-6"><strong>UPDATE</strong>：记录修改行的 before/after；</li>
<li class="lvl-6"><strong>INSERT</strong>：记录主键，回滚时 DELETE；</li>
<li class="lvl-6"><strong>DELETE</strong>：记录整行数据，回滚时 INSERT。</li>
</ol>
<blockquote>
<ul class="lvl-3">
<li class="lvl-2">
<p>不支持 <strong>DDL</strong>（如 <code>ALTER TABLE</code>）；</p>
</li>
<li class="lvl-2">
<p>要求表有<strong>主键</strong>（用于定位回滚行）；</p>
</li>
<li class="lvl-2">
<p><strong>SQL 必须可解析</strong>（Seata 支持大部分 DML，但复杂 JOIN 可能失败）。</p>
</li>
</ul>
</blockquote>
</li>
</ol>
<h4 id="隔离性">隔离性</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>写隔离</strong>：一阶段本地事务提交前，需要确保先拿到 <strong>全局锁</strong> 。拿不到不能提交本地事务。且尝试被限制在一定范围内，超出范围将放弃，并回滚本地事务，释放本地锁。</p>
</li>
<li class="lvl-2">
<p><strong>读隔离</strong>：在数据库本地事务隔离级别 读已提交（Read Committed） 或以上的基础上，Seata（AT 模式）的默认全局隔离级别是 <strong>读未提交（Read Uncommitted）</strong> 。必需要求全局的 读已提交 ，可以通过 <code>SELECT FOR UPDATE </code>语句的代理。该语句的执行会申请 <strong>全局锁</strong> ，如果 全局锁 被其他事务持有，则释放本地锁（回滚 <code>SELECT FOR UPDATE</code> 语句的本地执行）并重试。这个过程中，查询是被 block 住的，直到 <strong>全局锁</strong> 拿到，即读取的相关数据是 <strong>已提交</strong> 的，才返回</p>
</li>
</ul>
<h3 id="TCC-模式">TCC 模式</h3>
<p>TCC（Try-Confirm-Cancel）是一种<strong>业务层面</strong>的补偿型事务模型，不要求底层数据库支持分布式事务（不是让数据库自动回滚，而是<strong>由业务代码主动执行补偿逻辑</strong>）。</p>
<p>一般适用于高并发、高性能系统（如电商、金融）。不过需业务逻辑配合设计。</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>无长时间锁定资源，性能好</td>
<td>Try 阶段仅短暂锁定（如加数据库行锁），Confirm/Cancel 阶段无需锁</td>
</tr>
<tr>
<td>高并发</td>
<td>资源预留后即可释放数据库连接，适合高吞吐场景</td>
</tr>
<tr>
<td>业务侵入性强</td>
<td>需为每个业务操作开发 Try/Confirm/Cancel 三套逻辑</td>
</tr>
<tr>
<td>最终一致性</td>
<td>不保证中间状态一致性（如冻结期间余额不可用），但最终一致</td>
</tr>
<tr>
<td>幂等性要求高</td>
<td>网络超时可能导致重复调用，Confirm/Cancel 必须幂等</td>
</tr>
</tbody>
</table>
<h4 id="核心思想-2">核心思想</h4>
<p><strong>一个大事务拆解成多个小事务</strong>。</p>
<p>try阶段检查并预留资源，确保在confirm阶段有资源可用，最大程度的确保confirm阶段能够执行成功。</p>
<pre class="mermaid">sequenceDiagram
    participant TM as 事务管理器(TC)
    participant ServiceA as 服务A
    participant ServiceB as 服务B

    TM->>ServiceA: Try()
    TM->>ServiceB: Try()
    alt 所有 Try 成功
        TM->>ServiceA: Confirm()
        TM->>ServiceB: Confirm()
        Note right of TM: 全局提交
    else 任一 Try 失败
        TM->>ServiceA: Cancel()
        TM->>ServiceB: Cancel()
        Note right of TM: 全局回滚
    end</pre>
<p>将传统事务的“提交/回滚”语义，<strong>转化为业务可理解的三步操作</strong>：</p>
<blockquote>
<ol>
<li class="lvl-3">
<p><strong><mark>Try</mark></strong>：预留资源（如冻结金额、占用库存），检查业务可行性，不真正执行业务（一致性和隔离性）。</p>
<ol>
<li class="lvl-6"><strong>幂等性</strong>（可重复执行）；</li>
<li class="lvl-6"><strong>快速失败</strong>（如余额不足立即返回）；</li>
<li class="lvl-6"><strong>资源隔离</strong>（防止被其他请求使用）。</li>
</ol>
</li>
<li class="lvl-3">
<p><strong><mark>Confirm</mark></strong>：真正执行业务（如扣款、出库），在所有参与方 Try 成功后，<strong>真正完成业务</strong>。。</p>
<ol>
<li class="lvl-6"><strong>必须幂等</strong>（因网络问题可能重复调用）；</li>
<li class="lvl-6"><strong>尽量不失败</strong>（理想情况下 Confirm 不应出错）；</li>
<li class="lvl-6"><strong>无需再校验业务条件</strong>（Try 已保证）。</li>
</ol>
</li>
<li class="lvl-3">
<p><strong><mark>Cancel</mark></strong>：释放预留资源（回滚），若任一参与者 Try 失败，或 Confirm 超时，<strong>释放已预留资源</strong>。。</p>
<ol>
<li class="lvl-6"><strong>必须幂等</strong>；</li>
<li class="lvl-6"><strong>必须能成功执行</strong>（即使系统异常也要保证补偿）。</li>
</ol>
</li>
</ol>
</blockquote>
<img src= "/img/20241215205335173426721579192.webp" data-lazy-src="/imgs/java/f81a815047d761053273ff2e5f33b9e603e4f713.webp" alt="img" style="zoom: 50%;" />
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Try: 冻结转出账户 100 元，检查转入账户是否存在</span></span><br><span class="line"><span class="meta">@Compensable(confirmMethod = &quot;transferConfirm&quot;, cancelMethod = &quot;transferCancel&quot;)</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> STATE <span class="title function_">transferTry</span><span class="params">(<span class="type">long</span> fromAccountId, <span class="type">long</span> toAccountId, <span class="type">int</span> amount)</span> &#123;</span><br><span class="line">    <span class="comment">//检查 Tom 账户</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (tom.balance &lt; amount) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InsufficientFunds</span>();</span><br><span class="line">        tom.frozen += amount;   <span class="comment">// 冻结资金</span></span><br><span class="line">        tom.balance -= amount;</span><br><span class="line">        <span class="comment">// 不动 Tracy，仅校验其存在性</span></span><br><span class="line">        verifyTracyExists(toAccountId);</span><br><span class="line">        <span class="keyword">return</span> SUCCESS;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> FAIL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Confirm: 解冻并完成转账（实际是将冻结资金“转正”）</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transferConfirm</span><span class="params">(<span class="type">long</span> fromAccountId, <span class="type">long</span> toAccountId, <span class="type">int</span> amount)</span> &#123;</span><br><span class="line">    <span class="comment">//Tom 账户-100元</span></span><br><span class="line">    <span class="comment">//tracy 账户+100元</span></span><br><span class="line">    tom.balance += amount;      <span class="comment">// 入账</span></span><br><span class="line">    <span class="comment">// tracy 的冻结资金已扣减，无需操作</span></span><br><span class="line">    state = <span class="string">&quot;confirmed&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Cancel: 解冻资金，恢复原状</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transferCancel</span><span class="params">(<span class="type">long</span> fromAccountId, <span class="type">long</span> toAccountId, <span class="type">int</span> amount)</span> &#123;</span><br><span class="line">    <span class="comment">//解除Tom账户锁定资金</span></span><br><span class="line">    tom.balance += amount;</span><br><span class="line">	tom.frozen -= amount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>TCC框架是如何保证数据一致性？</p>
<img src= "/img/20241215205335173426721579192.webp" data-lazy-src="/imgs/java/b5b927eb63c1c76388a213f6a2825b7ae93c3a3b.webp" alt="img" style="zoom:67%;" />
<p>TCC依赖于一条事务处理记录，在开始TCC事务前标记创建此记录，然后在TCC的每个环节持续更新此记录的状态，这样就可以知道事务执行到那个环节了，当一次执行失败，进行重试时同样根据此数据来确定当前阶段，并判断应该执行什么操作。</p>
<h4 id="挑战与应对">挑战与应对</h4>
<p>通常需引入 <strong>事务日志表</strong> 或使用 <strong>Seata TCC 模式</strong> 自动处理这些问题。</p>
<ol>
<li class="lvl-3">
<p><strong>空回滚</strong>（Cancel 执行时 Try 未执行）</p>
<ul class="lvl-2">
<li class="lvl-5">
<p><strong>原因</strong>：网络超时导致 TM 误判 Try 失败，直接发 Cancel。</p>
</li>
<li class="lvl-5">
<p><strong>解决方案</strong>：Cancel 前检查是否执行过 Try（如记录事务日志）。</p>
</li>
</ul>
</li>
<li class="lvl-3">
<p><strong>幂等控制</strong></p>
<p>为每个事务生成全局唯一 ID（xid），服务端记录已处理的 xid。</p>
</li>
<li class="lvl-3">
<p><strong>悬挂问题</strong>（Try 在 Cancel 之后到达）</p>
<ul class="lvl-2">
<li class="lvl-5">
<p><strong>原因</strong>：Cancel 先执行（因超时），Try 后到（网络延迟）。</p>
</li>
<li class="lvl-5">
<p><strong>解决方案</strong>：Try 前检查是否已 Cancel（通过事务状态表）。</p>
</li>
</ul>
</li>
</ol>
<h4 id="应用场景">应用场景</h4>
<ol>
<li class="lvl-3">
<p><strong>电商下单</strong></p>
<ul class="lvl-2">
<li class="lvl-5">Try：冻结库存、预占优惠券、校验地址</li>
<li class="lvl-5">Confirm：扣减库存、使用优惠券、生成订单</li>
<li class="lvl-5">Cancel：释放库存、归还优惠券</li>
</ul>
</li>
<li class="lvl-3">
<p><strong>金融转账</strong></p>
<ul class="lvl-2">
<li class="lvl-5">Try：冻结转出金额，校验转入账户</li>
<li class="lvl-5">Confirm：完成转账</li>
<li class="lvl-5">Cancel：解冻金额</li>
</ul>
</li>
<li class="lvl-3">
<p><strong>机票/酒店预订</strong></p>
<ul class="lvl-2">
<li class="lvl-5">Try：预占座位/房态</li>
<li class="lvl-5">Confirm：出票/确认入住</li>
<li class="lvl-5">Cancel：释放资源</li>
</ul>
</li>
</ol>
<h3 id="Saga-模式">Saga 模式</h3>
<p>一种用于<strong>长事务</strong> 的分布式事务模式，特别适用于<strong>跨多个服务、执行时间较长、无法使用传统 ACID 事务</strong>的业务场景（如订单履约、旅行预订、贷款审批等）。</p>
<blockquote>
<p>它通过将一个全局事务拆解为<strong>一系列本地事务</strong>，并为每个本地事务定义<strong>对应的补偿操作（Compensation）</strong>，从而在发生失败时实现<strong>回滚（补偿）</strong>，最终达成<strong>最终一致性</strong>。</p>
</blockquote>
<ul class="lvl-0">
<li class="lvl-2">
<p>适用于长流程、长时间运行的事务。</p>
</li>
<li class="lvl-2">
<p>无锁、高吞吐。</p>
</li>
<li class="lvl-2">
<p>不能保证中间状态隔离性（可能读到“部分完成”状态）。</p>
</li>
<li class="lvl-2">
<p>补偿逻辑复杂，可能无法完全回滚（如发短信已发出）。</p>
</li>
</ul>
<h4 id="核心思想-3">核心思想</h4>
<p>**“分而治之 + 事后补偿”**机制，</p>
<blockquote>
<ul class="lvl-1">
<li class="lvl-2">
<p><strong>正向操作链</strong>：T1 → T2 → T3 …</p>
</li>
<li class="lvl-2">
<p><strong>失败时反向补偿</strong>：若 T3 失败，则执行 C2 → C1（补偿 T2、T1）</p>
</li>
</ul>
</blockquote>
<pre class="mermaid">sequenceDiagram
    participant Coordinator as Saga协调器
    participant Service1 as 服务1
    participant Service2 as 服务2
    participant Service3 as 服务3

    Coordinator->>Service1: 执行 Step1
    Service1-->>Coordinator: 成功
    Coordinator->>Service2: 执行 Step2
    Service2-->>Coordinator: 成功
    Coordinator->>Service3: 执行 Step3
    alt Step3 成功
        Coordinator-->>Coordinator: 全局成功
    else Step3 失败
        Coordinator->>Service2: 补偿 Compensate2
        Service2-->>Coordinator: 回滚成功
        Coordinator->>Service1: 补偿 Compensate1
        Service1-->>Coordinator: 回滚成功
        Note right of Coordinator: 反向补偿已执行步骤
    end</pre>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>不追求强一致性</strong>，允许中间状态短暂不一致；</p>
</li>
<li class="lvl-2">
<p><strong>每个步骤都是一个本地事务</strong>（可独立提交）；</p>
</li>
<li class="lvl-2">
<p><strong>失败时通过反向操作（补偿）撤销已生效的步骤</strong>；</p>
</li>
<li class="lvl-2">
<p><strong>无需长时间锁定资源</strong>，适合高并发、长时间运行的业务。</p>
</li>
</ul>
<p><strong>两种实现模式</strong>：</p>
<ol>
<li class="lvl-3">
<p><strong>Choreography（事件驱动）</strong>：各服务通过事件通信，自主决定下一步。</p>
<ul class="lvl-2">
<li class="lvl-5"><strong>无中心协调者</strong>；</li>
<li class="lvl-5">每个服务<strong>监听事件并自主决定下一步</strong>；</li>
<li class="lvl-5">通过<strong>事件链</strong>驱动流程，失败时发布<strong>补偿事件</strong>。</li>
</ul>
<pre class="mermaid">   sequenceDiagram
    participant Order as 订单服务
    participant Inventory as 库存服务
    participant Payment as 支付服务

    Order->>Inventory: 扣减库存事件
    Inventory->>Payment: 发起支付事件
    Payment->>Order: 付款成功事件
    Order->>Order: 确认订单

    Note right of Payment: 若支付失败
    Payment->>Inventory: 取消库存扣减事件
    Inventory->>Order: 取消订单事件</pre>
<blockquote>
<p><strong>优点</strong>：服务解耦，无单点瓶颈。<br>
<strong>缺点</strong>：流程分散，难以追踪；补偿逻辑散布各处。</p>
</blockquote>
</li>
<li class="lvl-3">
<p><strong>Orchestration（编排）</strong>：由中心协调器控制流程和补偿。</p>
<ul class="lvl-2">
<li class="lvl-5"><strong>引入 Saga Coordinator（协调器）</strong> 控制整个流程；</li>
<li class="lvl-5">协调器<strong>顺序调用各服务</strong>，并记录执行状态；</li>
<li class="lvl-5">失败时<strong>显式调用补偿接口</strong>。</li>
</ul>
<pre class="mermaid">   sequenceDiagram
    participant Coordinator as Saga协调器
    participant Order as 订单服务
    participant Inventory as 库存服务
    participant Payment as 支付服务

    Coordinator->>Order: 提交订单
    Coordinator->>Inventory: 扣减库存
    Coordinator->>Payment: 发起扣款

    alt 支付失败
        Coordinator->>Inventory: 取消库存扣减 (补偿)
        Coordinator->>Order: 取消订单 (补偿)
    end</pre>
<blockquote>
<p><strong>优点</strong>：流程集中，易监控、重试、调试。<br>
<strong>缺点</strong>：协调器成为中心依赖（但可通过持久化状态保证可靠性）。</p>
</blockquote>
</li>
</ol>
<h4 id="补偿机制">补偿机制</h4>
<p><strong>正向流程</strong>（Forward Flow）</p>
<ol>
<li class="lvl-3">
<p>执行步骤 1 → 提交本地事务；</p>
</li>
<li class="lvl-3">
<p>执行步骤 2 → 提交本地事务；</p>
</li>
<li class="lvl-3">
<p>…</p>
</li>
<li class="lvl-3">
<p>所有步骤成功 → 全局成功。</p>
</li>
</ol>
<p><strong>逆向补偿</strong>（Compensation）</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>若步骤 <strong>N 失败</strong>，则<strong>反向执行 N-1, N-2, …, 1 的补偿操作</strong>；</p>
</li>
<li class="lvl-2">
<p><strong>补偿操作必须幂等</strong>（可能被重复调用）；</p>
</li>
<li class="lvl-2">
<p><strong>补偿不能保证 100% 回滚</strong>（如“发送短信”无法撤回）。</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>补偿方式</th>
</tr>
</thead>
<tbody>
<tr>
<td>扣减库存</td>
<td>释放库存</td>
</tr>
<tr>
<td>冻结金额</td>
<td>解冻金额</td>
</tr>
<tr>
<td>创建订单</td>
<td>标记订单为“已取消”</td>
</tr>
<tr>
<td>发送邮件</td>
<td><strong>无法撤销</strong> → 改为“发送取消通知”</td>
</tr>
</tbody>
</table>
</li>
</ul>
<blockquote>
<p><strong>Saga 无法保证隔离性（Isolation）</strong>：在事务完成前，其他事务可能读到“中间状态”（如订单已创建但未支付）。</p>
<p>解决方案：<strong>语义锁</strong>（如订单状态机）、<strong>乐观锁</strong>、<strong>业务规则校验</strong>。</p>
</blockquote>
<h4 id="应用场景-2">应用场景</h4>
<p>通常为符合的场景：<strong>流程长、步骤多、能补偿、可接收最终一致</strong></p>
<ol>
<li class="lvl-3">
<p><strong>旅行预订</strong></p>
<ul class="lvl-2">
<li class="lvl-5">预订航班 → 预订酒店 → 租车</li>
<li class="lvl-5">若租车失败 → 取消酒店、取消航班</li>
</ul>
</li>
<li class="lvl-3">
<p><strong>电商订单履约</strong></p>
<ul class="lvl-2">
<li class="lvl-5">创建订单 → 锁库存 → 扣款 → 发货</li>
<li class="lvl-5">若扣款失败 → 释放库存、取消订单</li>
</ul>
</li>
<li class="lvl-3">
<p><strong>贷款审批</strong></p>
<ul class="lvl-2">
<li class="lvl-5">提交申请 → 征信查询 → 风控审核 → 放款</li>
<li class="lvl-5">任一环节失败 → 撤销已执行步骤</li>
</ul>
</li>
</ol>
<h3 id="消息模式">消息模式</h3>
<p>基于消息队列的最终一致性（本地消息表 / 消息事务）。</p>
<p>利用消息中间件（如 Kafka、RocketMQ）保证异步操作的最终一致性。</p>
<blockquote>
<ol>
<li class="lvl-3">
<p><strong>本地消息表</strong>：</p>
<ul class="lvl-3">
<li class="lvl-5">在业务数据库中建消息表，与业务操作在同一事务中写入。</li>
<li class="lvl-5">后台任务轮询消息表，发送消息到 MQ。</li>
</ul>
</li>
<li class="lvl-3">
<p><strong>事务消息（如 RocketMQ 的 Half Message）</strong>：</p>
<ul class="lvl-3">
<li class="lvl-5">发送“半消息” → 执行本地事务 → 根据结果提交或回滚消息。</li>
<li class="lvl-5">消费者收到消息后执行下游操作。</li>
</ul>
</li>
</ol>
</blockquote>
<p><strong>优点</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>解耦、高性能、高可用。</p>
</li>
<li class="lvl-2">
<p>适合异步、最终一致性场景。</p>
</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>不支持强一致性。</p>
</li>
<li class="lvl-2">
<p>需处理消息重复、丢失等问题。</p>
</li>
</ul>
<h2 id="Seata-框架"><a href="https://seata.apache.org/zh-cn/docs/user/quickstart">Seata 框架</a></h2>
<p>Seata 是一款开源的<code>分布式事务</code>解决方案，致力于提供<code>高性能</code>和<code>简单易用</code>的分布式事务服务。</p>
<p>Seata 支持多种模式：</p>
<blockquote>
<ul class="lvl-1">
<li class="lvl-2">
<p><strong>AT 模式</strong>（自动补偿）：基于本地事务+全局锁，对业务无侵入。</p>
</li>
<li class="lvl-2">
<p><strong>TCC 模式</strong>：如上所述。</p>
</li>
<li class="lvl-2">
<p><strong>Saga 模式</strong>：长事务编排。</p>
</li>
<li class="lvl-2">
<p><strong>XA 模式</strong>：基于标准 XA 协议（类似 2PC）。</p>
</li>
</ul>
</blockquote>
<h3 id="AT-模式-2"><a href="https://seata.apache.org/zh-cn/docs/dev/mode/at-mode"><strong>AT 模式</strong></a></h3>
<p>AT 模式是 Seata 创新的一种<strong>非侵入式</strong>的分布式事务解决方案</p>
<p>Seata 在内部做了<strong>对数据库操作的代理层</strong>，使用 Seata AT 模式时，实际上用的是 Seata 自带的数据源代理 DataSourceProxy，Seata 在这层代理中加入了很多逻辑，比如插入回滚 undo_log 日志，检查全局锁等。</p>
<p><strong>两阶段提交协议的演变</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>一阶段：业务数据和回滚日志记录在同一个本地事务中提交，释放本地锁和连接资源（全局锁）。</p>
<blockquote>
<ol>
<li class="lvl-3"><strong>解析 SQL</strong>：得到 SQL 的类型（UPDATE），表（product），条件（where name = ‘TXC’）等相关的信息。</li>
<li class="lvl-3"><strong>查询前镜像</strong>：根据解析得到的条件信息，生成查询语句，定位数据。</li>
<li class="lvl-3"><strong>执行业务 SQL</strong>：更新这条记录。</li>
<li class="lvl-3"><strong>查询后镜像</strong>：根据前镜像的结果，通过 <strong>主键</strong> 定位数据。</li>
<li class="lvl-3"><strong>插入回滚日志</strong>：把前后镜像数据以及业务 SQL 相关的信息组成一条回滚日志记录，插入到 <code>UNDO_LOG</code> 表中</li>
<li class="lvl-3"><strong>提交前向 TC 注册分支</strong>：申请 <code>product</code> 表中，主键值等于 1 的记录的 <strong>全局锁</strong> 。</li>
<li class="lvl-3"><strong>本地事务提交</strong>：业务数据的更新和前面步骤中生成的 UNDO LOG 一并提交。</li>
<li class="lvl-3">将本地事务提交的结果上报给 TC。</li>
</ol>
</blockquote>
</li>
<li class="lvl-2">
<p>二阶段：</p>
<ul class="lvl-2">
<li class="lvl-4">提交异步化，非常快速地完成。</li>
<li class="lvl-4">通过一阶段的回滚日志进行反向补偿。</li>
</ul>
<blockquote>
<p><strong>提交</strong>：</p>
<ol>
<li class="lvl-3">收到 TC 的分支提交请求，把请求放入一个异步任务的队列中，马上返回提交成功的结果给 TC。</li>
<li class="lvl-3">异步任务阶段的分支提交请求将异步和批量地删除相应 UNDO LOG 记录。</li>
</ol>
<p><strong>回滚</strong>：</p>
<ol>
<li class="lvl-3">
<p>收到 TC 的分支回滚请求，开启一个本地事务，执行如下操作。</p>
</li>
<li class="lvl-3">
<p>通过 XID 和 Branch ID 查找到相应的 UNDO LOG 记录。</p>
</li>
<li class="lvl-3">
<p>数据校验：拿 UNDO LOG 中的后镜与当前数据进行比较，如果有不同，说明数据被当前全局事务之外的动作做了修改。这种情况，需要根据配置策略来做处理，详细的说明在另外的文档中介绍。</p>
</li>
<li class="lvl-3">
<p>根据 UNDO LOG 中的前镜像和业务 SQL 的相关信息生成并执行回滚的语句。</p>
</li>
<li class="lvl-3">
<p>提交本地事务。并把本地事务的执行结果（即分支事务回滚的结果）上报给 TC。</p>
</li>
</ol>
</blockquote>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GlobalTransactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">purchase</span><span class="params">(String userId, String commodityCode, <span class="type">int</span> count, <span class="type">int</span> money)</span> &#123;</span><br><span class="line">    jdbcTemplateA.update(<span class="string">&quot;update stock_tbl set count = count - ? where commodity_code = ?&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;count, commodityCode&#125;);</span><br><span class="line">    jdbcTemplateB.update(<span class="string">&quot;update account_tbl set money = money - ? where user_id = ?&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;money, userId&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><mark><strong>注意事项：</strong></mark></p>
<ul class="lvl-0">
<li class="lvl-2">
<p>必须要在业务数据库中添加undo_log表，可参考 <a href="https://seata.apache.org/zh-cn/docs/dev/mode/at-mode/">官网</a></p>
</li>
<li class="lvl-2">
<p>必须在所有涉及事务的服务中都引入seata依赖和相关配置，且所有服务的数据库都需要添加undo_log表</p>
</li>
<li class="lvl-2">
<p>事务分组的映射关系，seata 的配置在各个服务之间需保持一致，尤其是 <code>vgroup-mapping</code></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># seata 服务器的配置</span></span><br><span class="line"><span class="attr">seata:</span></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">application:</span> <span class="string">seata-server</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">SEATA_GROUP</span></span><br><span class="line">      <span class="attr">cluster:</span> <span class="string">order-seata</span>  <span class="comment"># 必须与应用中 seata.service.vgroup-mapping 下子节点的值一致</span></span><br><span class="line">      <span class="attr">username:</span> </span><br><span class="line">      <span class="attr">password:</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用中的配置</span></span><br><span class="line"><span class="attr">seata:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Seata 应用编号，默认为 $&#123;spring.application.name&#125;</span></span><br><span class="line">  <span class="attr">application-id:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line">  <span class="comment"># Seata 事务组编号，用于 TC 集群名，默认为 default_tx_group</span></span><br><span class="line">  <span class="attr">tx-service-group:</span> <span class="string">order_tx_group</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="comment"># 虚拟组和分组的映射</span></span><br><span class="line">    <span class="attr">vgroup-mapping:</span></span><br><span class="line">      <span class="comment"># 该节点名称 order_tx_group 必须与上面节点tx-service-group的值保持一致 （若nacos上没有对应名称的配置，就需要手动添加）</span></span><br><span class="line">      <span class="attr">order_tx_group:</span> <span class="string">order-seata</span></span><br><span class="line">    <span class="attr">group-list:</span></span><br><span class="line">      <span class="comment"># 分组和 Seata 服务的映射</span></span><br><span class="line">      <span class="comment">#      该节点名 order-seata 必须与 配置文件中 seata.registry.nacos.cluster的值相对应（注册至nacos注册中心的集群名，默认default）</span></span><br><span class="line">      <span class="comment">#      该节点名 order-seata 必须与上面order_tx_group节点的值相对应</span></span><br><span class="line">      <span class="attr">order-seata:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8091</span></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">application:</span> <span class="string">seata-server</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">cluster:</span> <span class="string">order-seata</span>  <span class="comment"># 必须与上面 seata.service.group-list 的子节点名相对应</span></span><br><span class="line">      <span class="attr">username:</span></span><br><span class="line">      <span class="attr">password:</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">SEATA_GROUP</span></span><br></pre></td></tr></table></figure>
</li>
<li class="lvl-2">
<p>注解 <code>@GlobalTransactional</code> 为代理模式，必须符合动态代理，否则无效</p>
</li>
<li class="lvl-2">
<p>在 <code>@GlobalTransactional </code>之前的所有方法，不能处理异常，包括 <code>@SentinelResource</code> 异常熔断，<code>@SneakyThrows</code>捕获，或者通过<code>@FeignClient </code>调用执行的 熔断降级处理，各个服务之间更不能 catch 其他任何异常</p>
</li>
</ul>
<h3 id="TCC-模式-2"><a href="https://seata.apache.org/zh-cn/docs/user/mode/tcc">TCC 模式</a></h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>通过 <code>@TwoPhaseBusinessAction</code> 注解定义 Try/Confirm/Cancel；</p>
</li>
<li class="lvl-2">
<p>自动处理幂等、空回滚、悬挂等问题；</p>
</li>
<li class="lvl-2">
<p>提供事务日志（事务状态存储）。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TwoPhaseBusinessAction(name = &quot;transfer&quot;, commitMethod = &quot;confirm&quot;, rollbackMethod = &quot;cancel&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">prepare</span><span class="params">(BusinessActionContext context, String userId, <span class="type">double</span> amount)</span> &#123;</span><br><span class="line">    <span class="comment">// Try 逻辑</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">confirm</span><span class="params">(BusinessActionContext context)</span> &#123;</span><br><span class="line">    <span class="comment">// Confirm 逻辑</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">cancel</span><span class="params">(BusinessActionContext context)</span> &#123;</span><br><span class="line">    <span class="comment">// Cancel 逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Saga-模式-2"><a href="https://seata.apache.org/zh-cn/docs/user/mode/saga">Saga 模式</a></h3>
<p>通过状态机定义 Saga 流程（JSON 配置）。</p>
<p>状态机定义：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;StateLanguageVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;StartState&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CreateOrder&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;States&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;CreateOrder&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ServiceTask&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ServiceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;orderService&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ServiceMethod&quot;</span><span class="punctuation">:</span> <span class="string">&quot;create&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;CompensateState&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CancelOrder&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;NextState&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ReserveInventory&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ReserveInventory&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ServiceTask&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ServiceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;inventoryService&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ServiceMethod&quot;</span><span class="punctuation">:</span> <span class="string">&quot;reserve&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;CompensateState&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ReleaseInventory&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;End&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="使用案例">使用案例</h2>
<h3 id="MySQL-的-XA-事务">MySQL 的 XA 事务</h3>
<p>MySQL 从 5.0 开始支持 XA 事务。XA 事务通过以下标准命令操作：</p>
<blockquote>
<ul class="lvl-1">
<li class="lvl-2">
<p>存储引擎为 InnoDB（MyISAM 不支持 XA）。</p>
</li>
<li class="lvl-2">
<p><code>innodb_support_xa</code>（MySQL 5.7+ 默认启用，8.0 已移除此参数，并始终支持）。</p>
</li>
<li class="lvl-2">
<p>应用程序需扮演 <strong>事务管理器（TM）</strong> 角色，协调多个资源。</p>
</li>
</ul>
</blockquote>
<p><strong>示例场景</strong>：假设一个分布式事务涉及 <strong>两个数据库实例</strong>（或同一实例中的两个表），需同时更新：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><code>account_db</code>：用户账户余额</p>
</li>
<li class="lvl-2">
<p><code>order_db</code>：订单状态</p>
</li>
</ul>
<p>执行流程：</p>
<ol>
<li class="lvl-3">
<p>开启 XA 事务（为每个 RM 分配全局事务 ID）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 为第一个资源（如 account 表）开启 XA 事务</span></span><br><span class="line">XA <span class="keyword">START</span> <span class="string">&#x27;txn_id_123&#x27;</span>, <span class="string">&#x27;account_branch&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 执行业务操作</span></span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">100</span> <span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结束第一阶段操作</span></span><br><span class="line">XA <span class="keyword">END</span> <span class="string">&#x27;txn_id_123&#x27;</span>, <span class="string">&#x27;account_branch&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 为第二个资源（如 order 表）开启同一全局事务</span></span><br><span class="line">XA <span class="keyword">START</span> <span class="string">&#x27;txn_id_123&#x27;</span>, <span class="string">&#x27;order_branch&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 执行业务操作</span></span><br><span class="line"><span class="keyword">UPDATE</span> orders <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;paid&#x27;</span> <span class="keyword">WHERE</span> order_id <span class="operator">=</span> <span class="number">1001</span>;</span><br><span class="line"></span><br><span class="line">XA <span class="keyword">END</span> <span class="string">&#x27;txn_id_123&#x27;</span>, <span class="string">&#x27;order_branch&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li class="lvl-3">
<p>准备阶段（PREPARE）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 对两个分支分别 prepare</span></span><br><span class="line">XA <span class="keyword">PREPARE</span> <span class="string">&#x27;txn_id_123&#x27;</span>, <span class="string">&#x27;account_branch&#x27;</span>;</span><br><span class="line">XA <span class="keyword">PREPARE</span> <span class="string">&#x27;txn_id_123&#x27;</span>, <span class="string">&#x27;order_branch&#x27;</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<ul class="lvl-3">
<li class="lvl-2">
<p>写入 <strong>undo log</strong> 和 <strong>redo log</strong></p>
</li>
<li class="lvl-2">
<p>将事务状态标记为 <code>PREPARED</code></p>
</li>
<li class="lvl-2">
<p>持久化到磁盘（保证崩溃后可恢复）</p>
</li>
</ul>
</blockquote>
</li>
<li class="lvl-3">
<p>提交或回滚（根据协调者决策）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 全部 prepare 成功 → 提交</span></span><br><span class="line">XA <span class="keyword">COMMIT</span> <span class="string">&#x27;txn_id_123&#x27;</span>, <span class="string">&#x27;account_branch&#x27;</span>;</span><br><span class="line">XA <span class="keyword">COMMIT</span> <span class="string">&#x27;txn_id_123&#x27;</span>, <span class="string">&#x27;order_branch&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 若任一分支失败 → 回滚</span></span><br><span class="line"><span class="comment">-- XA ROLLBACK &#x27;txn_id_123&#x27;, &#x27;account_branch&#x27;;</span></span><br><span class="line"><span class="comment">-- XA ROLLBACK &#x27;txn_id_123&#x27;, &#x27;order_branch&#x27;;</span></span><br></pre></td></tr></table></figure>
</li>
<li class="lvl-3">
<p>查看事务状态</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">XA RECOVER;  <span class="comment">-- 显示所有处于 PREPARED 状态的 XA 事务</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输出</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------------+--------------+------------+</span></span><br><span class="line"><span class="operator">|</span> formatID <span class="operator">|</span> gtrid_length <span class="operator">|</span> bqual_length <span class="operator">|</span> data       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------------+--------------+------------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span>           <span class="number">11</span> <span class="operator">|</span>           <span class="number">14</span> <span class="operator">|</span> txn_id_123 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------------+--------------+------------+</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ul class="lvl-3">
<li class="lvl-2">
<p>XA 事务会<strong>长时间持有行锁</strong>，影响并发性能。</p>
</li>
<li class="lvl-2">
<p>不支持 DDL 语句（如 <code>ALTER TABLE</code>）。</p>
</li>
<li class="lvl-2">
<p>应用层需实现协调逻辑（或使用 Seata、Atomikos 等 TM 框架）。</p>
</li>
</ul>
</blockquote>
</li>
</ol>
<h3 id="MySQL-崩溃恢复">MySQL 崩溃恢复</h3>
<p><strong>在任意节点崩溃后，如何保证事务的原子性</strong>？这依赖于 <strong>可靠的日志</strong>。</p>
<blockquote>
<ul class="lvl-1">
<li class="lvl-2">
<p><strong>InnoDB 的 XA 恢复</strong>：</p>
<ul class="lvl-3">
<li class="lvl-4">启动时自动扫描 <code>ibdata1</code> 中的 undo log，找出 <code>PREPARED</code> 事务。</li>
<li class="lvl-4">若应用连接断开，可通过 <code>XA RECOVER</code> + 手动 <code>COMMIT/ROLLBACK</code> 处理。</li>
</ul>
</li>
<li class="lvl-2">
<p><strong>日志双写保障</strong>：redo log + binlog（在 MySQL 半同步复制中用于崩溃一致性）。</p>
</li>
</ul>
</blockquote>
<p>本地事务日志 + 全局状态记录的模式实现：</p>
<ol>
<li class="lvl-3">
<p><strong>参与者（RM）的日志</strong></p>
<p>每个参与者在执行 2PC 时，必须记录以下日志到<strong>持久化存储</strong>（如磁盘）：</p>
<table>
<thead>
<tr>
<th>阶段</th>
<th>日志内容</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>执行本地事务后</td>
<td><code>UNDO LOG</code>（回滚用） + <code>REDO LOG</code>（重做用）</td>
<td>支持崩溃后回滚或提交</td>
</tr>
<tr>
<td>收到 <code>PREPARE</code> 后</td>
<td>写入 <strong><code>&lt;TransactionID, PREPARED&gt;</code></strong> 到事务日志</td>
<td>标记事务已进入 2PC</td>
</tr>
<tr>
<td>收到 <code>COMMIT</code> 后</td>
<td>写入 <strong><code>&lt;TransactionID, COMMITTED&gt;</code></strong>，并释放资源</td>
<td>完成提交</td>
</tr>
<tr>
<td>收到 <code>ABORT</code> 后</td>
<td>写入 <strong><code>&lt;TransactionID, ABORTED&gt;</code></strong>，执行 undo</td>
<td>回滚</td>
</tr>
</tbody>
</table>
</li>
<li class="lvl-3">
<p><strong>协调者（TM）的日志</strong></p>
<p>协调者也需记录全局事务状态，状态包括：<code>INIT</code>, <code>PREPARING</code>, <code>PREPARED</code>, <code>COMMITTING</code>, <code>COMMITTED</code>, <code>ABORTED</code></p>
</li>
</ol>
<p><strong>崩溃恢复的几种情况</strong>：</p>
<blockquote>
<ul class="lvl-1">
<li class="lvl-2">
<p>情况 1：<strong>参与者崩溃后重启</strong></p>
<p>读取本地事务日志时发现存在 <code>PREPARED</code> ，且无最终状态的事务时：</p>
<ul class="lvl-3">
<li class="lvl-4">
<p><strong>向协调者查询该事务的最终决策</strong>。</p>
</li>
<li class="lvl-4">
<p>若协调者不可用，则<strong>阻塞等待</strong>。</p>
</li>
</ul>
</li>
<li class="lvl-2">
<p>情况 2：<strong>协调者崩溃后重启</strong></p>
<p>读取自己的日志，对处于 <code>PREPARED</code> 状态的事务：</p>
<ul class="lvl-3">
<li class="lvl-4">
<p>向所有参与者查询状态；</p>
</li>
<li class="lvl-4">
<p>若所有参与者都 <code>PREPARED</code>，则继续发送 <code>COMMIT</code>；</p>
</li>
<li class="lvl-4">
<p>若有任一参与者未 <code>PREPARED</code>，则发送 <code>ABORT</code>。</p>
</li>
</ul>
</li>
<li class="lvl-2">
<p>情况 3：<strong>协调者永久宕机（无恢复）</strong></p>
<p>参与者将<strong>永远阻塞</strong>在 <code>PREPARED</code> 状态（需人工干预或超时机制，但是2PC 本身无超时）。</p>
</li>
</ul>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://pengline.github.io">余一叶知秋尽</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://pengline.github.io/2025/11/a8416e3d58d542d3883d2be1dab051f6/">https://pengline.github.io/2025/11/a8416e3d58d542d3883d2be1dab051f6/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://pengline.github.io" target="_blank">余一叶知秋尽</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/">分布式事务</a><a class="post-meta__tags" href="/tags/2PC%E5%8D%8F%E8%AE%AE/">2PC协议</a><a class="post-meta__tags" href="/tags/3PC%E5%8D%8F%E8%AE%AE/">3PC协议</a><a class="post-meta__tags" href="/tags/XA%E5%8D%8F%E8%AE%AE/">XA协议</a><a class="post-meta__tags" href="/tags/TCC%E6%A8%A1%E5%BC%8F/">TCC模式</a><a class="post-meta__tags" href="/tags/Saga%E6%A8%A1%E5%BC%8F/">Saga模式</a><a class="post-meta__tags" href="/tags/AT%E6%A8%A1%E5%BC%8F/">AT模式</a><a class="post-meta__tags" href="/tags/Seata/">Seata</a></div><div class="post-share"><div class="social-share" data-image="/img/essay/small204025vlPNF1760100025.webp" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/11/bbd3588b364c411b9d216db736b34a97/" title="JVM 几种常用垃圾收集器的比较"><img class="cover" src= "/img/20241215205335173426721579192.webp" data-lazy-src="/img/essay/1712590480744171259048056.webp" onerror="onerror=null;src='/img/k3zssqvjw2d.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">JVM 几种常用垃圾收集器的比较</div></div><div class="info-2"><div class="info-item-1">Java 中四种主流垃圾收集器（Serial、Parallel、CMS、G1）的特点、适用场景以及典型优化方案。</div></div></div></a><a class="pagination-related" href="/2025/11/fa52fee6645d46579a0edf46cc50414b/" title="Java 线程休眠、等待、加入、让步的区别"><img class="cover" src= "/img/20241215205335173426721579192.webp" data-lazy-src="/img/essay/1753762079722175376207982.webp" onerror="onerror=null;src='/img/k3zssqvjw2d.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Java 线程休眠、等待、加入、让步的区别</div></div><div class="info-2"><div class="info-item-1">线程中“休眠（sleep）、等待（wait）、加入（join）、让步（yield）” 的作用、机制和使用场景各有不同。</div></div></div></a></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%91%E6%88%98%E4%B8%8E%E7%9B%AE%E6%A0%87"><span class="toc-number">1.</span> <span class="toc-text">挑战与目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.</span> <span class="toc-text">事务协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%EF%BC%882PC-%E5%8D%8F%E8%AE%AE%EF%BC%89"><span class="toc-number">2.1.</span> <span class="toc-text">两阶段提交（2PC 协议）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%EF%BC%883PC-%E5%8D%8F%E8%AE%AE%EF%BC%89"><span class="toc-number">2.2.</span> <span class="toc-text">三阶段提交（3PC 协议）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XA-%E5%8D%8F%E8%AE%AE%EF%BC%882PC-%E7%9A%84%E6%A0%87%E5%87%86%EF%BC%89"><span class="toc-number">2.3.</span> <span class="toc-text">XA 协议（2PC 的标准）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.</span> <span class="toc-text">事务模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AT-%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.1.</span> <span class="toc-text">AT 模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3"><span class="toc-number">3.1.1.</span> <span class="toc-text">核心思想</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Undo-Log-%E6%9C%BA%E5%88%B6"><span class="toc-number">3.1.2.</span> <span class="toc-text">Undo Log 机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9A%94%E7%A6%BB%E6%80%A7"><span class="toc-number">3.1.3.</span> <span class="toc-text">隔离性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCC-%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.2.</span> <span class="toc-text">TCC 模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3-2"><span class="toc-number">3.2.1.</span> <span class="toc-text">核心思想</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%91%E6%88%98%E4%B8%8E%E5%BA%94%E5%AF%B9"><span class="toc-number">3.2.2.</span> <span class="toc-text">挑战与应对</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">3.2.3.</span> <span class="toc-text">应用场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Saga-%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.3.</span> <span class="toc-text">Saga 模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3-3"><span class="toc-number">3.3.1.</span> <span class="toc-text">核心思想</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%A5%E5%81%BF%E6%9C%BA%E5%88%B6"><span class="toc-number">3.3.2.</span> <span class="toc-text">补偿机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-2"><span class="toc-number">3.3.3.</span> <span class="toc-text">应用场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.4.</span> <span class="toc-text">消息模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Seata-%E6%A1%86%E6%9E%B6"><span class="toc-number">4.</span> <span class="toc-text">Seata 框架</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AT-%E6%A8%A1%E5%BC%8F-2"><span class="toc-number">4.1.</span> <span class="toc-text">AT 模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCC-%E6%A8%A1%E5%BC%8F-2"><span class="toc-number">4.2.</span> <span class="toc-text">TCC 模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Saga-%E6%A8%A1%E5%BC%8F-2"><span class="toc-number">4.3.</span> <span class="toc-text">Saga 模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="toc-number">5.</span> <span class="toc-text">使用案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL-%E7%9A%84-XA-%E4%BA%8B%E5%8A%A1"><span class="toc-number">5.1.</span> <span class="toc-text">MySQL 的 XA 事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL-%E5%B4%A9%E6%BA%83%E6%81%A2%E5%A4%8D"><span class="toc-number">5.2.</span> <span class="toc-text">MySQL 崩溃恢复</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 - 2026 By 余一叶知秋尽</span><span class="framework-info"><span>框架 </span><a href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.3</a></span></div><div class="footer_custom_text"><p><a style="margin-inline:5px"target="_blank"href="https://github.com/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Hosted-Github-brightgreen?style=flat&logo=GitHub"title="本站项目由Gtihub托管"></a><a style="margin-inline:5px"target="_blank"href="https://hexo.io/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo"title="博客框架为Hexo"></a><a style="margin-inline:5px"target="_blank"href="https://butterfly.js.org/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?logoColor=white&style=flat&logo=buefy"title="主题采用butterfly"></a><a style="margin-inline:5px"target="_blank"href="https://giscus.app/zh-CN/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Comment-Giscus-2873df?logoColor=white&style=flat&logo=git"title="评论系统为Giscus"></a><a style="margin-inline:5px"target="_blank"href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris"title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div><script src="https://unpkg.com/mermaid@11.5.0/dist/mermaid.min.js"></script><script>if (window.mermaid) {
  mermaid.initialize({
    startOnLoad: true,
    theme: '[object Object]',
    securityLevel: 'loose',
    flowchart: { useMaxWidth: true, htmlLabels: true }
  });
}</script></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="日间和夜间模式切换"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getGiscusTheme = theme => theme === 'dark' ? 'dark' : 'light'

  const createScriptElement = config => {
    const ele = document.createElement('script')
    Object.entries(config).forEach(([key, value]) => {
      ele.setAttribute(key, value)
    })
    return ele
  }

  const loadGiscus = (el = document, key) => {
    const mappingConfig = isShuoshuo
      ? { 'data-mapping': 'specific', 'data-term': key }
      : { 'data-mapping': (option && option['data-mapping']) || 'pathname' }

    const giscusConfig = {
      src: 'https://giscus.app/client.js',
      'data-repo': 'pengline/pengline.github.io',
      'data-repo-id': 'R_kgDOPqG50w',
      'data-category-id': 'DIC_kwDOPqG5084Cu_K9',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      'data-lang': 'zh-CN',
      'data-input-position': 'top',
      async: true,
      ...option,
      ...mappingConfig
    }

    const scriptElement = createScriptElement(giscusConfig)

    el.querySelector('#giscus-wrap').appendChild(scriptElement)

    if (isShuoshuo) {
      window.shuoshuoComment.destroyGiscus = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }
  }

  const changeGiscusTheme = theme => {
    const iframe = document.querySelector('#giscus-wrap iframe')
    if (iframe) {
      const message = {
        giscus: {
          setConfig: {
            theme: getGiscusTheme(theme),
            lang: 'zh-CN'
          }
        }
      }
      iframe.contentWindow.postMessage(message, 'https://giscus.app')
    }
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if (isShuoshuo) {
    'Giscus' === 'Giscus'
      ? window.shuoshuoComment = { loadComment: loadGiscus }
      : window.loadOtherComment = loadGiscus
    return
  }

  if ('Giscus' === 'Giscus' || !false) {
    if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment = loadGiscus
  }
})()</script></div><script src="/js/custom/sun_moon.js" async></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>