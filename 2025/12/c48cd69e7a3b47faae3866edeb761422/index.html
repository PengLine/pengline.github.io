<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>同步 Mysql 数据的多种方式和策略 | 余一叶知秋尽</title><meta name="author" content="余一叶知秋尽"><meta name="copyright" content="余一叶知秋尽"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="将 MySQL 数据同步至 ES、Redis 等其他数据库，有多种同步策略，各自特点对应不同的应用场景。">
<meta property="og:type" content="article">
<meta property="og:title" content="同步 Mysql 数据的多种方式和策略">
<meta property="og:url" content="https://pengline.github.io/2025/12/c48cd69e7a3b47faae3866edeb761422/index.html">
<meta property="og:site_name" content="余一叶知秋尽">
<meta property="og:description" content="将 MySQL 数据同步至 ES、Redis 等其他数据库，有多种同步策略，各自特点对应不同的应用场景。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pengline.github.io/img/essay/1658045160332165804516032.webp">
<meta property="article:published_time" content="2025-12-02T16:00:00.000Z">
<meta property="article:modified_time" content="2026-01-16T11:20:32.250Z">
<meta property="article:author" content="余一叶知秋尽">
<meta property="article:tag" content="MySQL同步Redis">
<meta property="article:tag" content="MySQL数据同步，MySQL同步ES">
<meta property="article:tag" content="Flink SQL">
<meta property="article:tag" content="Flink CDC">
<meta property="article:tag" content="MySQL Binlog">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pengline.github.io/img/essay/1658045160332165804516032.webp"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "同步 Mysql 数据的多种方式和策略",
  "url": "https://pengline.github.io/2025/12/c48cd69e7a3b47faae3866edeb761422/",
  "image": "https://pengline.github.io/img/essay/1658045160332165804516032.webp",
  "datePublished": "2025-12-02T16:00:00.000Z",
  "dateModified": "2026-01-16T11:20:32.250Z",
  "author": [
    {
      "@type": "Person",
      "name": "余一叶知秋尽",
      "url": "https://pengline.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://pengline.github.io/2025/12/c48cd69e7a3b47faae3866edeb761422/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":30,"languages":{"author":"作者: 余一叶知秋尽","link":"链接: ","source":"来源: 余一叶知秋尽","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '同步 Mysql 数据的多种方式和策略',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/font.css"><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="余一叶知秋尽" type="application/atom+xml">
</head><body><div id="web_bg" style="background: LightGray;"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="/img/butterfly-icon.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">52</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">236</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">41</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list-ul"></i><span> 归档</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类别</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签集</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-outdent"></i><span> AI</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/ai/aigc/"><i class="fa-fw fas fa-cubes"></i><span> AIGC 创意平台</span></a></li><li><a class="site-page child" href="/ai/agent/medical/"><i class="fa-fw fas fa-medkit"></i><span> 医疗问答Agent</span></a></li><li><a class="site-page child" href="https://github.com/HengLine/ai-stocks-agent"><i class="fa-fw fas fa-line-chart"></i><span> 股票分析Agent</span></a></li><li><a class="site-page child" href="/ai/agent/video/"><i class="fa-fw fas fa-cut"></i><span> 视频混剪Agent</span></a></li><li><a class="site-page child" href="https://github.com/HengLine/video-shot-agent"><i class="fa-fw fas fa-file-video"></i><span> 剧本分镜Agent</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list-ol"></i><span> 项目</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/turnkey/smart-city"><i class="fa-fw fas fa-building"></i><span> 智慧城市</span></a></li><li><a class="site-page child" href="/turnkey/smart-security"><i class="fa-fw fas fa-check-circle"></i><span> 智慧安检</span></a></li><li><a class="site-page child" href="/turnkey/tms"><i class="fa-fw fas fa-truck"></i><span> 物流运输</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-cogs"></i><span> 工具</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/tools/json/"><i class="fa-fw fas fa-cog"></i><span> JSON 转换工具集</span></a></li><li><a class="site-page child" href="/tools/diagrams/mermaid"><i class="fa-fw fas fa-pie-chart"></i><span> 在线绘制 UML 图</span></a></li><li><a class="site-page child" href="/tools/image/compressor/"><i class="fa-fw fas fa-image"></i><span> 图像批量压缩大小</span></a></li><li><a class="site-page child" href="/tools/image/watermark/"><i class="fa-fw fas fa-image"></i><span> 图像批量添加水印</span></a></li><li><a class="site-page child" href="/tools/image/convert/"><i class="fa-fw fas fa-file-image"></i><span> 图像格式编码转换</span></a></li><li><a class="site-page child" href="/tools/video/cropping/"><i class="fa-fw fas fa-cut"></i><span> 视频时长范围裁剪</span></a></li><li><a class="site-page child" href="/tools/video/watermark/"><i class="fa-fw fas fa-video"></i><span> 视频加水印马赛克</span></a></li><li><a class="site-page child" href="/tools/download/"><i class="fa-fw fas fa-cloud-download"></i><span> 批量下载视频图片</span></a></li><li><a class="site-page child" href="/tools/docu/watermark/"><i class="fa-fw fas fa-file-pdf"></i><span> PDF 文档添加水印</span></a></li><li><a class="site-page child" href="/tools/docu/signature"><i class="fa-fw fas fa-file"></i><span> 文档在线手写签名</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-pencil-square"></i><span> 文学</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/literature/poems"><i class="fa-fw fas fa-align-center"></i><span> 三行诗集</span></a></li><li><a class="site-page child" href="/literature/classical"><i class="fa-fw fas fa-align-justify"></i><span> 诗词歌赋</span></a></li><li><a class="site-page child" href="/literature/modern"><i class="fa-fw fas fa-align-left"></i><span> 现代诗歌</span></a></li><li><a class="site-page child" href="/literature/journal"><i class="fa-fw fas fa-align-right"></i><span> 随心随笔</span></a></li><li><a class="site-page child" href="/literature/incomplete"><i class="fa-fw fas fa-columns"></i><span> 忘梦残句</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-commenting"></i><span> 交流</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/messageboard/"><i class="fa-fw fas fa-paper-plane"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/essay/1658045160332165804516032.webp);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src= "/img/20241215205335173426721579192.webp" data-lazy-src="/img/logo.png" alt="Logo"><span class="site-name">余一叶知秋尽</span></a><a class="nav-page-title" href="/"><span class="site-name">同步 Mysql 数据的多种方式和策略</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list-ul"></i><span> 归档</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类别</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签集</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-outdent"></i><span> AI</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/ai/aigc/"><i class="fa-fw fas fa-cubes"></i><span> AIGC 创意平台</span></a></li><li><a class="site-page child" href="/ai/agent/medical/"><i class="fa-fw fas fa-medkit"></i><span> 医疗问答Agent</span></a></li><li><a class="site-page child" href="https://github.com/HengLine/ai-stocks-agent"><i class="fa-fw fas fa-line-chart"></i><span> 股票分析Agent</span></a></li><li><a class="site-page child" href="/ai/agent/video/"><i class="fa-fw fas fa-cut"></i><span> 视频混剪Agent</span></a></li><li><a class="site-page child" href="https://github.com/HengLine/video-shot-agent"><i class="fa-fw fas fa-file-video"></i><span> 剧本分镜Agent</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list-ol"></i><span> 项目</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/turnkey/smart-city"><i class="fa-fw fas fa-building"></i><span> 智慧城市</span></a></li><li><a class="site-page child" href="/turnkey/smart-security"><i class="fa-fw fas fa-check-circle"></i><span> 智慧安检</span></a></li><li><a class="site-page child" href="/turnkey/tms"><i class="fa-fw fas fa-truck"></i><span> 物流运输</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-cogs"></i><span> 工具</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/tools/json/"><i class="fa-fw fas fa-cog"></i><span> JSON 转换工具集</span></a></li><li><a class="site-page child" href="/tools/diagrams/mermaid"><i class="fa-fw fas fa-pie-chart"></i><span> 在线绘制 UML 图</span></a></li><li><a class="site-page child" href="/tools/image/compressor/"><i class="fa-fw fas fa-image"></i><span> 图像批量压缩大小</span></a></li><li><a class="site-page child" href="/tools/image/watermark/"><i class="fa-fw fas fa-image"></i><span> 图像批量添加水印</span></a></li><li><a class="site-page child" href="/tools/image/convert/"><i class="fa-fw fas fa-file-image"></i><span> 图像格式编码转换</span></a></li><li><a class="site-page child" href="/tools/video/cropping/"><i class="fa-fw fas fa-cut"></i><span> 视频时长范围裁剪</span></a></li><li><a class="site-page child" href="/tools/video/watermark/"><i class="fa-fw fas fa-video"></i><span> 视频加水印马赛克</span></a></li><li><a class="site-page child" href="/tools/download/"><i class="fa-fw fas fa-cloud-download"></i><span> 批量下载视频图片</span></a></li><li><a class="site-page child" href="/tools/docu/watermark/"><i class="fa-fw fas fa-file-pdf"></i><span> PDF 文档添加水印</span></a></li><li><a class="site-page child" href="/tools/docu/signature"><i class="fa-fw fas fa-file"></i><span> 文档在线手写签名</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-pencil-square"></i><span> 文学</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/literature/poems"><i class="fa-fw fas fa-align-center"></i><span> 三行诗集</span></a></li><li><a class="site-page child" href="/literature/classical"><i class="fa-fw fas fa-align-justify"></i><span> 诗词歌赋</span></a></li><li><a class="site-page child" href="/literature/modern"><i class="fa-fw fas fa-align-left"></i><span> 现代诗歌</span></a></li><li><a class="site-page child" href="/literature/journal"><i class="fa-fw fas fa-align-right"></i><span> 随心随笔</span></a></li><li><a class="site-page child" href="/literature/incomplete"><i class="fa-fw fas fa-columns"></i><span> 忘梦残句</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-commenting"></i><span> 交流</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/messageboard/"><i class="fa-fw fas fa-paper-plane"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">同步 Mysql 数据的多种方式和策略</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-12-02T16:00:00.000Z" title="发表于 2025-12-03 00:00:00">2025-12-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-01-16T11:20:32.250Z" title="更新于 2026-01-16 19:20:32">2026-01-16</time></span></div><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/DB/">DB</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/DB/MySQL/">MySQL</a></span><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p>将 MySQL 数据同步至 Elasticsearch（ES）或 Redis  是系统中的常见需求。根据业务场景、数据量、一致性要求和实时性要求，可以采用多种策略。</p>
<h2 id="双写机制（增量）">双写机制（增量）</h2>
<p>应用在写入 MySQL 的同时，也向 ES 写入一份数据。</p>
<blockquote>
<p><strong>优点</strong>：</p>
<ul class="lvl-1">
<li class="lvl-2">实现简单，无需额外中间件。</li>
<li class="lvl-2">写入延迟低（同步写）。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul class="lvl-1">
<li class="lvl-2">
<p><strong>一致性难保障</strong>：若 ES 写入失败，MySQL 已提交，会造成数据不一致。</p>
</li>
<li class="lvl-2">
<p><strong>耦合度高</strong>：业务代码需同时处理两个数据源。</p>
</li>
</ul>
</blockquote>
<pre class="mermaid">sequenceDiagram
    participant Client as 客户端
    participant App as 应用服务
    participant MySQL as MySQL
    participant ES as Elasticsearch

    Client->>App: 发送写请求 (e.g., 更新用户)
    App->>MySQL: 1. 执行 SQL 写入/更新
    MySQL-->>App: 2. 返回成功
    alt MySQL 写入成功
        App->>ES: 3. 同步写入 ES 文档
        alt ES 写入成功
            ES-->>App: 4. 返回成功
            App-->>Client: 5. 返回操作成功
        else ES 写入失败
            Note right of App: 数据不一致！<br/>MySQL 已提交，ES 未更新
            App-->>Client: 6. 返回部分成功或错误
        end
    else MySQL 写入失败
        App-->>Client: 返回失败（ES 不会写入）
    end</pre>
<p><strong>适用场景</strong>：数据一致性要求不高、写入量小、业务逻辑简单的场景。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DualWriteDemo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DB_URL</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DB_USER</span> <span class="operator">=</span> <span class="string">&quot;root&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DB_PASS</span> <span class="operator">=</span> <span class="string">&quot;123456&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 初始化 ES Client</span></span><br><span class="line">        <span class="type">RestClient</span> <span class="variable">restClient</span> <span class="operator">=</span> RestClient.builder(<span class="keyword">new</span> <span class="title class_">HttpHost</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">9200</span>)).build();</span><br><span class="line">        <span class="type">ElasticsearchTransport</span> <span class="variable">transport</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestClientTransport</span>(restClient, <span class="keyword">new</span> <span class="title class_">JacksonJsonpMapper</span>());</span><br><span class="line">        <span class="type">ElasticsearchClient</span> <span class="variable">esClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ElasticsearchClient</span>(transport);</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="number">1001L</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;张三&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 写 MySQL</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> DriverManager.getConnection(DB_URL, DB_USER, DB_PASS)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;INSERT INTO users(id, name) VALUES (?, ?) &quot;</span> +</span><br><span class="line">                         <span class="string">&quot;ON DUPLICATE KEY UPDATE name = ?&quot;</span>;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">PreparedStatement</span> <span class="variable">ps</span> <span class="operator">=</span> conn.prepareStatement(sql)) &#123;</span><br><span class="line">                ps.setLong(<span class="number">1</span>, userId);</span><br><span class="line">                ps.setString(<span class="number">2</span>, name);</span><br><span class="line">                ps.setString(<span class="number">3</span>, name);</span><br><span class="line">                ps.executeUpdate();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 写 ES</span></span><br><span class="line">        esClient.index(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>.Builder&lt;&gt;()</span><br><span class="line">            .index(<span class="string">&quot;users&quot;</span>)</span><br><span class="line">            .id(String.valueOf(userId))</span><br><span class="line">            .document(java.util.Map.of(<span class="string">&quot;id&quot;</span>, userId, <span class="string">&quot;name&quot;</span>, name))</span><br><span class="line">            .build()</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        esClient._transport().close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="定时轮询（全量-增量）">定时轮询（全量/增量）</h2>
<p>通过定时任务，定时查询 MySQL（如通过 <code>update_time</code>或 <code>ID</code> 字段），将新增或修改的数据同步到 ES。</p>
<blockquote>
<p><strong>优点</strong>：</p>
<ul class="lvl-1">
<li class="lvl-2">实现简单，无需 binlog 权限。</li>
<li class="lvl-2">适合历史数据初始化。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul class="lvl-1">
<li class="lvl-2">
<p><strong>延迟高</strong>：取决于轮询间隔。</p>
</li>
<li class="lvl-2">
<p><strong>性能压力</strong>：频繁查询可能影响 MySQL。</p>
</li>
<li class="lvl-2">
<p>难以处理删除操作（需软删除标记）。</p>
</li>
</ul>
</blockquote>
<pre class="mermaid">sequenceDiagram
    participant Scheduler as 定时调度器
    participant SyncService as 同步服务
    participant MySQL as MySQL
    participant ES as Elasticsearch

    loop 每 N 秒/分钟执行一次
        Scheduler->>SyncService: 触发同步任务
        SyncService->>MySQL: 1. 查询增量数据<br/>（如 WHERE update_time > '${last_sync_time}'）
        MySQL-->>SyncService: 2. 返回变更记录列表
        alt 存在变更数据
            loop 遍历每条记录
                SyncService->>ES: 3. 写入/更新 ES 文档
                ES-->>SyncService: 4. 确认写入
            end
            SyncService->>SyncService: 5. 更新 last_sync_time = max(update_time)
        else 无新数据
            Note over SyncService: 无操作，等待下次轮询
        end
    end</pre>
<p><strong>适用场景</strong>：对实时性要求低、数据变更频率低的小型系统。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 伪代码：定时轮询 MySQL 同步到 Elasticsearch</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySqlToEsSyncDemo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ES_INDEX</span> <span class="operator">=</span> <span class="string">&quot;demo&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MYSQL_QUERY_TEMPLATE</span> <span class="operator">=</span> </span><br><span class="line">        <span class="string">&quot;SELECT id, name, update_time FROM demo WHERE update_time &gt; ? ORDER BY update_time ASC&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DataSource mysqlDataSource; <span class="comment">// MySQL 连接池</span></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient esClient; <span class="comment">// Elasticsearch 客户端</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定时任务入口</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">MySqlToEsSyncDemo</span> <span class="variable">sync</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MySqlToEsSyncDemo</span>();</span><br><span class="line">        sync.init();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用 ScheduledExecutorService 定时执行</span></span><br><span class="line">        <span class="type">ScheduledExecutorService</span> <span class="variable">scheduler</span> <span class="operator">=</span> Executors.newSingleThreadScheduledExecutor();</span><br><span class="line">        scheduler.scheduleAtFixedRate(sync::syncData, <span class="number">0</span>, <span class="number">30</span>, TimeUnit.SECONDS); <span class="comment">// 每30秒同步一次</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 初始化 MySQL 数据源</span></span><br><span class="line">        mysqlDataSource = createMySqlDataSource();</span><br><span class="line">        <span class="comment">// 初始化 ES 客户端</span></span><br><span class="line">        esClient = createEsClient();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">syncData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 读取上次同步的时间戳</span></span><br><span class="line">            <span class="type">Instant</span> <span class="variable">lastSyncTime</span> <span class="operator">=</span> readLastSyncTime();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 查询 MySQL 中 update_time &gt; lastSyncTime 的记录</span></span><br><span class="line">            List&lt;Record&gt; records = queryFromMysql(lastSyncTime);</span><br><span class="line">            <span class="keyword">if</span> (records.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 批量写入 Elasticsearch</span></span><br><span class="line">            <span class="type">BulkRequest</span> <span class="variable">bulkRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BulkRequest</span>();</span><br><span class="line">            <span class="keyword">for</span> (Record record : records) &#123;</span><br><span class="line">                <span class="comment">// 构造 ES Document</span></span><br><span class="line">                Map&lt;String, Object&gt; source = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                source.put(<span class="string">&quot;id&quot;</span>, record.id);</span><br><span class="line">                source.put(<span class="string">&quot;name&quot;</span>, record.name);</span><br><span class="line">                source.put(<span class="string">&quot;update_time&quot;</span>, record.updateTime);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 使用 id 作为 ES 的 _id，避免重复</span></span><br><span class="line">                bulkRequest.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>(ES_INDEX)</span><br><span class="line">                    .id(String.valueOf(record.id))</span><br><span class="line">                    .source(source));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">BulkResponse</span> <span class="variable">bulkResponse</span> <span class="operator">=</span> esClient.bulk(bulkRequest, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="keyword">if</span> (!bulkResponse.hasFailures()) &#123;</span><br><span class="line">                <span class="comment">// 更新最后同步时间（取本次同步的最新 update_time）</span></span><br><span class="line">                <span class="type">Instant</span> <span class="variable">newSyncTime</span> <span class="operator">=</span> records.get(records.size() - <span class="number">1</span>).updateTime;</span><br><span class="line">                writeLastSyncTime(newSyncTime);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.error(<span class="string">&quot;Bulk write to ES failed&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Sync failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Instant <span class="title function_">readLastSyncTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 从 Redis / DB 中读取上次同步时间，若首次运行，返回一个较早的时间（如 1970-01-01）</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeLastSyncTime</span><span class="params">(Instant time)</span> &#123;</span><br><span class="line">        <span class="comment">// 持久化最新的同步时间</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Record&gt; <span class="title function_">queryFromMysql</span><span class="params">(Instant sinceTime)</span> &#123;</span><br><span class="line">        <span class="comment">// 注意：update_time 字段需有索引以提高查询效率</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="消息队列（全量-增量）">消息队列（全量/增量）</h2>
<p>应用在写 MySQL 后，发送消息到 Kafka/RabbitMQ，由消费者负责写入 ES。</p>
<blockquote>
<p><strong>优点</strong>：</p>
<ul class="lvl-1">
<li class="lvl-2">解耦应用与 ES。</li>
<li class="lvl-2">可重试、削峰填谷。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul class="lvl-1">
<li class="lvl-2">
<p>存在“先写 DB 成功、发消息失败”的一致性问题（需事务消息或本地消息表）。</p>
<ul class="lvl-3">
<li class="lvl-4"><strong>本地事务表 + 定时补偿</strong>。</li>
<li class="lvl-4"><strong>RocketMQ 事务消息</strong> 或 <strong>Kafka 事务</strong>（需强一致性）。</li>
</ul>
</li>
<li class="lvl-2">
<p>架构复杂度增加。</p>
</li>
</ul>
</blockquote>
<pre class="mermaid">sequenceDiagram
    participant Client as 客户端
    participant App as 应用服务
    participant MQ as 消息队列
    participant SyncConsumer as ES 同步消费者
    participant MySQL as MySQL
    participant ES as Elasticsearch

    Client->>App: 发送写请求 (e.g., 创建/更新用户)
    
    %% 应用先写数据库（关键：DB 写入必须在发消息前完成）
    App->>MySQL: 1. 执行 SQL 写入/更新
    MySQL-->>App: 2. 返回成功

    alt MySQL 写入成功
        App->>MQ: 3. 发送变更消息<br/>({id:1001, name:"张三", op:"upsert"})
        MQ-->>App: 4. 消息确认 (ACK)
        App-->>Client: 5. 返回操作成功
        
        %% 异步消费
        activate SyncConsumer
        MQ->>SyncConsumer: 6. 推送/拉取消息
        SyncConsumer->>ES: 7. 写入/更新 ES 文档
        alt ES 写入成功
            ES-->>SyncConsumer: 8a. 确认
            SyncConsumer->>MQ: 9a. 提交偏移量 (Commit Offset)
        else ES 写入失败
            Note right of SyncConsumer: 重试或进入死信队列
            loop 重试 (带退避)
                SyncConsumer->>ES: 重试写入
            end
            %% 可选：记录失败日志供人工干预
        end
        deactivate SyncConsumer
    else MySQL 写入失败
        App-->>Client: 返回失败（不发消息）
    end</pre>
<p><strong>Producer：业务服务写 DB成功好发送 RocketMQ</strong></p>
<p>全量同步时，发送所有数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EsSyncProducer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RocketMQTemplate rocketMQTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createUser</span><span class="params">(String name, String email)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setName(name);</span><br><span class="line">        user.setEmail(email);</span><br><span class="line">        user.setCreateTime(LocalDateTime.now());</span><br><span class="line">        userMapper.insert(user);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造同步事件（必须在事务提交后发送，避免回滚后消息已发）推荐使用 TransactionalEventListener 或异步线程池</span></span><br><span class="line">        sendSyncEventToMQ(user, <span class="string">&quot;INSERT&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 手动触发事件（在事务内调用）</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendSyncEventToMQ</span><span class="params">(User user, String eventType)</span> &#123;</span><br><span class="line">        <span class="comment">// Spring 会在事务成功提交后触发 @EventListener</span></span><br><span class="line">        applicationEventPublisher.publishEvent(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">UserSavedEvent</span>(<span class="built_in">this</span>, user, <span class="literal">true</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 TransactionalEventListener 确保在事务成功提交后才发消息</span></span><br><span class="line">    <span class="meta">@EventListener(condition = &quot;#event.success&quot;)</span></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleUserSaved</span><span class="params">(UserSavedEvent event)</span> &#123;</span><br><span class="line">        <span class="type">SyncEvent</span> <span class="variable">syncEvent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SyncEvent</span>();</span><br><span class="line">        syncEvent.setEventType(<span class="string">&quot;INSERT&quot;</span>);</span><br><span class="line">        syncEvent.setTable(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        syncEvent.setId(event.getUser().getId());</span><br><span class="line">        syncEvent.setData(Map.of(</span><br><span class="line">            <span class="string">&quot;id&quot;</span>, event.getUser().getId(),</span><br><span class="line">            <span class="string">&quot;name&quot;</span>, event.getUser().getName(),</span><br><span class="line">            <span class="string">&quot;email&quot;</span>, event.getUser().getEmail()</span><br><span class="line">        ));</span><br><span class="line"></span><br><span class="line">        rocketMQTemplate.convertAndSend(<span class="string">&quot;MYSQL_TO_ES_TOPIC&quot;</span>, syncEvent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Consumer：消费 RocketMQ 消息并同步到 Elasticsearch</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RocketMQMessageListener(</span></span><br><span class="line"><span class="meta">    topic = &quot;MYSQL_TO_ES_TOPIC&quot;,</span></span><br><span class="line"><span class="meta">    consumerGroup = &quot;es-sync-group&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EsSyncConsumer</span> <span class="keyword">implements</span> <span class="title class_">RocketMQListener</span>&lt;SyncEvent&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient esClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(SyncEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">index</span> <span class="operator">=</span> event.getTable();</span><br><span class="line">            <span class="type">String</span> <span class="variable">docId</span> <span class="operator">=</span> String.valueOf(event.getId());</span><br><span class="line">            Map&lt;String, Object&gt; doc = event.getData();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;DELETE&quot;</span>.equals(event.getEventType())) &#123;</span><br><span class="line">                esClient.delete(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">DeleteRequest</span>(index).id(docId),</span><br><span class="line">                    RequestOptions.DEFAULT</span><br><span class="line">                );</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                esClient.index(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">IndexRequest</span>(index)</span><br><span class="line">                        .id(docId)</span><br><span class="line">                        .source(doc, XContentType.JSON),</span><br><span class="line">                    RequestOptions.DEFAULT</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;ES sync failed, event: &#123;&#125;, error: &#123;&#125;&quot;</span>, event, e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e); <span class="comment">// 触发重试</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="三方工具（生产）">三方工具（生产）</h2>
<h3 id="基于-Binlog-工具">基于 Binlog 工具</h3>
<p>通过解析 MySQL 的 binlog（如使用 <strong>Canal、Debezium、Maxwell</strong>），捕获数据变更事件，再推送到 ES。</p>
<blockquote>
<p><strong>流程</strong>：MySQL → Binlog → Canal/Debezium → Kafka → 消费者 → ES</p>
</blockquote>
<blockquote>
<p><strong>优点</strong>：</p>
<ul class="lvl-1">
<li class="lvl-2"><strong>解耦</strong>：业务无感知，不侵入应用代码。</li>
<li class="lvl-2"><strong>可靠性高</strong>：基于 binlog，能保证数据变更不丢失（配合 ACK 机制）。</li>
<li class="lvl-2"><strong>支持增量同步</strong>。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul class="lvl-1">
<li class="lvl-2">
<p>部署维护较复杂（需部署 binlog 解析服务 + 消息队列）。</p>
</li>
<li class="lvl-2">
<p>需处理 DDL 变更、字段映射、ES 文档结构变更等问题。</p>
</li>
<li class="lvl-2">
<p>涉及节点较多，变更维护成本高</p>
</li>
</ul>
</blockquote>
<pre class="mermaid">sequenceDiagram
    participant MySQL as MySQL
    participant CanalServer as Canal Server
    participant CanalClient as Canal Client (Java 应用)
    participant ES as Elasticsearch

    Note over MySQL: 开启 binlog<br/>binlog-format=ROW

    %% 初始化：Canal Server 连接 MySQL
    CanalServer->>MySQL: 1. 模拟 MySQL Slave<br/>请求 binlog dump
    MySQL-->>CanalServer: 2. 允许连接，发送 binlog 流

    %% 数据变更触发
    Note right of MySQL: 用户执行:<br/>UPDATE users SET name='李四' WHERE id=1001;

    MySQL->>MySQL: 3. 写入 binlog (Row 格式)

    MySQL->>CanalServer: 4. 实时推送 binlog 事件
    CanalServer->>CanalClient: 5. 推送解析后的结构化变更事件<br/>(如 JSON 或 Protocol Buffer)

    activate CanalClient
    CanalClient->>CanalClient: 6. 解析事件：<br/>table=test.users, op=UPDATE,<br/>after={id:1001, name:"李四"}

    alt 是目标表(users)
        CanalClient->>ES: 7. 构造 ES 文档并写入<br/>PUT /users/_doc/1001 { "name": "李四" }
        ES-->>CanalClient: 8. 写入成功响应
        CanalClient->>CanalServer: 9. 确认消费位点 (ACK)
    else 非目标表
        CanalClient->>CanalServer: 忽略并 ACK
    end
    deactivate CanalClient

    Note over CanalClient: 持续监听，支持 INSERT/UPDATE/DELETE</pre>
<p><strong>常见工具</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>Canal</strong>（阿里开源，Java）</p>
</li>
<li class="lvl-2">
<p><strong>Debezium</strong>（基于 Kafka Connect，支持多种数据库）</p>
</li>
<li class="lvl-2">
<p><strong>Maxwell</strong>（轻量，输出 JSON 到 Kafka/Stdout）</p>
</li>
</ul>
<p><strong>适用场景</strong>：高可靠、准实时同步，数据量大，需解耦业务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CanalSyncDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. 连接 Canal Server</span></span><br><span class="line">        <span class="type">CanalConnector</span> <span class="variable">connector</span> <span class="operator">=</span> CanalConnectors.newSingleConnector(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">11111</span>), <span class="string">&quot;example&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        connector.connect();</span><br><span class="line">        connector.subscribe(<span class="string">&quot;test\\.users&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 初始化 ES</span></span><br><span class="line">        <span class="type">ElasticsearchClient</span> <span class="variable">esClient</span> <span class="operator">=</span> createEsClient();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> connector.get(<span class="number">1000</span>);</span><br><span class="line">            handleEntries(message.getEntries(), esClient);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleEntries</span><span class="params">(List&lt;CanalEntry.Entry&gt; entries, ElasticsearchClient esClient)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (CanalEntry.Entry entry : entries) &#123;</span><br><span class="line">            <span class="keyword">if</span> (entry.getEntryType() != CanalEntry.EntryType.ROWDATA) &#123;</span><br><span class="line">                <span class="keyword">continue</span>; <span class="comment">// 非行数据，跳过</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                CanalEntry.<span class="type">RowChange</span> <span class="variable">rowChange</span> <span class="operator">=</span> CanalEntry.RowChange.parseFrom(entry.getStoreValue());</span><br><span class="line">                handleRowChange(rowChange, esClient);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvalidProtocolBufferException e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;Failed to parse RowChange: &quot;</span> + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleRowChange</span><span class="params">(CanalEntry.RowChange rowChange, ElasticsearchClient esClient)</span> &#123;</span><br><span class="line">        CanalEntry.<span class="type">EventType</span> <span class="variable">eventType</span> <span class="operator">=</span> rowChange.getEventType();</span><br><span class="line">        <span class="keyword">if</span> (eventType != CanalEntry.EventType.INSERT &amp;&amp; eventType != CanalEntry.EventType.UPDATE) &#123;</span><br><span class="line">            <span class="keyword">return</span>; <span class="comment">// 只处理 INSERT 和 UPDATE</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (CanalEntry.RowData rowData : rowChange.getRowDatasList()) &#123;</span><br><span class="line">            extractAndSyncToEs(rowData, esClient);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">extractAndSyncToEs</span><span class="params">(CanalEntry.RowData rowData, ElasticsearchClient esClient)</span> &#123;</span><br><span class="line">        Map&lt;String, String&gt; afterMap = rowData.getAfterColumnsList().stream()</span><br><span class="line">            .filter(CanalEntry.Column::getUpdated) <span class="comment">// 只取更新过的列（或保留所有）</span></span><br><span class="line">            .collect(Collectors.toMap(</span><br><span class="line">                CanalEntry.Column::getName,</span><br><span class="line">                CanalEntry.Column::getValue,</span><br><span class="line">                (v1, v2) -&gt; v1 <span class="comment">// 防重，理论上不会有重复列名</span></span><br><span class="line">            ));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果 afterColumns 为空（比如 DELETE），跳过</span></span><br><span class="line">        <span class="keyword">if</span> (afterMap.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> afterMap.get(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> afterMap.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (id == <span class="literal">null</span> || name == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            esClient.index(b -&gt; b</span><br><span class="line">                .index(<span class="string">&quot;users&quot;</span>)</span><br><span class="line">                .id(id)</span><br><span class="line">                .document(Map.of(<span class="string">&quot;id&quot;</span>, Long.parseLong(id), <span class="string">&quot;name&quot;</span>, name))</span><br><span class="line">            );</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Failed to sync to ES: id=&quot;</span> + id + <span class="string">&quot;, error=&quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Logstash-插件">Logstash 插件</h3>
<p>Logstash 通过 <code>jdbc</code> input 插件定期查询 MySQL，同步到 ES。</p>
<blockquote>
<p><strong>优点</strong>：</p>
<ul class="lvl-1">
<li class="lvl-2">配置简单，Elastic 官方支持。</li>
<li class="lvl-2">支持 SQL 定制查询。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul class="lvl-1">
<li class="lvl-2">
<p>本质仍是轮询，无法做到实时。</p>
</li>
<li class="lvl-2">
<p>不支持监听 binlog。</p>
</li>
</ul>
</blockquote>
<pre class="mermaid">sequenceDiagram
    participant Scheduler as Logstash 调度器
    participant JDBCInput as JDBC Input 插件
    participant MySQL as MySQL
    participant Filter as (可选) Filter 插件
    participant ESOutput as Elasticsearch Output 插件
    participant ES as Elasticsearch

    loop 按 schedule 配置周期执行 (e.g., 每30秒)
        Scheduler->>JDBCInput: 触发下一次轮询
        JDBCInput->>MySQL: 1. 执行预定义 SQL 查询<br/>（含增量条件，如 update_time > :sql_last_value）
        MySQL-->>JDBCInput: 2. 返回结果集 (ResultSet)
        
        alt 有新数据返回
            JDBCInput->>Filter: 3. (可选) 字段清洗/转换
            Filter-->>ESOutput: 处理后的事件 (Event)
            
            ESOutput->>ES: 4. 批量写入 ES<br/>（使用 document_id 映射主键）
            ES-->>ESOutput: 5. 写入确认
            
            ESOutput->>JDBCInput: 6. 更新 last_run_metadata<br/>（记录本次最大 update_time）
        else 无新数据
            Note over JDBCInput: 无事件生成，跳过输出
        end
    end</pre>
<p><strong>适用场景</strong>：中小型项目，允许分钟级延迟。</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  jdbc &#123;</span><br><span class="line">    jdbc_driver_library =&gt; &quot;/<span class="built_in">path</span>/mysql-connector-java-<span class="number">8</span>.<span class="number">0</span>.<span class="number">33</span>.jar&quot;</span><br><span class="line">    jdbc_driver_class =&gt; &quot;com.mysql.cj.jdbc.Driver&quot;</span><br><span class="line">    jdbc_connection_string =&gt; &quot;jdbc:mysql://localhost:<span class="number">3306</span>/test&quot;</span><br><span class="line">    jdbc_user =&gt; &quot;logstash&quot;</span><br><span class="line">    jdbc_password =&gt; &quot;logstash&quot;</span><br><span class="line">    </span><br><span class="line">    # 增量同步关键：使用时间戳字段</span><br><span class="line">    schedule =&gt; &quot;*/<span class="number">30</span> * * * *&quot;          # 每<span class="number">30</span>秒执行</span><br><span class="line">    statement =&gt; &quot;SELECT id, name, update_time FROM users WHERE update_time &gt; :sql_last_value&quot;</span><br><span class="line">    use_column_value =&gt; true</span><br><span class="line">    tracking_column =&gt; &quot;update_time&quot;</span><br><span class="line">    tracking_column_type =&gt; &quot;timestamp&quot;</span><br><span class="line">    </span><br><span class="line">    # 记录上次同步时间的文件</span><br><span class="line">    last_run_metadata_path =&gt; &quot;/etc/logstash/.users_last_run&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  # 可选：重命名字段、添加标签等</span><br><span class="line">  mutate &#123;</span><br><span class="line">    <span class="built_in">copy</span> =&gt; &#123; &quot;id&quot; =&gt; &quot;[@metadata][_id]&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [&quot;http://localhost:<span class="number">9200</span>&quot;]</span><br><span class="line">    index =&gt; &quot;users&quot;</span><br><span class="line">    document_id =&gt; &quot;%&#123;[@metadata][_id]&#125;&quot;  # 确保 ES 文档 ID 与 MySQL 主键一致</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Flink-CDC"><a href="https://nightlies.apache.org/flink/flink-cdc-docs-release-3.0/zh/docs/get-started/introduction/">Flink CDC</a></h3>
<p>基于 Flink 的 CDC 连接器（如 <code>flink-cdc-connectors</code>），直接读取 MySQL binlog，进行流式 ETL 后写入 ES。</p>
<blockquote>
<p>MySQL → Flink CDC Source → Flink Job（Transform） → Flink ES Sink → Elasticsearch</p>
</blockquote>
<p><strong>优势</strong>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>真正的流处理，低延迟、高吞put。</p>
</li>
<li class="lvl-2">
<p>支持多种数据库（MySQL、Doris、Oracle、Postgres、SQLServer、DB2、MongoDB、Elasticsearch等）</p>
</li>
<li class="lvl-2">
<p>支持 Exactly-Once 语义（需配合 Flink Checkpoint）。</p>
</li>
<li class="lvl-2">
<p>可在同步过程中做字段转换、JOIN、聚合等。</p>
</li>
<li class="lvl-2">
<p>支持多种同步模式：</p>
<ul class="lvl-2">
<li class="lvl-4"><strong>Flink SQL</strong>：声明式 (SQL)，适用于 <strong>简单ETL、分析</strong>场景</li>
<li class="lvl-4"><strong>Table API</strong>：程序式声明，适用于<strong>中等复杂度</strong>场景</li>
<li class="lvl-4"><strong>DataStream API</strong>：命令式，适用于<strong>复杂业务逻辑</strong>场景</li>
<li class="lvl-4"><strong>Pipeline Config</strong>：配置声明式，适用于<strong>快速同步任务</strong>场景</li>
</ul>
</li>
</ul>
<pre class="mermaid">sequenceDiagram
    participant MySQL as MySQL
    participant FlinkJob as Flink Job (含 CDC Source)
    participant FlinkEngine as Flink Runtime Engine
    participant ESSink as Elasticsearch Sink
    participant ES as Elasticsearch

    Note over MySQL: 开启 binlog<br/>binlog-format=ROW

    %% 初始化：Flink CDC Source 连接 MySQL
    FlinkJob->>MySQL: 1. 启动时读取表结构 + 当前 binlog 位点
    MySQL-->>FlinkJob: 2. 返回 schema 和初始快照（可选）

    alt 全量 + 增量模式（默认）
        FlinkJob->>MySQL: 3a. 先 SELECT 全量数据（快照阶段）
        MySQL-->>FlinkJob: 3b. 返回全量结果集
        FlinkJob->>ESSink: 4a. 写入 ES（全量初始化）
    end

    %% 持续监听 binlog
    Note right of MySQL: 用户执行:<br/>INSERT INTO users VALUES(1002, '王五');

    MySQL->>MySQL: 5. 写入 binlog (Row 格式)

    MySQL->>FlinkJob: 6. Flink CDC Source 实时拉取 binlog 事件
    FlinkJob->>FlinkEngine: 7. 转换为 DataStream<RowData>
    
    activate FlinkEngine
    FlinkEngine->>FlinkEngine: 8. (可选) 流式 ETL：<br/>字段过滤、类型转换、脱敏等
    FlinkEngine->>ESSink: 9. 发送记录到 ES Sink
    ESSink->>ES: 10. 批量/逐条写入 ES<br/>（使用主键作为 document_id）
    ES-->>ESSink: 11. 写入确认
    ESSink-->>FlinkEngine: 12. 触发 checkpoint ACK
    FlinkEngine->>FlinkJob: 13. 持久化 binlog 位点（Exactly-Once 保障）
    deactivate FlinkEngine

    Note over FlinkJob: 持续处理 INSERT/UPDATE/DELETE<br/>DELETE → 调用 ES delete API</pre>
<p><strong>适用场景</strong>：需要实时计算 + 同步的复杂数据管道。</p>
<table>
<thead>
<tr>
<th>组件</th>
<th>作用</th>
<th>是否需手动安装</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>flink-dist-*.jar</code></td>
<td>Flink 核心运行时</td>
<td>无需，自带</td>
</tr>
<tr>
<td><code>flink-table-api-java-*.jar</code></td>
<td>Table API 基础类</td>
<td>无需，自带（SQL 依赖 Table API）</td>
</tr>
<tr>
<td><code>flink-table-planner_*.jar</code></td>
<td><strong>SQL 解析器、优化器、执行器（Blink Planner）</strong></td>
<td>无需，自带</td>
</tr>
<tr>
<td><code>flink-table-runtime-*.jar</code></td>
<td>运行时函数、类型系统</td>
<td>无需，自带</td>
</tr>
<tr>
<td><code>flink-json-*.jar</code></td>
<td>JSON 格式支持（如 <code>JSON_OBJECT</code>）</td>
<td>无需，自带</td>
</tr>
<tr>
<td><strong>MySQL / JDBC</strong></td>
<td><code>flink-connector-jdbc-*.jar</code></td>
<td>需<strong>手动下载并放入 <code>lib/</code> 目录</strong></td>
</tr>
<tr>
<td><strong>MySQL / CDC</strong></td>
<td><code>flink-sql-connector-mysql-cdc-*.jar</code></td>
<td>需<strong>手动下载并放入 <code>lib/</code> 目录</strong></td>
</tr>
<tr>
<td><strong>Elasticsearch 7</strong></td>
<td><code>flink-sql-connector-elasticsearch7-*.jar</code></td>
<td>需<strong>手动下载并放入 <code>lib/</code> 目录</strong></td>
</tr>
<tr>
<td><strong>MySQL 驱动</strong></td>
<td><code>mysql-connector-j-8.0.33.jar</code>（或 9.x）</td>
<td>需<strong>手动下载并放入 <code>lib/</code> 目录</strong></td>
</tr>
<tr>
<td><strong>Kafka</strong></td>
<td><code>flink-sql-connector-kafka-*.jar</code></td>
<td>非必须</td>
</tr>
</tbody>
</table>
<p>示例：从 MySQL 到 Elasticsearch 的同步，将 orders 和 order_items 表关联后写入 ES。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义数据结构</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Order</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> id;</span><br><span class="line">    <span class="keyword">public</span> String orderNo;</span><br><span class="line">    <span class="keyword">public</span> String status;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> userId;</span><br><span class="line">    <span class="keyword">public</span> List&lt;OrderItem&gt; items;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Order</span><span class="params">(<span class="type">long</span> id, String orderNo, String status, <span class="type">long</span> userId, List&lt;OrderItem&gt; items)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.orderNo = orderNo;</span><br><span class="line">        <span class="built_in">this</span>.status = status;</span><br><span class="line">        <span class="built_in">this</span>.userId = userId;</span><br><span class="line">        <span class="built_in">this</span>.items = items;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OrderItem</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> id;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> orderId;</span><br><span class="line">    <span class="keyword">public</span> String productName;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> unitPrice;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OrderItem</span><span class="params">(<span class="type">long</span> id, <span class="type">long</span> orderId, String productName, <span class="type">double</span> unitPrice)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.orderId = orderId;</span><br><span class="line">        <span class="built_in">this</span>.productName = productName;</span><br><span class="line">        <span class="built_in">this</span>.unitPrice = unitPrice;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Flink-SQL"><a href="https://nightlies.apache.org/flink/flink-docs-master/zh/docs/connectors/table/elasticsearch/">Flink SQL</a></h4>
<p>Flink SQL 实现数据同步（如 MySQL → Elasticsearch）主要有两种主流方式：</p>
<blockquote>
<ol>
<li class="lvl-3">
<p><strong>基于 JDBC 的批量/轮询同步（Polling-based）</strong></p>
</li>
<li class="lvl-3">
<p><strong>基于 CDC（Change Data Capture）的实时增量同步</strong></p>
</li>
</ol>
</blockquote>
<p>对于这种标准的关联查询，SQL 是最简洁、最高效的方式。我用的 ES 版本 为 7.17.29</p>
<table>
<thead>
<tr>
<th>对比项</th>
<th>JDBC 轮询</th>
<th>CDC</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>数据捕获层</strong></td>
<td>SQL 查询（应用层）</td>
<td>数据库日志（存储引擎层）</td>
</tr>
<tr>
<td><strong>变更可见性</strong></td>
<td>只能看到最终状态</td>
<td>看到完整变更过程（I/U/D）</td>
</tr>
<tr>
<td><strong>DELETE 支持</strong></td>
<td>不支持（除非软删除）</td>
<td>原生支持</td>
</tr>
<tr>
<td><strong>UPDATE 识别</strong></td>
<td>需时间戳字段</td>
<td>自动识别 before/after 值</td>
</tr>
<tr>
<td><strong>对源库影响</strong></td>
<td>高（查询压力）</td>
<td>低（只读 binlog）</td>
</tr>
<tr>
<td><strong>首次同步</strong></td>
<td>全量查询</td>
<td>全量快照 + 增量日志</td>
</tr>
<tr>
<td><strong>Exactly-Once</strong></td>
<td>难实现</td>
<td>原生支持（配合 checkpoint）</td>
</tr>
</tbody>
</table>
<blockquote>
<p>需提前下载（<a href="https://archive.apache.org/dist/flink/">Apache Archive Distribution Directory</a>）：</p>
<p>百度网盘分享的文件：Flink: <a href="https://pan.baidu.com/s/1q_W6tcfnfapHs9Ps37M7hA?pwd=wdv4">https://pan.baidu.com/s/1q_W6tcfnfapHs9Ps37M7hA?pwd=wdv4</a> 提取码: wdv4</p>
<ul class="lvl-1">
<li class="lvl-2">
<p><strong><a href="https://archive.apache.org/dist/flink/flink-1.20.3/flink-1.20.3-bin-scala_2.12.tgz">Flink</a></strong>（<code>flink-1.20.3-bin-scala_2.12.tgz</code>） 必须与 connector 版本一致，且各 connector 版本都要一致（1.20）</p>
</li>
<li class="lvl-2">
<p><a href="https://repo1.maven.org/maven2/org/apache/flink/flink-sql-connector-elasticsearch7/3.1.0-1.20/flink-sql-connector-elasticsearch7-3.1.0-1.20.jar">flink-sql-connector-elasticsearch7</a>（<code>flink-sql-connector-elasticsearch7-3.1.0-1.20.jar</code>）</p>
</li>
<li class="lvl-2">
<p><a href="https://repo1.maven.org/maven2/org/apache/flink/flink-table-api-java-bridge/1.20.3/flink-table-api-java-bridge-1.20.3.jar">flink-table-api-java-bridge</a>（<code>flink-table-api-java-bridge-1.20.3.jar</code>）</p>
</li>
<li class="lvl-2">
<p>连接DB 方式：</p>
<ul class="lvl-3">
<li class="lvl-4"><a href="https://repo1.maven.org/maven2/org/apache/flink/flink-connector-jdbc/3.3.0-1.20/flink-connector-jdbc-3.3.0-1.20.jar">flink-connector-jdbc</a>（<code>flink-connector-jdbc-3.3.0-1.20.jar</code>） jdbc 连接方式，用于<strong>全量同步</strong></li>
<li class="lvl-4"><a href="https://repo1.maven.org/maven2/com/ververica/flink-sql-connector-mysql-cdc/2.4.2/flink-sql-connector-mysql-cdc-2.4.2.jar">flink-sql-connector-mysql-cdc</a>（<code>flink-sql-connector-mysql-cdc-2.4.2.jar</code>） cdc 连接方式，用于<strong>实时同步</strong></li>
</ul>
</li>
<li class="lvl-2">
<p><a href="https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/9.5.0/mysql-connector-j-9.5.0.jar">mysql-connector-java</a>（<code>mysql-connector-j-8.4.0.jar</code>）</p>
</li>
</ul>
<p>解压 Flink 后，将所有 JAR 都放入 <code>flink-1.20.3/lib/</code> 目录下</p>
<p><font color='red'>注意：该版本（1.20.3）不支持 Pipeline，如果你需要自动路由可能得需要其他方式或升级最新版本。</font></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先启动 Flink 集群，JobManager + TaskManager。</span></span><br><span class="line">./bin/start-cluster.sh</span><br><span class="line"><span class="comment"># 查看 Web UI: </span></span><br><span class="line">curl http://localhost:8081</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第1种方式：直接运行</span></span><br><span class="line">flink run -d \</span><br><span class="line">  -p 4 \</span><br><span class="line">  -sql <span class="string">&quot;orders_to_es.sql&quot;</span> \</span><br><span class="line">  --jarfile flink-sql-connector-elasticsearch7-3.1.0-1.20.jar \</span><br><span class="line">  --jarfile flink-connector-jdbc-3.3.0-1.20.jar \</span><br><span class="line">  --jarfile mysql-connector-j-8.4.0.jar</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 第2种方式：启动 SQL Client</span></span><br><span class="line">./bin/sql-client.sh -f orders_to_es.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查数据同步情况</span></span><br><span class="line">curl -XGET <span class="string">&quot;http://localhost:9200/orders/_search?pretty&quot;</span></span><br></pre></td></tr></table></figure>
<h5 id="JDBC-批量-轮询">JDBC 批量/轮询</h5>
<p><strong>无法捕获 DELETE 操作</strong>（除非有软删除字段如 <code>is_deleted</code>）</p>
<blockquote>
<ul class="lvl-1">
<li class="lvl-2">
<p>Flink 通过 <strong>JDBC 连接器</strong>，周期性地<strong>全表扫描或按条件查询</strong>源表（如 <code>SELECT * FROM orders WHERE update_time &gt; last_max_time</code>）。</p>
</li>
<li class="lvl-2">
<p>数据被视为<strong>静态快照（bounded stream）或周期性 append-only 流</strong>。</p>
</li>
<li class="lvl-2">
<p>通常运行在 <strong>Batch 模式或 Streaming 模式下的有限流</strong>。</p>
</li>
</ul>
</blockquote>
<p><code>orders_to_es.sql</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ========= 1. 源表：orders =========</span></span><br><span class="line"><span class="keyword">CREATE</span> TEMPORARY <span class="keyword">TABLE</span> `orders`</span><br><span class="line">(</span><br><span class="line">    `id`       <span class="type">BIGINT</span>,</span><br><span class="line">    `order_no` STRING,</span><br><span class="line">    `status`   STRING,</span><br><span class="line">    `user_id`  <span class="type">BIGINT</span>,</span><br><span class="line">	<span class="keyword">PRIMARY KEY</span> (`id`) <span class="keyword">NOT</span> ENFORCED</span><br><span class="line">)</span><br><span class="line"><span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">&#x27;connector&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;jdbc&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;url&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;jdbc:mysql://192.168.3.146:3306/demo_order?useSSL=false&amp;serverTimezone=UTC&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;table-name&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;orders&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;username&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;password&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;123456&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;scan.fetch-size&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;1000&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;scan.partition.column&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;id&#x27;</span>,  <span class="comment">-- 可选：并行读取</span></span><br><span class="line">    <span class="string">&#x27;scan.partition.num&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;scan.partition.lower-bound&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;scan.partition.upper-bound&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;10000&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ========= 2. 源表：order_items =========</span></span><br><span class="line"><span class="keyword">CREATE</span> TEMPORARY <span class="keyword">TABLE</span> `order_item`</span><br><span class="line">(</span><br><span class="line">    `id`            <span class="type">BIGINT</span>,</span><br><span class="line">    `order_id`      <span class="type">BIGINT</span>,</span><br><span class="line">    `product_name`  STRING,</span><br><span class="line">    `unit_price`    <span class="type">DECIMAL</span>,</span><br><span class="line">	<span class="keyword">PRIMARY KEY</span> (`id`) <span class="keyword">NOT</span> ENFORCED</span><br><span class="line">)</span><br><span class="line"><span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">&#x27;connector&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;jdbc&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;url&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;jdbc:mysql://192.168.3.146:3306/demo_order?useSSL=false&amp;serverTimezone=UTC&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;table-name&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;order_item&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;username&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;password&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;123456&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;scan.fetch-size&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;1000&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ========= 3. 目标表：Elasticsearch =========</span></span><br><span class="line"><span class="keyword">CREATE</span> TEMPORARY <span class="keyword">TABLE</span> `es_orders` (</span><br><span class="line">    `id`         <span class="type">BIGINT</span>,</span><br><span class="line">    `orderNo`    STRING,</span><br><span class="line">    `status`     STRING,</span><br><span class="line">    `userId`     <span class="type">BIGINT</span>,</span><br><span class="line">    `orderItems` <span class="keyword">ARRAY</span><span class="operator">&lt;</span><span class="type">ROW</span><span class="operator">&lt;</span></span><br><span class="line">        `id`           <span class="type">BIGINT</span>,</span><br><span class="line">        `productName`  STRING,</span><br><span class="line">        `unitPrice`    <span class="keyword">DOUBLE</span></span><br><span class="line">    <span class="operator">&gt;&gt;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (`id`) <span class="keyword">NOT</span> ENFORCED</span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">&#x27;connector&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;elasticsearch-7&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;hosts&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;http://192.168.3.146:9200&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;index&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;orders&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;sink.bulk-flush.max-actions&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;1000&#x27;</span>,	</span><br><span class="line">    <span class="string">&#x27;sink.bulk-flush.interval&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;10s&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ========= 4. 批量插入 =========</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> `es_orders`</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    o.id,</span><br><span class="line">    o.order_no <span class="keyword">AS</span> orderNo,</span><br><span class="line">    o.status,</span><br><span class="line">    o.user_id <span class="keyword">AS</span> userId,</span><br><span class="line">    <span class="built_in">ARRAY_AGG</span>(</span><br><span class="line">        <span class="type">ROW</span>(</span><br><span class="line">            i.id,</span><br><span class="line">            i.product_name, </span><br><span class="line">            <span class="built_in">CAST</span>(i.unit_price <span class="keyword">AS</span> <span class="keyword">DOUBLE</span>)  <span class="comment">-- unitPrice (scaled_float)</span></span><br><span class="line">        )</span><br><span class="line">    ) <span class="keyword">AS</span> orderItems</span><br><span class="line"><span class="keyword">FROM</span> orders <span class="keyword">AS</span> o</span><br><span class="line">	<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> order_item <span class="keyword">AS</span> i <span class="keyword">ON</span> o.id <span class="operator">=</span> i.order_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> o.id, o.order_no, o.status, o.user_id;</span><br></pre></td></tr></table></figure>
<h5 id="CDC-全量-增量">CDC 全量+增量</h5>
<p>支持 <strong>全量 + 增量自动切换</strong>（Flink CDC 2.0+）。</p>
<blockquote>
<ul class="lvl-1">
<li class="lvl-2">
<p>Flink 通过 <strong>CDC 连接器</strong>（如 Debezium）<strong>读取数据库的事务日志</strong>（MySQL 的 binlog、PostgreSQL 的 WAL）。</p>
</li>
<li class="lvl-2">
<p>直接解析 <strong>INSERT / UPDATE / DELETE</strong> 的原始变更事件（<code>RowKind</code>：<code>+I</code>, <code>-U</code>, <code>+U</code>, <code>-D</code>）。</p>
</li>
<li class="lvl-2">
<p>数据以 <strong>changelog stream</strong> 形式流入 Flink，天然支持<strong>精确一次语义</strong>。</p>
</li>
</ul>
<p>‘scan.incremental.snapshot.enabled’ = ‘true’  <em>– 启用全量+增量</em></p>
</blockquote>
<p><code>orders_to_es.sql</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ========= 1. 源表：orders =========</span></span><br><span class="line"><span class="keyword">CREATE</span> TEMPORARY <span class="keyword">TABLE</span> `orders`</span><br><span class="line">(</span><br><span class="line">    `id`       <span class="type">BIGINT</span>,</span><br><span class="line">    `order_no` STRING,</span><br><span class="line">    `status`   STRING,</span><br><span class="line">    `user_id`  <span class="type">BIGINT</span>,</span><br><span class="line">	<span class="keyword">PRIMARY KEY</span> (`id`) <span class="keyword">NOT</span> ENFORCED</span><br><span class="line">)</span><br><span class="line"><span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">&#x27;connector&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;mysql-cdc&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;hostname&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;192.168.3.146&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;port&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;3306&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;username&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;password&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;123456&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;database-name&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;demo_order&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;table-name&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;orders&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;server-time-zone&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;Asia/Shanghai&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ========= 2. 源表：order_items =========</span></span><br><span class="line"><span class="keyword">CREATE</span> TEMPORARY <span class="keyword">TABLE</span> `order_item`</span><br><span class="line">(</span><br><span class="line">    `id`            <span class="type">BIGINT</span>,</span><br><span class="line">    `order_id`      <span class="type">BIGINT</span>,</span><br><span class="line">    `product_name`  STRING,</span><br><span class="line">    `unit_price`    <span class="type">DECIMAL</span>,</span><br><span class="line">	<span class="keyword">PRIMARY KEY</span> (`id`) <span class="keyword">NOT</span> ENFORCED</span><br><span class="line">)</span><br><span class="line"><span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">&#x27;connector&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;mysql-cdc&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;hostname&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;192.168.3.146&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;port&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;3306&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;username&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;password&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;123456&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;database-name&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;demo_order&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;table-name&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;order_item&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;server-time-zone&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;Asia/Shanghai&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ========= 3. 目标表：Elasticsearch =========</span></span><br><span class="line"><span class="keyword">CREATE</span> TEMPORARY <span class="keyword">TABLE</span> `es_orders` (</span><br><span class="line">    `id`         <span class="type">BIGINT</span>,</span><br><span class="line">    `orderNo`    STRING,</span><br><span class="line">    `status`     STRING,</span><br><span class="line">    `userId`     <span class="type">BIGINT</span>,</span><br><span class="line">    `orderItems` <span class="keyword">ARRAY</span><span class="operator">&lt;</span><span class="type">ROW</span><span class="operator">&lt;</span></span><br><span class="line">        `id`           <span class="type">BIGINT</span>,</span><br><span class="line">        `productName`  STRING,</span><br><span class="line">        `unitPrice`    <span class="keyword">DOUBLE</span></span><br><span class="line">    <span class="operator">&gt;&gt;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (`id`) <span class="keyword">NOT</span> ENFORCED</span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">&#x27;connector&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;elasticsearch-7&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;hosts&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;http://192.168.3.146:9200&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;index&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;orders&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;document-id.key-delimiter&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;$&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;sink.bulk-flush.max-actions&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;1000&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;sink.bulk-flush.interval&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;1000&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;format&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;json&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ========= 4. 批量插入 =========</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> `es_orders`</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    o.id,</span><br><span class="line">    o.order_no <span class="keyword">AS</span> orderNo,</span><br><span class="line">    o.status,</span><br><span class="line">    o.user_id <span class="keyword">AS</span> userId,</span><br><span class="line">    <span class="built_in">ARRAY_AGG</span>(</span><br><span class="line">        <span class="type">ROW</span>(</span><br><span class="line">            i.id,</span><br><span class="line">            i.product_name, </span><br><span class="line">            <span class="built_in">CAST</span>(i.unit_price <span class="keyword">AS</span> <span class="keyword">DOUBLE</span>)  <span class="comment">-- unitPrice (scaled_float)</span></span><br><span class="line">        )</span><br><span class="line">    ) <span class="keyword">AS</span> orderItems</span><br><span class="line"><span class="keyword">FROM</span> orders <span class="keyword">AS</span> o</span><br><span class="line">	<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> order_item <span class="keyword">AS</span> i <span class="keyword">ON</span> o.id <span class="operator">=</span> i.order_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> o.id, o.order_no, o.status, o.user_id;</span><br></pre></td></tr></table></figure>
<h5 id="常见异常">常见异常</h5>
<ul class="lvl-0">
<li class="lvl-2">
<p>对于版本不兼容或不支持（<strong>Flink 1.19 及之前不支持标准 SQL 的 <code>ARRAY_AGG</code></strong>），可能出错：</p>
<img src= "/img/20241215205335173426721579192.webp" data-lazy-src="/imgs/db/image-20251227231702027.webp" alt="image-20251227231702027" style="zoom:67%;" />
</li>
<li class="lvl-2">
<p>如果报错：<code>[ERROR] Could not execute SQL statement. Reason:java.net.ConnectException: 拒绝连接</code></p>
<p>先查看 flink/log 下的日志详细信息 <code>vim log/flink-root-sql-client-主机名.log</code>。</p>
<p>如果出错，拒绝连接：localhost/127.0.0.1:8081，Flink SQL Client（<a href="http://sql-client.sh">sql-client.sh</a>）默认会连接 本地 localhost:8081 的 JobManager，这是因为你 <strong>只解压了 Flink，没有启动集群</strong>导致的，解决方法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Flink SQL 不能独立运行，它需要一个 运行中的 Flink 集群来执行作业</span></span><br><span class="line"><span class="comment"># 在 Flink 目录下，启动：JobManager（默认监听 localhost:8081）和 TaskManager</span></span><br><span class="line">./bin/start-cluster.sh</span><br></pre></td></tr></table></figure>
<p>如果是mysql 无法连接，使用以下步骤排查：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">ping 192.168.3.146</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.使用 MySQL 客户端连接</span></span><br><span class="line">mysql -h 192.168.3.146 -u root -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.登录到 运行 Flink 任务的机器，执行：</span></span><br><span class="line"><span class="comment"># 如果 不通，说明 Flink 节点网络隔离，无法访问 MySQL</span></span><br><span class="line">telnet 192.168.3.146 3306</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.检查 MySQL 配置（在 MySQL 服务器上）：</span></span><br><span class="line"><span class="comment"># 如果返回 127.0.0.1，只允许本地连接，拒绝远程连接。正确值应为 0.0.0.0 或 192.168.3.146</span></span><br><span class="line"><span class="comment"># 编辑 my.cnf（通常在 /etc/mysql/my.cnf 或 /etc/my.cnf 或 C:\ProgramData\MySQL\MySQL Server 8.0）</span></span><br><span class="line"><span class="comment"># 在 [mysqld] 节点下添加：bind-address = 0.0.0.0，然后重启 MySQL：</span></span><br><span class="line">SHOW VARIABLES LIKE <span class="string">&#x27;bind_address&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.MySQL 用户可能只允许从特定主机连接，检查用户权限：</span></span><br><span class="line"><span class="comment"># 如果 host 是 localhost 或 127.0.0.1 不能从其他 IP 连。你需要 host = &#x27;%&#x27; 或 host = &#x27;你的Flink节点IP&#x27;。</span></span><br><span class="line">SELECT host, user FROM mysql.user WHERE user = <span class="string">&#x27;root&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.防火墙或安全组拦截</span></span><br><span class="line"><span class="comment"># MySQL 服务器防火墙（如 ufw、iptables）可能阻止 3306 端口。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.Flink 使用了错误的 URL（拼写、端口）</span></span><br><span class="line"><span class="comment"># MySQL 8+ 默认要求 SSL，useSSL=false 可临时绕过（测试环境）</span></span><br><span class="line"><span class="string">&#x27;connector&#x27;</span> = <span class="string">&#x27;jdbc&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;url&#x27;</span> = <span class="string">&#x27;jdbc:mysql://192.168.3.146:3306/demo_order?useSSL=false&amp;serverTimezone=UTC&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 7.MySQL 驱动版本兼容性问题，MySQL 9.x 驱动可能有行为变更（如默认 SSL、认证插件）</span></span><br><span class="line"><span class="comment"># link 1.20 + MySQL 8.0 推荐使用 mysql-connector-j:8.0.33</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 其他情况：如果你用的 VMware Linux服务器执行Flink，但是数据库在主机</span></span><br><span class="line"><span class="comment"># 你需要使用这个网络：以太网适配器 VMware Network Adapter VMnet8，而不是：无线局域网适配器 WLAN</span></span><br></pre></td></tr></table></figure>
</li>
<li class="lvl-2">
<p>如果JDBC数据同步失败，查看日志：<code>vim log/flink-root-taskexecutor-0-主机名.log</code>，详细出错信息</p>
</li>
<li class="lvl-2">
<p>如果CDC数据同步失败，查看日志：<code>vim log/flink-root-standalonesession-0-主机名.log</code>，报错：<code>Failed to create Source Enumerator for source Source: order_item[3] java.lang.NullPointerException: null</code>，说明Mysql连接的配置有误，可以删除多余的。</p>
</li>
<li class="lvl-2">
<p>如果出错：<code>[ERROR] Could not execute SQL statement. Reason:java.io.StreamCorruptedException: unexpected block data</code>，可能原因：</p>
<ul class="lvl-2">
<li class="lvl-4">
<p><strong>版本不匹配</strong>：CDC 连接器版本与 Flink 版本不兼容</p>
</li>
<li class="lvl-4">
<p><strong>序列化问题</strong>：Debezium 序列化器配置错误</p>
</li>
<li class="lvl-4">
<p><strong>数据格式不一致</strong>：期望的数据格式与实际接收的不匹配</p>
</li>
<li class="lvl-4">
<p><strong>清除检查点数据，重新启动</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 停止 Flink 集群</span></span><br><span class="line"><span class="built_in">cd</span> flink-1.20.3</span><br><span class="line">./bin/stop-cluster.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除所有检查点和状态数据</span></span><br><span class="line"><span class="built_in">rm</span> -rf /tmp/flink-checkpoints /tmp/flink-savepoints 2&gt;/dev/null</span><br><span class="line"><span class="built_in">rm</span> -rf /tmp/blobStore-* 2&gt;/dev/null</span><br><span class="line"><span class="built_in">rm</span> -rf /tmp/hadoop-unjar-* 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 Flink 的临时目录</span></span><br><span class="line">find /tmp -name <span class="string">&quot;*flink*&quot;</span> -<span class="built_in">type</span> d -<span class="built_in">exec</span> <span class="built_in">rm</span> -rf &#123;&#125; + 2&gt;/dev/null || <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启集群</span></span><br><span class="line">./bin/start-cluster.sh</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h4 id="Flink-Pipeline-Config">Flink Pipeline Config</h4>
<p><strong>Pipeline Config 适合简单同步</strong>，只需要单表同步，无需关联处理的场景。对复杂关联支持有限</p>
<p>YAML 配置文件：<code>mysql-to-es-pipeline.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方案一：分别同步两个表到 ES（简单但无法关联）</span></span><br><span class="line"><span class="attr">source:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3306</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">test_db</span></span><br><span class="line">  <span class="attr">tables:</span> <span class="string">test_db.orders</span>  <span class="comment"># 只能同步一个表</span></span><br><span class="line">  <span class="attr">server-id:</span> <span class="number">5400</span><span class="number">-5404</span></span><br><span class="line">  <span class="attr">server-time-zone:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sink:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">http://localhost:9200</span></span><br><span class="line">  <span class="attr">index:</span> <span class="string">orders</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">elastic</span>  <span class="comment"># 如果 ES 有认证</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">elastic</span>  <span class="comment"># 如果 ES 有认证</span></span><br><span class="line">  <span class="attr">document-type:</span> <span class="string">_doc</span></span><br><span class="line">  <span class="attr">bulk-flush:</span></span><br><span class="line">    <span class="attr">max-actions:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="string">1s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">pipeline:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">MySQL</span> <span class="string">Orders</span> <span class="string">to</span> <span class="string">ES</span></span><br><span class="line">  <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方案二：使用 Transformation 进行简单处理（需要 Flink CDC 3.0+）</span></span><br><span class="line"><span class="comment"># source: ...</span></span><br><span class="line"><span class="comment"># sink: ...</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># transformation:</span></span><br><span class="line"><span class="comment">#   - type: column-rename</span></span><br><span class="line"><span class="comment">#     source-column: order_no</span></span><br><span class="line"><span class="comment">#     target-column: orderNo</span></span><br><span class="line"><span class="comment">#   - type: column-rename</span></span><br><span class="line"><span class="comment">#     source-column: user_id</span></span><br><span class="line"><span class="comment">#     target-column: userId</span></span><br><span class="line"><span class="comment">#   - type: column-drop</span></span><br><span class="line"><span class="comment">#     columns: [column_to_drop]</span></span><br></pre></td></tr></table></figure>
<p>运行脚本：<code>run-pipeline.sh</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 运行 Pipeline 模式</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 下载 Flink CDC Pipeline JAR</span></span><br><span class="line"><span class="comment"># wget https://repo1.maven.org/maven2/com/ververica/flink-cdc-pipeline-connectors/3.0.0/flink-cdc-pipeline-connectors-3.0.0.jar</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 提交任务到 Flink</span></span><br><span class="line">./bin/flink run \</span><br><span class="line">    -d \</span><br><span class="line">    -p 2 \</span><br><span class="line">    -c com.ververica.cdc.pipeline.cli.PipelineCLI \</span><br><span class="line">    flink-cdc-pipeline-connectors-3.0.0.jar \</span><br><span class="line">    --config mysql-to-es-pipeline.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 查看任务状态</span></span><br><span class="line">./bin/flink list</span><br></pre></td></tr></table></figure>
<h4 id="Flink-Table-API">Flink Table API</h4>
<p><strong>Table API 适合中等复杂度</strong>，需要在 SQL 和 DataStream 之间平衡的场景</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySQLToESWithTableAPI</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 创建 Table 环境</span></span><br><span class="line">        <span class="type">EnvironmentSettings</span> <span class="variable">settings</span> <span class="operator">=</span> EnvironmentSettings</span><br><span class="line">            .newInstance()</span><br><span class="line">            .inStreamingMode()</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="type">TableEnvironment</span> <span class="variable">tableEnv</span> <span class="operator">=</span> TableEnvironment.create(settings);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 创建 MySQL CDC 源表 - orders</span></span><br><span class="line">        tableEnv.executeSql(</span><br><span class="line">            <span class="string">&quot;CREATE TABLE mysql_orders (\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    id BIGINT,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    order_no STRING,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    status STRING,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    user_id BIGINT,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    PRIMARY KEY(id) NOT ENFORCED\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;) WITH (\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#x27;connector&#x27; = &#x27;mysql-cdc&#x27;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#x27;hostname&#x27; = &#x27;localhost&#x27;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#x27;port&#x27; = &#x27;3306&#x27;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#x27;username&#x27; = &#x27;root&#x27;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#x27;password&#x27; = &#x27;123456&#x27;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#x27;database-name&#x27; = &#x27;test_db&#x27;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#x27;table-name&#x27; = &#x27;orders&#x27;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;)&quot;</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 创建 MySQL CDC 源表 - order_items</span></span><br><span class="line">        tableEnv.executeSql(</span><br><span class="line">            <span class="string">&quot;CREATE TABLE mysql_order_items (\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    id BIGINT,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    order_id BIGINT,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    product_name STRING,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    unit_price DECIMAL(10, 2),\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    PRIMARY KEY(id) NOT ENFORCED\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;) WITH (\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#x27;connector&#x27; = &#x27;mysql-cdc&#x27;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#x27;hostname&#x27; = &#x27;localhost&#x27;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#x27;port&#x27; = &#x27;3306&#x27;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#x27;username&#x27; = &#x27;root&#x27;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#x27;password&#x27; = &#x27;123456&#x27;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#x27;database-name&#x27; = &#x27;test_db&#x27;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#x27;table-name&#x27; = &#x27;order_items&#x27;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;)&quot;</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. 创建 Elasticsearch 目标表</span></span><br><span class="line">        tableEnv.executeSql(</span><br><span class="line">            <span class="string">&quot;CREATE TABLE es_orders (\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    id BIGINT,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    orderNo STRING,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    status STRING,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    userId BIGINT,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    orderItems ARRAY&lt;ROW&lt;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        id BIGINT,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        productName STRING,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;        unitPrice DOUBLE\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &gt;&gt;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    PRIMARY KEY (id) NOT ENFORCED\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;) WITH (\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#x27;connector&#x27; = &#x27;elasticsearch-7&#x27;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#x27;hosts&#x27; = &#x27;http://localhost:9200&#x27;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#x27;index&#x27; = &#x27;orders&#x27;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#x27;document-id.key-delimiter&#x27; = &#x27;$&#x27;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    &#x27;format&#x27; = &#x27;json&#x27;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;)&quot;</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. 使用 Table API 进行查询和写入</span></span><br><span class="line">        <span class="type">Table</span> <span class="variable">orders</span> <span class="operator">=</span> tableEnv.from(<span class="string">&quot;mysql_orders&quot;</span>);</span><br><span class="line">        <span class="type">Table</span> <span class="variable">orderItems</span> <span class="operator">=</span> tableEnv.from(<span class="string">&quot;mysql_order_items&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 使用 Table API 进行关联和聚合</span></span><br><span class="line">        <span class="type">Table</span> <span class="variable">result</span> <span class="operator">=</span> orders</span><br><span class="line">            .leftOuterJoin(orderItems, $(<span class="string">&quot;id&quot;</span>).isEqual($(<span class="string">&quot;order_id&quot;</span>)))</span><br><span class="line">            .groupBy($(<span class="string">&quot;id&quot;</span>), $(<span class="string">&quot;order_no&quot;</span>), $(<span class="string">&quot;status&quot;</span>), $(<span class="string">&quot;user_id&quot;</span>))</span><br><span class="line">            .select(</span><br><span class="line">                $(<span class="string">&quot;id&quot;</span>),</span><br><span class="line">                $(<span class="string">&quot;order_no&quot;</span>).as(<span class="string">&quot;orderNo&quot;</span>),</span><br><span class="line">                $(<span class="string">&quot;status&quot;</span>),</span><br><span class="line">                $(<span class="string">&quot;user_id&quot;</span>).as(<span class="string">&quot;userId&quot;</span>),</span><br><span class="line">                collect(</span><br><span class="line">                    row(</span><br><span class="line">                        orderItems.$(<span class="string">&quot;id&quot;</span>),</span><br><span class="line">                        orderItems.$(<span class="string">&quot;product_name&quot;</span>).as(<span class="string">&quot;productName&quot;</span>),</span><br><span class="line">                        orderItems.$(<span class="string">&quot;unit_price&quot;</span>).cast(DataTypes.DOUBLE()).as(<span class="string">&quot;unitPrice&quot;</span>)</span><br><span class="line">                    )</span><br><span class="line">                ).as(<span class="string">&quot;orderItems&quot;</span>)</span><br><span class="line">            );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 6. 执行并写入 ES</span></span><br><span class="line">        tableEnv.createTemporaryView(<span class="string">&quot;result_view&quot;</span>, result);</span><br><span class="line">        tableEnv.executeSql(<span class="string">&quot;INSERT INTO es_orders SELECT * FROM result_view&quot;</span>);</span><br><span class="line">        <span class="comment">// result.executeInsert(&quot;es_orders&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Flink-DataStream-API">Flink DataStream API</h4>
<p>这是最灵活的方式，<strong>需要复杂处理时用 DataStream API</strong>：如果有特殊的业务逻辑（如风控、复杂状态）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySQLToESWithDataStream</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. 创建执行环境</span></span><br><span class="line">        <span class="type">StreamExecutionEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.enableCheckpointing(<span class="number">10000</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 创建 MySQL CDC Source - orders</span></span><br><span class="line">        MySqlSource&lt;String&gt; ordersSource = MySqlSource.&lt;String&gt;builder()</span><br><span class="line">            .hostname(<span class="string">&quot;localhost&quot;</span>)</span><br><span class="line">            .port(<span class="number">3306</span>)</span><br><span class="line">            .databaseList(<span class="string">&quot;test_db&quot;</span>)</span><br><span class="line">            .tableList(<span class="string">&quot;test_db.orders&quot;</span>)</span><br><span class="line">            .username(<span class="string">&quot;root&quot;</span>)</span><br><span class="line">            .password(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">            .deserializer(<span class="keyword">new</span> <span class="title class_">JsonDebeziumDeserializationSchema</span>())</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 创建 MySQL CDC Source - order_items</span></span><br><span class="line">        MySqlSource&lt;String&gt; itemsSource = MySqlSource.&lt;String&gt;builder()</span><br><span class="line">            .hostname(<span class="string">&quot;localhost&quot;</span>)</span><br><span class="line">            .port(<span class="number">3306</span>)</span><br><span class="line">            .databaseList(<span class="string">&quot;test_db&quot;</span>)</span><br><span class="line">            .tableList(<span class="string">&quot;test_db.order_items&quot;</span>)</span><br><span class="line">            .username(<span class="string">&quot;root&quot;</span>)</span><br><span class="line">            .password(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">            .deserializer(<span class="keyword">new</span> <span class="title class_">JsonDebeziumDeserializationSchema</span>())</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. 添加 Source 到数据流</span></span><br><span class="line">        DataStream&lt;String&gt; ordersStream = env.fromSource(</span><br><span class="line">            ordersSource,</span><br><span class="line">            WatermarkStrategy.noWatermarks(),</span><br><span class="line">            <span class="string">&quot;MySQL Orders Source&quot;</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        DataStream&lt;String&gt; itemsStream = env.fromSource(</span><br><span class="line">            itemsSource,</span><br><span class="line">            WatermarkStrategy.noWatermarks(),</span><br><span class="line">            <span class="string">&quot;MySQL Order Items Source&quot;</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. 解析和处理数据</span></span><br><span class="line">        <span class="comment">// 解析 orders 流</span></span><br><span class="line">        DataStream&lt;Order&gt; orders = ordersStream</span><br><span class="line">            .map(<span class="keyword">new</span> <span class="title class_">MapFunction</span>&lt;String, Order&gt;() &#123;</span><br><span class="line">                <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">                </span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> Order <span class="title function_">map</span><span class="params">(String value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    <span class="type">ObjectNode</span> <span class="variable">node</span> <span class="operator">=</span> mapper.readValue(value, ObjectNode.class);</span><br><span class="line">                    <span class="type">ObjectNode</span> <span class="variable">after</span> <span class="operator">=</span> (ObjectNode) node.get(<span class="string">&quot;after&quot;</span>);</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (after != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="type">long</span> <span class="variable">id</span> <span class="operator">=</span> after.get(<span class="string">&quot;id&quot;</span>).asLong();</span><br><span class="line">                        <span class="type">String</span> <span class="variable">orderNo</span> <span class="operator">=</span> after.get(<span class="string">&quot;order_no&quot;</span>).asText();</span><br><span class="line">                        <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> after.get(<span class="string">&quot;status&quot;</span>).asText();</span><br><span class="line">                        <span class="type">long</span> <span class="variable">userId</span> <span class="operator">=</span> after.get(<span class="string">&quot;user_id&quot;</span>).asLong();</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Order</span>(id, orderNo, status, userId, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .filter(order -&gt; order != <span class="literal">null</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 解析 order_items 流</span></span><br><span class="line">        DataStream&lt;OrderItem&gt; items = itemsStream</span><br><span class="line">            .map(<span class="keyword">new</span> <span class="title class_">MapFunction</span>&lt;String, OrderItem&gt;() &#123;</span><br><span class="line">                <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">                </span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> OrderItem <span class="title function_">map</span><span class="params">(String value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    <span class="type">ObjectNode</span> <span class="variable">node</span> <span class="operator">=</span> mapper.readValue(value, ObjectNode.class);</span><br><span class="line">                    <span class="type">ObjectNode</span> <span class="variable">after</span> <span class="operator">=</span> (ObjectNode) node.get(<span class="string">&quot;after&quot;</span>);</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (after != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="type">long</span> <span class="variable">id</span> <span class="operator">=</span> after.get(<span class="string">&quot;id&quot;</span>).asLong();</span><br><span class="line">                        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> after.get(<span class="string">&quot;order_id&quot;</span>).asLong();</span><br><span class="line">                        <span class="type">String</span> <span class="variable">productName</span> <span class="operator">=</span> after.get(<span class="string">&quot;product_name&quot;</span>).asText();</span><br><span class="line">                        <span class="type">double</span> <span class="variable">unitPrice</span> <span class="operator">=</span> after.get(<span class="string">&quot;unit_price&quot;</span>).asDouble();</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OrderItem</span>(id, orderId, productName, unitPrice);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .filter(item -&gt; item != <span class="literal">null</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 6. 关联 orders 和 items（这里简化处理，实际需要 keyBy 和 connect）</span></span><br><span class="line">        <span class="comment">// 实际生产环境可能需要使用 CoProcessFunction 或 IntervalJoin</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 7. 创建 Elasticsearch Sink</span></span><br><span class="line">        List&lt;HttpHost&gt; httpHosts = Arrays.asList(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">HttpHost</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        ElasticsearchSink.Builder&lt;Order&gt; esSinkBuilder = <span class="keyword">new</span> <span class="title class_">ElasticsearchSink</span>.Builder&lt;&gt;(</span><br><span class="line">            httpHosts,</span><br><span class="line">            (Order order, RuntimeContext ctx, RequestIndexer indexer) -&gt; &#123;</span><br><span class="line">                <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">                <span class="type">ObjectNode</span> <span class="variable">json</span> <span class="operator">=</span> mapper.createObjectNode();</span><br><span class="line">                </span><br><span class="line">                json.put(<span class="string">&quot;id&quot;</span>, order.id);</span><br><span class="line">                json.put(<span class="string">&quot;orderNo&quot;</span>, order.orderNo);</span><br><span class="line">                json.put(<span class="string">&quot;status&quot;</span>, order.status);</span><br><span class="line">                json.put(<span class="string">&quot;userId&quot;</span>, order.userId);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 处理 orderItems</span></span><br><span class="line">                List&lt;ObjectNode&gt; itemList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                <span class="keyword">for</span> (OrderItem item : order.items) &#123;</span><br><span class="line">                    <span class="type">ObjectNode</span> <span class="variable">itemJson</span> <span class="operator">=</span> mapper.createObjectNode();</span><br><span class="line">                    itemJson.put(<span class="string">&quot;id&quot;</span>, item.id);</span><br><span class="line">                    itemJson.put(<span class="string">&quot;productName&quot;</span>, item.productName);</span><br><span class="line">                    itemJson.put(<span class="string">&quot;unitPrice&quot;</span>, item.unitPrice);</span><br><span class="line">                    itemList.add(itemJson);</span><br><span class="line">                &#125;</span><br><span class="line">                json.set(<span class="string">&quot;orderItems&quot;</span>, mapper.valueToTree(itemList));</span><br><span class="line">                </span><br><span class="line">                <span class="type">IndexRequest</span> <span class="variable">indexRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexRequest</span>(<span class="string">&quot;orders&quot;</span>)</span><br><span class="line">                    .id(String.valueOf(order.id))</span><br><span class="line">                    .source(mapper.writeValueAsString(json), XContentType.JSON);</span><br><span class="line">                </span><br><span class="line">                indexer.add(indexRequest);</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 配置 ES Sink</span></span><br><span class="line">        esSinkBuilder.setBulkFlushMaxActions(<span class="number">1000</span>);</span><br><span class="line">        esSinkBuilder.setBulkFlushInterval(<span class="number">1000L</span>);</span><br><span class="line">        esSinkBuilder.setBulkFlushBackoff(<span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 8. 添加 Sink</span></span><br><span class="line">        orders.addSink(esSinkBuilder.build());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 9. 执行任务</span></span><br><span class="line">        env.execute(<span class="string">&quot;MySQL to ES DataStream Job&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Apache-NiFi">Apache NiFi</h3>
<p>可视化数据流引擎，通过 <code>CaptureChangeMySQL</code> 或 <code>QueryDatabaseTable</code> 处理器捕获变更，输出到 ES。</p>
<blockquote>
<p><strong>优势</strong>：拖拽式 UI，支持复杂路由、重试、背压控制。</p>
<p><strong>缺点</strong>：资源消耗较大，学习曲线较陡。</p>
</blockquote>
<h3 id="其他工具">其他工具</h3>
<p>社区有一些基于 Go/Python 的轻量 binlog 同步工具（如 <code>go-mysql-elasticsearch</code>，<code>Go-MySQL-ES</code>），直接监听 binlog 并写 ES。</p>
<p>适合对轻量级、可控性要求高的场景，但需自行维护。</p>
<h2 id="云原生">云原生</h2>
<h3 id="AWS">AWS</h3>
<p>DMS（Database Migration Service） + OpenSearch（ES 托管版）</p>
<blockquote>
<ul class="lvl-1">
<li class="lvl-2">
<p>AWS DMS 支持从 RDS MySQL <strong>持续复制（CDC）</strong> 到 OpenSearch。</p>
</li>
<li class="lvl-2">
<p>全托管，自动处理 binlog、断点续传、网络加密。</p>
</li>
</ul>
</blockquote>
<h3 id="阿里云">阿里云</h3>
<p>DTS（Data Transmission Service） + Elasticsearch</p>
<blockquote>
<ul class="lvl-1">
<li class="lvl-2">
<p>DTS 支持 MySQL 到 阿里云 ES 的<strong>实时数据订阅与同步</strong>。</p>
</li>
<li class="lvl-2">
<p>支持结构初始化、全量 + 增量同步。</p>
</li>
<li class="lvl-2">
<p>可过滤表、列，支持冲突处理。</p>
</li>
</ul>
</blockquote>
<h3 id="Serverless-方案">Serverless 方案</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p><strong>AWS Lambda + RDS Binlog</strong>：DMS 将变更发布到 Kafka（MSK）或 SNS/SQS，触发 Lambda 写入 OpenSearch。</p>
</li>
<li class="lvl-2">
<p><strong>阿里云函数计算（FC） + DTS 消息订阅</strong>：DTS 支持将变更以消息形式投递到 MNS/MQ，函数计算消费后写 ES。</p>
</li>
</ul>
<blockquote>
<p><strong>优点</strong>：按需计费，无服务器运维。</p>
<p><strong>缺点</strong>：冷启动延迟，适合低频或中小流量场景。</p>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://pengline.github.io">余一叶知秋尽</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://pengline.github.io/2025/12/c48cd69e7a3b47faae3866edeb761422/">https://pengline.github.io/2025/12/c48cd69e7a3b47faae3866edeb761422/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://pengline.github.io" target="_blank">余一叶知秋尽</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MySQL%E5%90%8C%E6%AD%A5Redis/">MySQL同步Redis</a><a class="post-meta__tags" href="/tags/MySQL%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%EF%BC%8CMySQL%E5%90%8C%E6%AD%A5ES/">MySQL数据同步，MySQL同步ES</a><a class="post-meta__tags" href="/tags/Flink-SQL/">Flink SQL</a><a class="post-meta__tags" href="/tags/Flink-CDC/">Flink CDC</a><a class="post-meta__tags" href="/tags/MySQL-Binlog/">MySQL Binlog</a></div><div class="post-share"><div class="social-share" data-image="/img/essay/1658045160332165804516032.webp" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/12/27fc28876c1e4f9baacd88ca8f29b266/" title="Mysql 各种索引详解和使用指南"><img class="cover" src= "/img/20241215205335173426721579192.webp" data-lazy-src="/img/essay/small193133vUdYM1755689493.webp" onerror="onerror=null;src='/img/k3zssqvjw2d.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Mysql 各种索引详解和使用指南</div></div><div class="info-2"><div class="info-item-1">MySQL 索引是提高数据库查询性能的关键机制。索引是一种数据结构，用于快速定位表中数据行，类似书籍目录。</div></div></div></a><a class="pagination-related" href="/2025/11/bbd3588b364c411b9d216db736b34a97/" title="JVM 几种常用垃圾收集器的比较"><img class="cover" src= "/img/20241215205335173426721579192.webp" data-lazy-src="/img/essay/small194442zl9VR1758541482.webp" onerror="onerror=null;src='/img/k3zssqvjw2d.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">JVM 几种常用垃圾收集器的比较</div></div><div class="info-2"><div class="info-item-1">Java 中四种主流垃圾收集器（Serial、Parallel、CMS、G1）的特点、适用场景以及典型优化方案。</div></div></div></a></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8C%E5%86%99%E6%9C%BA%E5%88%B6%EF%BC%88%E5%A2%9E%E9%87%8F%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">双写机制（增量）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E8%BD%AE%E8%AF%A2%EF%BC%88%E5%85%A8%E9%87%8F-%E5%A2%9E%E9%87%8F%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">定时轮询（全量&#x2F;增量）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%88%E5%85%A8%E9%87%8F-%E5%A2%9E%E9%87%8F%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">消息队列（全量&#x2F;增量）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E6%96%B9%E5%B7%A5%E5%85%B7%EF%BC%88%E7%94%9F%E4%BA%A7%EF%BC%89"><span class="toc-number">4.</span> <span class="toc-text">三方工具（生产）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-Binlog-%E5%B7%A5%E5%85%B7"><span class="toc-number">4.1.</span> <span class="toc-text">基于 Binlog 工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Logstash-%E6%8F%92%E4%BB%B6"><span class="toc-number">4.2.</span> <span class="toc-text">Logstash 插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flink-CDC"><span class="toc-number">4.3.</span> <span class="toc-text">Flink CDC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Flink-SQL"><span class="toc-number">4.3.1.</span> <span class="toc-text">Flink SQL</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#JDBC-%E6%89%B9%E9%87%8F-%E8%BD%AE%E8%AF%A2"><span class="toc-number">4.3.1.1.</span> <span class="toc-text">JDBC 批量&#x2F;轮询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CDC-%E5%85%A8%E9%87%8F-%E5%A2%9E%E9%87%8F"><span class="toc-number">4.3.1.2.</span> <span class="toc-text">CDC 全量+增量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E5%BC%82%E5%B8%B8"><span class="toc-number">4.3.1.3.</span> <span class="toc-text">常见异常</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Flink-Pipeline-Config"><span class="toc-number">4.3.2.</span> <span class="toc-text">Flink Pipeline Config</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Flink-Table-API"><span class="toc-number">4.3.3.</span> <span class="toc-text">Flink Table API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Flink-DataStream-API"><span class="toc-number">4.3.4.</span> <span class="toc-text">Flink DataStream API</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Apache-NiFi"><span class="toc-number">4.4.</span> <span class="toc-text">Apache NiFi</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%B7%A5%E5%85%B7"><span class="toc-number">4.5.</span> <span class="toc-text">其他工具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%91%E5%8E%9F%E7%94%9F"><span class="toc-number">5.</span> <span class="toc-text">云原生</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AWS"><span class="toc-number">5.1.</span> <span class="toc-text">AWS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%BF%E9%87%8C%E4%BA%91"><span class="toc-number">5.2.</span> <span class="toc-text">阿里云</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Serverless-%E6%96%B9%E6%A1%88"><span class="toc-number">5.3.</span> <span class="toc-text">Serverless 方案</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 - 2026 By 余一叶知秋尽</span><span class="framework-info"><span>框架 </span><a href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.3</a></span></div><div class="footer_custom_text"><p><a style="margin-inline:5px"target="_blank"href="https://github.com/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Hosted-Github-brightgreen?style=flat&logo=GitHub"title="本站项目由Gtihub托管"></a><a style="margin-inline:5px"target="_blank"href="https://hexo.io/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo"title="博客框架为Hexo"></a><a style="margin-inline:5px"target="_blank"href="https://butterfly.js.org/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?logoColor=white&style=flat&logo=buefy"title="主题采用butterfly"></a><a style="margin-inline:5px"target="_blank"href="https://giscus.app/zh-CN/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Comment-Giscus-2873df?logoColor=white&style=flat&logo=git"title="评论系统为Giscus"></a><a style="margin-inline:5px"target="_blank"href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src= "/img/20241215205335173426721579192.webp" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris"title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div><script src="https://unpkg.com/mermaid@11.5.0/dist/mermaid.min.js"></script><script>if (window.mermaid) {
  mermaid.initialize({
    startOnLoad: true,
    theme: '[object Object]',
    securityLevel: 'loose',
    flowchart: { useMaxWidth: true, htmlLabels: true }
  });
}</script></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="日间和夜间模式切换"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getGiscusTheme = theme => theme === 'dark' ? 'dark' : 'light'

  const createScriptElement = config => {
    const ele = document.createElement('script')
    Object.entries(config).forEach(([key, value]) => {
      ele.setAttribute(key, value)
    })
    return ele
  }

  const loadGiscus = (el = document, key) => {
    const mappingConfig = isShuoshuo
      ? { 'data-mapping': 'specific', 'data-term': key }
      : { 'data-mapping': (option && option['data-mapping']) || 'pathname' }

    const giscusConfig = {
      src: 'https://giscus.app/client.js',
      'data-repo': 'pengline/pengline.github.io',
      'data-repo-id': 'R_kgDOPqG50w',
      'data-category-id': 'DIC_kwDOPqG5084Cu_K9',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      'data-lang': 'zh-CN',
      'data-input-position': 'top',
      async: true,
      ...option,
      ...mappingConfig
    }

    const scriptElement = createScriptElement(giscusConfig)

    el.querySelector('#giscus-wrap').appendChild(scriptElement)

    if (isShuoshuo) {
      window.shuoshuoComment.destroyGiscus = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }
  }

  const changeGiscusTheme = theme => {
    const iframe = document.querySelector('#giscus-wrap iframe')
    if (iframe) {
      const message = {
        giscus: {
          setConfig: {
            theme: getGiscusTheme(theme),
            lang: 'zh-CN'
          }
        }
      }
      iframe.contentWindow.postMessage(message, 'https://giscus.app')
    }
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if (isShuoshuo) {
    'Giscus' === 'Giscus'
      ? window.shuoshuoComment = { loadComment: loadGiscus }
      : window.loadOtherComment = loadGiscus
    return
  }

  if ('Giscus' === 'Giscus' || !false) {
    if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment = loadGiscus
  }
})()</script></div><script src="/js/custom/sun_moon.js" async></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>